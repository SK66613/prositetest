<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';
                 script-src 'self' https://telegram.org https://*.telegram.org 'unsafe-inline' 'unsafe-eval';
                 connect-src 'self' https://*.workers.dev https://*.cloudflareclient.com;
                 img-src 'self' https: data:; font-src 'self' https: data:; frame-src https: telegram.org *.telegram.org;"/>

  <title>–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --bg:#0b0c15; --text:#f4f6fa; --muted:#a7acc2; --primary:#7b5bff; --blue:#5b8cff; --mint:#3de0c5; --card:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.1) }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
    .container{ max-width:980px; margin:0 auto; padding:16px }
    header.container{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .logo{ width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--mint),var(--primary)); box-shadow:0 8px 20px rgba(0,0,0,.35) }
    .brand{ font-weight:800; letter-spacing:.4px }
    .muted{ color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:16px; backdrop-filter:blur(8px) }

    /* nav */
    #spa-nav{ position:sticky; top:0; z-index:10; background:rgba(10,12,22,.6); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.06); margin:8px; padding:6px; border-radius:14px; display:flex; gap:6px }
    #spa-nav .btn{ appearance:none; border:0; background:transparent; color:var(--text); font-weight:700; padding:8px 10px; border-radius:10px; cursor:pointer }
    #spa-nav .btn.active{ background:linear-gradient(135deg,var(--primary),var(--blue)); color:#fff }

    /* calendar */
    .calendar{ user-select:none }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px }
    .cal-head .mon{ font-weight:800 }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
    .cal-cell{ height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); font-weight:600; cursor:pointer }
    .cal-cell.muted{ opacity:.35 }
    .cal-cell.off{ opacity:.25; pointer-events:none }
    .cal-dow{ opacity:.6; font-weight:700; font-size:12px }

    /* slots */
    #slots{ display:none; gap:8px; flex-wrap:wrap }
    #slots.show{ display:flex }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.18); background:transparent; color:var(--text); border-radius:12px; padding:8px 10px; font-weight:700; cursor:pointer }
    .btn-primary{ background:linear-gradient(135deg,var(--primary),var(--blue)); color:#fff; border-color:transparent; box-shadow:0 10px 20px rgba(91,140,255,.32) }
    .off{ opacity:.5 }

    .row{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px }
    .stack{ display:grid; gap:10px }
    .hint{ font-size:12px; color:var(--muted) }
  </style>

  <!-- –ö–æ–Ω—Ñ–∏–≥ -->
  <script>
    window.APP_CONFIG = {
      TG_BOT_USERNAME: 'serge_kamensky_bot',
      API_BASE: 'https://cifrovichkoff.cyberian13.workers.dev', // ‚Üê –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–º–µ–Ω—è–π
      API_KEY: '',
      USE_TG_SIGNATURE: true
    };
  </script>
</head>
<body>
  <header class="container">
    <div style="display:flex; align-items:center; gap:10px">
      <div class="logo"></div>
      <div>
        <div class="brand">–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</div>
        <div class="muted">–°—á–∏—Ç–∞–µ–º –ø—Ä–∏–±—ã–ª—å, –∞ –Ω–µ –∫–ª–∏–∫–∏</div>
      </div>
    </div>
  </header>

  <nav id="spa-nav" class="container">
    <button class="btn active" data-page="consult">üìÖ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</button>
    <button class="btn" data-page="about">üë§ –û–±–æ –º–Ω–µ</button>
  </nav>

  <main class="container">
    <section class="page" id="consult">
      <div class="card stack">
        <div class="cal-head">
          <button id="prevM" class="btn">‚Äπ</button>
          <div class="mon" id="monLabel"></div>
          <button id="nextM" class="btn">‚Ä∫</button>
        </div>

        <div id="cal" class="calendar" data-ready="1">
          <div class="cal-grid" id="calGrid"></div>
        </div>

        <div class="stack">
          <div class="row">
            <div class="muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
            <div>
              <button class="btn dur" data-dur="30">30 –º–∏–Ω</button>
              <button class="btn dur" data-dur="60">60 –º–∏–Ω</button>
              <button class="btn dur" data-dur="90">90 –º–∏–Ω</button>
            </div>
          </div>

          <div id="slots" class="stack"></div>

          <div class="row">
            <input id="contact" class="btn" placeholder="@username / +7..." style="width:100%"/>
            <button id="bookBtn" class="btn btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
          </div>
          <div id="status" class="muted"></div>
          <div class="hint">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –≤ Telegram.</div>
        </div>
      </div>
    </section>

    <section class="page" id="about" style="display:none">
      <div class="card">
        <h3>–û–±–æ –º–Ω–µ</h3>
        <p class="muted">–î–µ–º–æ: Cloudflare Worker + Google Sheets. –°–ª–æ—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 30/60/90 –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</p>
      </div>
    </section>
  </main>

  <script>
  // ---------- helpers ----------
  const dd2 = n => String(n).padStart(2,'0');
  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow';

  function getTgId(){ try{ return tg?.initDataUnsafe?.user?.id || null }catch(_){ return null } }
  function getStartParam(){ try{ return tg?.initDataUnsafe?.start_param || '' }catch(_){ return '' } }
  function getInitData(){ try{ return tg?.initData || '' }catch(_){ return '' } }

  function urlWithParams(base, params){ const u=new URL(base); Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined&&v!==null) u.searchParams.set(k,String(v)); }); return u; }
  async function apiGet(path, params){ const r=await fetch(urlWithParams(APP_CONFIG.API_BASE+path, params)); const t=await r.text(); try{ return JSON.parse(t);}catch{ return {ok:false, error:'bad_json', raw:t} } }
  async function apiPost(path, body){
    body = body || {};
    if (!body.tg_id)        body.tg_id        = String(getTgId()||'');
    if (!body._start_param) body._start_param = getStartParam();
    if (!body._init_data)   body._init_data   = getInitData();
    const r=await fetch(APP_CONFIG.API_BASE+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const t=await r.text(); try{ return JSON.parse(t);}catch{ return {ok:false, error:'bad_json', raw:t} }
  }

  // ---------- state ----------
  let curY, curM;           // YYYY, MM
  let FREE = {};            // {'YYYY-MM-DD':['HH:MM',...]}
  let GRAN = 30;            // —à–∞–≥ —Å–ª–æ—Ç–æ–≤
  let SERVER_FILTERED = false; // FIX: —Å–µ—Ä–≤–µ—Ä —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª –ø–æ–¥ duration_min
  let selDate=null, selTime=null, selDur=30;
  let REQ=0, pollTimer=null;

  function nowYM(){ const d=new Date(); return { y:String(d.getFullYear()), m:dd2(d.getMonth()+1) }; }

  // ---------- UI ----------
  document.getElementById('prevM').onclick = ()=>{ stopPolling(); shiftMonth(-1); };
  document.getElementById('nextM').onclick = ()=>{ stopPolling(); shiftMonth(1); };
  qsa('.dur').forEach(b=> b.onclick = async ()=>{
    qsa('.dur').forEach(x=>x.classList.remove('btn-primary'));
    b.classList.add('btn-primary');
    selDur = +b.dataset.dur || 30;
    await syncMonth();                 // —Ç—è–Ω–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥ 30/60/90
    if (selDate) renderSlots(selDate); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
    startPolling(selDate);
  });
  document.getElementById('bookBtn').onclick = onBook;

  function shiftMonth(delta){
    const y=+curY, m=+curM;
    const d=new Date(y, m-1+delta, 1);
    curY=String(d.getFullYear()); curM=dd2(d.getMonth()+1);
    syncMonth();
  }

  function drawCalendar(y,m){
    const grid = document.getElementById('calGrid'); grid.innerHTML='';
    const mon = new Date(+y, +m-1, 1);
    const monLabel = mon.toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
    document.getElementById('monLabel').textContent = monLabel.charAt(0).toUpperCase()+monLabel.slice(1);

    const dow=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
    dow.forEach(d=>{ const div=document.createElement('div'); div.className='cal-cell cal-dow'; div.textContent=d; grid.appendChild(div); });

    const firstDow=(new Date(+y,+m-1,1).getDay()+6)%7;
    for(let i=0;i<firstDow;i++){ const sp=document.createElement('div'); sp.className='cal-cell muted'; grid.appendChild(sp); }

    const daysInMonth = new Date(+y,+m,0).getDate();
    for(let d=1; d<=daysInMonth; d++){
      const iso = `${y}-${m}-${dd2(d)}`;
      const btn=document.createElement('div'); btn.className='cal-cell'; btn.textContent=d; btn.dataset.iso=iso;
      btn.onclick=()=>{ selDate=iso; qsa('.cal-cell.sel',grid).forEach(x=>x.classList.remove('sel')); btn.classList.add('sel'); renderSlots(iso); startPolling(iso); };
      grid.appendChild(btn);
    }
    applyDaysState(y,m);
  }

  function applyDaysState(y,m){
    const grid=document.getElementById('calGrid');
    qsa('.cal-cell',grid).forEach(cell=>{
      if (cell.classList.contains('cal-dow') || !cell.dataset.iso) return;
      const arr = FREE[cell.dataset.iso] || [];
      const off = !(Array.isArray(arr) && arr.length>0);
      cell.classList.toggle('off', off); cell.classList.toggle('muted', off);
    });
  }

  // —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ä—Ç–æ–≤ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ü–µ–ø–æ—á–∫–∞ 30/60/90)
  function filterStartsByDuration(starts, durMin, step){
    if (!Array.isArray(starts) || !starts.length) return [];
    const need = Math.ceil(durMin / step);
    const toMin = t=>{ const m=t.match(/(\d{1,2}):(\d{2})/); return m? (+m[1])*60+(+m[2]) : null };
    const set = new Set(starts.map(toMin).filter(x=>x!=null));
    return starts.filter(t=>{
      const m=toMin(t); if(m==null) return false;
      for(let i=0;i<need;i++){ if(!set.has(m+i*step)) return false }
      return true;
    });
  }

  function renderSlots(iso){
    const wrap=qs('#slots'); wrap.innerHTML=''; wrap.classList.add('show'); selTime=null;
    const arr = FREE[iso] || [];

    // FIX: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å —É—á—ë—Ç–æ–º duration_min ‚Äî –ù–ï —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
    const list = SERVER_FILTERED ? arr : filterStartsByDuration(arr, selDur, GRAN);

    if (!list.length){ wrap.innerHTML='<div class="muted">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç–∞—Ä—Ç–æ–≤ –¥–ª—è '+selDur+' –º–∏–Ω</div>'; return; }
    list.forEach(label=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.dataset.time=label;
      b.onclick=()=>{ qsa('#slots .btn').forEach(x=>x.classList.remove('btn-primary')); b.classList.add('btn-primary'); selTime=label; };
      wrap.appendChild(b);
    });
  }

  function autoPickDay(){
    const days = Object.keys(FREE).filter(d => (FREE[d]||[]).length);
    if (!days.length) return;
    selDate = days.includes(selDate) ? selDate : days[0];
    const cell = document.querySelector(`#calGrid [data-iso="${selDate}"]`);
    if (cell){ qsa('#calGrid .cal-cell.sel').forEach(x=>x.classList.remove('sel')); cell.classList.add('sel'); }
    renderSlots(selDate);
  }

  // polling
  function startPolling(iso){
    stopPolling();
    if (!iso) return;
    const refresh = async ()=>{
      const data = await apiGet('/api/slots/free', {from:iso, to:iso, tz, lead_min:60, duration_min: selDur});
      if (data?.ok && data.days?.[iso]){
        const next = data.days[iso] || [];
        const same = JSON.stringify(next) === JSON.stringify(FREE[iso]||[]);
        // FIX: –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        SERVER_FILTERED = !!data.filtered_by_duration;
        GRAN = data.gran || GRAN;

        if (!same){ FREE[iso]=next; renderSlots(iso); applyDaysState(curY,curM); }
      }
    };
    pollTimer = setInterval(refresh, 10000);
    document.addEventListener('visibilitychange',()=>{ if(!document.hidden) refresh(); }, { once:true });
    refresh();
  }
  function stopPolling(){ if (pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

  // –ø–æ–¥—Ç—è–∂–∫–∞ —Å–ª–æ—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü
  async function syncMonth(){
    const my = ++REQ;
    const first = `${curY}-${curM}-01`;
    const last  = `${curY}-${curM}-${dd2(new Date(+curY, +curM, 0).getDate())}`;
    const grid = qs('#calGrid');
    grid.innerHTML = '<div class="muted" style="grid-column:1/-1;text-align:center;padding:10px">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>';

    const data = await apiGet('/api/slots/free', { from:first, to:last, tz, lead_min:60, duration_min: selDur });
    if (my !== REQ) return;

    if (data?.ok){
      FREE = data.days || {};
      GRAN = data.gran || 30;
      SERVER_FILTERED = !!data.filtered_by_duration; // FIX: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫
      drawCalendar(curY,curM); applyDaysState(curY,curM);
      autoPickDay();
    } else {
      qs('#status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤';
    }
  }

  // –±—Ä–æ–Ω—å
  let __busy=false;
  async function onBook(){
    if (__busy) return; __busy=true;
    try{
      if (!selDate || !selTime){ qs('#status').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'; return; }
      const contact = qs('#contact').value.trim(); if(!contact){ qs('#status').textContent='–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏'; return; }

      const hold = await apiPost('/api/slots/hold', { date:selDate, time:selTime, duration_min:selDur });
      if (!hold?.ok){ qs('#status').textContent='–°–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç, –æ–±–Ω–æ–≤–ª—è—é‚Ä¶'; await syncMonth(); return; }

      const res = await apiPost('/api/consult/book', { date:selDate, time:selTime, duration_min:selDur, format:'call', contact });
      if (res?.ok){ qs('#status').textContent='–ì–æ—Ç–æ–≤–æ! –ë—Ä–æ–Ω—å '+(res.booking_id||'—Å–æ–∑–¥–∞–Ω–∞'); await syncMonth(); }
      else { qs('#status').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'; await syncMonth(); }
    } finally { __busy=false; }
  }

  // init
  (function(){
    const ym=nowYM(); curY=ym.y; curM=ym.m;
    try{ const u=tg?.initDataUnsafe?.user; if(u?.username) qs('#contact').placeholder='@'+u.username; }catch(_){}
    qsa('.dur')[0].classList.add('btn-primary'); // 30 –º–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    syncMonth();
  })();
</script>
</body>
</html>
