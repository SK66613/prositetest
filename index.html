<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Правильный Учёт — Мини‑приложение (pro)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c15; --text:#f4f6fa; --muted:#a7acc2;
      --primary:#7b5bff; --mint:#3de0c5; --blue:#5b8cff;
      --card:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.10);
      --toast:#0f1221;
    
  --nav-active-pad-extra: 6px;}
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);overflow-x:hidden}
    .container{max-width:1080px;margin:0 auto;padding:16px 16px 24px}
    header.container{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px}
    .brand-wrap{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;position:relative;overflow:hidden}
    .logo::before{content:"";position:absolute;inset:-30%;background:
      radial-gradient(120px 120px at 30% 30%, var(--mint), transparent 60%),
      radial-gradient(160px 160px at 80% 80%, var(--primary), transparent 60%);
      filter:blur(.2px);
    }
    .brand{font-family:'Montserrat',sans-serif;font-weight:800;font-size:20px;letter-spacing:.4px}
    .slogan{font-size:13px;color:var(--mint)}

    /* Background canvas */
    #bg-canvas{position:fixed;inset:0;z-index:-1}

    /* nav capsule */
    #spa-nav{position:sticky;top:0;z-index:10;display:flex;gap:8px;overflow:visible;
      padding:8px;margin:8px 0 18px;background:rgba(10,12,22,.6);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);
      white-space:nowrap;
    }
    #spa-nav .btn{appearance:none;border:1px solid transparent;background:transparent;color:var(--text);
      font-weight:600;font-size:14px;padding:9px 12px;border-radius:12px;cursor:pointer;text-decoration:none;transition:.18s;
      white-space:nowrap;position:relative;overflow:hidden;flex:0 0 auto;max-width:160px;text-overflow:ellipsis;
    }
    #spa-nav .btn:hover{background:rgba(255,255,255,.08)}
    #spa-nav .btn.active{background:linear-gradient(135deg,var(--primary),var(--blue));color:#fff;box-shadow:0 10px 22px rgba(91,140,255,.35);max-width:none}

    .h1{font-size:19px;line-height:1.2;font-weight:800;margin:14px 0 10px}
    .h1 span{background:linear-gradient(90deg,var(--primary),var(--mint));-webkit-background-clip:text;color:transparent}
    .lead{color:var(--muted);font-size:17px;max-width:820px}

    .grid{display:grid;gap:14px}
    @media(min-width:920px){.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}.h1{font-size:56px}}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:20px;padding:18px;backdrop-filter:blur(8px);
      transition:transform .2s ease, box-shadow .2s ease; will-change: transform}
    .card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(0,0,0,.4)}
    .card h3{margin:0 0 8px;font-size:18px}

    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px;color:var(--muted)}
    .list li{display:flex;gap:10px;align-items:flex-start}
    .dot{width:10px;height:10px;border-radius:50%;margin-top:6px;background:linear-gradient(135deg,var(--mint),var(--primary))}

    .cta{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
    .btn{appearance:none;border:none;border-radius:14px;padding:10px 12px;font-weight:700;font-size:12px;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;text-decoration:none;transition:.18s;position:relative;overflow:hidden}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--blue));color:#fff;box-shadow:0 10px 26px rgba(91,140,255,.32)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}

    .highlight-banner{margin:18px 0;padding:16px 18px;border-radius:16px;
      background:linear-gradient(135deg,rgba(61,224,197,.14),rgba(123,91,255,.14));
      color:var(--mint);font-weight:600;font-size:15px;text-align:center}
    .highlight-banner strong{color:#fff}

    /* KPI marquee */
    .kpi-strip{margin:14px 0 0;overflow:hidden;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
    .kpi-track{display:flex;gap:22px;padding:10px 12px;animation:marquee 20s linear infinite;will-change:transform}
    .kpi{display:flex;align-items:center;gap:8px;white-space:nowrap;font-weight:600}
    .kpi .v{font-weight:800;color:#fff}
    @keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}

    /* Savings widget */
    .savings{display:grid;gap:12px}
    .savings .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px}
    .savings input[type=range]{width:100%}
    .savings .stat{display:flex;gap:10px;flex-wrap:wrap}
    .badge{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);font-weight:700}
    .big{font-size:18px;font-weight:800}

    /* Toasts */
    .toasts{position:fixed;right:14px;top:14px;display:flex;flex-direction:column;gap:8px;z-index:1000}
    .toast{background:var(--toast);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;box-shadow:0 12px 26px rgba(0,0,0,.4);min-width:240px}
    .toast .t{font-weight:700}
    .toast .m{color:var(--muted);font-size:13px}

    /* Onboarding */
    .onb{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1200}
    .onb .box{width:min(560px,92vw);background:#0f1221;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
    .onb .steps{display:grid;gap:10px;margin:12px 0}
    .onb .steps .step{display:flex;gap:10px;align-items:flex-start}
    .onb .steps .num{width:24px;height:24px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--mint));display:grid;place-items:center;font-weight:800}
    .onb .actions{display:flex;gap:8px;justify-content:flex-end}

    footer{text-align:center;padding:36px 0 48px;color:var(--muted);font-size:13px}
    section.page{display:none;scroll-margin-top:70px}
    section.page.active{display:block}

    /* reveal animations */
    .reveal{opacity:0;transform:translateY(14px);transition:opacity .5s ease, transform .5s ease}
    .reveal.visible{opacity:1;transform:none}

    /* Console overlay */
    .console-toggle{position:fixed;right:14px;bottom:14px;z-index:1000}
    .console-panel{position:fixed;right:14px;bottom:56px;width:360px;max-height:45vh;background:rgba(15,18,33,.9);
      border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;overflow:auto;font:12px/1.4 monospace;color:#b9d3ff;display:none;z-index:1000}
    .console-panel .line{white-space:pre-wrap;border-bottom:1px dashed rgba(255,255,255,.06);padding:3px 0}
    .console-panel .time{color:#7bffcb;margin-right:6px}
    .console-panel .event{color:#e6eaff}

    /* mobile */
    @media(max-width:480px){
      html,body{font-size:14px}
      header.container{padding:12px 12px}
      .logo{margin-left:12px;}
      .logo{width:36px;height:36px;border-radius:10px}
      .brand{font-size:18px}
      #spa-nav{gap:6px;padding:6px}
      #spa-nav .btn{font-size:12.5px;padding:7px 9px;border-radius:10px;max-width:120px}
      #spa-nav .btn.active{max-width:none}
      .console-panel{width:88vw; right:6vw}
      .kpi-track{animation-duration:26s}
    }
  
/* --- Nav: carousel style + hide scrollbar line --- */
#spa-nav{
  overflow:visible; white-space:nowrap; border-bottom:none;
  -ms-overflow-style: none;  /* IE/Edge */
  scrollbar-width: none;     /* Firefox */
  mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
}
#spa-nav::-webkit-scrollbar{ height:0 } /* Chrome/Safari: hide bar */
#spa-nav .btn{
  scroll-snap-align: center;
  transform-origin: center center;
  transition: transform .18s ease, opacity .18s ease, background .18s ease;
  opacity:.86;
}
#spa-nav .btn.active{ opacity:1 }
#spa-nav .track{display:flex; gap:8px; scroll-snap-type: x mandatory
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;}


/* Leaderboard bars */
.bar{height:10px; border-radius:6px; background:rgba(255,255,255,.08); overflow:hidden}
.bar > span{display:block; height:100%; background:linear-gradient(90deg, var(--mint), var(--primary))}


/* --- New segmented carousel nav with bubble indicator --- */
#spa-nav{
  position:sticky; top:0; z-index:20;
  padding:6px; margin:8px 0 18px;
  background:rgba(10,12,22,.65); backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.35);
  overflow:hidden;
}
#spa-nav .track{
  display:flex; align-items:center; gap:8px; overflow-x:auto; padding:2px;
  scroll-snap-type:x mandatory; white-space:nowrap;
  -ms-overflow-style:none; scrollbar-width:none;
}
#spa-nav .track::-webkit-scrollbar{ display:none }
#spa-nav .btn{
  position:relative; z-index:1;
  scroll-snap-align:center;
  font-weight:700; font-size:14px; padding:9px 12px; border-radius:12px;
  color:var(--text); border:1px solid transparent; background:transparent;
  transition:transform .18s ease, opacity .18s ease, color .18s ease;
  flex:0 0 auto;
}
#spa-nav .btn:not(.active){ opacity:.82 }
#spa-nav .btn.active{ color:#fff }
#spa-nav .bubble{
  position:absolute; z-index:0; height:32px; border-radius:12px;
  background:linear-gradient(135deg, var(--primary), var(--blue));
  box-shadow:0 10px 22px rgba(91,140,255,.35);
  transition:left .24s cubic-bezier(.2,.8,.2,1), width .24s cubic-bezier(.2,.8,.2,1);
  will-change:left,width;
}
@media(max-width:480px){
  #spa-nav .btn{font-size:12.5px; padding:7px 10px; border-radius:10px}
  #spa-nav .bubble{height:28px; border-radius:10px}
}


/* Calendar styles */
.calendar{user-select:none}
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.cal-head .mon{font-weight:800}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-cell{height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03); font-weight:600; cursor:pointer; transition:transform .15s ease, background .15s ease, color .15s ease}
.cal-cell:hover{transform:translateY(-1px);}
.cal-cell.muted{opacity:.35}
.cal-cell.off{opacity:.25; pointer-events:none}
.cal-cell.sel{color:#fff; background:linear-gradient(135deg, var(--primary), var(--mint)); border-color:transparent}
.cal-dow{opacity:.6; font-weight:700; font-size:12px}


.badge-pill{display:inline-block; padding:revert; border-radius:999px; border:0px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); font-weight:700; font-size:revert}
.lb-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.q-badge{display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); font-size:12px}


/* Safe minimal "grow" effect for active tab without JS changes */
#spa-nav .btn { /* declare a fallback for horizontal padding if none defined as CSS var */
  --btn-pad-x: 12px; /* only used by the rule below if the existing CSS doesn't define it */
}
#spa-nav .btn.active{
  padding-left:  calc(var(--btn-pad-x, 12px) + var(--nav-active-pad-extra));
  padding-right: calc(var(--btn-pad-x, 12px) + var(--nav-active-pad-extra));
}


/* === Global vertical rhythm & paddings === */
:root{
  --space-1: 6px; --space-2: 10px; --space-3: 14px; --space-4: 18px;
  --section-gap: 28px;
}
.container{max-width:1080px;margin:0 auto;padding:18px 18px 28px!important;}
section.page > * + *{ margin-top: var(--section-gap); }
.grid{ gap: var(--space-2) !important; }
.card + .card{ margin-top: var(--space-3); }


/* === v13: global paddings & spacing === */
section.page{ padding-left:18px; padding-right:18px; }
@media (min-width:1024px){ section.page{ padding-left:24px; padding-right:24px; } }

/* vertical rhythm */
:root{ --section-gap: 28px; --space-2: 10px; --space-3: 14px; }
section.page > * + *{ margin-top: var(--section-gap); }
.grid{ gap: var(--space-2) !important; }
.card + .card{ margin-top: var(--space-3); }

/* KPI pills micro-gaps */
.kpi-track{ display:flex; gap:22px; padding:10px 12px; }
.kpi{ display:inline-flex; align-items:center; gap:6px; }
.kpi .v{ margin-left:4px; }

/* bonuses: ticker/marquee safe spacing */
.marquee,.ticker{ margin-bottom:14px; }
.marquee + .card, .ticker + .card{ margin-top:14px; }

/* consult: show time slots only after date select */
#consult #slots{ display:none; gap:10px; flex-wrap:wrap; }
#consult #slots.show{ display:flex; }
#consult .dur{ min-width:88px; text-align:center; }


/* === v14: unified spacing & typography === */
:root{
  --container-pad-x: 18px;
  --container-pad-y: 18px;
  --section-gap: 28px;
  --grid-gap: 12px;
  --card-pad: 18px;
}
@media (min-width: 1024px){
  :root{
    --container-pad-x: 24px;
    --container-pad-y: 20px;
    --section-gap: 32px;
    --grid-gap: 14px;
    --card-pad: 20px;
  }
}
.container{ padding: var(--container-pad-y) var(--container-pad-x) !important; }
section.page > * + *{ margin-top: var(--section-gap) !important; }
.grid{ gap: var(--grid-gap) !important; }
.card{ padding: var(--card-pad) !important; }

/* Typography */
body{ font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
.brand{ font-family: 'Montserrat', sans-serif !important; }
.h1{ font-size: clamp(19px, 3.4vw + 12px, 56px)  line-height: 1.15; font-weight: 800; margin: 0 0 4px; }


/* === v15: layout normalizer (uniform paddings & width) === */
:root{ --content-max: 1080px; }

/* 1) A single content column width for everything */
main, .container { max-width: var(--content-max); margin-inline: auto; }

/* 2) Identical horizontal paddings everywhere */
section.page { padding-left: var(--container-pad-x); padding-right: var(--container-pad-x); }
.container{ padding-left: 0 !important; padding-right: 0 !important; } /* avoid double padding */

/* 3) If секция без .container — выравниваем внутренние крупные блоки */
section.page > .card,
section.page > .grid,
section.page > .section-head,
section.page > header,
section.page > .pillbar,
section.page > .stepper,
section.page > .pricing { margin-inline: 0; }

/* 4) Hero/heading rows inside sections also align */
section.page .hero, section.page .lead, section.page .h1 { margin-inline: 0; }

/* 5) Safety: on mobile keep paddings; on desktop they already scale by var */
@media (min-width: 1280px){
  :root{ --content-max: 1160px; }
}

</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>

<header class="container">
  <div class="brand-wrap">
    <div class="logo"></div>
    <div>
      <div class="brand">Маркетолог</div>
      <div class="slogan">Считаем прибыль, а не клики</div>
    </div>
  </div>
</header>

<nav class="container" id="spa-nav"><div class="track"><a class="btn" data-page="home" href="#home">🏠 Главная</a><a class="btn" data-page="services" href="#services">🧩 Услуги</a><a class="btn" data-page="about" href="#about">👩‍💼 Обо мне</a><a class="btn" data-page="faq" href="#faq">❓ Вопросы</a><a class="btn" data-page="bonuses" href="#bonuses">🎁 Бонусы</a><a class="btn" data-page="community" href="#community">🤝 Сообщество</a><a class="btn" data-page="consult" href="#consult">📅 Консультация</a><a class="btn" data-page="invite" href="#invite">🎯 Партнерка</a><span class="bubble" aria-hidden="true"></span></div></nav>

<main class="container">

  <section class="page" id="home">

    <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>

    <!-- Savings widget -->
    <div class="grid grid-2 reveal" style="margin-top:14px">
      <div class="card savings">
        <div class="h1 reveal">Быстрый <span>расчет прибыли</span> бизнеса</div>
        <div class="row">
          <label>Выручка: <strong id="revVal">10 000 000 ₽</strong></label>
          <input id="rev" type="range" min="500000" max="50000000" step="500000" value="10000000">
        </div>
        <div class="row">
          <label>Эффект оптимизации: <strong id="pctVal">12%</strong></label>
          <input id="pct" type="range" min="1" max="30" step="1" value="12">
        </div>
        <div class="stat">
          <div class="badge">Было: <span id="oldTax">1 500 000 ₽</span></div>
          <div class="badge">Стало: <span id="newTax">1 320 000 ₽</span></div>
        </div>
        <div>Потенциальная экономия:</div>
        <div class="big" id="saveCounter">0 ₽</div>
        <div class="cta"><button class="btn btn-primary confetti" id="ctaCalc">Получить персональный расчёт</button></div>
      </div>
<div class="card reveal" style="margin-bottom:12px"><div class="h1 reveal" style="margin-bottom:20px">Как <span>мы</span> работаем</div><div id="flow" style="display:grid;gap:8px"><div class="badge">Шаг 1 · Диагностика</div><div class="badge">Шаг 2 · План оптимизации</div><div class="badge">Шаг 3 · Внедрение</div><div class="badge">Шаг 4 · Контроль и отчёты</div></div><div class="cta" style="margin-top:10px"><button class="btn btn-primary" id="flowNext">Дальше</button><button class="btn btn-ghost" id="flowReset">Сбросить</button></div></div>
      <div class="card">
        <div class="h1 reveal" style="margin-bottom:20px">Что <span>делать</span> дальше</div>
        <ul class="list">
          <li><span class="dot"></span>Запускаем калькулятор в боте</li>
          <li><span class="dot"></span>Фиксируем источник «утечек»</li>
          <li><span class="dot"></span>Формируем пошаговый план</li>
        </ul>
        <div class="highlight-banner" style="text-align:left"><strong>Бонус:</strong> мини‑гайд «Как перейти на выгодный режим»</div>
      </div>

  </section>

  <section class="page" id="services">
<div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
<div class="card reveal"><h3>Тарифы</h3><div class="cta"><button class="btn btn-primary svcMode" data-mode="month">Месяц</button><button class="btn btn-ghost svcMode" data-mode="year">Год −15%</button></div></div><div class="card price reveal" data-base="30000"><h3>📈 Продвижение на Авито</h3><p class="lead" style="font-size:14px">Ваши объявления будут выходить на первые позиции — поток заявок при минимальном бюджете.</p><div class="big" data-price>30,000 ₽</div></div><div class="card price reveal" data-base="60000"><h3>🎯 Контекстная реклама</h3><p class="lead" style="font-size:14px">Яндекс.Директ и Google Ads: кампании без слива бюджета, под ваши KPI.</p><div class="big" data-price>60,000 ₽</div></div><div class="card price reveal" data-base="45000"><h3>🔍 SEO и сайты (Tilda/MODx)</h3><p class="lead" style="font-size:14px">Сайт‑магнит: оптимизация, структура, тексты под спрос.</p><div class="big" data-price>45,000 ₽</div></div><div class="card price reveal" data-base="55000"><h3>🤖 CRM и чат‑боты</h3><p class="lead" style="font-size:14px">Amo/Bitrix24 + боты: заявки 24/7, ничего не теряется.</p><div class="big" data-price>55,000 ₽</div></div><div class="card price reveal" data-base="40000"><h3>🛒 Маркетплейсы</h3><p class="lead" style="font-size:14px">Карточки под ключ: фото, описание, ключи, продвижение в площадке.</p><div class="big" data-price>40,000 ₽</div></div><div class="card price reveal" data-base="50000"><h3>📊 Аналитика и стратегия</h3><p class="lead" style="font-size:14px">Сквозная аналитика + карта действий на 6–12 мес.</p><div class="big" data-price>50,000 ₽</div></div><div class="card price reveal" data-base="35000"><h3>💬 Репутация и SMM</h3><p class="lead" style="font-size:14px">Образ бренда и работа с отзывами.</p><div class="big" data-price>35,000 ₽</div></div><div class="card price reveal" data-base="38000"><h3>📲 Telegram‑маркетинг</h3><p class="lead" style="font-size:14px">Канал, рассылки, воронки, связка с CRM.</p><div class="big" data-price>38,000 ₽</div></div><div class="card price reveal" data-base="70000"><h3>⚡ Mini‑Apps в Telegram</h3><p class="lead" style="font-size:14px">Калькуляторы, квизы, лид‑формы, интеграции.</p><div class="big" data-price>70,000 ₽</div></div>
    </div>
<div class="card reveal" style="margin-bottom:12px">
  <div class="h1 reveal">Быстрый квиз: <span>что даст</span> наибольшую экономию?</div>
  <div id="quiz" data-step="0">
    <div id="q0" class="q">
      <div class="lead" style="font-size:14px">Выручка в месяц?</div>
      <div class="cta">
        <button class="btn btn-ghost quiz-option" data-score="1">до 1 млн</button>
        <button class="btn btn-ghost quiz-option" data-score="2">1–5 млн</button>
        <button class="btn btn-ghost quiz-option" data-score="3">5–20 млн</button>
        <button class="btn btn-ghost quiz-option" data-score="4">20+ млн</button>
      </div>
    </div>
    <div id="q1" class="q" style="display:none">
      <div class="lead" style="font-size:14px">Доля расходов к выручке?</div>
      <div class="cta">
        <button class="btn btn-ghost quiz-option" data-score="1">до 20%</button>
        <button class="btn btn-ghost quiz-option" data-score="2">20–40%</button>
        <button class="btn btn-ghost quiz-option" data-score="3">40–60%</button>
        <button class="btn btn-ghost quiz-option" data-score="4">60%+</button>
      </div>
    </div>
    <div id="q2" class="q" style="display:none">
      <div class="lead" style="font-size:14px">Есть НДС‑клиенты / входной НДС?</div>
      <div class="cta">
        <button class="btn btn-ghost quiz-option" data-score="2">Да, часто</button>
        <button class="btn btn-ghost quiz-option" data-score="1">Редко/нет</button>
      </div>
    </div>
    <div id="quizResult" style="display:none">
      <div class="h1" style="font-size:22px">Результат</div>
      <p class="lead" id="quizText" style="font-size:14px"></p>
      <div class="cta">
        <a class="btn btn-primary" href="https://t.me/pravuchet_bot?start=get_table" target="_blank" rel="noopener">Запустить калькулятор</a>
        <button class="btn btn-ghost" id="quizReset">Пройти заново</button>
      </div>
    </div>
  </div>
</div>    

  </section>

  <section class="page" id="about">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
<div class="grid grid-2 reveal">
  <div class="card"><h3>Путь</h3><ul class="list">
    <li><span class="dot"></span>2014 — старт в учёте и 1С</li>
    <li><span class="dot"></span>2018 — первые автоматизации</li>
    <li><span class="dot"></span>2022 — ниша e‑commerce</li>
    <li><span class="dot"></span>2024 — мини‑приложения и боты</li>
  </ul></div>
  <div class="card"><h3>Факты</h3><ul class="list">
    <li><span class="dot"></span>50+ проектов</li>
    <li><span class="dot"></span>Средняя экономия 12–30%</li>
    <li><span class="dot"></span>Срок запуска 5–10 дней</li>
  </ul></div>
</div>

  </section>

  <section class="page" id="bonuses">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
<div class="grid grid-3">
      <div class="card tilt reveal">
        <h3>Регистрация бизнеса</h3>
        <ul class="list">
          <li><span class="dot"></span>Подбор ОКВЭД и формы (ИП/ООО)</li>
          <li><span class="dot"></span>Документы + подача онлайн</li>
          <li><span class="dot"></span>Подключение 1С и настройка</li>
        </ul>
        <div class="cta"><button class="btn btn-primary toast-btn" data-msg="Свяжемся и подготовим документы за 1–2 дня.">Оформить регистрацию</button></div>
      </div>
      <div class="card tilt reveal">
        <h3>Подбор системы налогообложения</h3>
        <ul class="list">
          <li><span class="dot"></span>УСН 6% / УСН 15% / Патент / ОСНО</li>
          <li><span class="dot"></span>Сравнение по данным</li>
          <li><span class="dot"></span>Рекомендация за 10 минут</li>
        </ul>
        <div class="cta"><a class="btn btn-primary" href="https://t.me/pravuchet_bot?start=mode" target="_blank" rel="noopener">Подобрать режим</a></div>
      </div>
      <div class="card tilt reveal">
        <h3>Экспресс‑аудит</h3>
        <ul class="list">
          <li><span class="dot"></span>«Рентген» финансов</li>
          <li><span class="dot"></span>Убыточные направления</li>
          <li><span class="dot"></span>Список быстрых правок</li>
        </ul>
        <div class="cta"><a class="btn btn-primary" href="https://t.me/pravuchet_bot?start=audit" target="_blank" rel="noopener">Получить экспресс‑аудит</a></div>
      </div>
  <div class="card">
    <h3>Колесо призов сообщества</h3>
    <p class="lead" style="font-size:14px">Разыгрываем консультацию/шаблоны каждую неделю среди активных.</p>
    <div class="cta"><button class="btn btn-primary" id="spin">Крутить 🎡</button></div>
    <div id="spinRes" class="lead" style="font-size:14px; margin-top:8px"></div>
  </div>
  <div class="grid grid-3 reveal" style="margin-top:12px">

    </div>

</div>

  </section>

  <section class="page" id="faq">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
      <div class="card tilt reveal"><h3>Сколько занимает экспресс‑аудит?</h3><p class="lead" style="font-size:14px">Обычно 1–2 дня. Быстрые правки — сразу.</p></div>
      <div class="card tilt reveal"><h3>Реально ли подобрать режим за 5 минут?</h3><p class="lead" style="font-size:14px">Да. Нужны выручка, расходы и ФОТ.</p></div>
    </div>
  
<div class="card reveal" style="margin-top:12px">
  <h3>Быстрые ответы</h3>
  <div class="cta">
    <button class="btn btn-ghost copy" data-text="Подбор режима за 5 минут в мини‑приложении.">Скопировать ✂️ «Как быстро?»</button>
    <button class="btn btn-ghost copy" data-text="Да, работаем с Ozon/WB: комиссии, логистика, возвраты.">Скопировать ✂️ «Маркетплейсы?»</button>
  </div>
  <div class="cta">
    <input id="faqSearch" placeholder="Найти ответ…" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); color:#fff">
    <button class="btn btn-primary" id="faqDoSearch">Искать</button>
  </div>
  <div id="faqResult" class="lead" style="font-size:14px; margin-top:8px; color:#a7acc2"></div>
</div>

  </section>

</main>

  <section class="page" id="community">

    <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
 <div class="card">
    <h3>Хайлайт недели</h3>
    <ul class="list">
      <li><span class="dot"></span>Самая активная тема — НДС на маркетплейсах</li>
      <li><span class="dot"></span>Лучший ответ — @you (гайд по УСН 15%)</li>
      <li><span class="dot"></span>Встреча в четверг, 19:00</li>
    </ul>
  </div>
    </div>
  </div>
  <div class="card" style="display:grid; place-items:center">
    <div style="position:relative; width:140px; height:140px">
      <svg viewBox="0 0 120 120" width="140" height="140">
        <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.12)" stroke-width="12" fill="none"/>
        <circle id="ring" cx="60" cy="60" r="52" stroke="url(#g1)" stroke-width="12" fill="none"
          stroke-dasharray="327" stroke-dashoffset="327" stroke-linecap="round" transform="rotate(-90 60 60)"/>
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="var(--mint)"/>
            <stop offset="1" stop-color="var(--primary)"/>
          </linearGradient>
        </defs>
      </svg>
      <div id="ringText" style="position:absolute; inset:0; display:grid; place-items:center; font-weight:800">0%</div>
    </div>
    <div class="lead" style="font-size:12px; margin-top:8px">Прогресс челленджа недели</div>
  </div>
</div>
 <div class="card">
    <h3>Статистика сообщества</h3>
    <div class="grid grid-3" style="gap:12px">
      <div class="card" style="text-align:center">
        <div class="big" data-count="137" data-suffix="">0</div>
        <div class="lead" style="font-size:12px">участников онлайн</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="big" data-count="42" data-suffix="">0</div>
        <div class="lead" style="font-size:12px">ответов за неделю</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="big" data-count="19" data-suffix="">0</div>
        <div class="lead" style="font-size:12px">новых гайдов</div>
      </div>


  </section>

</main>

  <section class="page" id="consult">
    <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>
    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
    <div class="grid grid-2">
      <div class="card reveal">
        <h3>Выберите формат</h3>
        <div class="cta">
          <button class="btn btn-primary consult-type" data-type="call">📞 Звонок</button>
          <button class="btn btn-ghost consult-type" data-type="zoom">💻 Zoom</button>
          <button class="btn btn-ghost consult-type" data-type="office">🏢 Офис</button>
        </div>
        <div class="highlight-banner" id="tzInfo">Часовой пояс: …</div>
        <div class="savings">
      </div>
    </div>          
<div class="card" style="background:rgba(255,255,255,.04)">
  <div class="h1" style="font-size:18px;margin:0 0 8px">Календарь</div>
  <div id="cal" class="calendar"></div>
</div>
<div class="cta" style="margin-top:10px">
  <span class="badge-pill">Выберете длительность консультации:</span>
  <button class="btn btn-primary dur" data-min="30">30 мин</button>
  <button class="btn btn-ghost dur" data-min="60">60 мин</button>
  <button class="btn btn-ghost dur" data-min="90">90 мин</button>
</div>
<div style="margin-top:10px">Свободные слоты:<div id="slots" class="cta" style="margin-top:8px"></div></div>
</div>
          <div class="row">
            <label>:</label>
            <input id="contact" placeholder="@username или +7…"
              style="padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); color:#fff">
          </div>
          <div class="cta">
            <button class="btn btn-primary" id="confirmConsult">Подтвердить</button>
            <a class="btn btn-ghost" id="icsBtn" download="consult.ics" style="display:none">Добавить в календарь</a>
          </div>
        </div>
      </div>
      <div class="card reveal">
        <h3>Как проходит консультация</h3>
        <ul class="list">
          <li><span class="dot"></span>15–20 минут диагностика задач</li>
          <li><span class="dot"></span>Разбор цифр и быстрых гипотез</li>
          <li><span class="dot"></span>Фиксация плана на 1–2 недели</li>
        </ul>
        <div class="highlight-banner">Если не получите пользу — вернём деньги за первую сессию</div>
      </div>
    </div>
  </section>

  <section class="page" id="invite">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
    <div class="grid grid-2">
      <div class="card reveal">
        <h3>Твоя реферальная ссылка</h3>
        <div class="cta">
          <input id="refLink" readonly style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); color:#fff">
          <button class="btn btn-primary" id="copyRef">Скопировать</button>
          <button class="btn btn-ghost" id="shareRef">Поделиться</button>
        </div>
        <div class="highlight-banner">За каждого активного друга — бонусы и приоритетные ответы</div>
        <div class="cta"><button class="btn btn-ghost" id="simulateRef">+1 приглашение (демо)</button></div>
      </div>
      <div class="card reveal">
        <h3>Таблица лидеров</h3>
        <div id="leaders" class="list"></div>
        <div class="cta" style="margin-top:10px">
          <button class="btn btn-primary" id="resetBoard">Сбросить демо‑данные</button>
        </div>
      </div>
    </div>
  </section>

<footer>© 2025 • Информационный сервис. Не является налоговой консультацией.</footer>

<!-- Onboarding -->
<div class="onb" id="onb">
  <div class="box">
    <div class="h1" style="font-size:19px">Добро пожаловать! 👋</div>
    <div class="steps">
      <div class="step"><div class="num">1</div><div>Нажмите <b>📊 Калькулятор</b> — за 5 минут увидите, где экономия.</div></div>
      <div class="step"><div class="num">2</div><div>Откройте <b>Услуги</b> — там быстрые шаги по регистрации и аудиту.</div></div>
      <div class="step"><div class="num">3</div><div>Нажмите на кнопки — появятся подсказки и тосты с советами.</div></div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" id="onbLater">Позже</button>
      <button class="btn btn-primary" id="onbGo">Погнали</button>
    </div>
  </div>
</div>

<!-- Toasts & Console -->
<div class="toasts" id="toasts"></div>
<button class="btn btn-ghost console-toggle">🔧</button>
<div class="console-panel" id="consolePanel"></div>

<script>

// === Globals & safe helpers ===
window.ALLOW_DRAG = (function(){ try { return matchMedia('(pointer: coarse)').matches; } catch(e){ return false; } })();
function fmtRUR(n){ return (n||0).toLocaleString('ru-RU') + ' ₽'; }


// === v14 Router helpers ===
function __pickInitialPage(){
  const url = new URL(location.href);
  let page = (url.searchParams.get('page')||'').trim();
  if(!page && location.hash) page = location.hash.replace('#','').trim();
  if(!page){
    page = (url.searchParams.get('tgWebAppStartParam')||url.searchParams.get('startapp')||url.searchParams.get('start_param')||'').trim();
  }
  if(!page || !document.getElementById(page)) page = 'home';
  return page;
}
function __updateURL(page){
  try{
    const u = new URL(location.href);
    u.searchParams.set('page', page);
    history.replaceState(null, '', u.pathname + u.search + '#' + page);
  }catch(e){ location.hash = page; }
}

// ===== In-page console =====
(function(){
  const panel = document.getElementById('consolePanel');
  const btn = document.querySelector('.console-toggle');
  const write = (type, args)=>{
    const line = document.createElement('div');
    const ts = new Date().toLocaleTimeString();
    line.className='line';
    line.innerHTML = '<span class="time">'+ts+'</span><span class="event">['+type+'] '+Array.from(args).map(a=>typeof a==='object'?JSON.stringify(a):a).join(' ')+'</span>';
    panel.appendChild(line);
    panel.scrollTop = panel.scrollHeight;
  };
  ['log','warn','error'].forEach(fn=>{
    const native = console[fn].bind(console);
    console[fn] = function(){ write(fn, arguments); native.apply(console, arguments); };
  });
  btn.addEventListener('click', ()=>{
    panel.style.display = panel.style.display==='block' ? 'none' : 'block';
  });
  console.log('UI ready');
})();



// ===== Nav: robust clicks + drag threshold + keep carousel look =====
(function(){
  const nav = document.getElementById('spa-nav');
  const track = nav.querySelector('.track');
  const pages = document.querySelectorAll('section.page');

  // Expose showPage
  window.__showPage = function(id){
    pages.forEach(p=>p.classList.toggle('active', p.id===id));
    track.querySelectorAll('[data-page]').forEach(el=>el.classList.toggle('active', el.getAttribute('data-page')===id));
    if (window.__centerNavActive) window.__centerNavActive();
    console.log('page_view', {page:id});
  };

  // Delegate clicks (desktop-safe), prevent ghost clicks after drag
  let dragged = false;
  track.addEventListener('click', (e)=>{
    if (dragged) { dragged = false; return; }
    const a = e.target.closest('[data-page]');
    if(!a) return;
    e.preventDefault();
    __showPage(a.getAttribute('data-page')); __updateURL(a.getAttribute('data-page'));
    history.replaceState(null,'','#'+a.getAttribute('data-page'));
  });

  // Drag scroll with threshold
  let isDown=false, sx=0, sl=0;
  track.addEventListener('pointerdown', (e)=>{ if (!ALLOW_DRAG) return;
    isDown=true; dragged=false; sx=e.clientX; sl = track.scrollLeft; track.setPointerCapture(e.pointerId);
  });
  track.addEventListener('pointermove', (e)=>{ if (!ALLOW_DRAG) return;
    if(!isDown) return;
    const dx = e.clientX - sx;
    if (Math.abs(dx) > 6) dragged = true;
    track.scrollLeft = sl - dx;
  });
  track.addEventListener('pointerup', ()=>{ isDown=false; });

  // Keyboard support
  track.querySelectorAll('[data-page]').forEach(a=>{
    a.setAttribute('tabindex','0');
    a.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        __showPage(a.getAttribute('data-page')); __updateURL(a.getAttribute('data-page'));
      }
    });
  });

  const initial = (window.__pickInitialPage ? __pickInitialPage() : (location.hash||'#home').replace('#','')||'home'); __showPage(initial);
__updateURL(initial);
})();


// ===== Nav bubble & carousel logic =====
(function(){
  const nav = document.getElementById('spa-nav');
  const track = nav.querySelector('.track');
  const links = [...track.querySelectorAll('[data-page]')];
  const bubble = track.querySelector('.bubble');
  
  const ALLOW_DRAG = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
function moveBubble(){
    const a = track.querySelector('.btn.active') || links[0];
    if(!a) return;
    const r = a.getBoundingClientRect();
    const nr = track.getBoundingClientRect();
    bubble.style.left = (a.offsetLeft - track.scrollLeft + 6) + 'px';
    bubble.style.width = r.width + 'px';
  }
  function centerActive(){
    const a = track.querySelector('.btn.active'); if(!a) return;
    a.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    setTimeout(moveBubble, 220);
  }
  window.__centerNavActive = centerActive;
  // delegated clicks + drag threshold
  let isDown=false, sx=0, sl=0, moved=false;
  track.addEventListener('pointerdown', (e)=>{ if (!ALLOW_DRAG) return;isDown=true;moved=false;sx=e.clientX;sl = track.scrollLeft;track.setPointerCapture(e.pointerId)});
  track.addEventListener('pointermove', (e)=>{ if (!ALLOW_DRAG) return; if(!isDown) return; const dx=e.clientX-sx; if(Math.abs(dx)>6) moved=true; track.scrollLeft = sl-dx; moveBubble();});
  track.addEventListener('pointerup', ()=>{isDown=false});
  track.addEventListener('click', (e)=>{ if (ALLOW_DRAG && moved) { moved=false; return; } const a=e.target.closest('[data-page]'); if(!a) return; e.preventDefault(); show(a.getAttribute('data-page')); history.replaceState(null,'','#'+a.getAttribute('data-page')); });
  track.addEventListener('scroll', ()=>{ // update scaling + bubble on scroll
    requestAnimationFrame(()=>{ scaleItems(); moveBubble(); });
  }, {passive:true});
  window.addEventListener('resize', ()=>{ scaleItems(); moveBubble(); });
  // scaling like before
  function scaleItems(){
    const rect = nav.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    links.forEach(a=>{
      const r = a.getBoundingClientRect();
      const ax = r.left + r.width/2;
      const d = Math.abs(ax - cx);
      const k = Math.max(0.9, 1.0 - d / (rect.width*0.9));
      a.style.transform = `scale(${k.toFixed(3)})`;
      a.style.opacity = String(0.65 + (k-0.9)*2.4);
    });
  }
  // expose show (reusing old one if exists)
  window.show = window.show || function(id){
    document.querySelectorAll('section.page').forEach(p=>p.classList.toggle('active', p.id===id));
    links.forEach(el=>el.classList.toggle('active', el.getAttribute('data-page')===id));
    centerActive();
    console.log('page_view', {page:id});
  };
  const initial = (window.__pickInitialPage ? __pickInitialPage() : (location.hash||'#home').replace('#','')||'home'); show(initial);
__updateURL(initial);
setTimeout(()=>{ scaleItems(); moveBubble(); }, 60);
})();

// ===== Background particles (canvas) =====
(function(){
  const c = document.getElementById('bg-canvas');
  const ctx = c.getContext('2d');
  let w, h, particles;
  function resize(){
    w = c.width = innerWidth; h = c.height = innerHeight;
    particles = Array.from({length: Math.min(120, Math.floor(w*h/16000))}, ()=>({
      x: Math.random()*w, y: Math.random()*h,
      r: Math.random()*2 + 0.5,
      vx: (Math.random()-.5)*0.4,
      vy: (Math.random()-.5)*0.4,
      a: Math.random()
    }));
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for (const p of particles){
      p.x += p.vx; p.y += p.vy;
      if (p.x<0||p.x>w) p.vx*=-1;
      if (p.y<0||p.y>h) p.vy*=-1;
      ctx.globalAlpha = 0.5 + 0.5*Math.sin(p.a+=0.02);
      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*4);
      g.addColorStop(0,'rgba(61,224,197,.35)');
      g.addColorStop(1,'rgba(123,91,255,0)');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r*4,0,Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  addEventListener('resize', resize, {passive:true});
  resize(); tick();
  console.log('particles:init');
})();

// ===== Scroll reveal =====
(function(){
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if (e.isIntersecting) { e.target.classList.add('visible'); obs.unobserve(e.target); } });
  }, {threshold: 0.12});
  document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
})();

// ===== Magnetic buttons =====
(function(){
  const strength = 22;
  document.querySelectorAll('.magnetic').forEach(btn=>{
    btn.addEventListener('mousemove', e=>{
      const r = btn.getBoundingClientRect();
      const x = e.clientX - (r.left + r.width/2);
      const y = e.clientY - (r.top + r.height/2);
      btn.style.transform = `translate(${x/strength}px, ${y/strength}px)`;
    });
    btn.addEventListener('mouseleave', ()=> btn.style.transform = '');
  });
})();

// === Bonuses: spin wheel (single & deduped) ===
(function(){
  const section = document.getElementById('bonuses'); if (!section) return;
  const btn0 = section.querySelector('#spin');
  const out  = section.querySelector('#spinRes');
  if (!btn0 || !out) return;

  // 1) Жёстко снимаем ВСЕ старые слушатели с кнопки
  const btn = btn0.cloneNode(true);
  btn0.replaceWith(btn);

  // 2) Синглтон-анонс приза (не даст показать тост дважды)
  const announcePrize = (() => {
    let locked = false, timer;
    return (text) => {
      if (locked) return;
      locked = true;
      try { showToast('Поздравляю!', text); } catch(e){}
      clearTimeout(timer);
      timer = setTimeout(() => { locked = false; }, 1500);
    };
  })();

  // 3) Само вращение
  const prizes = [
    '🎁 Шаблон «Оффер»',
    '📘 Чек-лист аудита',
    '💬 +30 мин консультации',
    '🧮 Доступ к калькулятору PRO',
    '⭐ Приоритетный разбор'
  ];

  let busy = false;
  btn.addEventListener('click', () => {
    if (busy) return;
    busy = true;
    out.textContent = 'Крутим…';

    const total = 1800 + Math.floor(Math.random() * 900);
    const t0 = performance.now();

    const tick = (t) => {
      if (t - t0 >= total) {
        const win = prizes[Math.floor(Math.random() * prizes.length)];
        out.textContent = 'Выпало: ' + win;
        announcePrize(win);       // ← тост гарантированно один раз
        busy = false;
        return;
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  });
})();

// ===== Tilt cards =====
(function(){
  const max = 10;
  document.querySelectorAll('.tilt').forEach(card=>{
    card.addEventListener('mousemove', e=>{
      const r = card.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width - 0.5;
      const py = (e.clientY - r.top) / r.height - 0.5;
      card.style.transform = `rotateY(${px*max}deg) rotateX(${ -py*max}deg) translateY(-6px)`;
    });
    card.addEventListener('mouseleave', ()=> card.style.transform = '');
  });
})();

// ===== Ripple + Confetti =====
(function(){
  // ripple
  document.body.addEventListener('click', function(e){
    const t = e.target.closest('.btn');
    if(!t) return;
    const r = document.createElement('span');
    const size = Math.max(t.clientWidth, t.clientHeight);
    const rect = t.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    r.style.cssText = `position:absolute; left:0; top:0; width:${size}px; height:${size}px; border-radius:50%;
      transform:translate(${x - size/2}px, ${y - size/2}px);
      background:rgba(255,255,255,.25); pointer-events:none; animation:ripple .6s ease-out`;
    t.appendChild(r); setTimeout(()=>r.remove(), 600);
  });
  const style = document.createElement('style');
  style.textContent = `@keyframes ripple{from{transform:scale(.2);opacity:.7}to{transform:scale(1.8);opacity:0}}`;
  document.head.appendChild(style);

  // confetti
  document.querySelectorAll('.confetti').forEach(btn=>btn.addEventListener('click', (e)=>{
    e.preventDefault();
    runConfetti(e.clientX, e.clientY);
    showToast('Готово!', 'Отправим чек‑лист и заявку в течение дня.');
  }));
  function runConfetti(x,y){
    const c = document.createElement('canvas');
    c.width = innerWidth; c.height = innerHeight;
    Object.assign(c.style,{position:'fixed',left:0,top:0,pointerEvents:'none',zIndex:999});
    document.body.appendChild(c);
    const ctx = c.getContext('2d');
    const N = 140, P = [];
    for(let i=0;i<N;i++){
      P.push({
        x, y, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2,
        g:0.2+Math.random()*0.2, s:4+Math.random()*5, r:Math.random()*Math.PI,
        col: `hsl(${Math.random()*360},90%,60%)`
      });
    }
    let t = 0;
    (function tick(){
      ctx.clearRect(0,0,c.width,c.height);
      P.forEach(p=>{
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.r += 0.08;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle = p.col; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
        ctx.restore();
      });
      t++; if (t<180) requestAnimationFrame(tick); else c.remove();
    })();
  }
})();

// ===== Toasts =====
function showToast(title, msg, timeout=3500){
  const box = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = `<div class="t">${title}</div><div class="m">${msg||''}</div>`;
  box.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-6px)'; }, timeout);
  setTimeout(()=> t.remove(), timeout+600);
}
document.querySelectorAll('.toast-btn').forEach(b=>b.addEventListener('click',()=>showToast('Заявка', b.dataset.msg)));


// === Community: counters & ring progress ===
(function(){
  const host = document.getElementById('community'); if(!host) return;
  host.querySelectorAll('.big[data-count]').forEach(el=>{
    const target = parseInt(el.getAttribute('data-count'),10)||0;
    const suffix = el.getAttribute('data-suffix')||'';
    let cur = 0;
    const step = Math.max(1, Math.round(target/50));
    const tick = ()=>{
      cur = Math.min(target, cur+step);
      el.textContent = cur.toLocaleString('ru-RU') + suffix;
      if(cur < target) requestAnimationFrame(tick);
    };
    tick();
  });
  const ring = host.querySelector('#ring');
  const txt  = host.querySelector('#ringText');
  if(ring && txt){
    const full = 327;
    let val = 0, target = 62;
    const anim = ()=>{
      val = Math.min(target, val+2);
      ring.style.strokeDashoffset = String(full - full*val/100);
      txt.textContent = val + '%';
      if(val < target) requestAnimationFrame(anim);
    };
    anim();
  }
})();

// ===== KPI counters (animated) =====
(function(){
  const k1 = document.getElementById('k1');
  const k2 = document.getElementById('k2');
  let v1=0, v2=0;
  function step(){
    v1 = Math.min(35, v1 + 1);
    v2 = Math.min(1500000, v2 + Math.round(50000*Math.random()+20000));
    k1.textContent = `+${v1}%`;
    k2.textContent = v2.toLocaleString('ru-RU') + ' ₽';
    if (v1<35 || v2<1500000) requestAnimationFrame(step);
  }
  step();
})();


// === Services tariff toggle (Месяц/Год −15%) ===
(function(){
  const box = document.getElementById('services'); if(!box) return;
  const btns = box.querySelectorAll('.svcMode');
  const cards = box.querySelectorAll('.card.price[data-base]');
  if(!btns.length || !cards.length) return;
  let mode = 'month';
  function apply(){
    cards.forEach(c=>{
      const base = parseInt(c.getAttribute('data-base'),10) || 0;
      const priceNode = c.querySelector('[data-price]');
      if(!priceNode) return;
      if(mode==='month'){
        priceNode.textContent = fmtRUR(base);
      }else{
        const y = Math.round(base*12*0.85);
        priceNode.textContent = fmtRUR(y) + ' / 12 мес.';
      }
    });
    btns.forEach(b=>{
      const is = b.getAttribute('data-mode') === mode;
      b.classList.toggle('btn-primary', is);
      b.classList.toggle('btn-ghost', !is);
      b.setAttribute('aria-pressed', is ? 'true' : 'false');
    });
  }
  btns.forEach(b=> b.addEventListener('click', ()=>{ mode = b.getAttribute('data-mode'); apply(); }));
  apply();
})();

// ===== Savings widget logic =====
(function(){
  const rev = document.getElementById('rev');
  const pct = document.getElementById('pct');
  const revVal = document.getElementById('revVal');
  const pctVal = document.getElementById('pctVal');
  const oldTax = document.getElementById('oldTax');
  const newTax = document.getElementById('newTax');
  const saveCounter = document.getElementById('saveCounter');

  function fmt(n){ return n.toLocaleString('ru-RU') + ' ₽'; }
  function animateTo(el, target){
    const start = parseInt((el.textContent||'0').replace(/[^\d]/g,''))||0;
    const dur = 600; const t0 = performance.now();
    function tick(t){
      const k = Math.min(1, (t-t0)/dur);
      const val = Math.round(start + (target-start)*k);
      el.textContent = fmt(val);
      if(k<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }
  function recalc(){
    const R = +rev.value; const P = +pct.value/100;
    revVal.textContent = R.toLocaleString('ru-RU')+' ₽';
    pctVal.textContent = Math.round(P*100)+'%';
    // простая модель: "старые налоги" = 15% от выручки, "новые" = 15%*(1-P)
    const oldT = Math.round(R*0.15);
    const newT = Math.round(oldT*(1-P));
    const save = oldT - newT;
    oldTax.textContent = fmt(oldT);
    newTax.textContent = fmt(newT);
    animateTo(saveCounter, save);
  }
  rev.addEventListener('input', recalc);
  pct.addEventListener('input', recalc);
  recalc();
  document.getElementById('ctaCalc').addEventListener('click', ()=>showToast('Расчёт отправлен', 'Мы уточним детали и вернёмся с рекомендацией.'));
})();



// === Consultation: format + duration + slots ===
(function(){
  const scope = document.getElementById('consult'); if(!scope) return;
  const types = scope.querySelectorAll('.consult-type');
  let ctype = 'call';
  types.forEach(b=> b.addEventListener('click', ()=>{
    ctype = b.getAttribute('data-type');
    types.forEach(x=>{
      const on = x===b;
      x.classList.toggle('btn-primary', on);
      x.classList.toggle('btn-ghost', !on);
    });
  }));
  const durs = scope.querySelectorAll('.dur');
  let dmin = 30;
  function markDur(btn){
    durs.forEach(x=>{
      const on = x===btn;
      x.classList.toggle('btn-primary', on);
      x.classList.toggle('btn-ghost', !on);
    });
  }
  durs.forEach(b=> b.addEventListener('click', ()=>{ dmin = +b.getAttribute('data-min'); markDur(b); renderSlots(); }));
  const def = scope.querySelector('.dur[data-min="30"]'); if(def){ markDur(def); }
  const slotsEl = scope.querySelector('#slots');
  const calendar = scope.querySelector('.calendar, #cal, .date-grid, .days');
  function showSlots(){ if(slotsEl) slotsEl.classList.add('show'); }
  if(calendar){
    calendar.addEventListener('click', (e)=>{
      const day = e.target.closest('button, .cal-cell, .day');
      if(!day) return;
      calendar.querySelectorAll('.selected,.sel').forEach(x=>x.classList.remove('selected','sel'));
      day.classList.add('selected'); day.classList.add('sel');
      showSlots(); renderSlots();
    });
  } else {
    durs.forEach(b=> b.addEventListener('click', ()=>{ showSlots(); renderSlots(); }));
  }

  function renderSlots(){
    if(!slotsEl) return;
    slotsEl.innerHTML = '';
    const start = 10, end = 18;
    for(let h=start; h<=end; h++){
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.textContent = String(h).padStart(2,'0') + ':00 (' + dmin + ' мин)';
      btn.addEventListener('click', ()=>{
        slotsEl.querySelectorAll('.btn').forEach(x=>x.classList.remove('btn-primary'));
        btn.classList.add('btn-primary'); btn.classList.remove('btn-ghost');
        scope._selTime = btn.textContent;
      });
      slotsEl.appendChild(btn);
    }
  }
  /* render later after date is chosen */
})();

// ===== Consultation: calendar + slots =====
(function(){
  const calEl = document.getElementById('cal');
  if(!calEl) return;
  const slotsEl = document.getElementById('slots');
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  document.getElementById('tzInfo').textContent = 'Часовой пояс: ' + tz;

  let selDate = null;
  function buildCalendar(monthOffset=0){
    const today = new Date();
    const base = new Date(today.getFullYear(), today.getMonth()+monthOffset, 1);
    const year = base.getFullYear(), month = base.getMonth();
    const start = new Date(year, month, 1);
    const startDay = (start.getDay()+6)%7; // 0=Mon
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const daysPrev = new Date(year, month, 0).getDate();
    // header
    calEl.innerHTML = '<div class="cal-head"><button class="btn btn-ghost" id="prevM">←</button><div class="mon">'+base.toLocaleString("ru-RU",{month:"long", year:"numeric"})+'</div><button class="btn btn-ghost" id="nextM">→</button></div>';
    // weekdays
    const grid = document.createElement('div'); grid.className='cal-grid';
    ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].forEach(d=>{
      const c = document.createElement('div'); c.className='cal-dow'; c.textContent=d; grid.appendChild(c);
    });
    // prev month days
    for(let i=startDay-1; i>=0; i--){
      const n = daysPrev - i;
      const c = document.createElement('div'); c.className='cal-cell muted'; c.textContent=n; grid.appendChild(c);
    }
    // current month
    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(year, month, d);
      const c = document.createElement('div'); c.className='cal-cell'; c.textContent=d;
      if(date < new Date(today.getFullYear(), today.getMonth(), today.getDate())){ c.classList.add('off'); }
      c.onclick = ()=>{ selDate = date; grid.querySelectorAll('.cal-cell').forEach(x=>x.classList.remove('sel')); c.classList.add('sel'); renderSlots(); };
      grid.appendChild(c);
    }
    // next fillers
    while(grid.children.length % 7 !== 0){
      const c = document.createElement('div'); c.className='cal-cell muted'; c.textContent=''; grid.appendChild(c);
    }
    calEl.appendChild(grid);
    // nav
    calEl.querySelector('#prevM').onclick = ()=> buildCalendar(monthOffset-1);
    calEl.querySelector('#nextM').onclick = ()=> buildCalendar(monthOffset+1);
  }

  function renderSlots(){
    slotsEl.innerHTML='';
    if(!selDate) return;
    const start=10, end=19; // 10-19
    for(let h=start; h<=end; h++){
      const t=String(h).padStart(2,'0')+':00';
      const b=document.createElement('button'); b.className='btn btn-ghost'; b.textContent=t;
      b.onclick=()=>{ slotsEl.querySelectorAll('.btn').forEach(x=>x.classList.remove('btn-primary')); b.classList.add('btn-primary'); saveSelection(t); };
      slotsEl.appendChild(b);
    }
  }

  function saveSelection(time){
    localStorage.setItem('consult_selected', JSON.stringify({date: selDate.toISOString().slice(0,10), time}));
    showToast('Слот выбран', new Date(selDate.getTime()).toLocaleDateString('ru-RU') + ' ' + time);
  }

  buildCalendar(0);
})();

// ===== Onboarding =====
(function(){
  const key='onb_seen_v1';
  const onb=document.getElementById('onb');
  if(!localStorage.getItem(key)){
    onb.style.display='grid';
  }
  document.getElementById('onbLater').onclick=()=>{ onb.style.display='none'; };
  document.getElementById('onbGo').onclick=()=>{ localStorage.setItem(key,'1'); onb.style.display='none'; showToast('Добро пожаловать!','Начните с калькулятора или откройте Услуги'); };
})();

// ===== Services flow stepper =====
(function(){
  let step = 0;
  const flow = document.getElementById('flow');
  const items = flow.querySelectorAll('.badge');
  function draw(){
    items.forEach((b,i)=>{
      b.style.background = i<=step ? 'linear-gradient(135deg, var(--primary), var(--mint))' : 'rgba(255,255,255,.04)';
      b.style.borderColor = i<=step ? 'transparent' : 'rgba(255,255,255,.14)';
      b.style.color = i<=step ? '#fff' : '';
    });
  }
  draw();
  document.getElementById('flowNext').onclick = ()=>{ step = Math.min(items.length-1, step+1); draw(); };
  document.getElementById('flowReset').onclick = ()=>{ step = 0; draw(); };
})();

// ===== FAQ copy buttons =====
document.querySelectorAll('.copy').forEach(b=>b.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(b.dataset.text); showToast('Скопировано', 'Текст в буфере обмена'); }catch(e){ showToast('Не удалось скопировать'); }
}));

// ===== FAQ mini search (client-side demo) =====
(function(){
  const base = [
    {q:'сколько времени займёт', a:'Экспресс‑аудит: 1–2 дня. Подбор режима — 5 минут.'},
    {q:'маркетплейсы', a:'Да, работаем с Ozon/WB: учитываем комиссии, логистику, возвраты.'},
    {q:'ндс', a:'Помогаем считать входной/исходящий НДС и эффективную ставку.'},
    {q:'усн', a:'Подскажем, когда выгоднее 6% vs 15% и как перейти.'},
  ];
  const input = document.getElementById('faqSearch');
  const out = document.getElementById('faqResult');
  document.getElementById('faqDoSearch').onclick = ()=>{
    const s = (input.value||'').toLowerCase();
    if(!s){ out.textContent = 'Введите запрос'; return; }
    const hit = base.find(i=>s.includes(i.q));
    out.textContent = hit ? hit.a : 'Ответ не найден. Напишите нам в боте — подскажем.';
  };
})();



// === Invite: ref link + demo leaderboard ===
(function(){
  const box = document.getElementById('invite'); if(!box) return;
  const ref = box.querySelector('#refLink');
  const leaders = box.querySelector('#leaders');
  if(ref){
    const uid = (localStorage.getItem('uid') || (Date.now().toString(36)+Math.random().toString(36).slice(2,8)));
    localStorage.setItem('uid', uid);
    const bot = 'pravuchet_bot';
    ref.value = 'https://t.me/'+bot+'?start=ref_'+uid;
  }
  function render(){
    if(!leaders) return;
    const me = {name:'Ты', invites: +(localStorage.getItem('ref_count')||0)};
    const demo = [{name:'@alice',invites:7},{name:'@bob',invites:5},{name:'@mike',invites:3}];
    const arr = [me, ...demo].sort((a,b)=>b.invites-a.invites);
    leaders.innerHTML = arr.map((u,i)=>`<div class="lb-row"><span>${i+1}. ${u.name}</span><span class="badge-pill">${u.invites}</span></div>`).join('');
  }
  render();
  const sim = box.querySelector('#simulateRef');
  if(sim) sim.addEventListener('click', ()=>{ const n=+(localStorage.getItem('ref_count')||0)+1; localStorage.setItem('ref_count', n); render(); });
  const copy = box.querySelector('#copyRef');
  if(copy && ref) copy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(ref.value); showToast('Скопировано','Ссылка в буфере'); }catch(e){} });
  const share = box.querySelector('#shareRef');
  if(share && ref) share.addEventListener('click', async ()=>{
    if(navigator.share){ try{ await navigator.share({title:'Сообщество', text:'Присоединяйся', url:ref.value}); }catch(e){} }
    else { try{ await navigator.clipboard.writeText(ref.value); showToast('Скопировано','Ссылка в буфере'); }catch(e){} }
  });
})();

// ===== Community quiz =====
(function(){
  const quiz = document.getElementById('quiz'); if(!quiz) return;
  let step = 0, score = 0;
  function next(){
    document.getElementById('q'+step).style.display='none';
    step++;
    if(step<=2){ document.getElementById('q'+step).style.display='block'; }
    else {
      const res = document.getElementById('quizResult');
      const txt = document.getElementById('quizText');
      let msg = 'Скорее всего выгоднее УСН 6% c контролем расходов.';
      if(score>=8) msg = 'Рассмотрите ОСНО: входной НДС и вычеты могут дать экономию.';
      else if(score>=6) msg = 'УСН 15% («доходы-расходы») выглядит перспективно.';
      else if(score>=4) msg = 'УСН 6% + оптимизация расходов/взносов даст быстрый эффект.';
      txt.textContent = msg + ' Точный ответ — в калькуляторе.';
      res.style.display='block';
    }
  }
  quiz.querySelectorAll('.quiz-option').forEach(b=>b.addEventListener('click', ()=>{ score += +b.dataset.score; next(); }));
  document.getElementById('quizReset').onclick = ()=>{
    score=0; step=0;
    ['q0','q1','q2'].forEach((id,i)=>document.getElementById(id).style.display = i? 'none':'block');
    document.getElementById('quizResult').style.display='none';
  };
})();

// ===== Poll (local demo) =====
(function(){
  const out = document.getElementById('pollResult'); if(!out) return;
  const state = {cashflow: 12, tax: 18, ops: 9};
  document.querySelectorAll('.poll').forEach(b=>b.addEventListener('click', ()=>{
    state[b.dataset.id]++;
    const sum = state.cashflow + state.tax + state.ops;
    const pct = k => Math.round(state[k]*100/sum);
    out.textContent = `Кассовые разрывы — ${pct('cashflow')}% · Налоги — ${pct('tax')}% · Операционка — ${pct('ops')}%`;
    showToast('Спасибо!', 'Твой голос учтён');
  }));
})();

// ===== Consultation booking =====
(function(){
  const types = document.querySelectorAll('.consult-type');
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  const tzInfo = document.getElementById('tzInfo');
  const datePick = document.getElementById('datePick');
  const dateOut = document.getElementById('dateOut');
  const slots = document.getElementById('slots');
  const contact = document.getElementById('contact');
  const confirmBtn = document.getElementById('confirmConsult');
  const icsBtn = document.getElementById('icsBtn');
  if(!tzInfo) return;

  tzInfo.textContent = 'Часовой пояс: ' + tz;
  let SEL = {type:'call', date:null, time:null};

  types.forEach(b=>b.addEventListener('click', ()=>{
    types.forEach(x=>x.classList.toggle('btn-primary', x===b));
    types.forEach(x=>x.classList.toggle('btn-ghost', x!==b));
    SEL.type = b.dataset.type;
  }));

  // default date = tomorrow
  const tomorrow = new Date(Date.now()+24*3600*1000);
  datePick.valueAsDate = tomorrow;
  dateOut.textContent = tomorrow.toLocaleDateString('ru-RU');
  renderSlots(tomorrow);

  datePick.addEventListener('change', ()=>{
    const d = datePick.valueAsDate;
    dateOut.textContent = d ? d.toLocaleDateString('ru-RU') : '—';
    renderSlots(d);
  });

  function renderSlots(d){
    slots.innerHTML = '';
    if(!d) return;
    const start = 10, end = 19; // 10:00-19:00 local
    for(let h=start; h<=end; h+=1){
      const t = String(h).padStart(2,'0') + ':00';
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.textContent = t;
      btn.onclick = ()=>{
        slots.querySelectorAll('.btn').forEach(b=>b.classList.remove('btn-primary'));
        btn.classList.add('btn-primary');
        SEL.date = new Date(d); SEL.time = t;
      };
      slots.appendChild(btn);
    }
  }

  function makeICS(dtStart, dtEnd, summary, desc){
    function pad(n){return String(n).padStart(2,'0');}
    const y = dtStart.getFullYear(), m = pad(dtStart.getMonth()+1), d=pad(dtStart.getDate());
    const sh=pad(dtStart.getHours()), sm=pad(dtStart.getMinutes());
    const y2 = dtEnd.getFullYear(), m2 = pad(dtEnd.getMonth()+1), d2=pad(dtEnd.getDate());
    const eh=pad(dtEnd.getHours()), em=pad(dtEnd.getMinutes());
    const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PravUchet//MiniApp//RU
BEGIN:VEVENT
DTSTART:${y}${m}${d}T${sh}${sm}00
DTEND:${y2}${m2}${d2}T${eh}${em}00
SUMMARY:${summary}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;
    return new Blob([ics], {type:'text/calendar'});
  }

  confirmBtn.addEventListener('click', ()=>{
    if(!SEL.time || !datePick.valueAsDate){ showToast('Заполните данные', 'Выберите дату и время'); return; }
    if(!contact.value){ showToast('Укажите контакт', 'Телеграм или телефон'); return; }
    const d = new Date(datePick.value); const [hh,mm]=SEL.time.split(':');
    d.setHours(+hh, +mm, 0, 0);
    const de = new Date(d.getTime()+60*60*1000);
    localStorage.setItem('consult_booking', JSON.stringify({type:SEL.type, at:d.toISOString(), contact:contact.value}));
    showToast('Заявка отправлена', 'Мы подтвердим время в течение дня.');
    // build ICS
    const blob = makeICS(d, de, 'Консультация — Правильный учёт', `Формат: ${SEL.type}; Контакт: ${contact.value}`);
    const url = URL.createObjectURL(blob);
    icsBtn.href = url; icsBtn.style.display='inline-flex';
  });
})();

// ===== Invite / Leaderboard =====
(function(){
  const linkEl = document.getElementById('refLink');
  const copyBtn = document.getElementById('copyRef');
  const shareBtn = document.getElementById('shareRef');
  const simBtn = document.getElementById('simulateRef');
  const leadersEl = document.getElementById('leaders');
  const resetBtn = document.getElementById('resetBoard');
  if(!linkEl) return;

  // Generate / load code
  let code = localStorage.getItem('ref_code');
  if(!code){ code = Math.random().toString(36).slice(2,8).toUpperCase(); localStorage.setItem('ref_code', code); }
  const base = (location.origin || '') + (location.pathname || '');
  const link = base + '?ref=' + code;
  linkEl.value = link;

  copyBtn.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(link); showToast('Скопировано', 'Отправь ссылку друзьям'); }catch(e){ showToast('Не удалось скопировать'); }
  };
  shareBtn.onclick = ()=>{
    if(navigator.share){ navigator.share({title:'Присоединяйся к Правильный учёт', url: link}).catch(()=>{}); }
    else { navigator.clipboard.writeText(link); showToast('Ссылка скопирована'); }
  };

  // Leaderboard demo data
  let board = JSON.parse(localStorage.getItem('ref_board')||'null') || [
    {name:'@alex', score:5},
    {name:'@maria', score:3},
    {name:'@ivan', score:2},
  ];
  const meName = '@you';
  const me = board.find(b=>b.name===meName) || (board.push({name:meName, score:0}), board[board.length-1]);

  function render(){
    leadersEl.innerHTML = '';
    const max = Math.max(...board.map(b=>b.score), 1);
    board.sort((a,b)=>b.score-a.score);
    board.forEach((b,i)=>{
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0">
        <div><strong>${i+1}.</strong> ${b.name}</div>
        <div>${b.score}</div>
      </div>
      <div class="bar"><span style="width:${Math.round(b.score*100/max)}%"></span></div>`;
      leadersEl.appendChild(item);
    });
    localStorage.setItem('ref_board', JSON.stringify(board));
  }
  render();

  // simulate +1 (demo)
  simBtn.onclick = ()=>{ me.score++; render(); showToast('+1 приглашение', 'Зачтено тебе в лидерборд'); };

  resetBtn.onclick = ()=>{ localStorage.removeItem('ref_board'); board = [{name:'@alex',score:5},{name:'@maria',score:3},{name:'@ivan',score:2},{name:meName,score:0}]; render(); };
})();


// ===== Invite: QR + weekly leaderboard =====
(function(){
  const linkEl = document.getElementById('refLink');
  if(!linkEl) return;
  const url = linkEl.value;
  // QR via api.qrserver.com (client-side fetch to IMG then draw to canvas)
  const canvas = document.getElementById('qrCanvas');
  if (canvas && url){
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>{
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      // center-fit
      const size = Math.min(canvas.width, canvas.height)-10;
      ctx.drawImage(img, (canvas.width-size)/2, (canvas.height-size)/2, size, size);
    };
    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(url);
  }
  const dl = document.getElementById('dlQR');
  if(dl && canvas){
    dl.onclick = ()=>{
      const a = document.createElement('a');
      a.download = 'invite_qr.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    };
  }

  // Weekly leaderboard
  const leadersWeek = document.getElementById('leadersWeek');
  const leadersAll = document.getElementById('leaders');
  const tabs = document.querySelectorAll('.lb-tab');
  function weekKey(){
    const d = new Date(); const onejan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    return 'ref_board_week_' + d.getFullYear() + '_' + week;
  }
  function renderList(el, list){
    el.innerHTML='';
    const max = Math.max(...list.map(x=>x.score),1);
    list.sort((a,b)=>b.score-a.score).forEach((b,i)=>{
      const item = document.createElement('div');
      item.className='lb-row';
      item.innerHTML = `<div><strong>${i+1}.</strong> ${b.name}</div><div>${b.score}</div>`;
      const bar = document.createElement('div'); bar.className='bar';
      const span = document.createElement('span'); span.style.width = Math.round(b.score*100/max)+'%';
      bar.appendChild(span);
      el.appendChild(item); el.appendChild(bar);
    });
  }
  function getBoardAll(){
    return JSON.parse(localStorage.getItem('ref_board')||'[]');
  }
  function getBoardWeek(){
    return JSON.parse(localStorage.getItem(weekKey())||'[]');
  }
  function setBoardWeek(arr){
    localStorage.setItem(weekKey(), JSON.stringify(arr));
  }
  // initial render
  renderList(leadersAll, getBoardAll());
  renderList(leadersWeek, getBoardWeek());
  tabs.forEach(t=>t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.toggle('btn-primary', x===t));
    tabs.forEach(x=>x.classList.toggle('btn-ghost', x!==t));
    if(t.dataset.mode==='week') { renderList(leadersWeek, getBoardWeek()); }
    else { renderList(leadersAll, getBoardAll()); }
  }));

  // Hook simulateRef to also update WEEK board
  const sim = document.getElementById('simulateRef');
  if(sim){
    sim.addEventListener('click', ()=>{
      // all-time already handled in previous logic; duplicate here for week
      let w = getBoardWeek();
      const me = '@you';
      const meItem = w.find(x=>x.name===me) || (w.push({name:me, score:0}), w[w.length-1]);
      meItem.score++;
      setBoardWeek(w);
      renderList(leadersWeek, getBoardWeek());
    });
  }
})();

// ===== Consultation: duration + busy slots + ICS duration =====
(function(){
  const durBtns = document.querySelectorAll('.dur');
  const slotsEl = document.getElementById('slots');
  const confirmBtn = document.getElementById('confirmConsult');
  const icsBtn = document.getElementById('icsBtn');
  if(!slotsEl || !confirmBtn) return;
  let duration = 30; // minutes
  let selDateISO = null, selTime = null;
  durBtns.forEach(b=>b.addEventListener('click', ()=>{
    durBtns.forEach(x=>x.classList.toggle('btn-primary', x===b));
    durBtns.forEach(x=>x.classList.toggle('btn-ghost', x!==b));
    duration = +b.dataset.min;
    if(selDateISO) renderSlots(new Date(selDateISO)); // refresh for duration
  }));

  // sample busy intervals (demo): today+2 at 12:00–14:00, every day 13:00 busy
  function busyFor(date){
    // returns array of [startHour, endHour) busy
    return [{s:13, e:14}];
  }

  function renderSlots(d){
    slotsEl.innerHTML='';
    selDateISO = d.toISOString().slice(0,10);
    const busy = busyFor(d);
    const start = 10, end = 19;
    function isBusy(hour){
      return busy.some(b=>hour>=b.s && hour<b.e);
    }
    for(let h=start; h<=end; h++){
      // if slot would overlap busy considering duration, mark off
      let blocked = false;
      for(let t=h; t<h + duration/60; t+=0.5){
        if(isBusy(Math.floor(t))) { blocked = true; break; }
      }
      const label = String(h).padStart(2,'0')+':00';
      const btn=document.createElement('button');
      btn.className='btn ' + (blocked? 'btn-ghost' : 'btn-ghost');
      btn.textContent = label + (blocked? ' ⛔' : '');
      if(blocked){ btn.disabled = true; btn.style.opacity='.5'; }
      btn.onclick=()=>{
        slotsEl.querySelectorAll('.btn').forEach(x=>x.classList.remove('btn-primary'));
        btn.classList.add('btn-primary'); selTime = label;
      };
      slotsEl.appendChild(btn);
    }
  }
  // expose hook from calendar when a date selected
  const prevSaveSelection = window.saveSelection;
  window.saveSelection = function(time){
    // Called by calendar in previous code; we override to support duration
    selTime = time;
  };

  // Rebind calendar selection handler to call renderSlots
  (function patchCalendar(){
    const cal = document.getElementById('cal');
    if(!cal) return;
    const observer = new MutationObserver(()=>{
      const cells = cal.querySelectorAll('.cal-cell:not(.muted):not(.off)');
      cells.forEach(c=>{
        c.addEventListener('click', ()=>{
          const yearMon = cal.querySelector('.mon').textContent; // not used for ISO; we'll read from class selection
          const cur = new Date(); // fallback
          // compute selected date from cells index (simple approach: rely on existing selection in original code)
          const sel = cal.querySelector('.cal-cell.sel');
          if(sel){
            const dnum = +sel.textContent;
            const title = cal.querySelector('.mon').textContent;
            const [monName, y] = title.split(' ');
            const months = ['январь','февраль','март','апрель','май','июнь','июль','август','сентябрь','октябрь','ноябрь','декабрь'];
            const mi = months.findIndex(m=>title.toLowerCase().includes(m));
            const date = new Date(+y, mi, dnum);
            renderSlots(date);
          }
        }, {once:true});
      });
    });
    observer.observe(cal, {childList:true, subtree:true});
  })();

  // Confirm with ICS duration
  confirmBtn.addEventListener('click', ()=>{
    if(!selDateISO || !selTime){ showToast('Выберите дату и время'); return; }
    const [h,m]=selTime.split(':').map(Number);
    const d = new Date(selDateISO + 'T00:00:00');
    d.setHours(h,m,0,0);
    const de = new Date(d.getTime()+duration*60000);
    const blob = new Blob([`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}00
DTEND:${de.getFullYear()}${String(de.getMonth()+1).padStart(2,'0')}${String(de.getDate()).padStart(2,'0')}T${String(de.getHours()).padStart(2,'0')}${String(de.getMinutes()).padStart(2,'0')}00
SUMMARY:Консультация — Правильный учёт
END:VEVENT
END:VCALENDAR`], {type:'text/calendar'});
    const url = URL.createObjectURL(blob);
    const a = document.getElementById('icsBtn');
    a.href = url; a.style.display='inline-flex';
    showToast('Бронь создана', `Продолжительность ${duration} мин`);
  });
})();

// ===== Community quests & mini-chat typing =====
(function(){
  // Quests
  const quests = document.querySelectorAll('.quest');
  const qBanner = document.getElementById('questState');
  let state = JSON.parse(localStorage.getItem('quests_state')||'{}');
  function redraw(){
    const done = Object.keys(state).filter(k=>state[k]).length;
    qBanner.textContent = `Прогресс: ${done}/3`;
    quests.forEach(q=>{
      q.classList.toggle('btn-primary', !!state[q.dataset.id]);
      q.classList.toggle('btn-ghost', !state[q.dataset.id]);
    });
  }
  quests.forEach(q=>q.addEventListener('click', ()=>{
    state[q.dataset.id] = !state[q.dataset.id];
    localStorage.setItem('quests_state', JSON.stringify(state));
    redraw();
    if(state[q.dataset.id]) showToast('Зачтено', 'Шаг выполнен');
  }));
  redraw();

  // Mini chat (demo)
  const box = document.getElementById('chatBox');
  const input = document.getElementById('chatInput');
  const send = document.getElementById('chatSend');
  const typing = document.getElementById('typing');
  const me = '@you';
  function addMsg(user, msg){
    const line = document.createElement('div');
    line.innerHTML = `<strong>${user}</strong>: ${msg}`;
    box.appendChild(line); box.scrollTop = box.scrollHeight;
  }
  send.addEventListener('click', ()=>{
    const t = input.value.trim(); if(!t) return;
    addMsg(me, t); input.value='';
    // fake "typing..." and reply
    typing.textContent = '@admin печатает…';
    setTimeout(()=>{ addMsg('@admin', 'Спасибо! Принято 👍'); typing.textContent=''; }, 1000 + Math.random()*1000);
  });
})();


// ===== Community stats: animated counters + ring =====
(function(){
  const counters = document.querySelectorAll('#community [data-count]');
  const ring = document.getElementById('ring');
  const ringText = document.getElementById('ringText');
  if(!counters.length || !ring) return;
  const length = 2*Math.PI*52; // stroke length used in SVG
  ring.style.strokeDasharray = String(length);
  ring.style.strokeDashoffset = String(length);
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(!e.isIntersecting) return;
      const el = e.target;
      const target = +el.dataset.count;
      const suffix = el.dataset.suffix || '';
      const t0 = performance.now(), dur = 900;
      function tick(t){
        const k = Math.min(1,(t-t0)/dur);
        const val = Math.round(target*k);
        el.textContent = val + suffix;
        if(k<1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
      obs.unobserve(el);
    });
  }, {threshold:.3});
  counters.forEach(el=>obs.observe(el));
  // Animate ring to a weekly progress (demo: 72% or from quests)
  let progress = 72;
  try {
    const qs = JSON.parse(localStorage.getItem('quests_state')||'{}');
    const done = Object.values(qs).filter(Boolean).length;
    progress = Math.round((done/3)*100) || progress;
  } catch(e){}
  const offset = length*(1 - progress/100);
  let cur = length;
  function ringTick(){
    cur -= (cur - offset) * 0.1;
    if (Math.abs(cur - offset) < 0.5) cur = offset;
    ring.style.strokeDashoffset = String(cur);
    ringText.textContent = Math.round((1 - cur/length)*100) + '%';
    if (cur !== offset) requestAnimationFrame(ringTick);
  }
  requestAnimationFrame(ringTick);
})();

</script>
<script>
// ===== NAV (desktop-safe): single source of truth =====
(function(){
  const nav   = document.getElementById('spa-nav');
  const track = nav.querySelector('.track');
  const links = [...track.querySelectorAll('[data-page]')];
  const bubble = track.querySelector('.bubble');
  
  const ALLOW_DRAG = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
const pages = document.querySelectorAll('section.page');

  function show(id){
    pages.forEach(p=>p.classList.toggle('active', p.id===id));
    links.forEach(a=>a.classList.toggle('active', a.dataset.page===id));
    centerActive();
    moveBubble();
    console.log('page_view', {page:id});
  }
  window.show = show;

  let dragging = false;
  track.addEventListener('click', (e)=>{
    if (dragging) { dragging = false; return; }
    const a = e.target.closest('[data-page]');
    if(!a) return;
    e.preventDefault();
    show(a.dataset.page);
    __updateURL(a.dataset.page);
  });

  let isDown=false, sx=0, sl=0;
  track.addEventListener('pointerdown', (e)=>{ if (!ALLOW_DRAG) return;
    isDown = true; dragging = false; sx = e.clientX; sl = track.scrollLeft; track.setPointerCapture(e.pointerId);
  });
  track.addEventListener('pointermove', (e)=>{ if (!ALLOW_DRAG) return;
    if(!isDown) return;
    const dx = e.clientX - sx;
    if(Math.abs(dx) > 6) dragging = true;
    track.scrollLeft = sl - dx;
    moveBubble();
  });
  track.addEventListener('pointerup', ()=>{ isDown=false; });

  links.forEach(a=>{
    a.setAttribute('tabindex','0');
    a.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); show(a.dataset.page); __updateURL(a.dataset.page); }
    });
  });

  function moveBubble(){
    const a = track.querySelector('.btn.active') || links[0];
    if(!a) return;
    bubble.style.left  = (a.offsetLeft - track.scrollLeft + 6) + 'px';
    bubble.style.width = a.getBoundingClientRect().width + 'px';
  }

  function centerActive(){
    const a = track.querySelector('.btn.active');
    if(!a) return;
    a.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }

  function scaleItems(){
    const rect = track.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    links.forEach(a=>{
      const r = a.getBoundingClientRect();
      const ax = r.left + r.width/2;
      const d = Math.abs(ax - cx);
      const k = Math.max(0.9, 1.0 - d / (rect.width*0.9));
      a.style.transform = `scale(${k.toFixed(3)})`;
      a.style.opacity = String(0.65 + (k-0.9)*2.4);
    });
  }

  track.addEventListener('scroll', ()=>{ requestAnimationFrame(()=>{ scaleItems(); moveBubble(); }); }, {passive:true});
  window.addEventListener('resize', ()=>{ scaleItems(); moveBubble(); });

  const initial = (location.hash||'#home').slice(1);
  show(initial || 'home');
  setTimeout(()=>{ scaleItems(); moveBubble(); }, 60);
})();
</script>
</body>
</html>
