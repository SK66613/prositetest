<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';
        script-src 'self' https://script.google.com https://*.googleusercontent.com https://*.googleapis.com 'unsafe-inline' 'unsafe-eval';
        connect-src 'self' https://script.google.com https://*.googleusercontent.com https://*.googleapis.com data: blob:;
        img-src 'self' https: data: blob:;
        media-src 'self' https: data: blob:;
        font-src 'self' https: data:;
        frame-src https: telegram.org *.telegram.org https://*.googleusercontent.com;
      ">
  <title>Правильный Учёт — Мини‑приложение (pro)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c15; --text:#f4f6fa; --muted:#a7acc2;
      --primary:#7b5bff; --mint:#3de0c5; --blue:#5b8cff;
      --card:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.10);
      --toast:#0f1221;
    
  --nav-active-pad-extra: 6px;}
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);overflow-x:hidden}
    .container{max-width:1080px;margin:0 auto;padding:16px 16px 24px}
    header.container{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px}
    .brand-wrap{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;position:relative;overflow:hidden}
    .logo::before{content:"";position:absolute;inset:-30%;background:
      radial-gradient(120px 120px at 30% 30%, var(--mint), transparent 60%),
      radial-gradient(160px 160px at 80% 80%, var(--primary), transparent 60%);
      filter:blur(.2px);
    }
    .brand{font-family:'Montserrat',sans-serif;font-weight:800;font-size:20px;letter-spacing:.4px}
    .slogan{font-size:13px;color:var(--mint)}

    /* Background canvas */
    #bg-canvas{position:fixed;inset:0;z-index:-1}

    /* nav capsule */
    #spa-nav{position:sticky;top:0;z-index:10;display:flex;gap:8px;overflow:visible;
      padding:8px;margin:8px 0 18px;background:rgba(10,12,22,.6);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);
      white-space:nowrap;
    }
    #spa-nav .btn{appearance:none;border:1px solid transparent;background:transparent;color:var(--text);
      font-weight:600;font-size:14px;padding:9px 12px;border-radius:12px;cursor:pointer;text-decoration:none;transition:.18s;
      white-space:nowrap;position:relative;overflow:hidden;flex:0 0 auto;max-width:160px;text-overflow:ellipsis;
    }
    #spa-nav .btn:hover{background:rgba(255,255,255,.08)}
    #spa-nav .btn.active{background:linear-gradient(135deg,var(--primary),var(--blue));color:#fff;box-shadow:0 10px 22px rgba(91,140,255,.35);max-width:none}

    .h1{font-size:19px;line-height:1.2;font-weight:800;margin:14px 0 10px}
    .h1 span{background:linear-gradient(90deg,var(--primary),var(--mint));-webkit-background-clip:text;color:transparent}
    .lead{color:var(--muted);font-size:17px;max-width:820px}

    .grid{display:grid;gap:14px}
    @media(min-width:920px){.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}.h1{font-size:56px}}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:20px;padding:18px;backdrop-filter:blur(8px);
      transition:transform .2s ease, box-shadow .2s ease; will-change: transform}
    .card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(0,0,0,.4)}
    .card h3{margin:0 0 8px;font-size:18px}

    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px;color:var(--muted)}
    .list li{display:flex;gap:10px;align-items:flex-start}
    .dot{width:10px;height:10px;border-radius:50%;margin-top:6px;background:linear-gradient(135deg,var(--mint),var(--primary))}

    .cta{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
    .btn{appearance:none;border:none;border-radius:14px;padding:10px 12px;font-weight:700;font-size:12px;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;text-decoration:none;transition:.18s;position:relative;overflow:hidden}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--blue));color:#fff;box-shadow:0 10px 26px rgba(91,140,255,.32)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}

    .highlight-banner{margin:18px 0;padding:16px 18px;border-radius:16px;
      background:linear-gradient(135deg,rgba(61,224,197,.14),rgba(123,91,255,.14));
      color:var(--mint);font-weight:600;font-size:15px;text-align:center}
    .highlight-banner strong{color:#fff}

    /* KPI marquee */
    .kpi-strip{margin:14px 0 0;overflow:hidden;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
    .kpi-track{display:flex;gap:22px;padding:10px 12px;animation:marquee 20s linear infinite;will-change:transform}
    .kpi{display:flex;align-items:center;gap:8px;white-space:nowrap;font-weight:600}
    .kpi .v{font-weight:800;color:#fff}
    @keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}

    /* Savings widget */
    .savings{display:grid;gap:12px}
    .savings .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px}
    .savings input[type=range]{width:100%}
    .savings .stat{display:flex;gap:10px;flex-wrap:wrap}
    .badge{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);font-weight:700}
    .big{font-size:18px;font-weight:800}

    /* Toasts */
    .toasts{position:fixed;right:14px;top:14px;display:flex;flex-direction:column;gap:8px;z-index:1000}
    .toast{background:var(--toast);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;box-shadow:0 12px 26px rgba(0,0,0,.4);min-width:240px}
    .toast .t{font-weight:700}
    .toast .m{color:var(--muted);font-size:13px}

    /* Onboarding */
    .onb{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1200}
    .onb .box{width:min(560px,92vw);background:#0f1221;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
    .onb .steps{display:grid;gap:10px;margin:12px 0}
    .onb .steps .step{display:flex;gap:10px;align-items:flex-start}
    .onb .steps .num{width:24px;height:24px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--mint));display:grid;place-items:center;font-weight:800}
    .onb .actions{display:flex;gap:8px;justify-content:flex-end}

    footer{text-align:center;padding:36px 0 48px;color:var(--muted);font-size:13px}
    section.page{display:none;scroll-margin-top:70px}
    section.page.active{display:block}

    /* reveal animations */
    .reveal{opacity:0;transform:translateY(14px);transition:opacity .5s ease, transform .5s ease}
    .reveal.visible{opacity:1;transform:none}

    /* Console overlay */
    .console-toggle{position:fixed;right:14px;bottom:14px;z-index:1000}
    .console-panel{position:fixed;right:14px;bottom:56px;width:360px;max-height:45vh;background:rgba(15,18,33,.9);
      border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;overflow:auto;font:12px/1.4 monospace;color:#b9d3ff;display:none;z-index:1000}
    .console-panel .line{white-space:pre-wrap;border-bottom:1px dashed rgba(255,255,255,.06);padding:3px 0}
    .console-panel .time{color:#7bffcb;margin-right:6px}
    .console-panel .event{color:#e6eaff}

    /* mobile */
    @media(max-width:480px){
      html,body{font-size:14px}
      header.container{padding:12px 12px}
      .logo{margin-left:12px;}
      .logo{width:36px;height:36px;border-radius:10px}
      .brand{font-size:18px}
      #spa-nav{gap:6px;padding:6px}
      #spa-nav .btn{font-size:12.5px;padding:7px 9px;border-radius:10px;max-width:120px}
      #spa-nav .btn.active{max-width:none}
      .console-panel{width:88vw; right:6vw}
      .kpi-track{animation-duration:26s}
    }
  
/* --- Nav: carousel style + hide scrollbar line --- */
#spa-nav{
  overflow:visible; white-space:nowrap; border-bottom:none;
  -ms-overflow-style: none;  /* IE/Edge */
  scrollbar-width: none;     /* Firefox */
  mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
}
#spa-nav::-webkit-scrollbar{ height:0 } /* Chrome/Safari: hide bar */
#spa-nav .btn{
  scroll-snap-align: center;
  transform-origin: center center;
  transition: transform .18s ease, opacity .18s ease, background .18s ease;
  opacity:.86;
}
#spa-nav .btn.active{ opacity:1 }
#spa-nav .track{display:flex; gap:8px; scroll-snap-type: x mandatory
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;}


/* Leaderboard bars */
.bar{height:10px; border-radius:6px; background:rgba(255,255,255,.08); overflow:hidden}
.bar > span{display:block; height:100%; background:linear-gradient(90deg, var(--mint), var(--primary))}


/* --- New segmented carousel nav with bubble indicator --- */
#spa-nav{
  position:sticky; top:0; z-index:20;
  padding:6px; margin:8px 0 18px;
  background:rgba(10,12,22,.65); backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.35);
  overflow:hidden;
}
#spa-nav .track{
  display:flex; align-items:center; gap:8px; overflow-x:auto; padding:2px;
  scroll-snap-type:x mandatory; white-space:nowrap;
  -ms-overflow-style:none; scrollbar-width:none;
}
#spa-nav .track::-webkit-scrollbar{ display:none }
#spa-nav .btn{
  position:relative; z-index:1;
  scroll-snap-align:center;
  font-weight:700; font-size:14px; padding:9px 12px; border-radius:12px;
  color:var(--text); border:1px solid transparent; background:transparent;
  transition:transform .18s ease, opacity .18s ease, color .18s ease;
  flex:0 0 auto;
}
#spa-nav .btn:not(.active){ opacity:.82 }
#spa-nav .btn.active{ color:#fff }
#spa-nav .bubble{
  position:absolute; z-index:0; height:32px; border-radius:12px;
  background:linear-gradient(135deg, var(--primary), var(--blue));
  box-shadow:0 10px 22px rgba(91,140,255,.35);
  transition:left .24s cubic-bezier(.2,.8,.2,1), width .24s cubic-bezier(.2,.8,.2,1);
  will-change:left,width;
}
@media(max-width:480px){
  #spa-nav .btn{font-size:12.5px; padding:7px 10px; border-radius:10px}
  #spa-nav .bubble{height:28px; border-radius:10px}
}


/* Calendar styles */
.calendar{user-select:none}
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.cal-head .mon{font-weight:800}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-cell{height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03); font-weight:600; cursor:pointer; transition:transform .15s ease, background .15s ease, color .15s ease}
.cal-cell:hover{transform:translateY(-1px);}
.cal-cell.muted{opacity:.35}
.cal-cell.off{opacity:.25; pointer-events:none}
.cal-cell.sel{color:#fff; background:linear-gradient(135deg, var(--primary), var(--mint)); border-color:transparent}
.cal-dow{opacity:.6; font-weight:700; font-size:12px}


.badge-pill{display:inline-block; padding:revert; border-radius:999px; border:0px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); font-weight:700; font-size:revert}
.lb-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.q-badge{display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); font-size:12px}


/* Safe minimal "grow" effect for active tab without JS changes */
#spa-nav .btn { /* declare a fallback for horizontal padding if none defined as CSS var */
  --btn-pad-x: 12px; /* only used by the rule below if the existing CSS doesn't define it */
}
#spa-nav .btn.active{
  padding-left:  calc(var(--btn-pad-x, 12px) + var(--nav-active-pad-extra));
  padding-right: calc(var(--btn-pad-x, 12px) + var(--nav-active-pad-extra));
}


/* === Global vertical rhythm & paddings === */
:root{
  --space-1: 6px; --space-2: 10px; --space-3: 14px; --space-4: 18px;
  --section-gap: 28px;
}
.container{max-width:1080px;margin:0 auto;padding:18px 18px 28px!important;}
section.page > * + *{ margin-top: var(--section-gap); }
.grid{ gap: var(--space-2) !important; }
.card + .card{ margin-top: var(--space-3); }


/* === v13: global paddings & spacing === */
section.page{ padding-left:18px; padding-right:18px; }
@media (min-width:1024px){ section.page{ padding-left:24px; padding-right:24px; } }

/* vertical rhythm */
:root{ --section-gap: 28px; --space-2: 10px; --space-3: 14px; }
section.page > * + *{ margin-top: var(--section-gap); }
.grid{ gap: var(--space-2) !important; }
.card + .card{ margin-top: var(--space-3); }

/* KPI pills micro-gaps */
.kpi-track{ display:flex; gap:22px; padding:10px 12px; }
.kpi{ display:inline-flex; align-items:center; gap:6px; }
.kpi .v{ margin-left:4px; }

/* bonuses: ticker/marquee safe spacing */
.marquee,.ticker{ margin-bottom:14px; }
.marquee + .card, .ticker + .card{ margin-top:14px; }

/* consult: show time slots only after date select */
#consult #slots{ display:none; gap:10px; flex-wrap:wrap; }
#consult #slots.show{ display:flex; }
#consult .dur{ min-width:88px; text-align:center; }


/* === v14: unified spacing & typography === */
:root{
  --container-pad-x: 18px;
  --container-pad-y: 18px;
  --section-gap: 28px;
  --grid-gap: 12px;
  --card-pad: 18px;
}
@media (min-width: 1024px){
  :root{
    --container-pad-x: 24px;
    --container-pad-y: 20px;
    --section-gap: 32px;
    --grid-gap: 14px;
    --card-pad: 20px;
  }
}
.container{ padding: var(--container-pad-y) var(--container-pad-x) !important; }
section.page > * + *{ margin-top: var(--section-gap) !important; }
.grid{ gap: var(--grid-gap) !important; }
.card{ padding: var(--card-pad) !important; }

/* Typography */
body{ font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
.brand{ font-family: 'Montserrat', sans-serif !important; }
.h1{ font-size: clamp(19px, 3.4vw + 12px, 56px)  line-height: 1.15; font-weight: 800; margin: 0 0 4px; }


/* === v15: layout normalizer (uniform paddings & width) === */
:root{ --content-max: 1080px; }

/* 1) A single content column width for everything */
main, .container { max-width: var(--content-max); margin-inline: auto; }

/* 2) Identical horizontal paddings everywhere */
section.page { padding-left: var(--container-pad-x); padding-right: var(--container-pad-x); }
.container{ padding-left: 0 !important; padding-right: 0 !important; } /* avoid double padding */

/* 3) If секция без .container — выравниваем внутренние крупные блоки */
section.page > .card,
section.page > .grid,
section.page > .section-head,
section.page > header,
section.page > .pillbar,
section.page > .stepper,
section.page > .pricing { margin-inline: 0; }

/* 4) Hero/heading rows inside sections also align */
section.page .hero, section.page .lead, section.page .h1 { margin-inline: 0; }

/* 5) Safety: on mobile keep paddings; on desktop they already scale by var */
@media (min-width: 1280px){
  :root{ --content-max: 1160px; }
}


/* v16-safe: input highlight + iOS zoom fix */
.input, .field, #contact{transition:box-shadow .18s ease, border-color .18s ease, background-color .18s ease}
.input.attn, .field.attn, #contact.attn{
  border-color: var(--mint,#3de0c5) !important;
  box-shadow: 0 0 0 3px rgba(61,224,197,.35);
  background: rgba(61,224,197,.06);
}
.input.ok, .field.ok, #contact.ok{
  border-color: var(--primary,#5b8cff) !important;
  box-shadow: 0 0 0 3px rgba(91,140,255,.35);
}
@media(max-width:480px){ input, select, textarea{ font-size:16px !important; line-height:1.3 } }


/* v21: mobile tap comfort, anti zoom & safer tilt */
html, body{ -webkit-text-size-adjust: 100%; }
.btn{ touch-action: manipulation; } /* removes 300ms delay & dbl-tap zoom on iOS */
@media (max-width: 480px){
  .tilt{ transform: none !important; } /* avoid Safari repaint glitches on iOS */
}
/* profile panel on top of everything */
.console-panel{ z-index: 3000; }
.console-toggle{ z-index: 3001; }


/* v23: fully remove legacy console log visuals */
.console-log, .console-panel pre, .console-panel .line, .console-panel .time, .console-panel .event { display:none !important; }
.console-panel { font: inherit; color: inherit; }
/* keep the panel container for profile usage */

/* v25: hide any legacy log UI completely; keep panel for profile */
.console-panel pre,.console-panel .line,.console-panel .time,.console-panel .event,.console-log{display:none!important}
/* z-index to ensure profile over content */
.console-panel{z-index:3000}
.console-toggle{z-index:3001}
/* mobile: prevent dbl-tap zoom + flicker */
.btn,button{touch-action:manipulation}
html,body{-webkit-text-size-adjust:100%}
@media(max-width:480px){.tilt{transform:none!important}}


/* v27 ensure panel on top */
.console-panel{z-index:3000}
.console-toggle,.fab-console{z-index:3001}

</style>

<!-- ==== DEV TEST (встраивается на home, видно только с ?debug=1) ==== -->
<style>
  #dev-fab{position:fixed;right:14px;bottom:14px;z-index:9999;border:0;border-radius:999px;padding:12px 14px;background:#2b52ff;color:#fff;font:600 13px system-ui;box-shadow:0 8px 22px rgba(0,0,0,.35);cursor:pointer;display:none}
  #dev-panel{position:fixed;right:14px;bottom:64px;z-index:9999;width:320px;max-width:92vw;background:#0f1221;color:#c9d1ff;border:1px solid #2a3157;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;overflow:hidden}
  #dev-panel .hdr{padding:10px 12px;border-bottom:1px solid #2a3157;display:flex;gap:8px;align-items:center}
  #dev-panel .hdr .ttl{font-weight:600}
  #dev-panel .hdr .badge{margin-left:auto;font-size:11px;opacity:.8}
  #dev-panel .body{padding:12px;display:flex;flex-direction:column;gap:8px}
  #dev-panel button{padding:10px 12px;border:0;border-radius:10px;color:#fff;cursor:pointer}
  #btn-test-bootstrap{background:#2b52ff}
  #btn-test-booking{background:#3aa76d}
  #dev-log{background:#0b0e1a;border:1px solid #2a3157;border-radius:10px;padding:10px;max-height:180px;overflow:auto;white-space:pre-wrap}
</style>

<button id="dev-fab">DEV</button>
<div id="dev-panel">
  <div class="hdr">
    <div class="ttl">DEV • GAS quick test</div>
    <div class="badge" id="dev-badge"></div>
  </div>
  <div class="body">
    <button id="btn-test-bootstrap">1) Bootstrap</button>
    <button id="btn-test-booking">2) Test consult_booking</button>
    <div id="dev-log"></div>
  </div>
</div>

<script>
(function(){
  const params = new URL(location.href).searchParams;
  const debugOn = params.get('debug') === '1';
  const fab = document.getElementById('dev-fab');
  const panel = document.getElementById('dev-panel');
  const badge = document.getElementById('dev-badge');
  const logBox = document.getElementById('dev-log');

  if(!debugOn){ return; } // показываем только с ?debug=1

  // если есть секция #home — отлично, но панель всё равно фиксом поверх
  function log(msg, obj){
    const line = '['+new Date().toLocaleTimeString()+'] '+msg+(obj?' '+JSON.stringify(obj):'');
    console.log('[DEV]', msg, obj||'');
    logBox.textContent = line + '\n' + logBox.textContent;
  }

  // быстрый бейдж состояния Telegram WebApp
  const inTG = !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData);
  const initLen = (Telegram && Telegram.WebApp && (Telegram.WebApp.initData||'').length) || 0;
  badge.textContent = inTG ? ('TG OK • initData '+initLen) : 'not in Telegram';
  if (!inTG) log('⚠ Открой через кнопку мини-аппа. Сейчас не в Telegram.');

  // показать FAB и панель (по клику)
  fab.style.display = 'inline-flex';
  fab.onclick = () => { panel.style.display = panel.style.display==='none'?'block':'none'; };
  // по умолчанию сразу открыть
  panel.style.display = 'block';

  // хелперы API (если уже есть у тебя — будут переопределены ниже)
  async function apiBootstrapFallback(){
    const tgInit = Telegram.WebApp.initData;
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK) + '?mode=bootstrap&tg_init=' + encodeURIComponent(tgInit);
    const r = await fetch(url, { method: 'GET' });
    return r.json();
  }
  async function apiEventFallback(type, extra={}){
    const tgInit = Telegram.WebApp.initData;
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type, tg_init: tgInit, ...extra })
    });
    return r.json();
  }
  const apiBootstrap = (window.apiBootstrap || apiBootstrapFallback);
  const apiEvent = (window.apiEvent || apiEventFallback);

  document.getElementById('btn-test-bootstrap').addEventListener('click', async ()=>{
    try{
      log('→ bootstrap()…');
      const res = await apiBootstrap();
      log('← bootstrap()', res);
      if(res && res.ok) log('Profile', res.profile || {});
    }catch(e){ log('bootstrap error', String(e)); }
  });

  document.getElementById('btn-test-booking').addEventListener('click', async ()=>{
    try{
      const now = new Date(Date.now() + 15*60*1000);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const hh = String(now.getHours()).padStart(2,'0');
      const mi = String(now.getMinutes()).padStart(2,'0');
      const date = `${yyyy}-${mm}-${dd}`;
      const time = `${hh}:${mi}`;

      const payload = { date, time, duration_min: 30, format: 'call', contact: '@dev_test' };
      log('→ consult_booking', payload);
      const res = await apiEvent('consult_booking', payload);
      log('← consult_booking', res);
      if(res && res.ok) log('✓ Проверь лист consult_bookings — должна появиться новая строка.');
    }catch(e){ log('consult_booking error', String(e)); }
  });

  log('DEV-панель готова. Нажми кнопки по порядку.');
})();
</script>
<!-- ==== /DEV TEST ==== -->
<script>
(function(){
  const cont = document.getElementById('dev-panel') || document.body;
  const btn = document.createElement('button');
  btn.id = 'btn-echo-sign';
  btn.textContent = 'Echo Sign';
  btn.style.marginLeft = '8px';
  cont.appendChild(btn);

  btn.addEventListener('click', async ()=>{
    try{
      const res = await _jsonp(APP_CONFIG.GAS_WEBHOOK, {
        mode: 'echo_sign',
        tg_init: (Telegram.WebApp && Telegram.WebApp.initData) || ''
      });
      console.log('[echo_sign]', res);
      alert('equal=' + res.equal + ', ageSec=' + res.ageSec);
    }catch(e){
      console.error(e);
      alert('echo_sign error: ' + e);
    }
  });
})();
</script>

<script>
(function () {
  // ==== маленький JSONP-хелпер, если вдруг своего нет ====
  if (typeof window._jsonp !== 'function') {
    window._jsonp = function (baseUrl, params) {
      return new Promise(function (resolve, reject) {
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const url = new URL(baseUrl);
        Object.entries(params || {}).forEach(([k, v]) => url.searchParams.set(k, String(v)));
        url.searchParams.set('callback', cbName);

        const s = document.createElement('script');
        s.src = url.toString();
        s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };

        function cleanup() {
          try { delete window[cbName]; } catch(_) { window[cbName] = undefined; }
          if (s.parentNode) s.parentNode.removeChild(s);
        }
        window[cbName] = function (data) { cleanup(); resolve(data); };
        document.head.appendChild(s);
      });
    };
  }

  // ==== утилиты логирования ====
  const logBox = document.getElementById('dev-log');
  function logLine(msg, obj) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}` + (obj ? ' ' + JSON.stringify(obj) : '');
    console.log('[DEV]', msg, obj || '');
    if (logBox) {
      logBox.textContent = line + '\n' + logBox.textContent;
    } else {
      // если нет dev-log — создадим поверх
      let box = document.getElementById('dev-log-fallback');
      if (!box) {
        box = document.createElement('pre');
        box.id = 'dev-log-fallback';
        box.style.cssText = 'position:fixed;left:8px;bottom:8px;right:8px;max-height:40vh;overflow:auto;background:#0b1220;color:#9feaff;padding:8px;border-radius:8px;font:12px/1.4 ui-monospace,monospace;z-index:99999';
        document.body.appendChild(box);
      }
      box.textContent = line + '\n' + box.textContent;
    }
  }

  // ==== кнопка Echo Sign в DEV-панели ====
  (function ensureEchoButton() {
    const devPanel = document.getElementById('dev-panel') || document.getElementById('dev') || document.body;
    let btn = document.getElementById('btn-echo-sign');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'btn-echo-sign';
      btn.textContent = 'Echo Sign (diag)';
      btn.style.cssText = 'margin:8px 0; padding:10px 14px; border-radius:10px; background:#444cf7; color:#fff; border:none; cursor:pointer;';
      devPanel.appendChild(btn);
    }
    btn.onclick = devEchoSign;
  })();

  // ==== сама диагностика подписи ====
  async function devEchoSign() {
    try {
      const isTg = !!(window.Telegram && Telegram.WebApp);
      const platform = isTg ? Telegram.WebApp.platform : 'no-telegram';
      const userId   = isTg ? (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id) : null;
      const initData = isTg ? (Telegram.WebApp.initData || '') : '';
      const lenInit  = initData.length;
      const encInit  = encodeURIComponent(initData);
      const lenEnc   = encInit.length;

      logLine('TG context', { platform, userId, lenInit, lenEnc });

      if (!lenInit) {
        alert('initData пустой — это не WebApp-контекст. Открой через кнопку бота.');
        return;
      }

      // JSONP на GAS echo_sign
      const gas = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK) || '';
      if (!gas) { alert('APP_CONFIG.GAS_WEBHOOK пуст'); return; }

      logLine('→ echo_sign call');
      const res = await window._jsonp(gas, { mode: 'echo_sign', tg_init: initData });
      logLine('← echo_sign FULL', res);

      // Красивый итог
      const equalA = res.equalA ?? res.equal;    // поддержка старой версии
      const equalB = res.equalB;
      const age    = res.ageSec;
      const hint   = (equalA ? 'Метод A (по доке) OK' : (equalB ? 'Метод B OK' : 'Хэш не сошёл'));

      alert(
        'equalA=' + equalA + '  equalB=' + equalB + '\n' +
        'ageSec=' + age + '\n' +
        'len_init=' + (res.len_init ?? lenInit) + '\n' +
        hint
      );

      // Если хочется увидеть конкретные хэши — они в консоли/логе
      // res.receivedHash, res.computedA, res.computedB
    } catch (e) {
      console.error(e);
      logLine('echo_sign error', String(e));
      alert('echo_sign error: ' + String(e));
    }
  }
})();
</script>



  
    
<!-- === FAST PANEL CSS OVERRIDE (transform/opacity toggle) === -->
<style>
  .console-panel{
    position: fixed; right: 14px; bottom: 56px; width: 360px;
    max-height: 78vh; overflow: auto;
    background: rgba(15,18,33,.9);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 12px; padding: 10px 12px;
    /* fast show via compositor only */
    transform: translateY(18px);
    opacity: 0;
    pointer-events: none;
    transition: transform .16s ease, opacity .16s ease;
    will-change: transform, opacity;
    contain: content;
    content-visibility: auto;
    z-index: 3000;
  }
  .console-panel.open{
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }
  @media (max-width:480px){
    .console-panel{ width: 88vw; right: 6vw; }
  }
</style>

<script>
(function(){
  const RU2MM = { 'янв':'01','фев':'02','мар':'03','апр':'04','мая':'05','июн':'06','июл':'07','авг':'08','сен':'09','окт':'10','ноя':'11','дек':'12' };

  function parseHeadYM(){
    const h = document.querySelector('#cal .cal-head .mon');
    if(!h) return null;
    const t = (h.textContent||'').trim().toLowerCase();           // "Октябрь 2025"
    const m = t.match(/([а-яa-z]+)\s+(\d{4})/i);
    if(!m) return null;
    const mm = RU2MM[m[1].slice(0,3)] || RU2MM[m[1].slice(0,3).replace('ё','е')];
    return mm ? { y: m[2], m: mm } : null;
  }
  function dd2(ddd){ return String(ddd).padStart(2,'0'); }

  async function loadFreeSlotsForMonth(y, m){
    const first = `${y}-${m}-01`;
    const last  = `${y}-${m}-${dd2(new Date(+y, +m, 0).getDate())}`;
    const base  = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    if(!base){ console.warn('No GAS_WEBHOOK'); return; }
    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('lead_min','120');      // запись не раньше чем через 2ч
    u.searchParams.set('gran','30');
    u.searchParams.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
    try{ u.searchParams.set('tg_init', Telegram?.WebApp?.initData || ''); }catch(_){}
    const r = await fetch(u.toString());
    const j = await r.json();
    if(!j || !j.ok){ console.error(j); return; }
    window.__FREE__ = j.days || {};
    window.__GRAN__ = j.gran || 30;
  }

  function isDayFree(iso){
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    return Array.isArray(arr) && arr.length>0;
  }

  function applyDaysState(y, m){
    const grid = document.querySelector('#cal .cal-grid');
    if(!grid) return;
    grid.querySelectorAll('.cal-cell').forEach(cell=>{
      if(cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if(!day || /\D/.test(day)) return;
      const iso = `${y}-${m}-${dd2(day)}`;
      cell.dataset.iso = iso;
      const hasKey = window.__FREE__ && Object.prototype.hasOwnProperty.call(window.__FREE__, iso);
      if (!hasKey) return;
      if(!isDayFree(iso)){
        cell.classList.add('off','muted');
        cell.setAttribute('aria-disabled','true');
      }else{
        cell.classList.remove('off','muted');
        cell.removeAttribute('aria-disabled');
      }
    });
  }

  function renderSlotsForDate(iso){
    const wrap = document.getElementById('slots');
    if(!wrap) return;
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    wrap.innerHTML = '';
    wrap.classList.toggle('show', true);

    if(!arr.length){
      wrap.innerHTML = '<div class="muted">Нет свободных слотов</div>';
      return;
    }
    arr.forEach(label=>{
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.textContent = label;
      btn.dataset.time = label;
      btn.onclick = ()=>{
        wrap.querySelectorAll('button').forEach(x=>x.classList.remove('btn-primary','active'));
        btn.classList.add('btn-primary','active');
        window.SEL = window.SEL || {}; SEL.time = label;
        window.scope = window.scope || {}; scope._selTime = label;
      };
      wrap.appendChild(btn);
    });
  }

  async function syncMonthAndDays(){
    window.__CAL_REQ_ID__ = window.__CAL_REQ_ID__ || 0;
    const ym = parseHeadYM(); if(!ym) return;
    const __my = ++window.__CAL_REQ_ID__;
    await loadFreeSlotsForMonth(ym.y, ym.m);
    if (__my !== window.__CAL_REQ_ID__) return; // stale
    applyDaysState(ym.y, ym.m);
  }

  // Инициализация после первой отрисовки календаря
  setTimeout(syncMonthAndDays, 0);

  // Навигация по месяцам (если есть кнопки prev/next)
  document.addEventListener('click', (ev)=>{
    if (ev.target.closest('#cal #prevM') || ev.target.closest('#cal #nextM')){
      setTimeout(syncMonthAndDays, 0);
    }
  });

  // Выбор дня -> показываем слоты этого дня
  document.addEventListener('click', (ev)=>{
    const cell = ev.target.closest && ev.target.closest('#cal .cal-cell');
    if(!cell || cell.classList.contains('off')) return;
    const iso = cell.dataset.iso || cell.dataset.date;
    if(iso){
      window.scope = window.scope || {}; scope._selDate = iso; window.__selDate = iso;
      renderSlotsForDate(iso);
    }
  });

  // При подтверждении, если сервер вернёт slot_unavailable — перезагружаем месяц
  const _origApiEvent = window.apiEvent;
  window.apiEvent = async function(type, payload){
    const res = await _origApiEvent(type, payload);
    if(res && res.ok===false && /slot_unavailable/.test(res.error||'')){
      try{ await syncMonthAndDays(); }catch(_){}
    }
    return res;
  };
})();
</script>

<script>
/* === Calendar × GAS (V5 minimal, robust) === */
(function(){
  if (window.__CAL_GAS_V5__) return; window.__CAL_GAS_V5__ = true;

  const RU2MM = { 'янв':'01','фев':'02','мар':'03','апр':'04','мая':'05','май':'05','июн':'06','июл':'07','авг':'08','сен':'09','сент':'09','окт':'10','ноя':'11','дек':'12' };
  const dd2 = n => String(n).padStart(2,'0');
  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));

  function parseYM(){
    // поддержим разные верстки: #cal .cal-head .mon или .mon
    const h = qs('#cal .cal-head .mon') || qs('#cal .mon');
    if (!h) return null;
    const t = (h.textContent || '').trim().toLowerCase(); // "Октябрь 2025"
    const m = t.match(/([а-яa-zё]+)\s+(\d{4})/i);
    if (!m) return null;
    const stem = m[1].slice(0,3).replace('ё','е');
    const mm = RU2MM[stem];
    return mm ? { y: m[2], m: mm } : null;
  }

  function showError(msg){
    const wrap = qs('#slots,#slotsTime'); if (!wrap) return;
    wrap.classList.add('show');
    wrap.innerHTML = '<div class="muted" style="padding:8px">'+ msg +'</div>';
  }

  async function loadFreeSlots(y, m){
    const base = window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK;
    if (!base) { showError('Нет APP_CONFIG.GAS_WEBHOOK'); return null; }

    const first = `${y}-${m}-01`;
    const last  = `${y}-${m}-${dd2(new Date(+y,+m,0).getDate())}`;
    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('gran','30');
    u.searchParams.set('lead_min','120');
    u.searchParams.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');

    try{
      const tg = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
      if (tg) u.searchParams.set('tg_init', tg);
      else if (window.APP_CONFIG && APP_CONFIG.API_KEY) u.searchParams.set('key', APP_CONFIG.API_KEY);
    }catch(_){}

    let r, j;
    try{
      r = await fetch(u.toString(), { credentials:'omit' });
      j = await r.json();
    }catch(e){
      showError('Ошибка сети при загрузке слотов'); return null;
    }
    if (!j || j.ok === false) {
      showError('Сервер не отдал слоты' + (j && j.error ? `: ${j.error}` : ''));
      return null;
    }
    return j; // { days:{ 'YYYY-MM-DD': ['10:00','10:30',...]}, gran, tz }
  }

  function applyDays(ym, freeMap){
    const grid = qs('#cal .cal-grid'); if (!grid) return;
    qsa('.cal-cell', grid).forEach(cell=>{
      if (cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if (!day || /\D/.test(day)) return;
      const iso = `${ym.y}-${ym.m}-${dd2(day)}`;
      cell.dataset.iso = iso;

      const hasKey = freeMap && Object.prototype.hasOwnProperty.call(freeMap, iso);
      if (!hasKey) return; // не трогаем, если день не пришёл с сервера

      const arr = (freeMap && freeMap[iso]) || [];
      if (Array.isArray(arr) && arr.length>0){
        cell.classList.remove('off','muted');
        cell.removeAttribute('aria-disabled');
      } else {
        cell.classList.add('off','muted');
        cell.setAttribute('aria-disabled','true');
      }
    });
    }

  function renderSlots(iso, freeMap){
    const wrap = qs('#slots,#slotsTime'); if (!wrap) return;
    const arr = (freeMap && freeMap[iso]) || [];
    wrap.innerHTML = ''; wrap.classList.add('show');
    if (!arr.length){ wrap.innerHTML = '<div class="muted">Нет свободных слотов</div>'; return; }
    arr.forEach(time=>{
      const b = document.createElement('button');
      b.className = 'btn btn-ghost';
      b.textContent = time;
      b.dataset.time = time;
      b.onclick = ()=>{
        qsa('button',wrap).forEach(x=>x.classList.remove('btn-primary','active'));
        b.classList.add('btn-primary','active');
        // сохраняем выбор — твой код брони это увидит
        window.scope = window.scope || {}; scope._selTime = time;
        window.SEL   = window.SEL   || {}; SEL.time = time;
      };
      wrap.appendChild(b);
    });
  }

  async function syncMonth(){
    const ym = parseYM(); if (!ym) return;                        // нет заголовка месяца
    const data = await loadFreeSlots(ym.y, ym.m); if (!data) return;
    window.__FREE__ = data.days || {};
    applyDays(ym, window.__FREE__);
  }

  // Инициализация (даём календарю отрисоваться)
  setTimeout(syncMonth, 60);

  // Перелистывание месяцев
  document.addEventListener('click', e=>{
    if (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM')) {
      setTimeout(syncMonth, 30);
    }
  });

  // Клик по дню -> рендерим слоты
  document.addEventListener('click', e=>{
    const cell = e.target.closest && e.target.closest('#cal .cal-cell');
    if (!cell || cell.classList.contains('off')) return;          // закрытый день — игнор
    const iso = cell.dataset.iso || cell.dataset.date;
    if (!iso) return;
    window.scope = window.scope || {}; scope._selDate = iso;      // дай знать остальному коду
    window.__selDate = iso;
    renderSlots(iso, window.__FREE__);
  });

  /* ——— Бридж записи: подставь date/time/format в consult_booking ——— */
  (function(){
    if (window.__BOOKING_BRIDGE_V5__) return; window.__BOOKING_BRIDGE_V5__ = true;
    function pick(){
      let d = (window.scope && (scope._selDate||scope.selDate)) || '';
      let t = (window.scope && (scope._selTime||scope.selTime)) || '';
      let dur = (window.scope && (scope._durMin||scope.durMin)) || 30;
      const btn = qs('#slots .btn-primary, #slots .active'); if (!t && btn) t = (btn.dataset.time||btn.textContent||'').trim();
      return { date:d||'', time:t||'', duration_min:dur||30 };
    }
    function pickFormat(){
      const el = qs('.consult-type.btn-primary, .consult-type.active');
      return (el && el.dataset && el.dataset.type) || (window.SEL&&SEL.type) || (window.scope&&scope._format) || '';
    }
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      data = data || {};
      if (type==='consult_booking' || (data && data.type==='consult_booking')){
        const s = pick();
        data.date = data.date || s.date;
        data.time = data.time || s.time;
        data.duration_min = data.duration_min || s.duration_min;
        data.format = data.format || pickFormat();
      }
      try{ if(!data.tg_init && Telegram && Telegram.WebApp) data.tg_init = Telegram.WebApp.initData; }catch(_){}
      if (typeof prev === 'function') return prev(type, data);
      if (typeof window.__postGAS === 'function') return await window.__postGAS(Object.assign({type:type}, data));
    };
  })();
})();
</script>

<style>
/* На случай, если стилей нет — сделаем «приглушение» */
.cal-cell.off { pointer-events:none; }
.muted { opacity:.5; }
</style>

<script>
/* ===== DEV PANEL & AUDIT (включается по ?dev=1 или localStorage.dev=1) ===== */
(function(){
  const DEV = /[?&]dev=1/.test(location.search) || localStorage.getItem('dev')==='1';
  if (!DEV) return;
  window.__DEV__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const dd2 = n=>String(n).padStart(2,'0');
  const RU2MM = { 'янв':'01','фев':'02','мар':'03','апр':'04','мая':'05','май':'05','июн':'06','июл':'07','авг':'08','сен':'09','сент':'09','окт':'10','ноя':'11','дек':'12' };

  // ---------- UI ----------
  const box = document.createElement('div');
  box.id = 'devPanel';
  box.innerHTML = `
    <div class="dev-head">DEV</div>
    <div class="dev-body">
      <div class="row">
        <label>GAS_WEBHOOK</label>
        <input id="devGas" placeholder="https://script.google.com/macros/s/.../exec">
      </div>
      <div class="row">
        <label>API_KEY (для браузера)</label>
        <input id="devKey" placeholder="если ALLOW_API_KEY_FALLBACK=true">
      </div>
      <div class="row">
        <button id="devPing">Ping</button>
        <button id="devSlots">Free Slots</button>
        <button id="devAudit">Аудит календаря</button>
      </div>
      <div class="row">
        <label>Тест booking:</label>
        <input id="devContact" placeholder="@username / +7...">
        <button id="devBook">consult_booking</button>
      </div>
      <pre id="devLog"></pre>
    </div>`;
  document.body.appendChild(box);

  const $ = id => box.querySelector(id);
  const log = (m,obj)=>{ const t = new Date().toLocaleTimeString(); const s = typeof obj==='undefined' ? '' : ' ' + JSON.stringify(obj); $('#devLog').textContent += `[${t}] ${m}${s}\n`; };
  const cfg = window.APP_CONFIG = window.APP_CONFIG || {};
  $('#devGas').value = cfg.GAS_WEBHOOK || localStorage.getItem('GAS_WEBHOOK') || '';
  $('#devKey').value = cfg.API_KEY || localStorage.getItem('API_KEY') || '';
  $('#devContact').value = localStorage.getItem('DEV_CONTACT') || '';

  // сохраняем значения
  ['devGas','devKey','devContact'].forEach(id=>{
    $( '#'+id ).addEventListener('change', ()=>{
      if (id==='devGas'){ cfg.GAS_WEBHOOK = $('#devGas').value; localStorage.setItem('GAS_WEBHOOK', cfg.GAS_WEBHOOK); }
      if (id==='devKey'){ cfg.API_KEY = $('#devKey').value; localStorage.setItem('API_KEY', cfg.API_KEY); }
      if (id==='devContact'){ localStorage.setItem('DEV_CONTACT', $('#devContact').value); }
    });
  });

  function parseYM(){
    const h = qs('#cal .cal-head .mon') || qs('#cal .mon');
    if (!h) return null;
    const t = (h.textContent||'').trim().toLowerCase(); // "Октябрь 2025"
    const m = t.match(/([а-яa-zё]+)\s+(\d{4})/i);
    if (!m) return null;
    const mm = RU2MM[m[1].slice(0,3).replace('ё','е')];
    return mm ? { y: m[2], m: mm } : null;
  }

  async function fetchJSON(u){
    const r = await fetch(u.toString(), { credentials:'omit' });
    const j = await r.json().catch(()=>null);
    return { ok:r.ok, status:r.status, data:j };
  }

  async function ping(){
    const base = cfg.GAS_WEBHOOK; if(!base){ log('⛔ нет GAS_WEBHOOK'); return; }
    const u = new URL(base); u.searchParams.set('mode','ping');
    const {data} = await fetchJSON(u); log('ping', data);
  }

  async function getFreeSlots(){
    const base = cfg.GAS_WEBHOOK; if(!base){ log('⛔ нет GAS_WEBHOOK'); return null; }
    const ym = parseYM(); if(!ym){ log('⛔ не вижу заголовок месяца'); return null; }
    const first = `${ym.y}-${ym.m}-01`;
    const last  = `${ym.y}-${ym.m}-${dd2(new Date(+ym.y,+ym.m,0).getDate())}`;
    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('gran','30');
    u.searchParams.set('lead_min','120');
    u.searchParams.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
    try{
      const tgi = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
      if (tgi) u.searchParams.set('tg_init', tgi);
      else if (cfg.API_KEY) u.searchParams.set('key', cfg.API_KEY);
    }catch(_){}
    const {data} = await fetchJSON(u);
    log('free_slots', data);
    if (data && data.ok) window.__FREE__ = data.days || {};
    return data;
  }

  function auditCalendar(){
    const grid = qs('#cal .cal-grid'); if(!grid){ log('⛔ нет .cal-grid'); return; }
    const ym = parseYM(); if(!ym){ log('⛔ не вижу месяц/год'); return; }
    let bad=0, ok=0;
    qsa('.cal-cell', grid).forEach(cell=>{
      if (cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if (!day || /\D/.test(day)) return;
      const iso = `${ym.y}-${ym.m}-${dd2(day)}`;
      const fromSrv = window.__FREE__ && Object.prototype.hasOwnProperty.call(window.__FREE__, iso);
      if (!fromSrv) { cell.style.outline = ''; return; }
      const arr = window.__FREE__[iso] || [];
      const shouldOff = !(Array.isArray(arr) && arr.length>0);
      const isOff = cell.classList.contains('off') || cell.getAttribute('aria-disabled')==='true';
      if (shouldOff !== isOff){
        cell.style.outline = '2px solid #e53935'; bad++;
      } else {
        cell.style.outline = '2px solid #43a047'; ok++;
      }
    });
    log('Аудит календаря — ок/проблемы', {ok,bad});
  }

  async function bookTest(){
    const contact = $('#devContact').value.trim();
    localStorage.setItem('DEV_CONTACT', contact);
    // берём выбор из твоего UI/моста
    const s = (function(){
      let d = (window.scope && (scope._selDate||scope.selDate)) || '';
      let t = (window.scope && (scope._selTime||scope.selTime)) || '';
      let dur = (window.scope && (scope._durMin||scope.durMin)) || 30;
      const btn = qs('#slots .btn-primary, #slots .active'); if (!t && btn) t = (btn.dataset.time||btn.textContent||'').trim();
      return { date:d||'', time:t||'', duration_min:dur||30 };
    })();
    const payload = { type:'consult_booking', contact, format: (window.scope&&scope._format)||'call' };
    if (s.date) payload.date = s.date;
    if (s.time) payload.time = s.time;
    payload.duration_min = s.duration_min;

    // отдаём через твой apiEvent/bridge, чтобы отловить коллизию слота
    try{
      const res = await (window.apiEvent ? window.apiEvent('consult_booking', payload) : Promise.resolve({ok:false, error:'no_apiEvent'}));
      log('consult_booking →', payload);
      log('consult_booking ←', res);
    }catch(e){
      log('consult_booking error', String(e));
    }
  }

  // перехват apiEvent для логов
  (function(){
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      log('→ apiEvent', {type, data});
      const r = prev ? await prev(type, data) : undefined;
      log('← apiEvent', r);
      return r;
    };
  })();

  // кнопки
  $('#devPing').onclick  = ping;
  $('#devSlots').onclick = async()=>{ const d = await getFreeSlots(); if(d&&d.ok) auditCalendar(); };
  $('#devAudit').onclick = auditCalendar;
  $('#devBook').onclick  = bookTest;
})();
</script>
<style>
#devPanel{position:fixed;right:12px;bottom:12px;z-index:99999;background:#0b1220;color:#e6edf3;border:1px solid #24324a;border-radius:12px;width:320px;font:12px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:0;box-shadow:0 10px 30px rgba(0,0,0,.35)}
#devPanel .dev-head{padding:8px 10px;background:#111a2b;border-bottom:1px solid #24324a;border-top-left-radius:12px;border-top-right-radius:12px;font-weight:700;letter-spacing:.5px}
#devPanel .dev-body{padding:8px 10px;max-height:55vh;overflow:auto}
#devPanel .row{display:flex;gap:6px;align-items:center;margin:6px 0}
#devPanel label{min-width:110px;color:#8fb0ff}
#devPanel input{flex:1 1 auto;background:#0f172a;border:1px solid #2f3b59;border-radius:8px;color:#e6edf3;padding:6px 8px}
#devPanel button{background:#1f6feb;border:0;border-radius:8px;color:#fff;padding:6px 10px;cursor:pointer}
#devPanel pre{white-space:pre-wrap;background:#0f172a;border:1px dashed #2b3860;border-radius:8px;padding:6px 8px;margin:6px 0 0;max-height:26vh;overflow:auto}
</style>


<script>
/* === Duration bridge + slot filtering (не ломая текущую логику) === */
(function(){
  if (window.__DURATION_FILTER_V1__) return; window.__DURATION_FILTER_V1__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const toMin = (hhmm)=>{ const m = String(hhmm||'').match(/(\d{1,2}):(\d{2})/); if(!m) return null; return (+m[1])*60 + (+m[2]); };
  const toHHMM = (m)=>String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');

  // ---- 1) Читаем выбранную длительность из UI (разные разметки поддержим) ----
  function getSelectedDuration() {
    // популярные варианты: кнопки с data-* или .active, радио, селект
    const cand =
      qs('[data-dur].active, [data-duration].active, .dur.btn-primary, .dur.active') ||
      qs('input[name="duration"]:checked') ||
      qs('#duration, select[name="duration"]');

    let v = 30;
    if (cand){
      if (cand.dataset && cand.dataset.min) v = parseInt(cand.dataset.min,10)||v;
      else if (cand.dataset && cand.dataset.dur) v = parseInt(cand.dataset.dur,10)||v;
      else if (cand.value) v = parseInt(cand.value,10)||v;
      else {
        const txt = (cand.textContent||'').replace(/\D+/g,'');
        if (txt) v = parseInt(txt,10)||v;
      }
    }
    // запасной вариант: смотрим в scope/_durMin
    try{ if (window.scope && +scope._durMin) v = +scope._durMin; }catch(_){}
    return Math.min(Math.max(v, 15), 240); // 15..240
  }

  // ---- 2) Прокидываем duration в consult_booking ----
  (function(){
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      data = data || {};
      if (type==='consult_booking' || (data && data.type==='consult_booking')) {
        const dur = getSelectedDuration();
        data.duration_min = data.duration_min || dur;
        // синхронизируем с твоим scope, чтобы остальной код «видел»
        window.scope = window.scope || {}; scope._durMin = dur;
      }
      if (typeof prev === 'function') return prev(type, data);
      if (typeof window.__postGAS === 'function') return await window.__postGAS(Object.assign({type:type}, data));
    };
  })();

  // ---- 3) Фильтруем старты под выбранную длительность (по непрерывности шагов) ----
  function filterStartsByDuration(starts, durMin, stepMin){
    if (!Array.isArray(starts) || !starts.length) return [];
    const step = Math.max(5, stepMin|| (window.__GRAN__||30));
    if (durMin <= step) return starts.slice();

    const need = Math.ceil(durMin / step);
    const minsSet = new Set(starts.map(toMin).filter(m=>m!=null));
    return starts.filter(t=>{
      const m = toMin(t); if (m==null) return false;
      for (let i=0;i<need;i++){
        if (!minsSet.has(m + i*step)) return false; // не хватает подряд идущих шагов
      }
      return true;
    });
  }

  // ---- 4) Подхватываем отрисовку слотов и применяем фильтр на лету ----
  function refilterSlots() {
    const wrap = qs('#slots,#slotsTime'); if (!wrap) return;
    // текущие старты из DOM или из ответа сервера (предпочтительно из сервера)
    let starts = [];
    if (window.__selDate && window.__FREE__ && window.__FREE__[window.__selDate]) {
      starts = window.__FREE__[window.__selDate].slice();
    } else {
      // fallback: прочитаем из кнопок
      starts = qsa('button[data-time],button', wrap)
        .map(b => (b.dataset.time || b.textContent || '').trim())
        .filter(Boolean);
    }

    const dur = getSelectedDuration();
    const step = window.__GRAN__ || 30;
    const allowed = new Set(filterStartsByDuration(starts, dur, step));
    // проставим доступность на кнопках
    qsa('button', wrap).forEach(b=>{
      const t = (b.dataset.time || b.textContent || '').trim();
      if (!t) return;
      const ok = allowed.has(t);
      b.disabled = !ok;
      b.classList.toggle('muted', !ok);
      b.classList.toggle('off', !ok);
      if (!ok && b.classList.contains('btn-primary')) b.classList.remove('btn-primary','active');
    });

    if (window.__DEV__){
      const logEl = document.querySelector('#devLog');
      const msg = `[slots] duration=${dur}, step=${step}, total=${starts.length}, allowed=${allowed.size}`;
      if (logEl) logEl.textContent += msg + '\n'; else console.log(msg);
    }
  }

  // --- 5) Включаем рефильтр при выборе даты/при смене длительности ---
  // Клики по слоту/дате уже где-то обрабатываются; мы только подслушаем события.
  document.addEventListener('click', (e)=>{
    // смена длительности
    if (e.target.closest('.dur, [data-dur], [data-duration], input[name="duration"], #duration, select[name="duration"]')) {
      const dur = getSelectedDuration();
      window.scope = window.scope || {}; scope._durMin = dur;
      setTimeout(refilterSlots, 0);
    }
    // выбор даты -> после перерендера слотов чуть позже отфильтруем
    if (e.target.closest('#cal .cal-cell')) {
      setTimeout(refilterSlots, 30);
    }
  });

  // если слоты дорисованы асинхронно другим кодом — подстрахуемся
  const mo = new MutationObserver((muts)=>{
    for (const m of muts){
      if (m.target && (m.target.id==='slots' || m.target.id==='slotsTime')) {
        setTimeout(refilterSlots, 0);
        break;
      }
    }
  });
  const wrap = qs('#slots,#slotsTime'); if (wrap) mo.observe(wrap, { childList:true, subtree:true });

  // начальная попытка (если выбор уже есть)
  setTimeout(refilterSlots, 300);
})();
</script>
<style>
/* мягкая деактивация слотов, чтобы было понятно пользователю */
#slots .off, #slotsTime .off { pointer-events:none; opacity:.5; }
</style>

<!-- ==== STEP6 VER-CACHE: versioned month cache + stale-while-revalidate ==== -->
<script>
(function(){
  if (window.__CAL_STEP6_VER_CACHE__) return; window.__CAL_STEP6_VER_CACHE__ = true;

  const TZ  = (Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
  const dd2 = n => String(n).padStart(2,'0');
  const keyYM = (y,m)=> `${y}-${m}`;

  // --- helpers to read header YM (works with both heads you use) ---
  function parseYM_any(){
    try{ if (typeof parseYM==='function'){ const r=parseYM(); if(r&&r.y&&r.m) return r; } }catch(_){}
    try{ if (typeof parseHeadYM==='function'){ const r=parseHeadYM(); if(r&&r.y&&r.m) return r; } }catch(_){}
    // fallback from "Октябрь 2025"
    const h = document.querySelector('#cal .cal-head .mon')||document.querySelector('#cal .mon');
    if (h){
      const t=(h.textContent||'').trim();
      const map={янв:'01',фев:'02',мар:'03',апр:'04',мая:'05',май:'05',июн:'06',июл:'07',авг:'08',сен:'09',сент:'09',окт:'10',ноя:'11',дек:'12',
                 jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
      const m=t.toLowerCase().replace('ё','е').match(/^[^\d\s]+/);
      const y=t.match(/(\d{4})/);
      if(m&&y){ const mm=map[m[0].slice(0,3)]; if(mm) return {y:y[1], m:mm}; }
    }
    const now=new Date(); return { y:String(now.getFullYear()), m:dd2(now.getMonth()+1) };
  }

  // --- our RAM cache separate from old layer (to avoid closure issues) ---
  const RAM = new Map();

  function readSS(k){
    try { return JSON.parse(sessionStorage.getItem('free:'+k)||'null'); } catch(_){ return null; }
  }
  function writeSS(k, obj){
    try { sessionStorage.setItem('free:'+k, JSON.stringify(obj)); } catch(_){}
  }

  // wrap original getCache / setCache if they exist, but make version-aware
  const orig_getCache = window.getCache;
  const orig_setCache = window.setCache;

  function getCacheV(y,m){
    const k = keyYM(y,m);
    // prefer our RAM first
    if (RAM.has(k)) {
      const e = RAM.get(k);
      if (e && (Date.now()-(e.ts||0)) < (window.__TTL_MS__||60*1000)) return e;
    }
    // try original
    let e = null;
    if (typeof orig_getCache === 'function') {
      try { e = orig_getCache(y,m); } catch(_){}
    }
    // ensure ver presence if exists in SS
    if (!e) e = readSS(k);
    if (e) {
      // normalize shape
      e.ver = Number(e.ver||0);
      RAM.set(k, e);
      return (Date.now()-(e.ts||0)) < (window.__TTL_MS__||60*1000) ? e : null;
    }
    return null;
  }

  function setCacheV(y,m,days,gran,tz,ver){
    const k = keyYM(y,m);
    const e = { ts: Date.now(), days: days||{}, gran: gran||30, tz: tz||TZ, ver: Number(ver||0) };
    RAM.set(k, e);
    writeSS(k, e);
    // also call original setCache to preserve old flow (it will ignore ver)
    if (typeof orig_setCache === 'function'){
      try { orig_setCache(y,m,days,gran,tz); } catch(_){}
      // then rewrite SS with ver again (orig_setCache may have overwritten it)
      writeSS(k, e);
    }
    return e;
  }

  // expose for other layers
  window.getCache = getCacheV;
  window.setCache = setCacheV;

  // --- reapply UI if current calendar month matches passed ym ---
  function applyIfCurrent(ym, days, gran, tz){
    const cur = parseYM_any();
    if (!cur || cur.y!==ym.y || cur.m!==ym.m) return;
    window.__FREE__ = days || {};
    window.__GRAN__ = gran || 30;
    if (typeof window.applyDays === 'function') window.applyDays(ym, window.__FREE__);
    else if (typeof window.applyDaysFromMap === 'function') window.applyDaysFromMap(ym, window.__FREE__);
  }

  // --- patch V5 fetch wrapper (stale-while-revalidate) ---
  if (typeof window.loadFreeSlots === 'function'){
    const orig = window.loadFreeSlots;
    window.loadFreeSlots = async function(y,m,opt){
      opt = opt||{};
      const k = keyYM(y,m);
      const cached = getCacheV(y,m);

      // return cached instantly (no flicker)
      if (cached && !opt.force){
        // background revalidate
        queueMicrotask(async ()=>{
          try {
            const data = await orig.call(this, y,m, { force:true });
            // data may be {ok,days,gran,tz,ver} or similar
            const ver = Number((data && data.ver) || 0);
            if (!cached || ver>Number(cached.ver||0)) {
              setCacheV(y,m, data && data.days || {}, (data && data.gran)||30, (data && data.tz)||TZ, ver);
              applyIfCurrent({y,m}, (data && data.days)||{}, (data && data.gran)||30, (data && data.tz)||TZ);
            }
          } catch(_){}
        });
        // sync globals for callers that expect __FREE__/__GRAN__
        window.__FREE__ = cached.days || {};
        window.__GRAN__ = cached.gran || 30;
        return { ok:true, days: cached.days, gran: cached.gran, tz: cached.tz, ver: cached.ver, cached:true };
      }

      // no cache or force -> normal fetch and update cache
      const data = await orig.apply(this, arguments);
      const ver  = Number((data && data.ver) || 0);
      if (data && data.days){
        setCacheV(y,m, data.days, data.gran, data.tz, ver);
      }
      return data;
    };
  }

  // --- patch early loader too (same S-W-R) ---
  if (typeof window.loadFreeSlotsForMonth === 'function'){
    const orig2 = window.loadFreeSlotsForMonth;
    window.loadFreeSlotsForMonth = async function(y,m,opt){
      opt=opt||{};
      const cached = getCacheV(y,m);
      if (cached && !opt.force){
        window.__FREE__ = cached.days; window.__GRAN__ = cached.gran||30;
        // background revalidate
        queueMicrotask(async ()=>{
          try{
            await orig2.call(this, y,m, { force:true });
            // early loader usually fills __FREE__/__GRAN__ — прочитаем и перезапишем с версией, если back вернул вер
            const last = (window.__FREE__ && Object.keys(window.__FREE__).length) ? window.__FREE__ : null;
            // попробуем достать свежий JSON прямо через sessionStorage, если другой слой уже записал версию
            const ym = {y,m}; const k = 'free:'+keyYM(y,m); let ss=null;
            try { ss = JSON.parse(sessionStorage.getItem(k)||'null'); } catch(_){}
            const ver = Number(ss && ss.ver || 0);
            if (last) setCacheV(y,m,last, window.__GRAN__||30, TZ, ver);
            applyIfCurrent(ym, last||cached.days, window.__GRAN__||cached.gran||30, TZ);
          }catch(_){}
        });
        return;
      }
      await orig2.apply(this, arguments);
      const ym = {y,m};
      // прочитаем текущие __FREE__/__GRAN__ и положим в наш кэш
      const days = window.__FREE__ || {};
      const gran = window.__GRAN__ || 30;
      // если в sessionStorage уже лежит запись с ver — используем её
      let ver=0; try{ const ss=JSON.parse(sessionStorage.getItem('free:'+keyYM(y,m))||'null'); ver=Number(ss&&ss.ver||0); }catch(_){}
      setCacheV(y,m,days,gran,TZ,ver);
    };
  }

  // --- keep cache in sync when STEP5 syncMonth fetches direct JSON with ver ---
  if (typeof window.syncMonth === 'function'){
    const orig = window.syncMonth;
    window.syncMonth = async function(){
      const ym = parseYM_any();
      const res = await orig.apply(this, arguments);
      // try to read last json (if fetch function stored ver in SS)
      try{
        const ss = JSON.parse(sessionStorage.getItem('free:'+keyYM(ym.y,ym.m))||'null');
        const ver = Number(ss && ss.ver || 0);
        if (window.__FREE__) setCacheV(ym.y, ym.m, window.__FREE__, window.__GRAN__||30, TZ, ver);
      }catch(_){}
      return res;
    };
  }
})();
</script>

  
    
</head>
<body>

<script>
// Telegram WebApp SDK init + name read (runs as early as possible)
(function(){
  var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (!tg) return;
  try { tg.ready(); tg.expand && tg.expand(); } catch(e){}

  function getDisplayName(){
    try{
      var u = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
      if (!u) return null;
      var full = [u.first_name||'', u.last_name||''].filter(Boolean).join(' ').trim();
      return full || (u.username ? '@'+u.username : null);
    }catch(e){ return null; }
  }

  // Wait a bit in case Telegram fills user with slight delay
  function awaitUser(cb){
    var tries = 0, timer = setInterval(function(){
      var name = getDisplayName();
      if (name || tries++ > 20){ clearInterval(timer); cb(name || 'Гость'); }
    }, 150);
  }

  awaitUser(function(name){
    // Expose globally so any part of app can use
    window.__TG_DISPLAY_NAME__ = name;
    // Update any placeholders in UI if present
    var el = document.querySelector('[data-tg-name], .profile-name, #tg-user-header .name');
    if (el) el.textContent = name;
  });
})();
</script>

<canvas id="bg-canvas"></canvas>

<header class="container">
  <div class="brand-wrap">
    <div class="logo"></div>
    <div>
      <div class="brand">Маркетолог</div>
      <div class="slogan">Считаем прибыль, а не клики</div>
    </div>
  </div>
</header>

<nav class="container" id="spa-nav"><div class="track"><a class="btn" data-page="home" href="#home">🏠 Главная</a><a class="btn" data-page="services" href="#services">🧩 Услуги</a><a class="btn" data-page="about" href="#about">👩‍💼 Обо мне</a><a class="btn" data-page="faq" href="#faq">❓ Вопросы</a><a class="btn" data-page="bonuses" href="#bonuses">🎁 Бонусы</a><a class="btn" data-page="community" href="#community">🤝 Сообщество</a><a class="btn" data-page="consult" href="#consult">📅 Консультация</a><a class="btn" data-page="invite" href="#invite">🎯 Партнерка</a><span class="bubble" aria-hidden="true"></span></div></nav>

<main class="container">

  <section class="page" id="home">

    <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>

    <!-- Savings widget -->
    <div class="grid grid-2 reveal" style="margin-top:14px">
      <div class="card savings">
        <div class="h1 reveal">Быстрый <span>расчет прибыли</span> бизнеса</div>
        <div class="row">
          <label>Выручка: <strong id="revVal">10 000 000 ₽</strong></label>
          <input id="rev" type="range" min="500000" max="50000000" step="500000" value="10000000">
        </div>
        <div class="row">
          <label>Эффект оптимизации: <strong id="pctVal">12%</strong></label>
          <input id="pct" type="range" min="1" max="30" step="1" value="12">
        </div>
        <div class="stat">
          <div class="badge">Было: <span id="oldTax">1 500 000 ₽</span></div>
          <div class="badge">Стало: <span id="newTax">1 320 000 ₽</span></div>
        </div>
        <div>Потенциальная экономия:</div>
        <div class="big" id="saveCounter">0 ₽</div>
        <div class="cta"><button class="btn btn-primary confetti" id="ctaCalc">Получить персональный расчёт</button></div>
      </div>
<div class="card reveal" style="margin-bottom:12px"><div class="h1 reveal" style="margin-bottom:20px">Как <span>мы</span> работаем</div><div id="flow" style="display:grid;gap:8px"><div class="badge">Шаг 1 · Диагностика</div><div class="badge">Шаг 2 · План оптимизации</div><div class="badge">Шаг 3 · Внедрение</div><div class="badge">Шаг 4 · Контроль и отчёты</div></div><div class="cta" style="margin-top:10px"><button class="btn btn-primary" id="flowNext">Дальше</button><button class="btn btn-ghost" id="flowReset">Сбросить</button></div></div>
      <div class="card">
        <div class="h1 reveal" style="margin-bottom:20px">Что <span>делать</span> дальше</div>
        <ul class="list">
          <li><span class="dot"></span>Запускаем калькулятор в боте</li>
          <li><span class="dot"></span>Фиксируем источник «утечек»</li>
          <li><span class="dot"></span>Формируем пошаговый план</li>
        </ul>
        <div class="highlight-banner" style="text-align:left"><strong>Бонус:</strong> мини‑гайд «Как перейти на выгодный режим»</div>
      </div>

  </section>

  <section class="page" id="services">
<div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
<div class="card reveal"><h3>Тарифы</h3><div class="cta"><button class="btn btn-primary svcMode" data-mode="month">Месяц</button><button class="btn btn-ghost svcMode" data-mode="year">Год −15%</button></div></div><div class="card price reveal" data-base="30000"><h3>📈 Продвижение на Авито</h3><p class="lead" style="font-size:14px">Ваши объявления будут выходить на первые позиции — поток заявок при минимальном бюджете.</p><div class="big" data-price>30,000 ₽</div></div><div class="card price reveal" data-base="60000"><h3>🎯 Контекстная реклама</h3><p class="lead" style="font-size:14px">Яндекс.Директ и Google Ads: кампании без слива бюджета, под ваши KPI.</p><div class="big" data-price>60,000 ₽</div></div><div class="card price reveal" data-base="45000"><h3>🔍 SEO и сайты (Tilda/MODx)</h3><p class="lead" style="font-size:14px">Сайт‑магнит: оптимизация, структура, тексты под спрос.</p><div class="big" data-price>45,000 ₽</div></div><div class="card price reveal" data-base="55000"><h3>🤖 CRM и чат‑боты</h3><p class="lead" style="font-size:14px">Amo/Bitrix24 + боты: заявки 24/7, ничего не теряется.</p><div class="big" data-price>55,000 ₽</div></div><div class="card price reveal" data-base="40000"><h3>🛒 Маркетплейсы</h3><p class="lead" style="font-size:14px">Карточки под ключ: фото, описание, ключи, продвижение в площадке.</p><div class="big" data-price>40,000 ₽</div></div><div class="card price reveal" data-base="50000"><h3>📊 Аналитика и стратегия</h3><p class="lead" style="font-size:14px">Сквозная аналитика + карта действий на 6–12 мес.</p><div class="big" data-price>50,000 ₽</div></div><div class="card price reveal" data-base="35000"><h3>💬 Репутация и SMM</h3><p class="lead" style="font-size:14px">Образ бренда и работа с отзывами.</p><div class="big" data-price>35,000 ₽</div></div><div class="card price reveal" data-base="38000"><h3>📲 Telegram‑маркетинг</h3><p class="lead" style="font-size:14px">Канал, рассылки, воронки, связка с CRM.</p><div class="big" data-price>38,000 ₽</div></div><div class="card price reveal" data-base="70000"><h3>⚡ Mini‑Apps в Telegram</h3><p class="lead" style="font-size:14px">Калькуляторы, квизы, лид‑формы, интеграции.</p><div class="big" data-price>70,000 ₽</div></div>
    </div>
<div class="card reveal" style="margin-bottom:12px">
  <div class="h1 reveal">Быстрый квиз: <span>что даст</span> наибольшую экономию?</div>
  <div id="quiz" data-step="0">
    <div id="q0" class="q">
      <div class="lead" style="font-size:14px">Выручка в месяц?</div>
      <div class="cta">
        <button class="btn btn-ghost quiz-option" data-score="1">до 1 млн</button>
        <button class="btn btn-ghost quiz-option" data-score="2">1–5 млн</button>
        <button class="btn btn-ghost quiz-option" data-score="3">5–20 млн</button>
        <button class="btn btn-ghost quiz-option" data-score="4">20+ млн</button>
      </div>
    </div>
    <div id="q1" class="q" style="display:none">
      <div class="lead" style="font-size:14px">Доля расходов к выручке?</div>
      <div class="cta">
        <button class="btn btn-ghost quiz-option" data-score="1">до 20%</button>
        <button class="btn btn-ghost quiz-option" data-score="2">20–40%</button>
        <button class="btn btn-ghost quiz-option" data-score="3">40–60%</button>
        <button class="btn btn-ghost quiz-option" data-score="4">60%+</button>
      </div>
    </div>
    <div id="q2" class="q" style="display:none">
      <div class="lead" style="font-size:14px">Есть НДС‑клиенты / входной НДС?</div>
      <div class="cta">
        <button class="btn btn-ghost quiz-option" data-score="2">Да, часто</button>
        <button class="btn btn-ghost quiz-option" data-score="1">Редко/нет</button>
      </div>
    </div>
    <div id="quizResult" style="display:none">
      <div class="h1" style="font-size:22px">Результат</div>
      <p class="lead" id="quizText" style="font-size:14px"></p>
      <div class="cta">
        <a class="btn btn-primary" href="https://t.me/pravuchet_bot?start=get_table" target="_blank" rel="noopener">Запустить калькулятор</a>
        <button class="btn btn-ghost" id="quizReset">Пройти заново</button>
      </div>
    </div>
  </div>
</div>    

  </section>

  <section class="page" id="about">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
<div class="grid grid-2 reveal">
  <div class="card"><h3>Путь</h3><ul class="list">
    <li><span class="dot"></span>2014 — старт в учёте и 1С</li>
    <li><span class="dot"></span>2018 — первые автоматизации</li>
    <li><span class="dot"></span>2022 — ниша e‑commerce</li>
    <li><span class="dot"></span>2024 — мини‑приложения и боты</li>
  </ul></div>
  <div class="card"><h3>Факты</h3><ul class="list">
    <li><span class="dot"></span>50+ проектов</li>
    <li><span class="dot"></span>Средняя экономия 12–30%</li>
    <li><span class="dot"></span>Срок запуска 5–10 дней</li>
  </ul></div>
</div>

  </section>

  <section class="page" id="bonuses">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
<div class="grid grid-3">
      <div class="card tilt reveal">
        <h3>Регистрация бизнеса</h3>
        <ul class="list">
          <li><span class="dot"></span>Подбор ОКВЭД и формы (ИП/ООО)</li>
          <li><span class="dot"></span>Документы + подача онлайн</li>
          <li><span class="dot"></span>Подключение 1С и настройка</li>
        </ul>
        <div class="cta"><button class="btn btn-primary toast-btn" data-msg="Свяжемся и подготовим документы за 1–2 дня.">Оформить регистрацию</button></div>
      </div>
      <div class="card tilt reveal">
        <h3>Подбор системы налогообложения</h3>
        <ul class="list">
          <li><span class="dot"></span>УСН 6% / УСН 15% / Патент / ОСНО</li>
          <li><span class="dot"></span>Сравнение по данным</li>
          <li><span class="dot"></span>Рекомендация за 10 минут</li>
        </ul>
        <div class="cta"><a class="btn btn-primary" href="https://t.me/pravuchet_bot?start=mode" target="_blank" rel="noopener">Подобрать режим</a></div>
      </div>
      <div class="card tilt reveal">
        <h3>Экспресс‑аудит</h3>
        <ul class="list">
          <li><span class="dot"></span>«Рентген» финансов</li>
          <li><span class="dot"></span>Убыточные направления</li>
          <li><span class="dot"></span>Список быстрых правок</li>
        </ul>
        <div class="cta"><a class="btn btn-primary" href="https://t.me/pravuchet_bot?start=audit" target="_blank" rel="noopener">Получить экспресс‑аудит</a></div>
      </div>
  <div class="card">
    <h3>Колесо призов сообщества</h3>
    <p class="lead" style="font-size:14px">Разыгрываем консультацию/шаблоны каждую неделю среди активных.</p>
    <div class="cta"><button class="btn btn-primary" id="spin">Крутить 🎡</button></div>
    <div id="spinRes" class="lead" style="font-size:14px; margin-top:8px"></div>
  </div>
  <div class="grid grid-3 reveal" style="margin-top:12px">

    </div>

</div>

  </section>

  <section class="page" id="faq">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
      <div class="card tilt reveal"><h3>Сколько занимает экспресс‑аудит?</h3><p class="lead" style="font-size:14px">Обычно 1–2 дня. Быстрые правки — сразу.</p></div>
      <div class="card tilt reveal"><h3>Реально ли подобрать режим за 5 минут?</h3><p class="lead" style="font-size:14px">Да. Нужны выручка, расходы и ФОТ.</p></div>
    </div>
  
<div class="card reveal" style="margin-top:12px">
  <h3>Быстрые ответы</h3>
  <div class="cta">
    <button class="btn btn-ghost copy" data-text="Подбор режима за 5 минут в мини‑приложении.">Скопировать ✂️ «Как быстро?»</button>
    <button class="btn btn-ghost copy" data-text="Да, работаем с Ozon/WB: комиссии, логистика, возвраты.">Скопировать ✂️ «Маркетплейсы?»</button>
  </div>
  <div class="cta">
    <input id="faqSearch" placeholder="Найти ответ…" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); color:#fff">
    <button class="btn btn-primary" id="faqDoSearch">Искать</button>
  </div>
  <div id="faqResult" class="lead" style="font-size:14px; margin-top:8px; color:#a7acc2"></div>
</div>

  </section>

</main>

  <section class="page" id="community">

    <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
 <div class="card">
    <h3>Хайлайт недели</h3>
    <ul class="list">
      <li><span class="dot"></span>Самая активная тема — НДС на маркетплейсах</li>
      <li><span class="dot"></span>Лучший ответ — @you (гайд по УСН 15%)</li>
      <li><span class="dot"></span>Встреча в четверг, 19:00</li>
    </ul>
  </div>
    </div>
  </div>
  <div class="card" style="display:grid; place-items:center">
    <div style="position:relative; width:140px; height:140px">
      <svg viewBox="0 0 120 120" width="140" height="140">
        <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.12)" stroke-width="12" fill="none"/>
        <circle id="ring" cx="60" cy="60" r="52" stroke="url(#g1)" stroke-width="12" fill="none"
          stroke-dasharray="327" stroke-dashoffset="327" stroke-linecap="round" transform="rotate(-90 60 60)"/>
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="var(--mint)"/>
            <stop offset="1" stop-color="var(--primary)"/>
          </linearGradient>
        </defs>
      </svg>
      <div id="ringText" style="position:absolute; inset:0; display:grid; place-items:center; font-weight:800">0%</div>
    </div>
    <div class="lead" style="font-size:12px; margin-top:8px">Прогресс челленджа недели</div>
  </div>
</div>
 <div class="card">
    <h3>Статистика сообщества</h3>
    <div class="grid grid-3" style="gap:12px">
      <div class="card" style="text-align:center">
        <div class="big" data-count="137" data-suffix="">0</div>
        <div class="lead" style="font-size:12px">участников онлайн</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="big" data-count="42" data-suffix="">0</div>
        <div class="lead" style="font-size:12px">ответов за неделю</div>
      </div>
      <div class="card" style="text-align:center">
        <div class="big" data-count="19" data-suffix="">0</div>
        <div class="lead" style="font-size:12px">новых гайдов</div>
      </div>


  </section>

</main>

  <section class="page" id="consult">
    <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>
    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
    <div class="grid grid-2">
      <div class="card reveal">
        <h3>Выберите формат</h3>
        <div class="cta">
          <button class="btn btn-primary consult-type" data-type="call">📞 Звонок</button>
          <button class="btn btn-ghost consult-type" data-type="zoom">💻 Zoom</button>
          <button class="btn btn-ghost consult-type" data-type="office">🏢 Офис</button>
        </div>
        <div class="highlight-banner" id="tzInfo">Часовой пояс: …</div>
        <div class="savings">
      </div>
    </div>          
<div class="card" style="background:rgba(255,255,255,.04)">
  <div class="h1" style="font-size:18px;margin:0 0 8px">Календарь</div>
  <div id="cal" class="calendar"></div>
</div>
<div class="cta" style="margin-top:10px">
  <span class="badge-pill">Выберете длительность консультации:</span>
  <button class="btn btn-primary dur" data-min="30">30 мин</button>
  <button class="btn btn-ghost dur" data-min="60">60 мин</button>
  <button class="btn btn-ghost dur" data-min="90">90 мин</button>
</div>
<div style="margin-top:10px">Свободные слоты:<div id="slots" class="cta" style="margin-top:8px"></div></div>
</div>
          <div class="row">
            <label>:</label>
            <input id="contact" placeholder="@username или +7…"
              style="padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); color:#fff">
          </div>
          <div class="cta">
            <button class="btn btn-primary" id="confirmConsult">Подтвердить</button>
            <a class="btn btn-ghost" id="icsBtn" download="consult.ics" style="display:none">Добавить в календарь</a>
          </div>
        </div>
      </div>
      <div class="card reveal">
        <h3>Как проходит консультация</h3>
        <ul class="list">
          <li><span class="dot"></span>15–20 минут диагностика задач</li>
          <li><span class="dot"></span>Разбор цифр и быстрых гипотез</li>
          <li><span class="dot"></span>Фиксация плана на 1–2 недели</li>
        </ul>
        <div class="highlight-banner">Если не получите пользу — вернём деньги за первую сессию</div>
      </div>
    </div>
  </section>

  <section class="page" id="invite">
        <div class="h1 reveal">Покажем, где утекают деньги и <span>дадим план действий</span> с понятной экономией</div>
    <p class="lead reveal">❗️ <strong>Если по итогам не станет ясно</strong>, как улучшить результат — дарим 60 минут консультации бесплатно.</p>

    <!-- KPI marquee -->
    <div class="kpi-strip reveal">
      <div class="kpi-track" id="kpiTrack">
        <div class="kpi">📈 LTV <span class="v" id="k1">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v" id="k2">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>

        <div class="kpi">📈 LTV <span class="v">+0%</span></div>
        <div class="kpi">💰 Экономия налогов <span class="v">0 ₽</span></div>
        <div class="kpi">🕒 Срок внедрения <span class="v">5–10 дн</span></div>
        <div class="kpi">🧾 Автомат. отчёты <span class="v">✓</span></div>
      </div>
    </div>
    <div class="grid grid-2">
      <div class="card reveal">
        <h3>Твоя реферальная ссылка</h3>
        <div class="cta">
          <input id="refLink" readonly style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); color:#fff">
          <button class="btn btn-primary" id="copyRef">Скопировать</button>
          <button class="btn btn-ghost" id="shareRef">Поделиться</button>
        </div>
        <div class="highlight-banner">За каждого активного друга — бонусы и приоритетные ответы</div>
        <div class="cta"><button class="btn btn-ghost" id="simulateRef">+1 приглашение (демо)</button></div>
      </div>
      <div class="card reveal">
        <h3>Таблица лидеров</h3>
        <div id="leaders" class="list"></div>
        <div class="cta" style="margin-top:10px">
          <button class="btn btn-primary" id="resetBoard">Сбросить демо‑данные</button>
        </div>
      </div>
    </div>
  </section>

<footer>© 2025 • Информационный сервис. Не является налоговой консультацией.</footer>

<!-- Onboarding -->
<div class="onb" id="onb">
  <div class="box">
    <div class="h1" style="font-size:19px">Добро пожаловать! 👋</div>
    <div class="steps">
      <div class="step"><div class="num">1</div><div>Нажмите <b>📊 Калькулятор</b> — за 5 минут увидите, где экономия.</div></div>
      <div class="step"><div class="num">2</div><div>Откройте <b>Услуги</b> — там быстрые шаги по регистрации и аудиту.</div></div>
      <div class="step"><div class="num">3</div><div>Нажмите на кнопки — появятся подсказки и тосты с советами.</div></div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" id="onbLater">Позже</button>
      <button class="btn btn-primary" id="onbGo">Погнали</button>
    </div>
  </div>
</div>

<!-- Toasts & Console -->
<div class="toasts" id="toasts"></div>
<button class="btn btn-ghost console-toggle">🔧 Профиль</button>
<div class="console-panel" id="consolePanel"></div>

<script>

// === Globals & safe helpers ===
window.ALLOW_DRAG = (function(){ try { return matchMedia('(pointer: coarse)').matches; } catch(e){ return false; } })();
function fmtRUR(n){ return (n||0).toLocaleString('ru-RU') + ' ₽'; }


// === v14 Router helpers ===
function __pickInitialPage(){
  const url = new URL(location.href);
  let page = (url.searchParams.get('page')||'').trim();
  if(!page && location.hash) page = location.hash.replace('#','').trim();
  if(!page){
    page = (url.searchParams.get('tgWebAppStartParam')||url.searchParams.get('startapp')||url.searchParams.get('start_param')||'').trim();
  }
  if(!page || !document.getElementById(page)) page = 'home';
  return page;
}
function __updateURL(page){
  try{
    const u = new URL(location.href);
    u.searchParams.set('page', page);
    history.replaceState(null, '', u.pathname + u.search + '#' + page);
  }catch(e){ location.hash = page; }
}


// ===== In-page console (disabled in v23) =====
(function(){
  // Keep the toggle working for profile/panel later; no log hooking
  const panel = document.getElementById('consolePanel');
  const btn = document.querySelector('.console-toggle');
  if(btn && panel){
    btn.addEventListener('click', ()=>{
      panel.style.display='block'; panel.classList.toggle('open');
    });
  } //
})();

// ===== Nav: robust clicks + drag threshold + keep carousel look =====
(function(){
  const nav = document.getElementById('spa-nav');
  const track = nav.querySelector('.track');
  const pages = document.querySelectorAll('section.page');

  // Expose showPage
  window.__showPage = function(id){
    pages.forEach(p=>p.classList.toggle('active', p.id===id));
    track.querySelectorAll('[data-page]').forEach(el=>el.classList.toggle('active', el.getAttribute('data-page')===id));
    if (window.__centerNavActive) window.__centerNavActive();
    console.log('page_view', {page:id});
  };

  // Delegate clicks (desktop-safe), prevent ghost clicks after drag
  let dragged = false;
  track.addEventListener('click', (e)=>{
    if (dragged) { dragged = false; return; }
    const a = e.target.closest('[data-page]');
    if(!a) return;
    e.preventDefault();
    __showPage(a.getAttribute('data-page')); __updateURL(a.getAttribute('data-page'));
    history.replaceState(null,'','#'+a.getAttribute('data-page'));
  });

  // Drag scroll with threshold
  let isDown=false, sx=0, sl=0;
  track.addEventListener('pointerdown', (e)=>{ if (!ALLOW_DRAG) return;
    isDown=true; dragged=false; sx=e.clientX; sl = track.scrollLeft; track.setPointerCapture(e.pointerId);
  });
  track.addEventListener('pointermove', (e)=>{ if (!ALLOW_DRAG) return;
    if(!isDown) return;
    const dx = e.clientX - sx;
    if (Math.abs(dx) > 6) dragged = true;
    track.scrollLeft = sl - dx;
  });
  track.addEventListener('pointerup', ()=>{ isDown=false; });

  // Keyboard support
  track.querySelectorAll('[data-page]').forEach(a=>{
    a.setAttribute('tabindex','0');
    a.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        __showPage(a.getAttribute('data-page')); __updateURL(a.getAttribute('data-page'));
      }
    });
  });

  const initial = (window.__pickInitialPage ? __pickInitialPage() : (location.hash||'#home').replace('#','')||'home'); __showPage(initial);
__updateURL(initial);
})();


// ===== Nav bubble & carousel logic =====
(function(){
  const nav = document.getElementById('spa-nav');
  const track = nav.querySelector('.track');
  const links = [...track.querySelectorAll('[data-page]')];
  const bubble = track.querySelector('.bubble');
  
  const ALLOW_DRAG = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
function moveBubble(){
    const a = track.querySelector('.btn.active') || links[0];
    if(!a) return;
    const r = a.getBoundingClientRect();
    const nr = track.getBoundingClientRect();
    bubble.style.left = (a.offsetLeft - track.scrollLeft + 6) + 'px';
    bubble.style.width = r.width + 'px';
  }
  function centerActive(){
    const a = track.querySelector('.btn.active'); if(!a) return;
    a.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    setTimeout(moveBubble, 220);
  }
  window.__centerNavActive = centerActive;
  // delegated clicks + drag threshold
  let isDown=false, sx=0, sl=0, moved=false;
  track.addEventListener('pointerdown', (e)=>{ if (!ALLOW_DRAG) return;isDown=true;moved=false;sx=e.clientX;sl = track.scrollLeft;track.setPointerCapture(e.pointerId)});
  track.addEventListener('pointermove', (e)=>{ if (!ALLOW_DRAG) return; if(!isDown) return; const dx=e.clientX-sx; if(Math.abs(dx)>6) moved=true; track.scrollLeft = sl-dx; moveBubble();});
  track.addEventListener('pointerup', ()=>{isDown=false});
  track.addEventListener('click', (e)=>{ if (ALLOW_DRAG && moved) { moved=false; return; } const a=e.target.closest('[data-page]'); if(!a) return; e.preventDefault(); show(a.getAttribute('data-page')); history.replaceState(null,'','#'+a.getAttribute('data-page')); });
  track.addEventListener('scroll', ()=>{ // update scaling + bubble on scroll
    requestAnimationFrame(()=>{ scaleItems(); moveBubble(); });
  }, {passive:true});
  window.addEventListener('resize', ()=>{ scaleItems(); moveBubble(); });
  // scaling like before
  function scaleItems(){
    const rect = nav.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    links.forEach(a=>{
      const r = a.getBoundingClientRect();
      const ax = r.left + r.width/2;
      const d = Math.abs(ax - cx);
      const k = Math.max(0.9, 1.0 - d / (rect.width*0.9));
      a.style.transform = `scale(${k.toFixed(3)})`;
      a.style.opacity = String(0.65 + (k-0.9)*2.4);
    });
  }
  // expose show (reusing old one if exists)
  window.show = window.show || function(id){
    document.querySelectorAll('section.page').forEach(p=>p.classList.toggle('active', p.id===id));
    links.forEach(el=>el.classList.toggle('active', el.getAttribute('data-page')===id));
    centerActive();
    console.log('page_view', {page:id});
  };
  const initial = (window.__pickInitialPage ? __pickInitialPage() : (location.hash||'#home').replace('#','')||'home'); show(initial);
__updateURL(initial);
setTimeout(()=>{ scaleItems(); moveBubble(); }, 60);
})();

// ===== Background particles (canvas) =====
(function(){
  const c = document.getElementById('bg-canvas');
  const ctx = c.getContext('2d');
  let w, h, particles;
  function resize(){
    w = c.width = innerWidth; h = c.height = innerHeight;
    particles = Array.from({length: Math.min(120, Math.floor(w*h/16000))}, ()=>({
      x: Math.random()*w, y: Math.random()*h,
      r: Math.random()*2 + 0.5,
      vx: (Math.random()-.5)*0.4,
      vy: (Math.random()-.5)*0.4,
      a: Math.random()
    }));
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for (const p of particles){
      p.x += p.vx; p.y += p.vy;
      if (p.x<0||p.x>w) p.vx*=-1;
      if (p.y<0||p.y>h) p.vy*=-1;
      ctx.globalAlpha = 0.5 + 0.5*Math.sin(p.a+=0.02);
      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*4);
      g.addColorStop(0,'rgba(61,224,197,.35)');
      g.addColorStop(1,'rgba(123,91,255,0)');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r*4,0,Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  addEventListener('resize', resize, {passive:true});
  resize(); tick();
  console.log('particles:init');
})();

// ===== Scroll reveal =====
(function(){
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if (e.isIntersecting) { e.target.classList.add('visible'); obs.unobserve(e.target); } });
  }, {threshold: 0.12});
  document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
})();

// ===== Magnetic buttons =====
(function(){
  const strength = 22;
  document.querySelectorAll('.magnetic').forEach(btn=>{
    btn.addEventListener('mousemove', e=>{
      const r = btn.getBoundingClientRect();
      const x = e.clientX - (r.left + r.width/2);
      const y = e.clientY - (r.top + r.height/2);
      btn.style.transform = `translate(${x/strength}px, ${y/strength}px)`;
    });
    btn.addEventListener('mouseleave', ()=> btn.style.transform = '');
  });
})();

// === Bonuses: spin wheel (single & deduped) ===
(function(){
  const section = document.getElementById('bonuses'); if (!section) return;
  const btn0 = section.querySelector('#spin');
  const out  = section.querySelector('#spinRes');
  if (!btn0 || !out) return;

  // 1) Жёстко снимаем ВСЕ старые слушатели с кнопки
  const btn = btn0.cloneNode(true);
  btn0.replaceWith(btn);

  // 2) Синглтон-анонс приза (не даст показать тост дважды)
  const announcePrize = (() => {
    let locked = false, timer;
    return (text) => {
      if (locked) return;
      locked = true;
      try { showToast('Поздравляю!', text); } catch(e){}
      clearTimeout(timer);
      timer = setTimeout(() => { locked = false; }, 1500);
    };
  })();

  // 3) Само вращение
  const prizes = [
    '🎁 Шаблон «Оффер»',
    '📘 Чек-лист аудита',
    '💬 +30 мин консультации',
    '🧮 Доступ к калькулятору PRO',
    '⭐ Приоритетный разбор'
  ];

  let busy = false;
  btn.addEventListener('click', () => {
    if (busy) return;
    busy = true;
    out.textContent = 'Крутим…';

    const total = 1800 + Math.floor(Math.random() * 900);
    const t0 = performance.now();

    const tick = (t) => {
      if (t - t0 >= total) {
        const win = prizes[Math.floor(Math.random() * prizes.length)];
        out.textContent = 'Выпало: ' + win;
        announcePrize(win);       // ← тост гарантированно один раз
        busy = false;
        return;
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  });
})();

// ===== Tilt cards =====
(function(){
  const max = 10;
  document.querySelectorAll('.tilt').forEach(card=>{
    card.addEventListener('mousemove', e=>{
      const r = card.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width - 0.5;
      const py = (e.clientY - r.top) / r.height - 0.5;
      card.style.transform = `rotateY(${px*max}deg) rotateX(${ -py*max}deg) translateY(-6px)`;
    });
    card.addEventListener('mouseleave', ()=> card.style.transform = '');
  });
})();

// ===== Ripple + Confetti =====
(function(){
  // ripple
  document.body.addEventListener('click', function(e){
    const t = e.target.closest('.btn');
    if(!t) return;
    const r = document.createElement('span');
    const size = Math.max(t.clientWidth, t.clientHeight);
    const rect = t.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    r.style.cssText = `position:absolute; left:0; top:0; width:${size}px; height:${size}px; border-radius:50%;
      transform:translate(${x - size/2}px, ${y - size/2}px);
      background:rgba(255,255,255,.25); pointer-events:none; animation:ripple .6s ease-out`;
    t.appendChild(r); setTimeout(()=>r.remove(), 600);
  });
  const style = document.createElement('style');
  style.textContent = `@keyframes ripple{from{transform:scale(.2);opacity:.7}to{transform:scale(1.8);opacity:0}}`;
  document.head.appendChild(style);

  // confetti
  document.querySelectorAll('.confetti').forEach(btn=>btn.addEventListener('click', (e)=>{
    e.preventDefault();
    runConfetti(e.clientX, e.clientY);
    showToast('Готово!', 'Отправим чек‑лист и заявку в течение дня.');
  }));
  function runConfetti(x,y){
    const c = document.createElement('canvas');
    c.width = innerWidth; c.height = innerHeight;
    Object.assign(c.style,{position:'fixed',left:0,top:0,pointerEvents:'none',zIndex:999});
    document.body.appendChild(c);
    const ctx = c.getContext('2d');
    const N = 140, P = [];
    for(let i=0;i<N;i++){
      P.push({
        x, y, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2,
        g:0.2+Math.random()*0.2, s:4+Math.random()*5, r:Math.random()*Math.PI,
        col: `hsl(${Math.random()*360},90%,60%)`
      });
    }
    let t = 0;
    (function tick(){
      ctx.clearRect(0,0,c.width,c.height);
      P.forEach(p=>{
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.r += 0.08;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle = p.col; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
        ctx.restore();
      });
      t++; if (t<180) requestAnimationFrame(tick); else c.remove();
    })();
  }
})();

// ===== Toasts =====
function showToast(title, msg, timeout=3500){
  const box = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = `<div class="t">${title}</div><div class="m">${msg||''}</div>`;
  box.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-6px)'; }, timeout);
  setTimeout(()=> t.remove(), timeout+600);
}
document.querySelectorAll('.toast-btn').forEach(b=>b.addEventListener('click',()=>showToast('Заявка', b.dataset.msg)));


// === Community: counters & ring progress ===
(function(){
  const host = document.getElementById('community'); if(!host) return;
  host.querySelectorAll('.big[data-count]').forEach(el=>{
    const target = parseInt(el.getAttribute('data-count'),10)||0;
    const suffix = el.getAttribute('data-suffix')||'';
    let cur = 0;
    const step = Math.max(1, Math.round(target/50));
    const tick = ()=>{
      cur = Math.min(target, cur+step);
      el.textContent = cur.toLocaleString('ru-RU') + suffix;
      if(cur < target) requestAnimationFrame(tick);
    };
    tick();
  });
  const ring = host.querySelector('#ring');
  const txt  = host.querySelector('#ringText');
  if(ring && txt){
    const full = 327;
    let val = 0, target = 62;
    const anim = ()=>{
      val = Math.min(target, val+2);
      ring.style.strokeDashoffset = String(full - full*val/100);
      txt.textContent = val + '%';
      if(val < target) requestAnimationFrame(anim);
    };
    anim();
  }
})();

// ===== KPI counters (animated) =====
(function(){
  const k1 = document.getElementById('k1');
  const k2 = document.getElementById('k2');
  let v1=0, v2=0;
  function step(){
    v1 = Math.min(35, v1 + 1);
    v2 = Math.min(1500000, v2 + Math.round(50000*Math.random()+20000));
    k1.textContent = `+${v1}%`;
    k2.textContent = v2.toLocaleString('ru-RU') + ' ₽';
    if (v1<35 || v2<1500000) requestAnimationFrame(step);
  }
  step();
})();


// === Services tariff toggle (Месяц/Год −15%) ===
(function(){
  const box = document.getElementById('services'); if(!box) return;
  const btns = box.querySelectorAll('.svcMode');
  const cards = box.querySelectorAll('.card.price[data-base]');
  if(!btns.length || !cards.length) return;
  let mode = 'month';
  function apply(){
    cards.forEach(c=>{
      const base = parseInt(c.getAttribute('data-base'),10) || 0;
      const priceNode = c.querySelector('[data-price]');
      if(!priceNode) return;
      if(mode==='month'){
        priceNode.textContent = fmtRUR(base);
      }else{
        const y = Math.round(base*12*0.85);
        priceNode.textContent = fmtRUR(y) + ' / 12 мес.';
      }
    });
    btns.forEach(b=>{
      const is = b.getAttribute('data-mode') === mode;
      b.classList.toggle('btn-primary', is);
      b.classList.toggle('btn-ghost', !is);
      b.setAttribute('aria-pressed', is ? 'true' : 'false');
    });
  }
  btns.forEach(b=> b.addEventListener('click', ()=>{ mode = b.getAttribute('data-mode'); apply(); }));
  apply();
})();

// ===== Savings widget logic =====
(function(){
  const rev = document.getElementById('rev');
  const pct = document.getElementById('pct');
  const revVal = document.getElementById('revVal');
  const pctVal = document.getElementById('pctVal');
  const oldTax = document.getElementById('oldTax');
  const newTax = document.getElementById('newTax');
  const saveCounter = document.getElementById('saveCounter');

  function fmt(n){ return n.toLocaleString('ru-RU') + ' ₽'; }
  function animateTo(el, target){
    const start = parseInt((el.textContent||'0').replace(/[^\d]/g,''))||0;
    const dur = 600; const t0 = performance.now();
    function tick(t){
      const k = Math.min(1, (t-t0)/dur);
      const val = Math.round(start + (target-start)*k);
      el.textContent = fmt(val);
      if(k<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }
  function recalc(){
    const R = +rev.value; const P = +pct.value/100;
    revVal.textContent = R.toLocaleString('ru-RU')+' ₽';
    pctVal.textContent = Math.round(P*100)+'%';
    // простая модель: "старые налоги" = 15% от выручки, "новые" = 15%*(1-P)
    const oldT = Math.round(R*0.15);
    const newT = Math.round(oldT*(1-P));
    const save = oldT - newT;
    oldTax.textContent = fmt(oldT);
    newTax.textContent = fmt(newT);
    animateTo(saveCounter, save);
  }
  rev.addEventListener('input', recalc);
  pct.addEventListener('input', recalc);
  recalc();
  document.getElementById('ctaCalc').addEventListener('click', ()=>showToast('Расчёт отправлен', 'Мы уточним детали и вернёмся с рекомендацией.'));
})();



// === Consultation: format + duration + slots ===
(function(){
  const scope = document.getElementById('consult'); if(!scope) return;
  const types = scope.querySelectorAll('.consult-type');
  let ctype = 'call';
  types.forEach(b=> b.addEventListener('click', ()=>{
    ctype = b.getAttribute('data-type');
    types.forEach(x=>{
      const on = x===b;
      x.classList.toggle('btn-primary', on);
      x.classList.toggle('btn-ghost', !on);
    });
  }));
  const durs = scope.querySelectorAll('.dur');
  let dmin = 30;
  function markDur(btn){
    durs.forEach(x=>{
      const on = x===btn;
      x.classList.toggle('btn-primary', on);
      x.classList.toggle('btn-ghost', !on);
    });
  }
  durs.forEach(b=> b.addEventListener('click', ()=>{ dmin = +b.getAttribute('data-min'); markDur(b); renderSlots(); }));
  const def = scope.querySelector('.dur[data-min="30"]'); if(def){ markDur(def); }
  const slotsEl = scope.querySelector('#slots');
  const calendar = scope.querySelector('.calendar, #cal, .date-grid, .days');
  function showSlots(){ if(slotsEl) slotsEl.classList.add('show'); }
  if(calendar){
    calendar.addEventListener('click', (e)=>{
      const day = e.target.closest('button, .cal-cell, .day');
      if(!day) return;
      calendar.querySelectorAll('.selected,.sel').forEach(x=>x.classList.remove('selected','sel'));
      day.classList.add('selected'); day.classList.add('sel');
      showSlots(); renderSlots();
    });
  } else {
    durs.forEach(b=> b.addEventListener('click', ()=>{ showSlots(); renderSlots(); }));
  }

  function renderSlots(){
    if(!slotsEl) return;
    slotsEl.innerHTML = '';
    const start = 10, end = 18;
    for(let h=start; h<=end; h++){
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.textContent = String(h).padStart(2,'0') + ':00 (' + dmin + ' мин)';
      btn.addEventListener('click', ()=>{
        slotsEl.querySelectorAll('.btn').forEach(x=>x.classList.remove('btn-primary'));
        btn.classList.add('btn-primary'); btn.classList.remove('btn-ghost');
        scope._selTime = btn.textContent;
      });
      slotsEl.appendChild(btn);
    }
  }
  /* render later after date is chosen */
})();

// ===== Consultation: calendar + slots =====
(function(){
  const calEl = document.getElementById('cal');
  if(!calEl) return;
  const slotsEl = document.getElementById('slots');
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  document.getElementById('tzInfo').textContent = 'Часовой пояс: ' + tz;

  let selDate = null;
  function buildCalendar(monthOffset=0){
    const today = new Date();
    const base = new Date(today.getFullYear(), today.getMonth()+monthOffset, 1);
    const year = base.getFullYear(), month = base.getMonth();
    const start = new Date(year, month, 1);
    const startDay = (start.getDay()+6)%7; // 0=Mon
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const daysPrev = new Date(year, month, 0).getDate();
    // header
    calEl.innerHTML = '<div class="cal-head"><button class="btn btn-ghost" id="prevM">←</button><div class="mon">'+base.toLocaleString("ru-RU",{month:"long", year:"numeric"})+'</div><button class="btn btn-ghost" id="nextM">→</button></div>';
    // weekdays
    const grid = document.createElement('div'); grid.className='cal-grid';
    ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].forEach(d=>{
      const c = document.createElement('div'); c.className='cal-dow'; c.textContent=d; grid.appendChild(c);
    });
    // prev month days
    for(let i=startDay-1; i>=0; i--){
      const n = daysPrev - i;
      const c = document.createElement('div'); c.className='cal-cell muted'; c.textContent=n; grid.appendChild(c);
    }
    // current month
    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(year, month, d);
      const c = document.createElement('div'); c.className='cal-cell'; c.textContent=d;
      if(date < new Date(today.getFullYear(), today.getMonth(), today.getDate())){ c.classList.add('off'); }
      c.onclick = ()=>{ selDate = date; grid.querySelectorAll('.cal-cell').forEach(x=>x.classList.remove('sel')); c.classList.add('sel'); renderSlots(); };
      grid.appendChild(c);
    }
    // next fillers
    while(grid.children.length % 7 !== 0){
      const c = document.createElement('div'); c.className='cal-cell muted'; c.textContent=''; grid.appendChild(c);
    }
    calEl.appendChild(grid);
    // nav
    calEl.querySelector('#prevM').onclick = ()=> buildCalendar(monthOffset-1);
    calEl.querySelector('#nextM').onclick = ()=> buildCalendar(monthOffset+1);
  }

  function renderSlots(){
    slotsEl.innerHTML='';
    if(!selDate) return;
    const start=10, end=19; // 10-19
    for(let h=start; h<=end; h++){
      const t=String(h).padStart(2,'0')+':00';
      const b=document.createElement('button'); b.className='btn btn-ghost'; b.textContent=t;
      b.onclick=()=>{ slotsEl.querySelectorAll('.btn').forEach(x=>x.classList.remove('btn-primary')); b.classList.add('btn-primary'); saveSelection(t); };
      slotsEl.appendChild(b);
    }
  }

  function saveSelection(time){
    localStorage.setItem('consult_selected', JSON.stringify({date: selDate.toISOString().slice(0,10), time}));
    showToast('Слот выбран', new Date(selDate.getTime()).toLocaleDateString('ru-RU') + ' ' + time);
  }

  buildCalendar(0);
})();

// ===== Onboarding =====
(function(){
  const key='onb_seen_v1';
  const onb=document.getElementById('onb');
  if(!localStorage.getItem(key)){
    onb.style.display='grid';
  }
  document.getElementById('onbLater').onclick=()=>{ onb.style.display='none'; };
  document.getElementById('onbGo').onclick=()=>{ localStorage.setItem(key,'1'); onb.style.display='none'; showToast('Добро пожаловать!','Начните с калькулятора или откройте Услуги'); };
})();

// ===== Services flow stepper =====
(function(){
  let step = 0;
  const flow = document.getElementById('flow');
  const items = flow.querySelectorAll('.badge');
  function draw(){
    items.forEach((b,i)=>{
      b.style.background = i<=step ? 'linear-gradient(135deg, var(--primary), var(--mint))' : 'rgba(255,255,255,.04)';
      b.style.borderColor = i<=step ? 'transparent' : 'rgba(255,255,255,.14)';
      b.style.color = i<=step ? '#fff' : '';
    });
  }
  draw();
  document.getElementById('flowNext').onclick = ()=>{ step = Math.min(items.length-1, step+1); draw(); };
  document.getElementById('flowReset').onclick = ()=>{ step = 0; draw(); };
})();

// ===== FAQ copy buttons =====
document.querySelectorAll('.copy').forEach(b=>b.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(b.dataset.text); showToast('Скопировано', 'Текст в буфере обмена'); }catch(e){ showToast('Не удалось скопировать'); }
}));

// ===== FAQ mini search (client-side demo) =====
(function(){
  const base = [
    {q:'сколько времени займёт', a:'Экспресс‑аудит: 1–2 дня. Подбор режима — 5 минут.'},
    {q:'маркетплейсы', a:'Да, работаем с Ozon/WB: учитываем комиссии, логистику, возвраты.'},
    {q:'ндс', a:'Помогаем считать входной/исходящий НДС и эффективную ставку.'},
    {q:'усн', a:'Подскажем, когда выгоднее 6% vs 15% и как перейти.'},
  ];
  const input = document.getElementById('faqSearch');
  const out = document.getElementById('faqResult');
  document.getElementById('faqDoSearch').onclick = ()=>{
    const s = (input.value||'').toLowerCase();
    if(!s){ out.textContent = 'Введите запрос'; return; }
    const hit = base.find(i=>s.includes(i.q));
    out.textContent = hit ? hit.a : 'Ответ не найден. Напишите нам в боте — подскажем.';
  };
})();



// === Invite: ref link + demo leaderboard ===
(function(){
  const box = document.getElementById('invite'); if(!box) return;
  const ref = box.querySelector('#refLink');
  const leaders = box.querySelector('#leaders');
  if(ref){
    const uid = (localStorage.getItem('uid') || (Date.now().toString(36)+Math.random().toString(36).slice(2,8)));
    localStorage.setItem('uid', uid);
    const bot = 'pravuchet_bot';
    ref.value = 'https://t.me/'+bot+'?start=ref_'+uid;
  }
  function render(){
    if(!leaders) return;
    const me = {name:'Ты', invites: +(localStorage.getItem('ref_count')||0)};
    const demo = [{name:'@alice',invites:7},{name:'@bob',invites:5},{name:'@mike',invites:3}];
    const arr = [me, ...demo].sort((a,b)=>b.invites-a.invites);
    leaders.innerHTML = arr.map((u,i)=>`<div class="lb-row"><span>${i+1}. ${u.name}</span><span class="badge-pill">${u.invites}</span></div>`).join('');
  }
  render();
  const sim = box.querySelector('#simulateRef');
  if(sim) sim.addEventListener('click', ()=>{ const n=+(localStorage.getItem('ref_count')||0)+1; localStorage.setItem('ref_count', n); render(); });
  const copy = box.querySelector('#copyRef');
  if(copy && ref) copy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(ref.value); showToast('Скопировано','Ссылка в буфере'); }catch(e){} });
  const share = box.querySelector('#shareRef');
  if(share && ref) share.addEventListener('click', async ()=>{
    if(navigator.share){ try{ await navigator.share({title:'Сообщество', text:'Присоединяйся', url:ref.value}); }catch(e){} }
    else { try{ await navigator.clipboard.writeText(ref.value); showToast('Скопировано','Ссылка в буфере'); }catch(e){} }
  });
})();

// ===== Community quiz =====
(function(){
  const quiz = document.getElementById('quiz'); if(!quiz) return;
  let step = 0, score = 0;
  function next(){
    document.getElementById('q'+step).style.display='none';
    step++;
    if(step<=2){ document.getElementById('q'+step).style.display='block'; }
    else {
      const res = document.getElementById('quizResult');
      const txt = document.getElementById('quizText');
      let msg = 'Скорее всего выгоднее УСН 6% c контролем расходов.';
      if(score>=8) msg = 'Рассмотрите ОСНО: входной НДС и вычеты могут дать экономию.';
      else if(score>=6) msg = 'УСН 15% («доходы-расходы») выглядит перспективно.';
      else if(score>=4) msg = 'УСН 6% + оптимизация расходов/взносов даст быстрый эффект.';
      txt.textContent = msg + ' Точный ответ — в калькуляторе.';
      res.style.display='block';
    }
  }
  quiz.querySelectorAll('.quiz-option').forEach(b=>b.addEventListener('click', ()=>{ score += +b.dataset.score; next(); }));
  document.getElementById('quizReset').onclick = ()=>{
    score=0; step=0;
    ['q0','q1','q2'].forEach((id,i)=>document.getElementById(id).style.display = i? 'none':'block');
    document.getElementById('quizResult').style.display='none';
  };
})();

// ===== Poll (local demo) =====
(function(){
  const out = document.getElementById('pollResult'); if(!out) return;
  const state = {cashflow: 12, tax: 18, ops: 9};
  document.querySelectorAll('.poll').forEach(b=>b.addEventListener('click', ()=>{
    state[b.dataset.id]++;
    const sum = state.cashflow + state.tax + state.ops;
    const pct = k => Math.round(state[k]*100/sum);
    out.textContent = `Кассовые разрывы — ${pct('cashflow')}% · Налоги — ${pct('tax')}% · Операционка — ${pct('ops')}%`;
    showToast('Спасибо!', 'Твой голос учтён');
  }));
})();

// ===== Consultation booking =====
(function(){
  const types = document.querySelectorAll('.consult-type');
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  const tzInfo = document.getElementById('tzInfo');
  const datePick = document.getElementById('datePick');
  const dateOut = document.getElementById('dateOut');
  const slots = document.getElementById('slots');
  const contact = document.getElementById('contact');
  const confirmBtn = document.getElementById('confirmConsult');
  const icsBtn = document.getElementById('icsBtn');
  if(!tzInfo) return;

  tzInfo.textContent = 'Часовой пояс: ' + tz;
  let SEL = {type:'call', date:null, time:null};

  types.forEach(b=>b.addEventListener('click', ()=>{
    types.forEach(x=>x.classList.toggle('btn-primary', x===b));
    types.forEach(x=>x.classList.toggle('btn-ghost', x!==b));
    SEL.type = b.dataset.type;
  }));

  // default date = tomorrow
  const tomorrow = new Date(Date.now()+24*3600*1000);
  datePick.valueAsDate = tomorrow;
  dateOut.textContent = tomorrow.toLocaleDateString('ru-RU');
  renderSlots(tomorrow);

  datePick.addEventListener('change', ()=>{
    const d = datePick.valueAsDate;
    dateOut.textContent = d ? d.toLocaleDateString('ru-RU') : '—';
    renderSlots(d);
  });

  function renderSlots(d){
    slots.innerHTML = '';
    if(!d) return;
    const start = 10, end = 19; // 10:00-19:00 local
    for(let h=start; h<=end; h+=1){
      const t = String(h).padStart(2,'0') + ':00';
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.textContent = t;
      btn.onclick = ()=>{
        slots.querySelectorAll('.btn').forEach(b=>b.classList.remove('btn-primary'));
        btn.classList.add('btn-primary');
        SEL.date = new Date(d); SEL.time = t;
      };
      slots.appendChild(btn);
    }
  }

  function makeICS(dtStart, dtEnd, summary, desc){
    function pad(n){return String(n).padStart(2,'0');}
    const y = dtStart.getFullYear(), m = pad(dtStart.getMonth()+1), d=pad(dtStart.getDate());
    const sh=pad(dtStart.getHours()), sm=pad(dtStart.getMinutes());
    const y2 = dtEnd.getFullYear(), m2 = pad(dtEnd.getMonth()+1), d2=pad(dtEnd.getDate());
    const eh=pad(dtEnd.getHours()), em=pad(dtEnd.getMinutes());
    const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PravUchet//MiniApp//RU
BEGIN:VEVENT
DTSTART:${y}${m}${d}T${sh}${sm}00
DTEND:${y2}${m2}${d2}T${eh}${em}00
SUMMARY:${summary}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;
    return new Blob([ics], {type:'text/calendar'});
  }

  confirmBtn.addEventListener('click', ()=>{
    if(!SEL.time || !datePick.valueAsDate){ showToast('Заполните данные', 'Выберите дату и время'); return; }
    if(!contact.value){ showToast('Укажите контакт', 'Телеграм или телефон'); return; }
    const d = new Date(datePick.value); const [hh,mm]=SEL.time.split(':');
    d.setHours(+hh, +mm, 0, 0);
    const de = new Date(d.getTime()+60*60*1000);
    localStorage.setItem('consult_booking', JSON.stringify({type:SEL.type, at:d.toISOString(), contact:contact.value}));
    showToast('Заявка отправлена', 'Мы подтвердим время в течение дня.');
    // build ICS
    const blob = makeICS(d, de, 'Консультация — Правильный учёт', `Формат: ${SEL.type}; Контакт: ${contact.value}`);
    const url = URL.createObjectURL(blob);
    icsBtn.href = url; icsBtn.style.display='inline-flex';
  });
})();

// ===== Invite / Leaderboard =====
(function(){
  const linkEl = document.getElementById('refLink');
  const copyBtn = document.getElementById('copyRef');
  const shareBtn = document.getElementById('shareRef');
  const simBtn = document.getElementById('simulateRef');
  const leadersEl = document.getElementById('leaders');
  const resetBtn = document.getElementById('resetBoard');
  if(!linkEl) return;

  // Generate / load code
  let code = localStorage.getItem('ref_code');
  if(!code){ code = Math.random().toString(36).slice(2,8).toUpperCase(); localStorage.setItem('ref_code', code); }
  const base = (location.origin || '') + (location.pathname || '');
  const link = base + '?ref=' + code;
  linkEl.value = link;

  copyBtn.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(link); showToast('Скопировано', 'Отправь ссылку друзьям'); }catch(e){ showToast('Не удалось скопировать'); }
  };
  shareBtn.onclick = ()=>{
    if(navigator.share){ navigator.share({title:'Присоединяйся к Правильный учёт', url: link}).catch(()=>{}); }
    else { navigator.clipboard.writeText(link); showToast('Ссылка скопирована'); }
  };

  // Leaderboard demo data
  let board = JSON.parse(localStorage.getItem('ref_board')||'null') || [
    {name:'@alex', score:5},
    {name:'@maria', score:3},
    {name:'@ivan', score:2},
  ];
  const meName = '@you';
  const me = board.find(b=>b.name===meName) || (board.push({name:meName, score:0}), board[board.length-1]);

  function render(){
    leadersEl.innerHTML = '';
    const max = Math.max(...board.map(b=>b.score), 1);
    board.sort((a,b)=>b.score-a.score);
    board.forEach((b,i)=>{
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0">
        <div><strong>${i+1}.</strong> ${b.name}</div>
        <div>${b.score}</div>
      </div>
      <div class="bar"><span style="width:${Math.round(b.score*100/max)}%"></span></div>`;
      leadersEl.appendChild(item);
    });
    localStorage.setItem('ref_board', JSON.stringify(board));
  }
  render();

  // simulate +1 (demo)
  simBtn.onclick = ()=>{ me.score++; render(); showToast('+1 приглашение', 'Зачтено тебе в лидерборд'); };

  resetBtn.onclick = ()=>{ localStorage.removeItem('ref_board'); board = [{name:'@alex',score:5},{name:'@maria',score:3},{name:'@ivan',score:2},{name:meName,score:0}]; render(); };
})();


// ===== Invite: QR + weekly leaderboard =====
(function(){
  const linkEl = document.getElementById('refLink');
  if(!linkEl) return;
  const url = linkEl.value;
  // QR via api.qrserver.com (client-side fetch to IMG then draw to canvas)
  const canvas = document.getElementById('qrCanvas');
  if (canvas && url){
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>{
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      // center-fit
      const size = Math.min(canvas.width, canvas.height)-10;
      ctx.drawImage(img, (canvas.width-size)/2, (canvas.height-size)/2, size, size);
    };
    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(url);
  }
  const dl = document.getElementById('dlQR');
  if(dl && canvas){
    dl.onclick = ()=>{
      const a = document.createElement('a');
      a.download = 'invite_qr.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    };
  }

  // Weekly leaderboard
  const leadersWeek = document.getElementById('leadersWeek');
  const leadersAll = document.getElementById('leaders');
  const tabs = document.querySelectorAll('.lb-tab');
  function weekKey(){
    const d = new Date(); const onejan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    return 'ref_board_week_' + d.getFullYear() + '_' + week;
  }
  function renderList(el, list){
    el.innerHTML='';
    const max = Math.max(...list.map(x=>x.score),1);
    list.sort((a,b)=>b.score-a.score).forEach((b,i)=>{
      const item = document.createElement('div');
      item.className='lb-row';
      item.innerHTML = `<div><strong>${i+1}.</strong> ${b.name}</div><div>${b.score}</div>`;
      const bar = document.createElement('div'); bar.className='bar';
      const span = document.createElement('span'); span.style.width = Math.round(b.score*100/max)+'%';
      bar.appendChild(span);
      el.appendChild(item); el.appendChild(bar);
    });
  }
  function getBoardAll(){
    return JSON.parse(localStorage.getItem('ref_board')||'[]');
  }
  function getBoardWeek(){
    return JSON.parse(localStorage.getItem(weekKey())||'[]');
  }
  function setBoardWeek(arr){
    localStorage.setItem(weekKey(), JSON.stringify(arr));
  }
  // initial render
  renderList(leadersAll, getBoardAll());
  renderList(leadersWeek, getBoardWeek());
  tabs.forEach(t=>t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.toggle('btn-primary', x===t));
    tabs.forEach(x=>x.classList.toggle('btn-ghost', x!==t));
    if(t.dataset.mode==='week') { renderList(leadersWeek, getBoardWeek()); }
    else { renderList(leadersAll, getBoardAll()); }
  }));

  // Hook simulateRef to also update WEEK board
  const sim = document.getElementById('simulateRef');
  if(sim){
    sim.addEventListener('click', ()=>{
      // all-time already handled in previous logic; duplicate here for week
      let w = getBoardWeek();
      const me = '@you';
      const meItem = w.find(x=>x.name===me) || (w.push({name:me, score:0}), w[w.length-1]);
      meItem.score++;
      setBoardWeek(w);
      renderList(leadersWeek, getBoardWeek());
    });
  }
})();

// ===== Consultation: duration + busy slots + ICS duration =====
(function(){
  const durBtns = document.querySelectorAll('.dur');
  const slotsEl = document.getElementById('slots');
  const confirmBtn = document.getElementById('confirmConsult');
  const icsBtn = document.getElementById('icsBtn');
  if(!slotsEl || !confirmBtn) return;
  let duration = 30; // minutes
  let selDateISO = null, selTime = null;
  durBtns.forEach(b=>b.addEventListener('click', ()=>{
    durBtns.forEach(x=>x.classList.toggle('btn-primary', x===b));
    durBtns.forEach(x=>x.classList.toggle('btn-ghost', x!==b));
    duration = +b.dataset.min;
    if(selDateISO) renderSlots(new Date(selDateISO)); // refresh for duration
  }));

  // sample busy intervals (demo): today+2 at 12:00–14:00, every day 13:00 busy
  function busyFor(date){
    // returns array of [startHour, endHour) busy
    return [{s:13, e:14}];
  }

  function renderSlots(d){
    slotsEl.innerHTML='';
    selDateISO = d.toISOString().slice(0,10);
    const busy = busyFor(d);
    const start = 10, end = 19;
    function isBusy(hour){
      return busy.some(b=>hour>=b.s && hour<b.e);
    }
    for(let h=start; h<=end; h++){
      // if slot would overlap busy considering duration, mark off
      let blocked = false;
      for(let t=h; t<h + duration/60; t+=0.5){
        if(isBusy(Math.floor(t))) { blocked = true; break; }
      }
      const label = String(h).padStart(2,'0')+':00';
      const btn=document.createElement('button');
      btn.className='btn ' + (blocked? 'btn-ghost' : 'btn-ghost');
      btn.textContent = label + (blocked? ' ⛔' : '');
      if(blocked){ btn.disabled = true; btn.style.opacity='.5'; }
      btn.onclick=()=>{
        slotsEl.querySelectorAll('.btn').forEach(x=>x.classList.remove('btn-primary'));
        btn.classList.add('btn-primary'); selTime = label;
      };
      slotsEl.appendChild(btn);
    }
  }
  // expose hook from calendar when a date selected
  const prevSaveSelection = window.saveSelection;
  window.saveSelection = function(time){
    // Called by calendar in previous code; we override to support duration
    selTime = time;
  };

  // Rebind calendar selection handler to call renderSlots
  (function patchCalendar(){
    const cal = document.getElementById('cal');
    if(!cal) return;
    const observer = new MutationObserver(()=>{
      const cells = cal.querySelectorAll('.cal-cell:not(.muted):not(.off)');
      cells.forEach(c=>{
        c.addEventListener('click', ()=>{
          const yearMon = cal.querySelector('.mon').textContent; // not used for ISO; we'll read from class selection
          const cur = new Date(); // fallback
          // compute selected date from cells index (simple approach: rely on existing selection in original code)
          const sel = cal.querySelector('.cal-cell.sel');
          if(sel){
            const dnum = +sel.textContent;
            const title = cal.querySelector('.mon').textContent;
            const [monName, y] = title.split(' ');
            const months = ['январь','февраль','март','апрель','май','июнь','июль','август','сентябрь','октябрь','ноябрь','декабрь'];
            const mi = months.findIndex(m=>title.toLowerCase().includes(m));
            const date = new Date(+y, mi, dnum);
            renderSlots(date);
          }
        }, {once:true});
      });
    });
    observer.observe(cal, {childList:true, subtree:true});
  })();

  // Confirm with ICS duration
  confirmBtn.addEventListener('click', ()=>{
    if(!selDateISO || !selTime){ showToast('Выберите дату и время'); return; }
    const [h,m]=selTime.split(':').map(Number);
    const d = new Date(selDateISO + 'T00:00:00');
    d.setHours(h,m,0,0);
    const de = new Date(d.getTime()+duration*60000);
    const blob = new Blob([`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}00
DTEND:${de.getFullYear()}${String(de.getMonth()+1).padStart(2,'0')}${String(de.getDate()).padStart(2,'0')}T${String(de.getHours()).padStart(2,'0')}${String(de.getMinutes()).padStart(2,'0')}00
SUMMARY:Консультация — Правильный учёт
END:VEVENT
END:VCALENDAR`], {type:'text/calendar'});
    const url = URL.createObjectURL(blob);
    const a = document.getElementById('icsBtn');
    a.href = url; a.style.display='inline-flex';
    showToast('Бронь создана', `Продолжительность ${duration} мин`);
  });
})();

// ===== Community quests & mini-chat typing =====
(function(){
  // Quests
  const quests = document.querySelectorAll('.quest');
  const qBanner = document.getElementById('questState');
  let state = JSON.parse(localStorage.getItem('quests_state')||'{}');
  function redraw(){
    const done = Object.keys(state).filter(k=>state[k]).length;
    qBanner.textContent = `Прогресс: ${done}/3`;
    quests.forEach(q=>{
      q.classList.toggle('btn-primary', !!state[q.dataset.id]);
      q.classList.toggle('btn-ghost', !state[q.dataset.id]);
    });
  }
  quests.forEach(q=>q.addEventListener('click', ()=>{
    state[q.dataset.id] = !state[q.dataset.id];
    localStorage.setItem('quests_state', JSON.stringify(state));
    redraw();
    if(state[q.dataset.id]) showToast('Зачтено', 'Шаг выполнен');
  }));
  redraw();

  // Mini chat (demo)
  const box = document.getElementById('chatBox');
  const input = document.getElementById('chatInput');
  const send = document.getElementById('chatSend');
  const typing = document.getElementById('typing');
  const me = '@you';
  function addMsg(user, msg){
    const line = document.createElement('div');
    line.innerHTML = `<strong>${user}</strong>: ${msg}`;
    box.appendChild(line); box.scrollTop = box.scrollHeight;
  }
  send.addEventListener('click', ()=>{
    const t = input.value.trim(); if(!t) return;
    addMsg(me, t); input.value='';
    // fake "typing..." and reply
    typing.textContent = '@admin печатает…';
    setTimeout(()=>{ addMsg('@admin', 'Спасибо! Принято 👍'); typing.textContent=''; }, 1000 + Math.random()*1000);
  });
})();


// ===== Community stats: animated counters + ring =====
(function(){
  const counters = document.querySelectorAll('#community [data-count]');
  const ring = document.getElementById('ring');
  const ringText = document.getElementById('ringText');
  if(!counters.length || !ring) return;
  const length = 2*Math.PI*52; // stroke length used in SVG
  ring.style.strokeDasharray = String(length);
  ring.style.strokeDashoffset = String(length);
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(!e.isIntersecting) return;
      const el = e.target;
      const target = +el.dataset.count;
      const suffix = el.dataset.suffix || '';
      const t0 = performance.now(), dur = 900;
      function tick(t){
        const k = Math.min(1,(t-t0)/dur);
        const val = Math.round(target*k);
        el.textContent = val + suffix;
        if(k<1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
      obs.unobserve(el);
    });
  }, {threshold:.3});
  counters.forEach(el=>obs.observe(el));
  // Animate ring to a weekly progress (demo: 72% or from quests)
  let progress = 72;
  try {
    const qs = JSON.parse(localStorage.getItem('quests_state')||'{}');
    const done = Object.values(qs).filter(Boolean).length;
    progress = Math.round((done/3)*100) || progress;
  } catch(e){}
  const offset = length*(1 - progress/100);
  let cur = length;
  function ringTick(){
    cur -= (cur - offset) * 0.1;
    if (Math.abs(cur - offset) < 0.5) cur = offset;
    ring.style.strokeDashoffset = String(cur);
    ringText.textContent = Math.round((1 - cur/length)*100) + '%';
    if (cur !== offset) requestAnimationFrame(ringTick);
  }
  requestAnimationFrame(ringTick);
})();

</script>
<script>
// ===== NAV (desktop-safe): single source of truth =====
(function(){
  const nav   = document.getElementById('spa-nav');
  const track = nav.querySelector('.track');
  const links = [...track.querySelectorAll('[data-page]')];
  const bubble = track.querySelector('.bubble');
  
  const ALLOW_DRAG = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
const pages = document.querySelectorAll('section.page');

  function show(id){
    pages.forEach(p=>p.classList.toggle('active', p.id===id));
    links.forEach(a=>a.classList.toggle('active', a.dataset.page===id));
    centerActive();
    moveBubble();
    console.log('page_view', {page:id});
  }
  window.show = show;

  let dragging = false;
  track.addEventListener('click', (e)=>{
    if (dragging) { dragging = false; return; }
    const a = e.target.closest('[data-page]');
    if(!a) return;
    e.preventDefault();
    show(a.dataset.page);
    __updateURL(a.dataset.page);
  });

  let isDown=false, sx=0, sl=0;
  track.addEventListener('pointerdown', (e)=>{ if (!ALLOW_DRAG) return;
    isDown = true; dragging = false; sx = e.clientX; sl = track.scrollLeft; track.setPointerCapture(e.pointerId);
  });
  track.addEventListener('pointermove', (e)=>{ if (!ALLOW_DRAG) return;
    if(!isDown) return;
    const dx = e.clientX - sx;
    if(Math.abs(dx) > 6) dragging = true;
    track.scrollLeft = sl - dx;
    moveBubble();
  });
  track.addEventListener('pointerup', ()=>{ isDown=false; });

  links.forEach(a=>{
    a.setAttribute('tabindex','0');
    a.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); show(a.dataset.page); __updateURL(a.dataset.page); }
    });
  });

  function moveBubble(){
    const a = track.querySelector('.btn.active') || links[0];
    if(!a) return;
    bubble.style.left  = (a.offsetLeft - track.scrollLeft + 6) + 'px';
    bubble.style.width = a.getBoundingClientRect().width + 'px';
  }

  function centerActive(){
    const a = track.querySelector('.btn.active');
    if(!a) return;
    a.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }

  function scaleItems(){
    const rect = track.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    links.forEach(a=>{
      const r = a.getBoundingClientRect();
      const ax = r.left + r.width/2;
      const d = Math.abs(ax - cx);
      const k = Math.max(0.9, 1.0 - d / (rect.width*0.9));
      a.style.transform = `scale(${k.toFixed(3)})`;
      a.style.opacity = String(0.65 + (k-0.9)*2.4);
    });
  }

  track.addEventListener('scroll', ()=>{ requestAnimationFrame(()=>{ scaleItems(); moveBubble(); }); }, {passive:true});
  window.addEventListener('resize', ()=>{ scaleItems(); moveBubble(); });

  const initial = (location.hash||'#home').slice(1);
  show(initial || 'home');
  setTimeout(()=>{ scaleItems(); moveBubble(); }, 60);
})();
</script>

<script>
// ==== v16-safe config (only placeholders; nothing breaks if empty) ====
window.APP_CONFIG = {
  TG_BOT_USERNAME: 'serge_kamensky_bot',  // поменяешь здесь
  GAS_WEBHOOK: 'https://script.google.com/macros/s/AKfycbwD28iQzUk2oItU8nGTNYIXVyO55e5ijdjhhy8qrlR1fIr8NalncNfVTrbuAWsOWP6o/exec',                        // вставишь URL Apps Script
  API_KEY: '',                            // опционально
  USE_TG_SIGNATURE: true
};

// helpers
function __uid(){
  let u = localStorage.getItem('uid');
  if(!u){ u = Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid', u); }
  return u;
}
function __tgUser(){ try{ return Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user || null } catch(e){ return null } }
function __tgInit(){ try{ return Telegram && Telegram.WebApp && Telegram.WebApp.initData || null } catch(e){ return null } }
async function __postGAS(payload){
  const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

  if(!C.GAS_WEBHOOK) return {ok:false, error:'no_webhook'};
  try{
    const body = Object.assign({}, payload);
    if (C.USE_TG_SIGNATURE && __tgInit()) body.tg_init = __tgInit();
    if (!__tgInit() && C.API_KEY) body.key = C.API_KEY;
    const r = await fetch(C.GAS_WEBHOOK, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    return await r.json().catch(()=>({ok:true}));
  }catch(e){ return {ok:false, error:String(e)} }
}
function __haptic(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }

// глобальный лёгкий хаптик на кнопки (не ломает поведение)
document.addEventListener('click', function(e){ if(e.target.closest('.btn')) __haptic('light'); }, {passive:true});

// === Консультация: мягкая валидация поля контакта + отправка если задан WEBHOOK ===
(function(){
  const scope = document.getElementById('consult'); if(!scope) return;
  const btn = scope.querySelector('#confirmConsult') || Array.from(scope.querySelectorAll('button')).find(b=>(b.textContent||'').toLowerCase().includes('подтверд'));
  const input = scope.querySelector('#contact') || scope.querySelector('input,textarea');
  if(!btn || !input) return;

  input.addEventListener('input', function(){
  let v = this.value;
  v = v.replace(/[^\d+]/g, '');
  if(v.startsWith('+')) v = '+' + v.slice(1).replace(/\D/g, ''); else v = v.replace(/\D/g, '');
  v = v.replace(/(?!^)\+/g, '');
  this.value = v; this.classList.remove('attn','ok');
  const hint = __ensureContactHint(this);
  if(hint) hint.textContent = 'Можно: +7 999 123-45-67, 8 999..., 999... — нормализуем к 7XXXXXXXXXX';
});

  btn.addEventListener('click', async function(){
  const valRaw = (input.value||'').trim();
  const val = __normalizePhoneRU(valRaw);

    if(!val){
  input.classList.add('attn'); __haptic('medium'); input.focus({preventScroll:true});
  const hint = __ensureContactHint(input); if(hint) hint.textContent = 'Укажи номер. Пример: +7 999 123-45-67';
  return;
}
try{ input.value = '+'+val; }catch(_){}

    input.classList.add('ok');
    try{ __confAt(btn); }catch(_){ try{ __conf(); }catch(__){} }
__haptic('light');

    // Пытаемся отправить только если указан GAS_WEBHOOK (иначе тихо выходим)
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if (!C.GAS_WEBHOOK) return;

    const payload = {
      type: 'consult_booking',
      ts: new Date().toISOString(),
      uid: __uid(),
      page: (new URL(location.href)).searchParams.get('page') || (location.hash||'#home').slice(1) || 'home',
      date: scope._selDate || '',
      time: scope._selTime || '',
      duration_min: scope._durMin || +(scope.querySelector('.dur.btn-primary') && scope.querySelector('.dur.btn-primary').getAttribute('data-min') || 30),
      format: scope._type || (scope.querySelector('.consult-type.btn-primary') && scope.querySelector('.consult-type.btn-primary').getAttribute('data-type') || 'call'),
      contact: val,
      tg_user: __tgUser()
    };
    try{ Telegram && Telegram.WebApp && Telegram.WebApp.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){}
    const r = await __postGAS(payload);
    if (r && r.ok && window.showToast) showToast('Заявка отправлена', 'Мы подтвердим время в чате');
  });
})();

// === Партнёрка: формируем реферальную ссылку из одного места ===
(function(){
  const box = document.getElementById('invite'); if(!box) return;
  const inp = box.querySelector('#refLink'); const copy = box.querySelector('#copyRef'); const share = box.querySelector('#shareRef');
  
  const tg = __tgUser();
  const ref = tg && tg.id ? String(tg.id) : __uid();
  const bot = (window.APP_CONFIG && window.APP_CONFIG.TG_BOT_USERNAME) || 'serge_kamensky_bot';
  const link = 'https://t.me/' + bot + '?start=ref_' + ref;
  if (inp) inp.value = link;
  copy && copy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(link); window.showToast && showToast('Скопировано','Ссылка в буфере'); }catch(e){} });
  share && share.addEventListener('click', async ()=>{
    try{
      if (navigator.share) await navigator.share({title:'Сообщество', url: link});
      else { await navigator.clipboard.writeText(link); window.showToast && showToast('Скопировано','Ссылка в буфере'); }
    }catch(e){}
  });
})();

</script>


<script>
// v19 — global haptic feedback for buttons
(function(){
  function haptic(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }
  document.addEventListener('click', function(e){
    const b = e.target.closest('.btn');
    if(b) haptic('light');
  }, {passive:true});
})();

// v19 — normalize all t.me deeplinks to configured bot
(function(){
  const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}
 const bot = C.TG_BOT_USERNAME || 'serge_kamensky_bot';
  document.querySelectorAll('a[href*="t.me/"]').forEach(a=>{
    try{
      const u = new URL(a.href, location.href);
      if(u.hostname !== 't.me') return;
      const start = u.searchParams.get('start');
      const hash  = u.hash || '';
      a.href = 'https://t.me/' + bot + (start? ('?start='+start) : '') + hash;
    }catch(e){}
  });
})();

// v19 — "Получить персональный расчёт": конфетти + тост + отправка в бот + (опционально) GAS
(function(){
  const btn = document.getElementById('ctaCalc'); if(!btn) return;
  const rev = document.getElementById('revVal');
  const pct = document.getElementById('pctVal');
  const was = document.getElementById('oldTax');
  const became = document.getElementById('newTax');
  const econ = document.getElementById('saveCounter');
  const num = s => (s||'').toString().replace(/[^\d.-]/g,'')*1 || 0;

  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(e){ return null } }
  function tgInit(){ try{ return Telegram?.WebApp?.initData || null }catch(e){ return null } }
  function uid(){ let u=localStorage.getItem('uid'); if(!u){u=Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid',u);} return u; }

  async function postGAS(payload){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if(!C.GAS_WEBHOOK) return {ok:false, error:'no_webhook'};
    const body = Object.assign({}, payload);
    if (C.USE_TG_SIGNATURE && tgInit()) body.tg_init = tgInit();
    if (!tgInit() && C.API_KEY) body.key = C.API_KEY;
    try{
      const r = await fetch(C.GAS_WEBHOOK, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      return await r.json().catch(()=>({ok:true}));
    }catch(e){ return {ok:false, error:String(e)} }
  }

  btn.addEventListener('click', async ()=>{
    // confetti + toast
    try{ __confAt(btn); }catch(_){ try{ __conf(); }catch(__){} }
try{ window.showToast && showToast('Отправлено', 'Мы получили вводные и вернёмся с рекомендациями'); }catch(e){}

    const payload = {
      type: 'calc_lead',
      ts: new Date().toISOString(),
      uid: uid(),
      page: (new URL(location.href)).searchParams.get('page') || (location.hash||'#home').slice(1) || 'home',
      calc: {
        revenue: num(rev?.textContent),
        effect:  num(pct?.textContent),
        was:     num(was?.textContent),
        become:  num(became?.textContent),
        economy: num(econ?.textContent)
      },
      tg_user: tgUser()
    };

    // отправка в бота (web_app_data)
    try{ Telegram && Telegram.WebApp && Telegram.WebApp.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){}

    // отправка в GAS (если настроен)
    try{ await postGAS(payload); }catch(e){}
  });
})();

// v19 — guard: fix "services" page showing wrong content due to duplicate show()
// Ensure only top-level sections toggle .active
(function(){
  const links = document.querySelectorAll('#spa-nav [data-page]');
  const sections = Array.from(document.querySelectorAll('body > main.container section.page, body > section.page'));
  function showSafe(id){
    sections.forEach(s=> s.classList.toggle('active', s.id === id));
    links.forEach(l=> l.classList.toggle('active', l.getAttribute('data-page')===id));
  }
  // If current hash points to a valid section but it's not visible, force it
  const current = (location.hash||'#home').replace('#','');
  if (sections.some(s=>s.id===current) && !document.getElementById(current).classList.contains('active')){
    showSafe(current);
  }
  // Keep bubble in place if nav already initialized
  if (window.__centerNavActive) try{ window.__centerNavActive(); }catch(e){}
})();
</script>


<script>
// v20 — Bonuses: "Оформить регистрацию" safe handler (confetti + toast + sendData)
(function(){
  const box = document.getElementById('bonuses'); if(!box) return;
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      // confetti
      try{ if(window.confetti) confetti({particleCount:120, spread:70}); }catch(_){}
      // toast
      const msg = btn.getAttribute('data-msg') || 'Заявка получена';
      try{ window.showToast && showToast('Готово', msg); }catch(_){}
      // send to bot + GAS if configured
      try{
        const payload = { type:'register_business', ts:new Date().toISOString(), uid: (localStorage.getItem('uid')||'') };
        Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload));
      }catch(_){}
      // update local stats
      try{ localStorage.setItem('stat_points', String((+localStorage.getItem('stat_points')||0)+5)); }catch(_){}
    }, {once:false});
  });
})();

// v20 — Main flow: stepper with redirect to #consult on last step
(function(){
  const card = document.getElementById('home'); if(!card) return;
  const flow = card.querySelector('#flow'); if(!flow) return;
  const btnNext = card.querySelector('#flowNext'); const btnReset = card.querySelector('#flowReset');
  const steps = Array.from(flow.querySelectorAll('.badge'));
  let i = 0;
  function render(){
    steps.forEach((s,idx)=>{
      s.style.opacity = idx<=i ? 1 : .45;
      s.style.filter = idx<=i ? 'none' : 'grayscale(.3)';
    });
    if(i >= steps.length-1){ btnNext.textContent = 'Перейти к консультации'; }
    else { btnNext.textContent = 'Дальше'; }
  }
  btnNext?.addEventListener('click', ()=>{
    if(i < steps.length-1){ i++; render(); }
    else{
      try{ window.showToast && showToast('Готово', 'Открыл раздел «Консультация»'); }catch(_){}
      if (typeof __showPage === 'function'){ __showPage('consult'); }
      else if (typeof show === 'function'){ show('consult'); }
      try{
        const u = new URL(location.href);
        u.searchParams.set('page','consult'); history.replaceState(null,'', u.pathname+u.search+'#consult');
      }catch(_){ location.hash = 'consult'; }
    }
  });
  btnReset?.addEventListener('click', ()=>{ i = 0; render(); });
  render();
})();

// v20 — Wheel: 24h cooldown with countdown
(function(){
  const section = document.getElementById('bonuses'); if(!section) return;
  const oldBtn = section.querySelector('#spin'); const out = section.querySelector('#spinRes');
  if(!oldBtn || !out) return;
  const btn = oldBtn.cloneNode(true); oldBtn.replaceWith(btn);

  const uid = (localStorage.getItem('uid')|| (Date.now().toString(36)+Math.random().toString(36).slice(2,8))); localStorage.setItem('uid', uid);
  const KEY = 'spin_next_at_' + uid;
  const COOLDOWN = 24*60*60*1000;
  const prizes = ['🎁 Шаблон «Оффер»','📘 Чек-лист аудита','💬 +30 мин консультации','🧮 Доступ к калькулятору PRO','⭐ Приоритетный разбор'];

  function h(){ try{ Telegram.WebApp.HapticFeedback.impactOccurred('light'); }catch(e){ navigator.vibrate?.(25); } }
  function announce(txt){ try{ showToast && showToast('Поздравляю!', txt); }catch(e){} }

  let timer;
  function apply(){
    const left = (parseInt(localStorage.getItem(KEY)||'0',10) - Date.now());
    if(left>0){
      btn.disabled = true; btn.classList.add('btn-ghost'); btn.classList.remove('btn-primary');
      const tick = ()=>{
        const l = parseInt(localStorage.getItem(KEY)||'0',10) - Date.now();
        if(l<=0){ clearInterval(timer); btn.disabled=false; btn.classList.remove('btn-ghost'); btn.classList.add('btn-primary'); btn.textContent='Крутить 🎡'; return; }
        const s=Math.floor(l/1000), hhh=Math.floor(s/3600), mmm=Math.floor((s%3600)/60), ss=s%60;
        btn.textContent = 'Крутить через ' + (hhh? hhh+'ч ':'') + (mmm? mmm+'м ':'') + ss+'с';
      };
      clearInterval(timer); timer = setInterval(tick,1000); tick(); return true;
    } else {
      btn.disabled=false; btn.classList.remove('btn-ghost'); btn.classList.add('btn-primary'); btn.textContent='Крутить 🎡'; return false;
    }
  }

  let spinning=false;
  btn.addEventListener('click', ()=>{
    if(spinning) return;
    if(apply()) return;
    spinning=true; out.textContent='Крутим…'; h();
    const total = 1800 + Math.floor(Math.random()*900);
    const t0 = performance.now();
    const step = (t)=>{
      if(t - t0 >= total){
        const win = prizes[Math.floor(Math.random()*prizes.length)];
        out.textContent = 'Выпало: ' + win;
        announce(win);
        try{ if(window.__confAt) __confAt(btn); }catch(_){ }
        try{
          const ul = document.getElementById('ppPrizeList');
          if(ul){ ul.innerHTML=''; const li=document.createElement('li'); li.textContent=win; li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)'; ul.appendChild(li); }
          const pp = document.getElementById('ppPrize'); if(pp) pp.textContent = win;
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { prizes: ((window.__PROFILE&&window.__PROFILE.prizes)||[]).concat([{title:win}]).slice(-10) });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        }catch(_){ }
        // stats
        try{
          const arr = JSON.parse(localStorage.getItem('last_prizes')||'[]'); arr.push(win);
          localStorage.setItem('last_prizes', JSON.stringify(arr.slice(-10)));
          localStorage.setItem('stat_prizes', String(+(localStorage.getItem('stat_prizes')||0)+1));
          localStorage.setItem('stat_points', String(+(localStorage.getItem('stat_points')||0)+10));
        }catch(_){}
        localStorage.setItem(KEY, String(Date.now()+COOLDOWN));
        try{
          const nextAtISO = new Date(parseInt(localStorage.getItem(KEY)||'0',10)).toISOString();
          const prizes = JSON.parse(localStorage.getItem('last_prizes')||'[]');
          const payload = { type:'community_prize', prize: win, prizes_json: prizes, spin_next_at: nextAtISO, uid: (window.__uid&&__uid())||'' };
          if (typeof window.__postGAS==='function') window.__postGAS(payload);
        }catch(_){ }
        spinning=false; apply();
        return;
      }
      requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  });
  apply();
})();

/* removed: v20 profile panel block */


<script>
// v21 — iOS flag & double-tap zoom suppressor
(function(){
  var ua = navigator.userAgent || navigator.vendor || '';
  var isiOS = /iPad|iPhone|iPod/.test(ua);
  if(isiOS) document.documentElement.classList.add('ios');
  // naive double-tap suppressor for interactive elements
  var last = 0;
  document.addEventListener('touchend', function(e){
    const target = e.target.closest('button, .btn, a, [role="button"]');
    if(!target) return;
    var now = Date.now();
    if(now - last < 350){ e.preventDefault(); }
    last = now;
  }, {passive:false});
})();

// v21 — global haptics also on touchstart
(function(){
  function vibr(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }
  document.addEventListener('click',  function(e){ if(e.target.closest('.btn,button')) vibr('light'); }, {passive:true});
  document.addEventListener('touchstart', function(e){ if(e.target.closest('.btn,button')) vibr('light'); }, {passive:true});
})();

// v21 — Bonuses: guard all CTA buttons to avoid layout break + send events
(function(){
  const box = document.getElementById('bonuses'); if(!box) return;
  // normalize external links to open in bot page, but don't navigate inside WebApp
  box.querySelectorAll('a.btn').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ if(window.confetti) confetti({particleCount:120, spread:70}); }catch(_){}
      try{ showToast && showToast('Откроем в боте', 'Событие отправлено'); }catch(_){}
      const payload = { type:'bonus_btn', href:a.getAttribute('href'), ts:new Date().toISOString(), uid: localStorage.getItem('uid')||'' };
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
    }, {passive:false});
  });
  // existing toast-btn (регистрация и т.п.)
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ if(window.confetti) confetti({particleCount:120, spread:70}); }catch(_){}
      try{ showToast && showToast('Готово', btn.getAttribute('data-msg')||'Отправлено'); }catch(_){}
      try{
        const payload = { type:'register_business', ts:new Date().toISOString(), uid: localStorage.getItem('uid')||'' };
        Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload));
      }catch(_){}
      // force repaint to avoid Safari layer artifacts
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>{ document.body.style.webkitTransform=''; }, 60);
    }, {passive:false});
  });
})();

// v21 — Profile instead of console (ensure open on tap)
(function(){
  const btn = document.querySelector('.console-toggle');
  const panel = document.getElementById('consolePanel');
  if(!btn || !panel) return;

  function initials(name){
    const p=(name||'').trim().split(/\s+/);
    return ( (p[0]||'').charAt(0) + (p[1]||'').charAt(0) || (p[0]||'?').charAt(0) ).toUpperCase();
  }
  function render(){
    let user=null; try{ user = Telegram?.WebApp?.initDataUnsafe?.user || null; }catch(_){}
    const uname = user?.username ? '@'+user.username : '—';
    const name = [user?.first_name, user?.last_name].filter(Boolean).join(' ') || 'Гость';
    const pts = +localStorage.getItem('stat_points') || 0;
    const prize = (JSON.parse(localStorage.getItem('last_prizes')||'[]')||[]).slice(-1)[0] || '—';
    const booking = localStorage.getItem('last_booking') || 'Нет';

    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Очки</div><div class="big">${pts}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Последний приз</div><div class="big" style="font-size:14px">${prize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Запись</div><div class="big" style="font-size:14px">${booking}</div></div>
      </div>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">Открыть бота</a>
        <button class="btn btn-ghost" id="profClose">Закрыть</button>
      </div>
    `;
  }

  function openPanel(){
    render();
    panel.style.display='block';
    panel.style.maxHeight='70vh';
    panel.style.width='min(420px,92vw)';
  }
  function closePanel(){ panel.classList.remove('open'); }

  btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); 
    if (panel.classList.contains('open')) closePanel(); else openPanel();
  }, {passive:false});
  panel.addEventListener('click', (e)=>{
    if(e.target.id==='profClose') { closePanel(); }
  });
})();

</script>


<script>
/* ================= v25 SAFE PATCH ================= */

/* Config guard */
window.APP_CONFIG = Object.assign({
  TG_BOT_USERNAME: 'serge_kamensky_bot',
  GAS_WEBHOOK: '',
  API_KEY: '',
  USE_TG_SIGNATURE: true
}, window.APP_CONFIG||{});

/* Helpers */
function __uid(){ let u=localStorage.getItem('uid'); if(!u){u=Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid',u);} return u; }
function __tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user||null }catch(e){ return null } }
function __tgInit(){ try{ return Telegram?.WebApp?.initData||null }catch(e){ return null } }
function __haptic(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }
function __conf(){ try{ if(window.confetti) confetti({particleCount:140, spread:70}); }catch(e){} }

function __confAt(el){
  try{
    if(!el || !window.confetti){ __conf(); return; }
    const r = el.getBoundingClientRect();
    const x = (r.left + r.width/2) / window.innerWidth;
    const y = (r.top + r.height/2) / window.innerHeight;
    confetti({particleCount: 140, spread: 70, origin: {x, y}});
  }catch(e){ try{ __conf(); }catch(_){} }
}
function __normalizePhoneRU(raw){
  let s = (raw||'').replace(/[^\d+]/g, '');
  if(s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g, '');
  else s = s.replace(/\D/g, '');
  s = s.replace(/^\+/, '');
  if(s.startsWith('8') && s.length===11) s = '7' + s.slice(1);
  if(s.startsWith('7') && s.length===11) return s;
  if(s.length===10 && s[0]==='9') return '7'+s;
  if(s.length>11 && /\d{10}$/.test(s)) return '7' + s.slice(-10);
  return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : '');
}
function __ensureContactHint(input){
  try{
    const hintId = 'contactHint';
    let hint = document.getElementById(hintId);
    if(!hint){
      hint = document.createElement('div');
      hint.id = hintId;
      hint.style.opacity = '.7';
      hint.style.fontSize = '12px';
      hint.style.marginTop = '4px';
      input.insertAdjacentElement('afterend', hint);
    }
    return hint;
  }catch(_) { return null; }
}
function __getBookingISODate(){
  try{
    const lb = localStorage.getItem('last_booking') || '';
    try{
      const obj = JSON.parse(lb);
      if (obj && obj.date) return String(obj.date);
    }catch(_){}
    const m = lb.match(/\b(\d{4}-\d{2}-\d{2})\b/);
    if(m) return m[1];
  }catch(_){}
  try{
    const bd = localStorage.getItem('booking_date') || (window.booking_date||'');
    if(/\d{4}-\d{2}-\d{2}/.test(bd)) return bd.match(/\d{4}-\d{2}-\d{2}/)[0];
  }catch(_){}
  return '';
}
function __fmtDMY(iso){
  if(!iso) return '';
  const m = iso.match(/(\d{4})-(\d{2})-(\d{2})/);
  if(!m) return '';
  return m[3]+'.'+m[2]+'.'+m[1];
}
function __addBookingDatePrefixTo(el){
  try{
    if(!el) return;
    const iso = __getBookingISODate();
    if(!iso) return;
    const d = __fmtDMY(iso);
    const t = (el.textContent||'').trim();
    if(!t.startsWith(d)){
      el.textContent = (d + ' ' + t).trim();
    }
  }catch(_){}
}
async function __postGAS(payload){
  const C = window.APP_CONFIG||{}; if(!C.GAS_WEBHOOK) return {ok:false, error:'no_webhook'};
  const body = Object.assign({}, payload);
  if (C.USE_TG_SIGNATURE && __tgInit()) body.tg_init = __tgInit();
  if (!__tgInit() && C.API_KEY) body.key = C.API_KEY;
  try{ const r = await fetch(C.GAS_WEBHOOK, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
       return await r.json().catch(()=>({ok:true}));
  }catch(e){ return {ok:false, error:String(e)} }
}

/* 0) Kill any in-page console hooks that might print into panel */
window.__domLog = function(){};

/* 1) Global haptics + confetti hooks */
(function(){
  const sel='button,.btn,[role="button"],a.btn';
  document.addEventListener('click',e=>{ if(e.target.closest(sel)) __haptic('light'); }, {passive:true});
  document.addEventListener('touchstart',e=>{ if(e.target.closest(sel)) __haptic('light'); }, {passive:true});
  // auto-confetti on elements with .confetti or data-confetti
  document.addEventListener('click',e=>{ const t=e.target.closest('.confetti,[data-confetti]'); if(t) __conf(); }, {passive:true});
})();

/* 2) Deeplinks to the configured bot (open in Telegram) */
(function(){
  const bot = (window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot';
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-open-bot], a[href^="https://t.me/"], a[href^="t.me/"]');
    if(!a) return;
    e.preventDefault(); e.stopPropagation();
    const href = a.getAttribute('href')||('https://t.me/'+bot);
    try{ Telegram.WebApp.openTelegramLink(href); }catch(_){ window.open(href,'_blank'); }
  }, {passive:false});
})();

/* 3) Referral points: +100 per invited friend */
(function(){
  const u = new URL(location.href);
  const start = u.searchParams.get('start') || u.searchParams.get('tgWebAppStartParam') || u.searchParams.get('start_param');
  if(!start) return;
  const m = String(start).match(/^ref_(.+)$/);
  if(!m) return;
  const inviter = m[1];
  const KEY = 'ref_paid_'+inviter;
  if(localStorage.getItem(KEY)) return; // one-time per device for this inviter
  try{
    const cur = +(localStorage.getItem('stat_points_'+inviter) || 0);
    localStorage.setItem('stat_points_'+inviter, String(cur + 100));
    if((localStorage.getItem('uid')||'') === inviter){ // inviter on same device
      localStorage.setItem('stat_points', String((+localStorage.getItem('stat_points')||0)+100));
    }
    localStorage.setItem('invited_by', inviter);
    localStorage.setItem(KEY, '1');
    // send event (optional)
    const payload = {type:'ref_join', ts:new Date().toISOString(), inviter, uid:__uid(), tg_user:__tgUser()};
    try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
    __postGAS(payload);
  }catch(_){}
})();

/* 4) Invite page: generate link + demo add +100 */
(function(){
  const box=document.getElementById('invite'); if(!box) return;
  const bot=(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'; const link=`https://t.me/${bot}?start=ref_${(__tgUser()&&__tgUser().id)?__tgUser().id:__uid()}`;
  const inp=box.querySelector('#refLink'); if(inp) inp.value=link;
  const copy=box.querySelector('#copyRef'), share=box.querySelector('#shareRef'), sim=box.querySelector('#simulateRef');
  copy && copy.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(link); showToast && showToast('Скопировано','Ссылка в буфере'); }catch(_){}});
  share && share.addEventListener('click', async()=>{ try{ if(navigator.share) await navigator.share({title:'Сообщество',url:link}); else await navigator.clipboard.writeText(link); showToast && showToast('Готово','Ссылка скопирована'); }catch(_){}});
  sim && sim.addEventListener('click', ()=>{ const cur=+localStorage.getItem('stat_points')||0; localStorage.setItem('stat_points', String(cur+100)); __conf(); try{showToast('+100 очков','Зачисление за приглашение');}catch(_){} });
})();

/* 5) Profile panel (вместо консоли) — надёжный рендер имени */
(function(){
  const btn=document.querySelector('.console-toggle'); const panel=document.getElementById('consolePanel');
  if(!btn||!panel) return;
  function initials(name){ const p=(name||'').trim().split(/\s+/); return ((p[0]||'').charAt(0)+(p[1]||'').charAt(0)||'☺').toUpperCase(); }
  function render(){
    const u=__tgUser(); const name=[u?.first_name,u?.last_name].filter(Boolean).join(' ')||'Гость'; const uname=u?.username?('@'+u.username):'—';
    const pts=+localStorage.getItem('stat_points')||0;
    const prize=(JSON.parse(localStorage.getItem('last_prizes')||'[]')||[]).slice(-1)[0]||'—';
    const booking=localStorage.getItem('last_booking')||'Нет';
    const bot=(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot';
    panel.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Очки</div><div class="big">${pts}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Последний приз</div><div class="big" style="font-size:14px">${prize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Запись</div><div class="big" style="font-size:14px">${booking}</div></div>
      </div>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" data-open-bot href="https://t.me/${bot}">Открыть бота</a>
        <button class="btn btn-ghost" id="profClose">Закрыть</button>
      </div>`;
    panel.style.display='block'; panel.classList.add('open'); panel.style.maxHeight='70vh'; panel.style.width='min(420px,92vw)';
    panel.querySelector('#profClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
  }
  btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); if(panel.style.display==='block') panel.classList.remove('open'); else { render(); let tries=0; const t=setInterval(()=>{ const u=__tgUser(); if(u||tries++>20){clearInterval(t); if(u) render();}},150); } }, {passive:false});
})();

/* 6) Bonuses CTA safe-handlers: конфетти + событие в бота, без ломки слоя */
(function(){
  const box=document.getElementById('bonuses'); if(!box) return;
  // links
  box.querySelectorAll('a.btn').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      __conf(); __haptic('light');
      const payload={type:'bonus_btn', href:a.getAttribute('href'), ts:new Date().toISOString(), uid:__uid()};
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
  // toast buttons (регистрация)
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      __conf(); __haptic('light');
      try{ showToast && showToast('Готово', btn.getAttribute('data-msg')||'Отправлено'); }catch(_){}
      const payload={type:'register_business', ts:new Date().toISOString(), uid:__uid()};
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      __postGAS(payload);
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
})();

/* 7) "Как мы работаем" — переход в консультацию на последнем шаге */
(function(){
  const home=document.getElementById('home'); if(!home) return;
  const flow=home.querySelector('#flow'); const next=home.querySelector('#flowNext'); const reset=home.querySelector('#flowReset');
  if(!flow || !next) return;
  const steps=[...flow.querySelectorAll('.badge')]; let i=0;
  function paint(){ steps.forEach((s,idx)=>{ s.style.opacity=idx<=i?1:.45; s.style.filter=idx<=i?'none':'grayscale(.3)'; }); next.textContent = i>=steps.length-1 ? 'Перейти к консультации' : 'Дальше'; }
  next.addEventListener('click', ()=>{ if(i<steps.length-1){ i++; paint(); } else { try{ showToast && showToast('Открываю','Раздел «Консультация»'); }catch(_){}
    if (typeof __showPage==='function') __showPage('consult'); else if (typeof show==='function') show('consult');
    try{ const u=new URL(location.href); u.searchParams.set('page','consult'); history.replaceState(null,'', u.pathname+u.search+'#consult'); }catch(_){ location.hash='consult'; } } });
  reset && reset.addEventListener('click', ()=>{ i=0; paint(); });
  paint();
})();
/* ================================================== */
</script>


<script>
/* v26: robust SPA navigation helper used by stepper */
(function(){
  function go(page){
    try{
      const sections=[...document.querySelectorAll('section.page, main.container section.page')];
      sections.forEach(s=> s.classList.toggle('active', s.id===page));
      const links=[...document.querySelectorAll('#spa-nav [data-page]')];
      links.forEach(l=> l.classList.toggle('active', l.getAttribute('data-page')===page));
    }catch(e){}
    try{
      const u=new URL(location.href);
      u.searchParams.set('page', page);
      history.replaceState(null,'', u.pathname+u.search+'#'+page);
    }catch(_){ location.hash = page; }
    try{ window.__centerNavActive && window.__centerNavActive(); }catch(e){}
  }
  window.__goPage = go;
})();

/* v26: patch Stepper to use __goPage always */
(function(){
  const home=document.getElementById('home'); if(!home) return;
  const flow=home.querySelector('#flow'); const next=home.querySelector('#flowNext'); const reset=home.querySelector('#flowReset');
  if(!flow || !next) return;
  const steps=[...flow.querySelectorAll('.badge')]; let i=0;
  function paint(){ steps.forEach((s,idx)=>{ s.style.opacity=idx<=i?1:.45; s.style.filter=idx<=i?'none':'grayscale(.3)'; }); next.textContent = i>=steps.length-1 ? 'Перейти к консультации' : 'Дальше'; }
  next.addEventListener('click', ()=>{ if(i<steps.length-1){ i++; paint(); } else { try{ showToast && showToast('Открываю','Раздел «Консультация»'); }catch(_){}
    window.__goPage && window.__goPage('consult');
  }});
  reset && reset.addEventListener('click', ()=>{ i=0; paint(); });
  paint();
})();
</script>


<script>
/* v27 — Fixes: debounce toasts, robust profile toggle, reliable confetti triggers */

/* 0) Guard & helpers */
(function(){
  window.APP_CONFIG = Object.assign({
    TG_BOT_USERNAME: 'serge_kamensky_bot',
    GAS_WEBHOOK: '',
    API_KEY: '',
    USE_TG_SIGNATURE: true
  }, window.APP_CONFIG||{});
  window.__uid = window.__uid || function(){ let u=localStorage.getItem('uid'); if(!u){u=Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid',u);} return u; };
  window.__haptic = window.__haptic || function(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } };
})();

/* 1) Debounced toasts — предотвращает многократные всплытия подряд */
(function(){
  const orig = window.showToast;
  let lastAt = 0, lastKey = '';
  window.showToast = function(title, msg){
    const key = String(title||'')+'|'+String(msg||'');
    const now = Date.now();
    if (key===lastKey && (now - lastAt) < 900) return; // защита от «дублей»
    lastAt = now; lastKey = key;
    try{ if(typeof orig === 'function') return orig(title, msg); }catch(e){}
    // fallback
    try{ console.log('[Toast]', title, msg); }catch(e){}
  };
})();

/* 2) Global haptics + confetti everywhere (like on "Получить расчёт") */
(function(){
  function conf(){
    try{ if(window.confetti){ confetti({particleCount:140, spread:70}); return; } }catch(e){}
  }
  const celebrateSel = [
    '#ctaCalc',
    '#bonuses .toast-btn',
    '#bonuses a.btn',
    '#consult #confirmConsult, #consult #consultSubmit, #consult #confirmBtn',
    '#invite #copyRef',
    '#invite #shareRef',
    '.btn[data-confetti]',
    '.btn.confetti'
  ].join(',');
  document.addEventListener('click', (e)=>{
    const el = e.target.closest(celebrateSel);
    if(!el) return;
    conf(); window.__haptic('light');
  }, {passive:true});
})();

/* 3) Bonuses CTA safe handler (no layout break + single toast) */
(function(){
  const box = document.getElementById('bonuses'); if(!box) return;
  // Links
  box.querySelectorAll('a.btn').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ window.showToast('Откроем в боте', a.textContent.trim() || 'Событие отправлено'); }catch(e){}
      const payload = { type:'bonus_btn', href:a.getAttribute('href'), ts:new Date().toISOString(), uid: window.__uid() };
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      // repaint for Safari
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
  // Buttons with toast-msg
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      window.showToast('Готово', btn.getAttribute('data-msg')||'Отправлено');
      const payload = { type:'register_business', ts:new Date().toISOString(), uid: window.__uid() };
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
})();

/* 4) Profile panel — более надёжный поиск кнопки и открытие */
(function(){
  const panel = document.getElementById('consolePanel');
  const btn = document.querySelector('.console-toggle, #consoleToggle, .fab-console, .console');
  if(!panel || !btn) return;

  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null } catch(e){ return null } }
  function initials(name){ const p=(name||'').trim().split(/\s+/); return ((p[0]||'').charAt(0)+(p[1]||'').charAt(0)||'☺').toUpperCase(); }
  function render(){
    const u = tgUser();
    const name = [u?.first_name, u?.last_name].filter(Boolean).join(' ') || 'Гость';
    const uname = u?.username ? '@'+u.username : '—';
    const pts = +localStorage.getItem('stat_points') || 0;
    const prize = (JSON.parse(localStorage.getItem('last_prizes')||'[]')||[]).slice(-1)[0] || '—';
    const booking = localStorage.getItem('last_booking') || 'Нет';
    const bot = (window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot';
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Очки</div><div class="big">${pts}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Последний приз</div><div class="big" style="font-size:14px">${prize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Запись</div><div class="big" style="font-size:14px">${booking}</div></div>
      </div>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" data-open-bot href="https://t.me/${bot}">Открыть бота</a>
        <button class="btn btn-ghost" id="profClose">Закрыть</button>
      </div>
    `;
    panel.style.display='block';
    panel.style.maxHeight='70vh'; panel.style.width='min(420px,92vw)';
  }
  function open(){ panel.style.display='block'; panel.classList.add('open');  render(); __haptic('light'); let tries=0; const t=setInterval(()=>{ const u = (Telegram?.WebApp?.initDataUnsafe?.user || null); if(u || tries++>20){ clearInterval(t); if(u) render(); }}, 150); }
  function close(){ panel.classList.remove('open'); }
  btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); (panel.classList.contains('open')) ? close() : open(); }, {passive:false});
  panel.addEventListener('click', (e)=>{ if(e.target.id==='profClose'){ close(); }}, {passive:true});
})();
</script>


<script>
// GAS bootstrap: fetch profile by tg_init on load
(function(){
  const C = window.APP_CONFIG||{};
  if(!C.GAS_WEBHOOK) return;
  function tgInit(){ try{ return Telegram && Telegram.WebApp && Telegram.WebApp.initData || ''; }catch(e){ return '' } }
  async function bootstrap(){
    try{
      const url = C.GAS_WEBHOOK + '?mode=bootstrap&tg_init=' + encodeURIComponent(tgInit());
      const res = await fetch(url, {method:'GET', headers:{'Cache-Control':'no-store'}});
      const data = await res.json().catch(()=>null);
      if(!data || !data.ok) return;
      // Cache essentials for UI
      try{
        const p = data.profile||{};
        localStorage.setItem('stat_points', String(p.points||0));
        localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
        if(p.spin_next_at) localStorage.setItem('spin_next_at', p.spin_next_at);
        if(p.last_booking) localStorage.setItem('last_booking', p.last_booking);
      }catch(_){}
      // notify UI
      try{ window.showToast && showToast('Профиль обновлён', 'Данные подтянуты с сервера'); }catch(_){}
    }catch(e){ /*silent*/ }
  }
  // start when WebApp is ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') bootstrap();
  else document.addEventListener('DOMContentLoaded', bootstrap);
})();
</script>



<!-- ==== DEV TEST (home overlay; show only with ?debug=1) ==== -->
<style>
  #dev-fab{position:fixed;right:14px;bottom:14px;z-index:9999;border:0;border-radius:999px;padding:12px 14px;background:#2b52ff;color:#fff;font:600 13px system-ui;box-shadow:0 8px 22px rgba(0,0,0,.35);cursor:pointer;display:none}
  #dev-panel{position:fixed;right:14px;bottom:64px;z-index:9999;width:320px;max-width:92vw;background:#0f1221;color:#c9d1ff;border:1px solid #2a3157;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;overflow:hidden}
  #dev-panel .hdr{padding:10px 12px;border-bottom:1px solid #2a3157;display:flex;gap:8px;align-items:center}
  #dev-panel .hdr .ttl{font-weight:600}
  #dev-panel .hdr .badge{margin-left:auto;font-size:11px;opacity:.8}
  #dev-panel .body{padding:12px;display:flex;flex-direction:column;gap:8px}
  #dev-panel button{padding:10px 12px;border:0;border-radius:10px;color:#fff;cursor:pointer}
  #btn-test-bootstrap{background:#2b52ff}
  #btn-test-booking{background:#3aa76d}
  #dev-log{background:#0b0e1a;border:1px solid #2a3157;border-radius:10px;padding:10px;max-height:180px;overflow:auto;white-space:pre-wrap}
</style>
<button id="dev-fab">DEV</button>
<div id="dev-panel">
  <div class="hdr">
    <div class="ttl">DEV • GAS quick test</div>
    <div class="badge" id="dev-badge"></div>
  </div>
  <div class="body">
    <button id="btn-test-bootstrap">1) Bootstrap</button>
    <button id="btn-test-booking">2) Test consult_booking</button>
    <div id="dev-log"></div>
  </div>
</div>

<!-- ==== /DEV TEST ==== -->


<script>
(function(){
  function _jsonp(url, params = {}, cbName = 'cb_'+Math.random().toString(36).slice(2)) {
    return new Promise((resolve, reject) => {
      const q = new URLSearchParams(params);
      q.set('callback', cbName);
      const src = url + (url.includes('?') ? '&' : '?') + q.toString();
      const s = document.createElement('script');
      let done = false;
      window[cbName] = (data) => { if (done) return; done = true; resolve(data); cleanup(); };
      s.onerror = () => { if (done) return; done = true; reject(new Error('JSONP load error')); cleanup(); };
      function cleanup(){ try{ delete window[cbName]; }catch(e){} s.remove(); }
      s.src = src;
      document.head.appendChild(s);
      setTimeout(()=>{ if (!done) { done = true; reject(new Error('JSONP timeout')); cleanup(); } }, 15000);
    });
  }
  window._jsonp = _jsonp;

  async function apiBootstrap() {
    const tg = (window.Telegram && Telegram.WebApp) || null;
    const tgInit = tg ? (tg.initData || '') : '';
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    return _jsonp(url, { mode: 'bootstrap', tg_init: tgInit });
  }
  window.apiBootstrap = apiBootstrap;

  async function apiEvent(type, extra = {}) {
    const tg = (window.Telegram && Telegram.WebApp) || null;
    const tgInit = tg ? (tg.initData || '') : '';
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    const data = JSON.stringify({ ...extra });
    return _jsonp(url, { mode: 'event', type, tg_init: tgInit, data });
  }
  window.apiEvent = apiEvent;

  try{ console.log('[GAS] JSONP helpers ready', { webhook: (window.APP_CONFIG||{}).GAS_WEBHOOK }); }catch(e){}
})();
</script>

<!-- --- BEGIN: universal fetch wrapper for GAS (json -> form-urlencoded + auto type) --- -->
<script>
(function(){
  const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

  const GAS = (C && C.GAS_WEBHOOK) || '';
  if (!GAS) { console.warn('[fetch-wrapper] GAS_WEBHOOK not set'); return; }

  const strip = (u)=> (u||'').split('#')[0].split('?')[0];
  const GAS_BASE = strip(GAS);
  const _origFetch = window.fetch;

  function _autoType(obj){
    if (!obj || typeof obj !== 'object') return '';
    if (obj.type || obj.event) return obj.type || obj.event;
    if ('date' in obj && 'time' in obj) return 'consult_booking';
    if ('inviter' in obj) return 'ref_join';
    // пустой объект для простых действий
    if (Object.keys(obj).length === 0) return 'register_business';
    return '';
  }

  window.fetch = function(input, init){
    try{
      const url = (typeof input === 'string') ? input : (input && input.url) || '';
      const method = (init && (init.method || 'GET')).toUpperCase();
      const isGAS = GAS_BASE && strip(url) === GAS_BASE;

      if (isGAS && method === 'POST') {
        const hdrs = (init && init.headers) || {};
        const ct = (typeof hdrs.get === 'function') ? (hdrs.get('Content-Type')||'') : (hdrs['Content-Type'] || hdrs['content-type'] || '');
        if (String(ct).toLowerCase().includes('application/json')) {
          // Convert JSON body to x-www-form-urlencoded to avoid CORS preflight
          let obj = {};
          try { obj = JSON.parse(init.body || '{}'); } catch(_) {}

          const type = _autoType(obj);
          const params = new URLSearchParams();
          if (type) params.set('type', type);

          // auth: tg_init -> key
          if (obj.tg_init) params.set('tg_init', obj.tg_init);
          else {
            try {
              const initData = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
              if (initData) params.set('tg_init', initData);
            } catch(_){}
          }
          if (!params.has('tg_init') && obj.key) params.set('key', obj.key);
          if (!params.has('tg_init') && !params.has('key') && C.API_KEY) {
            params.set('key', C.API_KEY);
            if (C.DEV_ID) params.set('dev_id', C.DEV_ID);
          }
          if (obj.dev_id && !params.has('dev_id')) params.set('dev_id', obj.dev_id);

          const data = Object.assign({}, obj);
          delete data.type; delete data.event;
          delete data.tg_init; delete data.key; delete data.dev_id;

          params.set('data', JSON.stringify(data));

          const newInit = Object.assign({}, init, {
            method: 'POST',
            headers: (typeof Headers !== 'undefined' && hdrs instanceof Headers)
              ? (hdrs.set('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8'), hdrs)
              : Object.assign({}, hdrs, {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'}),
            body: params.toString(),
            credentials: 'omit'
          });

          return _origFetch.call(this, url, newInit);
        }
      }
    } catch (e) {
      console.warn('[fetch-wrapper] error:', e);
    }
    return _origFetch.apply(this, arguments);
  };

  console.log('[fetch-wrapper] active →', GAS_BASE);
})();
</script>
<!-- --- END: universal fetch wrapper --- -->








<!-- BEGIN: MiniApp core (clean) -->
<script>
(function(){
  function jsonp(url, params = {}, timeoutMs = 25000){
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const q = new URLSearchParams(params);
      q.set('callback', cb);
      q.set('_ts', Date.now().toString());
      const src = url + (url.includes('?') ? '&' : '?') + q.toString();
      const s = document.createElement('script');
      let done = false, tmr = null;
      function cleanup(){ if (tmr) clearTimeout(tmr); try{ delete window[cb]; }catch(_){ window[cb]=undefined; } if(s.parentNode) s.parentNode.removeChild(s); }
      window[cb] = (data)=>{ if(done) return; done = true; cleanup(); resolve(data); };
      s.onerror = ()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP load error')); };
      document.head.appendChild(s); s.src = src;
      tmr = setTimeout(()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
    });
  }
  window._jsonp = jsonp;

  function authParams(){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    const tg = (window.Telegram && Telegram.WebApp) || null;
    const init = tg ? (tg.initData || '') : '';
    if (init) return { tg_init: init };
    if (C.API_KEY){ const p = { key: C.API_KEY }; if (C.DEV_ID) p.dev_id = C.DEV_ID; return p; }
    return {};
  }

  window.apiBootstrap = function(){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if (!C.GAS_WEBHOOK) return Promise.reject(new Error('GAS_WEBHOOK not set'));
    return jsonp(C.GAS_WEBHOOK, { mode:'bootstrap', ...authParams() })
      .then(j => { if(!j || !j.ok) throw new Error(j && j.error || 'bootstrap_failed'); return j.profile; });
  };
  window.apiEvent = function(type, data = {}){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if (!C.GAS_WEBHOOK) return Promise.reject(new Error('GAS_WEBHOOK not set'));
    let t = type || '';
    if (!t && 'date' in data && 'time' in data) t = 'consult_booking';
    if (!t && 'inviter' in data) t = 'ref_join';
    if (!t && Object.keys(data).length === 0) t = 'register_business';
    return jsonp(C.GAS_WEBHOOK, { mode:'event', type: t, data: JSON.stringify(data), ...authParams() })
      .then(j => { if(!j || !j.ok) throw new Error(j && j.error || 'event_failed'); return j; });
  };

  function qs(id){ return document.getElementById(id); }
  function bindBooking(){
    const btn = qs('consultSubmit') || qs('btnConsultSubmit');
    if (!btn) return;
    btn.addEventListener('click', async ()=>{
      try{
        const date = (qs('consultDate') && qs('consultDate').value) || '';
        const time = (qs('consultTime') && qs('consultTime').value) || '';
        const duration_min = Number((qs('consultDuration') && qs('consultDuration').value) || 30);
        const format = (qs('consultType') && qs('consultType').value) || 'call';
        const contact = (qs('contact') && qs('contact').value) || '';
        const res = await window.apiEvent('consult_booking', { date, time, duration_min, format, contact });
        console.log('[consult_booking]', res);
        (window.showToast && showToast('Запись создана', 'Мы с вами свяжемся')) || alert('Запись создана');
      }catch(e){
        console.error(e);
        (window.showToast && showToast('Ошибка', String(e.message||e))) || alert('Ошибка: ' + String(e.message||e));
      }
    });
  }
  document.addEventListener('DOMContentLoaded', bindBooking);

  console.log('[MiniApp core] ready');
})();
</script>
<!-- END: MiniApp core (clean) -->


<!-- === Profile Panel Enhancer: server profile + referrals === -->
<script>
(function(){
  // Helper
  function initials(name){
    const parts = (name||'').trim().split(/\s+/);
    const a = (parts[0]||'').charAt(0), b = (parts[1]||'').charAt(0);
    return (a+b||a||'?').toUpperCase();
  }
  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(_){ return null } }
  function localFallback(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: localStorage.getItem('last_booking')||null,
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }

  async function getProfile(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p;
        // light cache to keep legacy widgets
        try{
          localStorage.setItem('stat_points', String(p.points||0));
          localStorage.setItem('last_booking', p.last_booking||'');
          localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
          localStorage.setItem('referrals_count', String(p.referrals_count||0));
        }catch(_){}
        return p;
      }
    }catch(e){}
    return Object.assign({ method:'fallback' }, localFallback());
  }

  function renderProfileInto(panel, p){
    let user = tgUser();
    const name = [user?.first_name, user?.last_name].filter(Boolean).join(' ') || 'Гость';
    const uname = user?.username ? '@'+user.username : '—';
    const points = p.points ?? 0;
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes[p.prizes.length-1].title || p.prizes[p.prizes.length-1].name || '—') : '—';
    const lastBooking = p.last_booking ? (function(x){ try{ return new Date(x).toLocaleString(); }catch(_){return x;} })(p.last_booking) : 'Нет';
    const refCount = p.referrals_count ?? 0;

    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Очки</div><div class="big">${points}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Последний приз</div><div class="big" style="font-size:14px">${lastPrize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Запись</div><div class="big" style="font-size:14px">${lastBooking}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">Рефералы</div><div class="big" style="font-size:14px">${refCount}</div></div>
      </div>

      <details style="margin-top:10px">
        <summary class="btn btn-ghost" style="display:inline-flex">Показать призы</summary>
        <ul id="prizeUL" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
      </details>

      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">Открыть бота</a>
        <button class="btn btn-ghost" id="profClose">Закрыть</button>
      </div>
    `;
    // Fill prize list
    const ul = panel.querySelector('#prizeUL');
    if (ul && Array.isArray(p.prizes)){
      p.prizes.forEach(x=>{
        const li = document.createElement('li');
        li.textContent = (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x === 'string' ? x : JSON.stringify(x));
        li.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
        ul.appendChild(li);
      });
    }
    panel.querySelector('#profClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
    panel.style.display='block'; panel.style.maxHeight='70vh'; panel.style.width='min(420px,92vw)';
  }

  /* removed: legacy toggle hook block */


/* === Profile Panel: instant open + async hydrate + skeleton === */
<style>
  #consolePanel{ max-height: 78vh; overflow:auto; }
  .skel{ position:relative; background:rgba(255,255,255,.08); border-radius:12px; overflow:hidden; }
  .skel::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-100%);
    animation: skel 1.2s infinite;
  }
  @keyframes skel{ to { transform: translateX(100%); } }
</style>
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  // Cache helpers
  function cachePut(p){
    try{
      localStorage.setItem('stat_points', String(p.points||0));
      localStorage.setItem('last_booking', p.last_booking||'');
      localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
      localStorage.setItem('referrals_count', String(p.referrals_count||0));
    }catch(_){}
  }
  function cacheGet(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' мин)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(),
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }

  // Skeleton HTML
  function skeleton(){
    return `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div class="skel" style="width:42px;height:42px;border-radius:12px"></div>
        <div style="flex:1">
          <div class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
          <div class="skel" style="height:12px;width:90px;border-radius:6px"></div>
        </div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card skel" style="height:54px"></div>
        <div class="card skel" style="height:54px"></div>
        <div class="card skel" style="height:54px"></div>
        <div class="card skel" style="height:54px"></div>
      </div>
      <div class="skel" style="height:38px;margin-top:10px;border-radius:10px"></div>
      <div class="cta" style="margin-top:10px;display:flex;gap:8px">
        <div class="skel" style="height:38px;width:140px;border-radius:10px"></div>
        <div class="skel" style="height:38px;width:100px;border-radius:10px"></div>
      </div>`;
  }

  // Patch existing openProfilePanel to show instantly with cache/skeleton
  (function patchOpen(){
    const prev = window.openProfilePanel;
    window.openProfilePanel = async function(){
      const panel = document.getElementById('consolePanel');
      if (!panel) return;
      // 1) instant open with cached data or skeleton
      panel.style.display = 'block';
      panel.innerHTML = skeleton();

      // 2) if cached profile exists, render it quickly (soft UI update)
      try{
        const pCached = window.__PROFILE || cacheGet();
        if (pCached && (pCached.points || (pCached.prizes||[]).length || pCached.last_booking || pCached.referrals_count)) {
          try { (prev && prev()); } catch(_){}
          // re-render using existing renderer if available
        }
      }catch(_){}

      // 3) fetch fresh profile in background and render via original implementation
      try{
        if (typeof window.apiBootstrap === 'function'){
          const p = await window.apiBootstrap();
          window.__PROFILE = p; cachePut(p);
        }
      }catch(_){}
      try { (prev && prev()); } catch(_){}
    };
  })();

  // Prefetch profile on startup to warm cache & Apps Script
  onReady(async function(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p; cachePut(p);
      }
    }catch(_){/* ignore */}
    // light ping endpoint if present
    try{
      const url = (window.APP_CONFIG && window.APP_CONFIG.GAS_WEBHOOK);
      if (url) {
        const s = document.createElement('script');
        const cb = 'cb_ping_' + Math.random().toString(36).slice(2);
        s.src = url + '?mode=ping&callback='+cb+'&_ts='+Date.now();
        window[cb] = function(){ try{ delete window[cb]; }catch(_){ } s.remove(); };
        document.head.appendChild(s);
      }
    }catch(_){}
  });
})();
</script>
<!-- === /instant profile panel patch === -->


<!-- === Profile Panel: smooth hydrate (micro-loaders + gradual text updates) === -->
<style>
  .skel { position:relative; background:rgba(255,255,255,.08); border-radius:8px; overflow:hidden; }
  .skel::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-100%);
    animation: skel 1.2s infinite;
  }
  @keyframes skel{ to { transform: translateX(100%); } }
  .metric { display:flex; flex-direction:column; gap:2px; }
  .metric .label { font-size:12px; opacity:.7 }
  .metric .value { font-weight:800 }
</style>
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(_){ return null } }
  function initials(name){ const p=(name||'').trim().split(/\s+/); const a=(p[0]||'').charAt(0), b=(p[1]||'').charAt(0); return (a+b||a||'?').toUpperCase(); }
  function cachePut(p){ try{ localStorage.setItem('stat_points', String(p.points||0)); localStorage.setItem('last_booking', p.last_booking||''); localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[])); localStorage.setItem('referrals_count', String(p.referrals_count||0)); }catch(_){ } }
  function cacheGet(){ return { points:+(localStorage.getItem('stat_points')||0), prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[], last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' мин)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(), referrals_count:+(localStorage.getItem('referrals_count')||0) }; }
  function fmtDate(x){ try{ return x ? new Date(x).toLocaleString() : 'Нет'; }catch(_){ return x||'Нет'; } }

  // Build minimal, controlled DOM for smooth updates
  function buildPanelShell(panel){
    const u = tgUser();
    const name = [u?.first_name, u?.last_name].filter(Boolean).join(' ') || 'Гость';
    const uname = u?.username ? '@'+u.username : '—';
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div id="ppAvatar" class="skel" style="width:42px;height:42px;border-radius:12px;display:grid;place-items:center;font-weight:800"></div>
        <div style="flex:1">
          <div id="ppName" class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
          <div id="ppUname" class="skel" style="height:12px;width:90px;border-radius:6px"></div>
        </div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card metric" style="padding:10px"><div class="label">Очки</div><div id="ppPoints" class="value skel" style="height:20px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">Последний приз</div><div id="ppPrize" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">Запись</div><div id="ppBooking" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">Рефералы</div><div id="ppRefs" class="value skel" style="height:16px;border-radius:6px"></div></div>
      </div>
      <details style="margin-top:10px">
        <summary class="btn btn-ghost" style="display:inline-flex">Показать призы</summary>
        <ul id="ppPrizeList" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
      </details>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">Открыть бота</a>
        <button class="btn btn-ghost" id="ppClose">Закрыть</button>
      </div>
    `;
    // Fill avatar/name instantly (no shimmer after)
    const av = panel.querySelector('#ppAvatar');
    av.classList.remove('skel'); av.style.background = 'linear-gradient(135deg,var(--mint),var(--primary))';
    av.textContent = initials(name);
    const nm = panel.querySelector('#ppName'); nm.classList.remove('skel'); nm.textContent = name;
    const un = panel.querySelector('#ppUname'); un.classList.remove('skel'); un.textContent = uname;
    panel.querySelector('#ppClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
  }

  function setVal(el, text){ if(!el) return; el.classList.remove('skel'); el.textContent = text; }
  function hydrateFrom(p){
    const panel = document.getElementById('consolePanel');
    if (!panel) return;
    setVal(panel.querySelector('#ppPoints'), String(p.points ?? 0));
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes[p.prizes.length-1].title || p.prizes[p.prizes.length-1].name || '—') : '—';
    setVal(panel.querySelector('#ppPrize'), lastPrize);
    setVal(panel.querySelector('#ppBooking'), fmtDate(p.last_booking));
    try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}
    setVal(panel.querySelector('#ppRefs'), String(p.referrals_count ?? 0));

    // diff render prize list
    const ul = panel.querySelector('#ppPrizeList');
    if (ul){
      const wanted = (Array.isArray(p.prizes) ? p.prizes : []).map(x => (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x === 'string' ? x : JSON.stringify(x)));
      const current = Array.from(ul.children).map(li => li.textContent);
      // remove extra
      for (let i=current.length-1;i>=0;i--){ if (!wanted.includes(current[i])) ul.removeChild(ul.children[i]); }
      // add missing in order
      wanted.forEach((txt, idx)=>{
        if (!current.includes(txt)){
          const li = document.createElement('li');
          li.textContent = txt;
          li.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
          ul.appendChild(li);
        }
      });
    }
  }

  // Override openProfilePanel to use shell + cache + async hydrate
  (function(){
    const prev = window.openProfilePanel;
    window.openProfilePanel = async function(){
      const panel = document.getElementById('consolePanel');
      if (!panel) return;
      panel.style.display = 'block';
      buildPanelShell(panel);

      // 1) show cached quickly
      const cached = window.__PROFILE || cacheGet();
      if (cached) hydrateFrom(cached);

      // 2) fetch fresh and hydrate
      try{
        if (typeof window.apiBootstrap === 'function'){
          const p = await window.apiBootstrap();
          window.__PROFILE = p; cachePut(p);
          hydrateFrom(p);
        }
      }catch(_){}

      // call previous if it exists (to keep any side effects/animations)
      try{ prev && prev(); }catch(_){}
    };
  })();

  // Preload profile to warm cache
  onReady(async function(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p; cachePut(p);
      }
    }catch(_){}
  });
})();
</script>
<!-- === /smooth hydrate === -->


<!-- === FAST PANEL JS (build once, toggle class, hydrate async) === -->
<script>
(function(){
  function onReady(f){ document.readyState!=='loading' ? f() : document.addEventListener('DOMContentLoaded', f); }
  function cachePut(p){
    try{
      localStorage.setItem('stat_points', String(p.points||0));
      localStorage.setItem('last_booking', p.last_booking||'');
      localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
      localStorage.setItem('referrals_count', String(p.referrals_count||0));
    }catch(_){}
  }
  function cacheGet(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' мин)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(),
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }
  function initials(name){
    const p=(name||'').trim().split(/\s+/);
    const a=(p[0]||'').charAt(0), b=(p[1]||'').charAt(0);
    return (a+b||a||'?').toUpperCase();
  }
  function tgUser(){
    try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(_){ return null }
  }
  function fmtDate(x){ try{ return x ? new Date(x).toLocaleString() : 'Нет'; }catch(_){ return x||'Нет'; } }
  function setVal(sel, txt){
    const el = document.querySelector(sel); if (!el) return;
    el.classList && el.classList.remove('skel');
    el.textContent = txt;
  }

  function buildShell(panel){
    const u = tgUser();
    const name = [u?.first_name, u?.last_name].filter(Boolean).join(' ') || 'Гость';
    const uname = u?.username ? '@'+u.username : '—';
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div id="ppAvatar" class="skel" style="width:42px;height:42px;border-radius:12px;display:grid;place-items:center;font-weight:800"></div>
        <div style="flex:1">
          <div id="ppName" class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
          <div id="ppUname" class="skel" style="height:12px;width:90px;border-radius:6px"></div>
        </div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card metric" style="padding:10px"><div class="label">Очки</div><div id="ppPoints" class="value skel" style="height:20px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">Последний приз</div><div id="ppPrize" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">Запись</div><div id="ppBooking" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">Рефералы</div><div id="ppRefs" class="value skel" style="height:16px;border-radius:6px"></div></div>
      </div>
      <details style="margin-top:10px">
        <summary class="btn btn-ghost" style="display:inline-flex">Показать призы</summary>
        <ul id="ppPrizeList" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
      </details>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">Открыть бота</a>
        <button class="btn btn-ghost" id="ppClose">Закрыть</button>
      </div>
    `;
    // avatar & name immediate
    const av = panel.querySelector('#ppAvatar');
    av && av.classList.remove('skel');
    if (av){ av.style.background='linear-gradient(135deg,var(--mint),var(--primary))'; av.textContent = initials(name); }
    setVal('#ppName', name); setVal('#ppUname', uname);
    panel.querySelector('#ppClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
  }

  function hydrate(p){
    const panel = document.getElementById('consolePanel'); if (!panel) return;
    setVal('#ppPoints', String(p.points ?? 0));
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes.at(-1).title || p.prizes.at(-1).name || '—') : '—';
    setVal('#ppPrize', lastPrize);
    try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}
    setVal('#ppBooking', fmtDate(p.last_booking));
    setVal('#ppRefs', String(p.referrals_count ?? 0));
    const ul = panel.querySelector('#ppPrizeList');
    if (ul){
      const wanted = (Array.isArray(p.prizes)?p.prizes:[]).map(x => (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x==='string'?x:JSON.stringify(x)));
      const cur = Array.from(ul.children).map(li=>li.textContent);
      for (let i=cur.length-1;i>=0;i--){ if(!wanted.includes(cur[i])) ul.removeChild(ul.children[i]); }
      wanted.forEach(txt=>{
        if(!cur.includes(txt)){
          const li=document.createElement('li');
          li.textContent=txt;
          li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
          ul.appendChild(li);
        }
      });
    }
  }

  async function refresh(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p; cachePut(p); hydrate(p);
      }
    }catch(_){}
  }

  // Build shell once
  onReady(function(){
    const panel = document.getElementById('consolePanel');
    if (!panel) return;
    if (!panel.dataset.ready){ buildShell(panel); panel.dataset.ready='1'; }
  });

  // Toggle on click (capture) without reflow-heavy DOM rebuilds
  document.addEventListener('click', function(ev){
    const t = ev.target.closest && ev.target.closest('.console-toggle');
    if (!t) return;
    ev.preventDefault();
    const panel = document.getElementById('consolePanel'); if (!panel) return;
    const opening = !panel.classList.contains('open');
      if (opening) panel.style.display='block';

  panel.classList.toggle('open');
    if (opening){
      // hydrate from cache instantly
      try{
        const cached = window.__PROFILE || cacheGet();
        hydrate(cached);
      }catch(_){}
      // refresh async
      refresh();
    }
  }, true);

  // Warm cache on start
  onReady(refresh);
})();
</script>


<!-- === FAST OPEN v2: zero-wait toggle + staged hydrate + fetch throttle === -->
<script>
(function(){
  let __profileFetching = false;
  let __profileFetchedAt = 0;

  function cachePut(p){
    try{
      localStorage.setItem('stat_points', String(p.points||0));
      localStorage.setItem('last_booking', p.last_booking||'');
      localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
      localStorage.setItem('referrals_count', String(p.referrals_count||0));
    }catch(_){}
  }
  function cacheGet(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' мин)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(),
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }
  function fmtDate(x){ try{ return x ? new Date(x).toLocaleString() : 'Нет'; }catch(_){ return x||'Нет'; } }
  function setVal(sel, txt){
    const el = document.querySelector(sel); if (!el) return;
    el.classList && el.classList.remove('skel');
    if (el.textContent !== String(txt)) el.textContent = String(txt);
  }
  function hydrate(p){
    if (!p) return;
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes.at(-1).title || p.prizes.at(-1).name || '—') : '—';
    setVal('#ppPoints', String(p.points ?? 0));
    try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}
    setVal('#ppPrize', lastPrize);
    setVal('#ppBooking', fmtDate(p.last_booking));
    setVal('#ppRefs', String(p.referrals_count ?? 0));

    const ul = document.querySelector('#ppPrizeList');
    if (ul){
      const wanted = (Array.isArray(p.prizes)?p.prizes:[]).map(x => (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x==='string'?x:JSON.stringify(x)));
      const cur = Array.from(ul.children).map(li=>li.textContent);
      // minimal diff
      // remove extras
      for (let i=cur.length-1;i>=0;i--){ if(!wanted.includes(cur[i])) ul.removeChild(ul.children[i]); }
      // add missing
      const frag = document.createDocumentFragment();
      wanted.forEach(txt=>{
        if(!cur.includes(txt)){
          const li=document.createElement('li');
          li.textContent=txt;
          li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
          frag.appendChild(li);
        }
      });
      if (frag.children && frag.children.length) ul.appendChild(frag);
    }
  }

  async function refresh(force=false){
    if (typeof window.apiBootstrap !== 'function') return;
    const now = Date.now();
    if (!force && (__profileFetching || (now - __profileFetchedAt) < 4000)) return;
    __profileFetching = true;
    try{
      const p = await window.apiBootstrap();
      window.__PROFILE = p; cachePut(p); hydrate(p);
      __profileFetchedAt = Date.now();
    }catch(_){}
    finally{ __profileFetching = false; }
  }

  // Replace the click handler to guarantee instant open (no awaits before showing)
  (function installFastOpen(){
    // Ensure shell exists
    document.addEventListener('DOMContentLoaded', function(){
      const panel = document.getElementById('consolePanel');
      if (!panel || panel.dataset.ready) return;
      // If shell wasn't built, build a very thin shell (minimal cost)
      if (!panel.querySelector('#ppPoints')){
        panel.innerHTML = panel.innerHTML || `
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
            <div id="ppAvatar" class="skel" style="width:42px;height:42px;border-radius:12px;display:grid;place-items:center;font-weight:800"></div>
            <div style="flex:1">
              <div id="ppName" class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
              <div id="ppUname" class="skel" style="height:12px;width:90px;border-radius:6px"></div>
            </div>
          </div>
          <div class="grid" style="gap:8px">
            <div class="card metric" style="padding:10px"><div class="label">Очки</div><div id="ppPoints" class="value skel" style="height:20px;border-radius:6px"></div></div>
            <div class="card metric" style="padding:10px"><div class="label">Последний приз</div><div id="ppPrize" class="value skel" style="height:16px;border-radius:6px"></div></div>
            <div class="card metric" style="padding:10px"><div class="label">Запись</div><div id="ppBooking" class="value skel" style="height:16px;border-radius:6px"></div></div>
            <div class="card metric" style="padding:10px"><div class="label">Рефералы</div><div id="ppRefs" class="value skel" style="height:16px;border-radius:6px"></div></div>
          </div>
          <details style="margin-top:10px">
            <summary class="btn btn-ghost" style="display:inline-flex">Показать призы</summary>
            <ul id="ppPrizeList" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
          </details>
          <div class="cta" style="margin-top:10px">
            <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">Открыть бота</a>
            <button class="btn btn-ghost" id="ppClose">Закрыть</button>
          </div>
        `;
        const u = (Telegram&&Telegram.WebApp&&Telegram.WebApp.initDataUnsafe&&Telegram.WebApp.initDataUnsafe.user)||null;
        const name = [u?.first_name,u?.last_name].filter(Boolean).join(' ') || 'Гость';
        const uname = u?.username ? '@'+u.username : '—';
        const av = panel.querySelector('#ppAvatar');
        if (av){ av.classList.remove('skel'); av.style.background='linear-gradient(135deg,var(--mint),var(--primary))'; av.textContent=(name[0]||'?')+(name.split(' ')[1]?.[0]||''); }
        setVal('#ppName', name); setVal('#ppUname', uname);
        panel.querySelector('#ppClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
      }
      panel.dataset.ready = '1';
    });

    <!-- removed: legacy fast-open rAF handler (duplicate) -->


<script>(function(){ try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}})();</script>

<script>
(function(){
  if (window.__helpersInjected__) return; window.__helpersInjected__ = true;

  window.__confAt = function(el){
    try{
      var r = el.getBoundingClientRect();
      var x = (r.left + r.width/2) / window.innerWidth;
      var y = (r.top + r.height/2) / window.innerHeight;
      if (window.confetti) return confetti({ particleCount: 140, spread: 70, origin: {x:x,y:y} });
    }catch(e){}
    try{ if (typeof __conf === 'function') __conf(); }catch(_){}
  };

  window.__normalizePhoneRU = function(raw){
    var s = String(raw||'').replace(/[^\d+]/g,'');
    if (s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g,''); else s = s.replace(/\D/g,'');
    s = s.replace(/^\+/, '');
    if (s.length===11 && s[0]==='8') s = '7' + s.slice(1);
    if (s.length===10 && s[0]==='9') s = '7' + s;
    if (s.length===11 && (s[0]==='7')) return s;
    return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : (s.length===10&&s[0]==='9'?'7'+s:''));
  };

  window.__maskPhoneRU = function(v){
    var d = String(v||'').replace(/\D/g,'');
    if (d.startsWith('8')) d = '7'+d.slice(1);
    if (d.length===10 && d[0]==='9') d = '7'+d;
    if (!d.startsWith('7')) d = '7'+d.replace(/^7?/,'');
    var p = (d+'           ').slice(0,11); // pad soft
    return ('+'+p[0]+' '+p.slice(1,4)+' '+p.slice(4,7)+'-'+p.slice(7,9)+'-'+p.slice(9,11)).trim().replace(/\s+$/,'');
  };

  window.__ensureContactHint = function(input){
    try{
      var id='contactHint', hint=document.getElementById(id);
      if(!hint){
        hint=document.createElement('div'); hint.id=id;
        hint.style.opacity='.75'; hint.style.fontSize='12px'; hint.style.marginTop='4px';
        input.insertAdjacentElement('afterend', hint);
      }
      return hint;
    }catch(_){ return null; }
  };

  function __getBookingISODate(){
    try{
      var lb = localStorage.getItem('last_booking')||'';
      try{
        var obj = JSON.parse(lb);
        if (obj && obj.date) return String(obj.date);
      }catch(_){}
      var m = lb.match(/\b(\d{4}-\d{2}-\d{2})\b/);
      if (m) return m[1];
    }catch(_){}
    try{
      var bd = localStorage.getItem('booking_date') || (window.booking_date||'');
      var mm = bd.match(/\d{4}-\d{2}-\d{2}/);
      if (mm) return mm[0];
    }catch(_){}
    return '';
  }
  function __fmtDMY(iso){
    var m = (iso||'').match(/(\d{4})-(\d{2})-(\d{2})/);
    return m ? (m[3]+'.'+m[2]+'.'+m[1]) : '';
  }
  window.__addBookingDatePrefixTo = function(el){
    try{
      if(!el) return;
      var iso = __getBookingISODate(); if(!iso) return;
      var d = __fmtDMY(iso);
      var t = (el.textContent||'').trim();
      if (!t.startsWith(d)) el.textContent = (d+' '+t).trim();
    }catch(_){}
  };

  window.__postGAS = async function(payload){
    try{
      var t = payload.type || 'event';
      if (window.apiEvent && typeof window.apiEvent === 'function'){
        return await window.apiEvent(t, payload);
      }
      var C = window.APP_CONFIG || {};
      if (C.GAS_WEBHOOK){
        return await fetch(C.GAS_WEBHOOK, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        }).catch(function(){});
      }
    }catch(_){}
  };
})();
</script>

<script>
(function(){

  // Spin: single source of truth
  try{
    var spinBtn = document.getElementById('spin');
    var spinOut = document.getElementById('spinRes');
    if (spinBtn && spinOut){
      spinBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

        var PRIZES = ['🎁 Шаблон «Оффер»','📘 Чек-лист аудита','💬 +30 мин консультации','🧮 Доступ к калькулятору PRO','⭐ Приоритетный разбор'];
        var win = PRIZES[Math.floor(Math.random()*PRIZES.length)];
        spinOut.textContent = 'Выпало: ' + win;

        try{ __confAt(spinBtn); }catch(_){}

        try{
          var arr = [];
          try{ arr = JSON.parse(localStorage.getItem('last_prizes')||'[]') }catch(_){}
          arr.push(win);
          localStorage.setItem('last_prizes', JSON.stringify(arr.slice(-1))); // храним 1 последний
          localStorage.setItem('stat_prizes', String((+localStorage.getItem('stat_prizes')||0)+1));
          localStorage.setItem('stat_points', String((+localStorage.getItem('stat_points')||0)+10));
        }catch(_){}

        try{
          var ul = document.getElementById('ppPrizeList');
          if (ul){
            ul.innerHTML = '';
            var li = document.createElement('li');
            li.textContent = win;
            li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
            ul.appendChild(li);
          }
          var pp = document.getElementById('ppPrize'); if (pp) pp.textContent = win;

          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { prizes: ((window.__PROFILE&&window.__PROFILE.prizes)||[]).concat([{title:win}]).slice(-10) });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        }catch(_){}

        try{
          var prizes = [];
          try{ prizes = JSON.parse(localStorage.getItem('last_prizes')||'[]') }catch(_){}
          var payload = { type:'community_prize', prize: win, prizes_json: prizes, uid: (window.__uid && __uid()) || '' };
          __postGAS && __postGAS(payload);
        }catch(_){}
      }, {capture:true});
    }
  }catch(_){}

  // Contact input: mask while typing
  try{
    var contact = document.querySelector('#contact');
    if (contact){
      function setHint(state){
        var hint = (window.__ensureContactHint && __ensureContactHint(contact)) || null;
        if(!hint) return;
        hint.style.padding='6px 8px'; hint.style.borderRadius='8px'; hint.style.border='1px solid rgba(255,255,255,.10)';
        hint.style.background='rgba(255,255,255,.04)'; hint.style.fontWeight='600';
        if(state==='empty'){ hint.textContent='Введите номер'; hint.style.color='#ffd95a'; }
        else if(state==='ok'){ hint.textContent='Номер введён верно'; hint.style.color='#7CFFA7'; }
        else if(state==='bad'){ hint.textContent='Проверь формат номера (пример: +7 999 123-45-67)'; hint.style.color='#ffd95a'; }
        else if(state==='sent'){ hint.textContent='Ваша заявка отправлена'; hint.style.color='#7CFFA7'; }
      }
      setHint('empty');
      contact.addEventListener('input', function(){
        var raw = this.value;
        raw = raw.replace(/[^\d+]/g, '');
        if (raw.startsWith('+')) raw = '+' + raw.slice(1).replace(/\D/g,''); else raw = raw.replace(/\D/g,'');
        raw = raw.replace(/(?!^)\+/g, '');
        var norm = raw.replace(/^\+/, '');
        if (!norm.length){
          this.value=''; this.dataset.norm=''; this.classList.remove('ok','attn'); setHint('empty'); return;
        }
        if (norm.length===11 && norm[0]==='8') norm = '7'+norm.slice(1);
        else if (norm.length===10 && norm[0]==='9') norm = '7'+norm;
        try{ this.value = (window.__maskPhoneRU ? __maskPhoneRU(norm) : raw); }catch(e){ this.value = raw; }
        this.dataset.norm = norm;
        this.classList.remove('attn');
        if(norm.length===11 && norm[0]==='7'){ this.classList.add('ok'); setHint('ok'); }
        else { this.classList.remove('ok'); setHint('empty'); }
      }, {capture:true});
    }
  }catch(_){}

  // Confirm consult

  try{
    var confBtn = document.getElementById('confirmConsult');
    if (confBtn){
      confBtn.addEventListener('click', async function(){
        var input = document.getElementById('contact');
        var valRaw = (input && input.value || '').trim();
        var norm = (input && input.dataset && input.dataset.norm) ? input.dataset.norm : (__normalizePhoneRU ? __normalizePhoneRU(valRaw) : valRaw);

        try{ __confAt(confBtn); }catch(_){}

        if (!norm || (norm.length!==11)){
          if (input){ input.classList.add('attn'); input.focus({preventScroll:true}); var hint=__ensureContactHint(input); if(hint) hint.textContent='Укажи номер. Пример: +7 999 123-45-67'; }
          (window.__haptic||function(){})('medium');
          return;
        } else {
          try{ if (input) input.value = '+'+norm; input.classList.add('ok'); }catch(_){}
        }

        var selDate = (window.scope && scope._selDate) || (window.__lastDate) || '';
        var selTime = (window.scope && scope._selTime) || (window.__lastTime) || '';
        var durMin  = (window.scope && scope._durMin)  || (window.__lastDur)  || 30;

        var human = '';
        try{
          var obj = { date: selDate, time: selTime, duration_min: durMin };
          localStorage.setItem('last_booking', JSON.stringify(obj));
          human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' мин)'):'');
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { last_booking: human });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
          try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); }catch(_){}
        }catch(_){}

        try{
          var payload = { type:'consult_booking', contact: '+'+norm, date: selDate, time: selTime, duration_min: durMin, last_booking: human, uid: (window.__uid && __uid()) || '' };
          __postGAS && __postGAS(payload);
        }catch(_){}
      }, {capture:true});
    }
  }catch(_){}

  try{
    setTimeout(function(){
      __addBookingDatePrefixTo && __addBookingDatePrefixTo(document.querySelector('#ppBooking'));
      __addBookingDatePrefixTo && __addBookingDatePrefixTo(document.querySelector('#p_record'));
    }, 200);
  }catch(_){}

})();
</script>
<script>(function(){ if(window.__helpers2) return; window.__helpers2=true;
window.__confAt = window.__confAt || function(el){
  try{
    if(!el) return;
    var r = el.getBoundingClientRect();
    var x = (r.left + r.width/2) / window.innerWidth;
    var y = (r.top + r.height/2) / window.innerHeight;
    if (window.confetti) return confetti({ particleCount: 140, spread: 70, origin: {x:x,y:y} });
  }catch(e){}
  try{ if (typeof __conf === 'function') __conf(); }catch(_){}
};
window.__normalizePhoneRU = window.__normalizePhoneRU || function(raw){
  var s = String(raw||'').replace(/[^\d+]/g,'');
  if (s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g,''); else s = s.replace(/\D/g,'');
  s = s.replace(/^\+/, '');
  if (s.length===11 && s[0]==='8') s = '7' + s.slice(1);
  if (s.length===10 && s[0]==='9') s = '7' + s;
  if (s.length===11 && s[0]==='7') return s;
  return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : (s.length===10&&s[0]==='9'?'7'+s:''));
};
window.__maskPhoneRU = window.__maskPhoneRU || function(v){
  var d = String(v||'').replace(/\D/g,'');
  if (d.startsWith('8')) d = '7'+d.slice(1);
  if (d.length===10 && d[0]==='9') d = '7'+d;
  if (!d.startsWith('7')) d = '7'+d.replace(/^7?/,'');
  var p = (d+'           ').slice(0,11);
  return ('+'+p[0]+' '+p.slice(1,4)+' '+p.slice(4,7)+'-'+p.slice(7,9)+'-'+p.slice(9,11)).trim().replace(/\s+$/,'');
};
window.__ensureContactHint = window.__ensureContactHint || function(input){
  try{
    var id='contactHint', hint=document.getElementById(id);
    if(!hint){
      hint=document.createElement('div'); hint.id=id;
      hint.style.opacity='.85'; hint.style.fontSize='12px'; hint.style.marginTop='4px';
      input.insertAdjacentElement('afterend', hint);
    }
    return hint;
  }catch(_){ return null; }
};
window.__postGAS = window.__postGAS || (async function(payload){
  try{
    var t = payload.type || 'event';
    if (window.apiEvent && typeof window.apiEvent === 'function') return await window.apiEvent(t, payload);
    var C = window.APP_CONFIG || {};
    if (C.GAS_WEBHOOK){
      return await fetch(C.GAS_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    }
  }catch(_){}
});
function __getBookingISODate(){
  try{
    var lb = localStorage.getItem('last_booking')||'';
    try{ var obj = JSON.parse(lb); if (obj && obj.date) return String(obj.date); }catch(_){}
    var m = lb.match(/\b(\d{4}-\d{2}-\d{2})\b/); if (m) return m[1];
  }catch(_){}
  try{
    var bd = localStorage.getItem('booking_date') || (window.booking_date||'');
    var mm = bd.match(/\d{4}-\d{2}-\d{2}/); if (mm) return mm[0];
  }catch(_){}
  return '';
}
function __fmtDMY(iso){ var m=(iso||'').match(/(\d{4})-(\d{2})-(\d{2})/); return m ? (m[3]+'.'+m[2]+'.'+m[1]) : ''; }
window.__addBookingDatePrefixTo = window.__addBookingDatePrefixTo || function(el){
  try{ if(!el) return; var iso = __getBookingISODate(); if(!iso) return;
    var d = __fmtDMY(iso); var t = (el.textContent||'').trim();
    if (!t.startsWith(d)) el.textContent = (d+' '+t).trim();
  }catch(_){}
};
})();</script>
<script>(function(){
  const input = document.getElementById('contact');
  if(!input) return;
  function setHint(state){
    const hint = (window.__ensureContactHint && __ensureContactHint(input)) || null;
    if(!hint) return;
    hint.style.padding = '6px 8px';
    hint.style.borderRadius = '8px';
    hint.style.border = '1px solid rgba(255,255,255,.10)';
    hint.style.background = 'rgba(255,255,255,.04)';
    hint.style.fontWeight = '600';
    if(state==='empty'){ hint.textContent='Введите номер'; hint.style.color='#ffd95a'; }
    else if(state==='ok'){ hint.textContent='Номер введён верно'; hint.style.color='#7CFFA7'; }
    else if(state==='sent'){ hint.textContent='Ваша заявка отправлена'; hint.style.color='#7CFFA7'; }
    else if(state==='bad'){ hint.textContent='Проверь формат номера (пример: +7 999 123-45-67)'; hint.style.color='#ffd95a'; }
  }
  setHint('empty');
  input.addEventListener('input', function(){
    let raw = this.value;
    raw = raw.replace(/[^\d+]/g, '');
    if (raw.startsWith('+')) raw = '+' + raw.slice(1).replace(/\D/g,''); else raw = raw.replace(/\D/g,'');
    raw = raw.replace(/(?!^)\+/g, '');
    let norm = raw.replace(/^\+/, '');
    if (norm.length===11 && norm[0]==='8') norm = '7'+norm.slice(1);
    else if (norm.length===10 && norm[0]==='9') norm = '7'+norm;
    try{ this.value = (window.__maskPhoneRU ? __maskPhoneRU(norm||raw) : raw); }catch(e){ this.value = raw; }
    this.dataset.norm = norm;
    this.classList.remove('attn');
    if(norm && norm.length===11 && norm[0]==='7'){ this.classList.add('ok'); setHint('ok'); }
    else { this.classList.remove('ok'); setHint('empty'); }
  }, {capture:true});
  const btn = document.getElementById('confirmConsult');
  if(btn){
    btn.addEventListener('click', async function(){
      const norm = input.dataset.norm ? input.dataset.norm : (window.__normalizePhoneRU ? __normalizePhoneRU(input.value) : '');
      try{ window.__confAt && __confAt(btn); }catch(_){}
      if(!norm || norm.length!==11){
        input.classList.add('attn');
        input.focus({preventScroll:true});
        setHint('bad');
        (window.__haptic||function(){})('medium');
        return;
      }else{
        try{ input.value = '+'+norm; input.classList.add('ok'); setHint('ok'); }catch(_){}
      }
      const selDate = (window.scope && scope._selDate) || (window.__lastDate) || '';
      const selTime = (window.scope && scope._selTime) || (window.__lastTime) || '';
      const durMin  = (window.scope && scope._durMin)  || (window.__lastDur)  || 30;
      try{
        const obj = { date: selDate, time: selTime, duration_min: durMin };
        localStorage.setItem('last_booking', JSON.stringify(obj));
        const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' мин)'):'') ;
        window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { last_booking: human });
        window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        try{ window.__addBookingDatePrefixTo && __addBookingDatePrefixTo(document.querySelector('#ppBooking')); }catch(_){}
      }catch(_){}
      try{
        const obj = JSON.parse(localStorage.getItem('last_booking')||'{}');
        const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' мин)'):'') ;
        const payload = { type:'consult_booking', contact:'+'+norm, date: obj.date||'', time: obj.time||'', duration_min: obj.duration_min||0, last_booking: human, uid: (window.__uid&&__uid())||'' };
        window.__postGAS && __postGAS(payload);
        setHint('sent');
      }catch(_){}
    }, {capture:true});
  }
})();</script>

<script>
(function(){
  window.__boom = function(x, y){
    try{
      const c = document.createElement('canvas');
      c.width = innerWidth; c.height = innerHeight;
      Object.assign(c.style,{position:'fixed',left:0,top:0,pointerEvents:'none',zIndex:999});
      document.body.appendChild(c);
      const ctx = c.getContext('2d'); const N=140, P=[];
      for(let i=0;i<N;i++){
        P.push({ x,y, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2, g:0.22+Math.random()*0.18, s:4+Math.random()*5, r:Math.random()*Math.PI, col:`hsl(${Math.random()*360},90%,60%)` });
      }
      let t=0;
      (function tick(){
        ctx.clearRect(0,0,c.width,c.height);
        P.forEach(p=>{ p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=0.08;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r); ctx.fillStyle=p.col; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
        });
        t++; if (t<180) requestAnimationFrame(tick); else c.remove();
      })();
    }catch(_){}
  };
  window.__conf = function(){
    try{ if (window.confetti) return confetti({particleCount:140, spread:70}); }catch(_){}
    try{ window.__boom(innerWidth/2, innerHeight*0.33); }catch(_){}
  };
  window.__confAt = function(el){
    try{
      if(!el) return window.__conf();
      const r = el.getBoundingClientRect();
      const x = (r.left + r.width/2);
      const y = (r.top + r.height/2);
      if (window.confetti) return confetti({particleCount:140, spread:70, origin:{ x:x/innerWidth, y:y/innerHeight }});
      return window.__boom(x,y);
    }catch(_){ try{ window.__conf(); }catch(__){} }
  };
})();
</script>


<!-- === app-patch: confetti, phone mask, spin wheel, booking hydrate (guarded) === -->
<script>
(function(){
  if (window.__APP_PATCH_V2__) return; window.__APP_PATCH_V2__ = true;

  window.__boom = window.__boom || function(x, y){
    try{
      const c = document.createElement('canvas');
      c.width = innerWidth; c.height = innerHeight;
      Object.assign(c.style, { position:'fixed', left:0, top:0, pointerEvents:'none', zIndex: 9999 });
      document.body.appendChild(c);
      const ctx = c.getContext('2d'), N=140, P=[];
      for(let i=0;i<N;i++){
        P.push({ x,y, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2, g:0.22+Math.random()*0.18, s:4+Math.random()*5, r:Math.random()*Math.PI, col:`hsl(${Math.random()*360},90%,60%)` });
      }
      let t=0; (function tick(){
        ctx.clearRect(0,0,c.width,c.height);
        for(const p of P){
          p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=0.08;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r); ctx.fillStyle=p.col; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
        }
        if (++t<180) requestAnimationFrame(tick); else c.remove();
      })();
    }catch(_){}
  };
  window.__conf = window.__conf || function(){
    try{ if (window.confetti) return confetti({ particleCount:140, spread:70 }); }catch(_){}
    try{ window.__boom(innerWidth/2, innerHeight*0.33); }catch(_){}
  };
  window.__confAt = window.__confAt || function(el){
    try{
      if(!el) return window.__conf();
      const r = el.getBoundingClientRect();
      const x = r.left + r.width/2, y = r.top + r.height/2;
      if (window.confetti) return confetti({ particleCount:140, spread:70, origin:{ x:x/innerWidth, y:y/innerHeight } });
      return window.__boom(x,y);
    }catch(_){ try{ window.__conf(); }catch(__){} }
  };

  window.__postGAS = window.__postGAS || (async function(payload){
    try{
      if (window.apiEvent && typeof window.apiEvent === 'function'){
        return await window.apiEvent(payload.type || 'event', payload);
      }
      const C = window.APP_CONFIG || {};
      if (C.GAS_WEBHOOK){
        return await fetch(C.GAS_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      }
    }catch(_){}
  });

  function __uid(){
    try{
      return (window.__PROFILE && (__PROFILE.tg_id||__PROFILE.id))
         || (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id)
         || '';
    }catch(_){ return ''; }
  }
  function fmtLeft(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
    return (h? h+'ч ' : '') + (m? m+'м ' : '') + ss+'с';
  }

  window.__normalizePhoneRU = window.__normalizePhoneRU || function(raw){
    let s = String(raw||'').replace(/[^\d+]/g,'');
    if (s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g,''); else s = s.replace(/\D/g,'');
    s = s.replace(/^\+/, '');
    if (s.length===11 && s[0]==='8') s = '7' + s.slice(1);
    if (s.length===10 && s[0]==='9') s = '7' + s;
    if (s.length===11 && s[0]==='7') return s;
    return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : (s.length===10&&s[0]==='9'?'7'+s:''));
  };
  window.__maskPhoneRU = window.__maskPhoneRU || function(v){
    let d = String(v||'').replace(/\D/g,'');
    if (d.startsWith('8')) d = '7'+d.slice(1);
    if (d.length===10 && d[0]==='9') d = '7'+d;
    if (!d.startsWith('7')) d = '7'+d.replace(/^7?/,'');
    const p = (d+'           ').slice(0,11);
    return ('+'+p[0]+' '+p.slice(1,4)+' '+p.slice(4,7)+'-'+p.slice(7,9)+'-'+p.slice(9,11)).trim().replace(/\s+$/,'');
  };
  window.__ensureContactHint = window.__ensureContactHint || function(input){
    try{
      let hint = document.getElementById('contactHint');
      if (!hint){
        hint = document.createElement('div');
        hint.id = 'contactHint';
        hint.style.cssText = 'opacity:.9;font-size:12px;margin-top:4px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-weight:600;';
        input.insertAdjacentElement('afterend', hint);
      }
      return hint;
    }catch(_){ return null; }
  };

  function replaceWithClone(el){ if(!el) return el; const cl = el.cloneNode(true); el.replaceWith(cl); return cl; }

  (function(){ // SPIN
    const btn0 = document.getElementById('spin');
    const out  = document.getElementById('spinRes');
    if (!btn0 || !out) return;
    const btn = replaceWithClone(btn0);

    const uid = String(__uid()||'anon');
    const KEY = 'spin_next_at_'+uid;
    const COOLDOWN = 24*60*60*1000;

    function updateBtn(){
      const now = Date.now();
      const next = Number(localStorage.getItem(KEY)||0);
      if (next>now){ btn.disabled = true; btn.textContent = 'Крутить через ' + fmtLeft(next-now); }
      else { btn.disabled = false; btn.textContent = 'Крутить 🎡'; }
    }
    updateBtn(); let tmr = setInterval(updateBtn, 1000);

    btn.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      const now = Date.now(); const next = Number(localStorage.getItem(KEY)||0);
      if (next>now){ updateBtn(); return; }
      const prizes = ['🎁 Шаблон «Оффер»','📘 Чек-лист аудита','💬 +30 мин консультации','🧮 Доступ к калькулятору PRO','⭐ Приоритетный разбор'];
      let ticks=0; btn.disabled = true;
      const spinInt = setInterval(()=>{ out.textContent = 'Крутим… ' + '⟲'.repeat((ticks%4)+1); ticks++; }, 80);
      setTimeout(()=>{
        clearInterval(spinInt);
        const win = prizes[Math.floor(Math.random()*prizes.length)];
        out.textContent = 'Выпало: ' + win;
        try{ __confAt(btn); }catch(_){}
        try{ localStorage.setItem('last_prizes', JSON.stringify([win])); }catch(_){}
        try{
          const ul = document.getElementById('ppPrizeList');
          if (ul){ ul.innerHTML=''; const li=document.createElement('li'); li.textContent=win; li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)'; ul.appendChild(li); }
          const pp = document.getElementById('ppPrize'); if (pp) pp.textContent = win;
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { prizes: ((window.__PROFILE&&window.__PROFILE.prizes)||[]).concat([{title:win}]).slice(-10) });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        }catch(_){}
        try{
          const until = Date.now()+COOLDOWN;
          localStorage.setItem(KEY, String(until));
        }catch(_){}
        updateBtn();
        try{
          const payload = { type:'community_prize', prize: win, prizes_json: JSON.parse(localStorage.getItem('last_prizes')||'[]'), spin_next_at: new Date(Number(localStorage.getItem(KEY)||0)).toISOString(), uid: uid };
          window.__postGAS && __postGAS(payload);
        }catch(_){}
      }, 1400);
    }, {capture:true});
  })();

  (function(){ // CONTACT
    const input0 = document.getElementById('contact');
    const btn0   = document.getElementById('confirmConsult');
    if (!input0 && !btn0) return;
    const input = input0 ? replaceWithClone(input0) : null;
    const btn   = btn0   ? replaceWithClone(btn0)   : null;

    function setHint(state){
      const hint = window.__ensureContactHint && __ensureContactHint(input);
      if (!hint) return;
      if (state==='empty'){ hint.textContent='Введите номер'; hint.style.color='#ffd95a'; }
      else if (state==='ok'){ hint.textContent='Номер введён верно'; hint.style.color='#7CFFA7'; }
      else if (state==='bad'){ hint.textContent='Проверь формат номера (пример: +7 999 123-45-67)'; hint.style.color='#ffd95a'; }
      else if (state==='sent'){ hint.textContent='Ваша заявка отправлена'; hint.style.color='#7CFFA7'; }
    }

    if (input){
      setHint('empty');
      input.addEventListener('input', function(){
        let raw = this.value;
        raw = raw.replace(/[^\d+]/g,'');
        if (raw.startsWith('+')) raw = '+' + raw.slice(1).replace(/\D/g,''); else raw = raw.replace(/\D/g,'');
        raw = raw.replace(/(?!^)\+/g, '');
        let norm = raw.replace(/^\+/, '');
        if (!norm.length){ this.value=''; this.dataset.norm=''; this.classList.remove('ok','attn'); setHint('empty'); return; }
        if (norm.length===11 && norm[0]==='8') norm = '7'+norm.slice(1);
        else if (norm.length===10 && norm[0]==='9') norm = '7'+norm;
        try{ this.value = (window.__maskPhoneRU ? __maskPhoneRU(norm) : raw); }catch(e){ this.value = raw; }
        this.dataset.norm = norm;
        this.classList.remove('attn');
        if (norm.length===11 && norm[0]==='7'){ this.classList.add('ok'); setHint('ok'); }
        else { this.classList.remove('ok'); setHint('empty'); }
      }, {capture:true});
    }

    if (btn){
      btn.addEventListener('click', function(){
        const norm = (input && input.dataset && input.dataset.norm) ? input.dataset.norm : (window.__normalizePhoneRU ? __normalizePhoneRU(input.value) : '');
        if (!norm || norm.length!==11){
          input && input.classList.add('attn');
          input && input.focus({preventScroll:true});
          setHint('bad');
          return;
        }
        try{ __confAt(btn); }catch(_){}
        try{ if (input){ input.value = '+'+norm; input.classList.add('ok'); setHint('ok'); } }catch(_){}
        const selDate = (window.scope && scope._selDate) || (window.__lastDate) || '';
        const selTime = (window.scope && scope._selTime) || (window.__lastTime) || '';
        const durMin  = (window.scope && scope._durMin)  || (window.__lastDur)  || 30;
        try{
          const obj = { date: selDate, time: selTime, duration_min: durMin };
          localStorage.setItem('last_booking', JSON.stringify(obj));
          const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' мин)'):'') ;
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { last_booking: human });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
          const dmy = (function(iso){ const m=(iso||'').match(/(\d{4})-(\d{2})-(\d{2})/); return m ? (m[3]+'.'+m[2]+'.'+m[1]) : ''; })(obj.date||'');
          [document.querySelector('#ppBooking'), document.querySelector('#p_record')].forEach(el=>{
            if (!el) return;
            const t = (el.textContent||'').trim();
            if (dmy && !t.startsWith(dmy)) el.textContent = (dmy + ' ' + t).trim();
          });
        }catch(_){}
        try{
          const obj = JSON.parse(localStorage.getItem('last_booking')||'{}');
          const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' мин)'):'') ;
          const payload = { type:'consult_booking', contact:'+'+norm, date: obj.date||'', time: obj.time||'', duration_min: obj.duration_min||0, last_booking: human, uid: __uid()||'' };
          window.__postGAS && __postGAS(payload);
          setHint('sent');
        }catch(_){}
      }, {capture:true});
    }
  })();

  (function(){ // On open: prefix date + render last prize
    try{
      const lb = localStorage.getItem('last_booking')||'';
      let dmy='';
      if (lb && lb.trim().startsWith('{')){
        const o = JSON.parse(lb);
        const m = (o.date||'').match(/(\d{4})-(\d{2})-(\d{2})/);
        if (m) dmy = m[3]+'.'+m[2]+'.'+m[1];
      } else if (lb){
        const m = lb.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (m) dmy = m[3]+'.'+m[2]+'.'+m[1];
      }
      if (dmy){
        [document.querySelector('#ppBooking'), document.querySelector('#p_record')].forEach(el=>{
          if (!el) return;
          const t = (el.textContent||'').trim();
          if (!t.startsWith(dmy)) el.textContent = (dmy + ' ' + t).trim();
        });
      }
    }catch(_){}
    try{
      const arr = JSON.parse(localStorage.getItem('last_prizes')||'[]');
      const last = arr && arr[0];
      const ul = document.getElementById('ppPrizeList');
      if (ul && last){
        ul.innerHTML='';
        const li=document.createElement('li'); li.textContent=last;
        li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
        ul.appendChild(li);
      }
    }catch(_){}
  })();

})();
</script>
<!-- === /app-patch === -->


<script>
(function(){
  if (window.__BOOKING_BRIDGE_V2__) return; window.__BOOKING_BRIDGE_V2__ = true;

  function dd2(n){ return String(n).padStart(2,'0'); }
  var RU = ['январ','феврал','март','апрел','май','июн','июл','август','сентябр','октябр','ноябр','декабр'];

  function pickDateFromCalendar(){
    try{
      var head = document.querySelector('#cal .cal-head .mon') || document.querySelector('#cal .mon');
      var sel  = document.querySelector('#cal .cal-cell.sel');
      if (!head || !sel) return '';
      var t = (head.textContent||'').toLowerCase();
      var y = (t.match(/\d{4}/)||[])[0] || new Date().getFullYear();
      var stem = RU.findIndex(s => t.includes(s));
      var m = stem>=0 ? dd2(stem+1) : dd2(new Date().getMonth()+1);
      var d = parseInt((sel.dataset.day || sel.textContent || '').replace(/\D+/g,''),10);
      if (!d) return '';
      var iso = y + '-' + m + '-' + dd2(d);
      sel.dataset.date = sel.dataset.date || iso;
      return iso;
    }catch(_){ return ''; }
  }

  function pickTimeFromSlots(){
    try{
      var btn = document.querySelector('#slots .btn.btn-primary, #slots .btn.active, #slots button[aria-pressed="true"]');
      var raw = (btn && (btn.dataset.time || btn.textContent)) || '';
      var m = String(raw).match(/\b\d{2}:\d{2}\b/);
      return m ? m[0] : '';
    }catch(_){ return ''; }
  }

  function getSelectedFormat(){
    try{
      if (window.scope && (scope._format || scope.format)) return (scope._format || scope.format);
      if (window.SEL && SEL.type) return SEL.type;
      var b = document.querySelector('.consult-type.btn-primary, .consult-type.active, .consult-type[aria-pressed="true"]');
      return (b && b.dataset && b.dataset.type) || '';
    }catch(_){ return ''; }
  }

  function getSelectedBooking(){
    var date = '', time = '', dur = 30;
    try{ date = (window.scope && (scope._selDate || scope.selDate)) || ''; }catch(_){}
    try{ time = (window.scope && (scope._selTime || scope.selTime)) || ''; }catch(_){}
    try{ dur  = (window.scope && (scope._durMin  || scope.durMin))  || 30; }catch(_){}

    if (!date || !time){
      try{
        var s = JSON.parse(localStorage.getItem('consult_selected')||'{}');
        if (!date && s.date) date = s.date;
        if (!time && s.time) time = s.time;
      }catch(_){}
    }

    if (!date){
      var dp = document.getElementById('datePick');
      if (dp && dp.value) { date = new Date(dp.value).toISOString().slice(0,10); }
      if (!date) { date = pickDateFromCalendar(); }
    }
    if (!time) time = pickTimeFromSlots();

    try{
      var dBtn = document.querySelector('.dur.btn-primary, .dur.active');
      if (dBtn && dBtn.dataset.min) dur = parseInt(dBtn.dataset.min,10)||dur;
    }catch(_){}

    return { date: date||'', time: time||'', duration_min: dur||30 };
  }

  window.getSelectedBooking = window.getSelectedBooking || getSelectedBooking;

  function attachTgInit(payload){
    try{
      if (!payload.tg_init && window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) {
        payload.tg_init = Telegram.WebApp.initData;
      }
    }catch(_){}
    return payload;
  }

  (function(){
    var prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      data = data || {};
      try{
        if (type==='consult_booking' || (data && data.type==='consult_booking')) {
          var pick = getSelectedBooking();
          if (!data.date) data.date = pick.date;
          if (!data.time) data.time = pick.time;
          if (!data.duration_min) data.duration_min = pick.duration_min;
          if (!data.format) data.format = getSelectedFormat();
        }
      }catch(_){}
      data = attachTgInit(data);
      if (typeof prev === 'function') return prev(type, data);
      if (typeof window.__postGAS === 'function') {
        var payload = Object.assign({ type: type || (data && data.type) || '' }, data);
        return await window.__postGAS(payload);
      }
    };
  })();

  (function(){
    var prev = window.__postGAS;
    if (typeof prev !== 'function') return;
    window.__postGAS = async function(payload){
      payload = payload || {};
      try{
        if (payload.type === 'consult_booking') {
          var pick = getSelectedBooking();
          if (!payload.date) payload.date = pick.date;
          if (!payload.time) payload.time = pick.time;
          if (!payload.duration_min) payload.duration_min = pick.duration_min;
          if (!payload.format) payload.format = getSelectedFormat();
        }
      }catch(_){}
      payload = attachTgInit(payload);
      return prev(payload);
    };
  })();

})();
</script>

<script>
// === Calendar × GAS (минимальная интеграция) ===
(function(){
  if (window.__CAL_MIN_GAS__) return; window.__CAL_MIN_GAS__ = true;

  // RU -> MM
  const RU2MM = { 'янв':'01','фев':'02','мар':'03','апр':'04','мая':'05','май':'05','июн':'06','июл':'07','авг':'08','сен':'09','сент':'09','окт':'10','ноя':'11','дек':'12' };
  const dd2 = (n)=>String(n).padStart(2,'0');
  const qs = (s,root=document)=>root.querySelector(s);
  const qsa= (s,root=document)=>Array.from(root.querySelectorAll(s));

  function parseYM(){
    const head = qs('#cal .cal-head .mon');
    if (!head) return null;
    const txt = (head.textContent||'').trim().toLowerCase();   // "Октябрь 2025"
    const m = txt.match(/([а-яa-zё]+)\s+(\d{4})/i);
    if (!m) return null;
    const stem = m[1].slice(0,3).replace('ё','е');
    const mm = RU2MM[stem];
    return mm ? { y: m[2], m: mm } : null;
  }

  async function loadFreeSlots(y, m){
    const base = window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK;
    if (!base) { console.warn('[cal] APP_CONFIG.GAS_WEBHOOK пуст'); return false; }
    const first = `${y}-${m}-01`;
    const last  = `${y}-${m}-${dd2(new Date(+y,+m,0).getDate())}`;

    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('gran','30');
    u.searchParams.set('lead_min','120');
    u.searchParams.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
    try{
      const tg = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
      if (tg) u.searchParams.set('tg_init', tg);
      else if (window.APP_CONFIG && APP_CONFIG.API_KEY) u.searchParams.set('key', APP_CONFIG.API_KEY);
    }catch(_){}

    const r = await fetch(u.toString()).catch(()=>null);
    const j = r && await r.json().catch(()=>null);
    if (!j || !j.ok) { console.warn('[cal] free_slots error', j); return false; }
    window.__FREE__ = j.days || {}; window.__GRAN__ = j.gran || 30;
    return true;
  }

  function dayHasSlots(iso){
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    return Array.isArray(arr) && arr.length > 0;
  }

  function applyDays(y, m){
    const grid = qs('#cal .cal-grid'); if (!grid) return;
    qsa('.cal-cell', grid).forEach(cell=>{
      if (cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if (!day || /\D/.test(day)) return;
      const iso = `${y}-${m}-${dd2(day)}`;
      cell.dataset.iso = iso;
      if (dayHasSlots(iso)) {
        cell.classList.remove('off','muted');
        cell.removeAttribute('aria-disabled');
      } else {
        cell.classList.add('off','muted');
        cell.setAttribute('aria-disabled','true');
      }
    });
  }

  function renderSlots(iso){
    const wrap = qs('#slots,#slotsTime'); if (!wrap) return;
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    wrap.innerHTML = ''; wrap.classList.add('show');
    if (!arr.length) { wrap.innerHTML = '<div class="muted">Нет свободных слотов</div>'; return; }
    arr.forEach(t=>{
      const b = document.createElement('button');
      b.className = 'btn btn-ghost'; b.textContent = t; b.dataset.time = t;
      b.onclick = ()=>{
        qsa('button', wrap).forEach(x=>x.classList.remove('btn-primary','active'));
        b.classList.add('btn-primary','active');
        window.scope = window.scope || {}; scope._selTime = t;
        window.SEL = window.SEL || {}; SEL.time = t;
      };
      wrap.appendChild(b);
    });
  }

  async function syncMonth(){
    const ym = parseYM(); if (!ym) return;
    const ok = await loadFreeSlots(ym.y, ym.m); if (!ok) return;
    applyDays(ym.y, ym.m);
  }

  // init (чуть позже, чтобы календарь успел отрисоваться)
  setTimeout(syncMonth, 50);

  // перелистывание месяцев
  document.addEventListener('click', (e)=>{
    if (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM')) setTimeout(syncMonth, 30);
  });

  // выбор дня -> слоты
  document.addEventListener('click', (e)=>{
    const cell = e.target.closest && e.target.closest('#cal .cal-cell');
    if (!cell || cell.classList.contains('off')) return;
    const iso = cell.dataset.iso || cell.dataset.date;
    if (iso) {
      window.scope = window.scope || {}; scope._selDate = iso; window.__selDate = iso;
      renderSlots(iso);
    }
  });
})();
</script>

<!-- ==== STEP2 NORMAL: tails hidden + monthly cache (race-safe, non-invasive) ==== -->
<style>
  /* Хвосты соседних месяцев — полностью скрываем и запрещаем клики */
  #cal .cal-cell.tail{ visibility:hidden; pointer-events:none; }
</style>
<script>
(function(){
  if (window.__CAL_STEP2_NORMAL__) return; window.__CAL_STEP2_NORMAL__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const dd2 = (n)=>String(n).padStart(2,'0');
  const TZ  = (Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');

  // ---------- MONTH HELPERS ----------
  function parseYM_fallback(){
    const h = qs('#cal .cal-head .mon') || qs('#cal .mon');
    if (!h) return null;
    const t = (h.textContent||'').trim();
    const m = t.match(/([А-Яа-яA-Za-zЁё]+)\s+(\d{4})/);
    if (!m) return null;
    const map = {янв:'01',фев:'02',мар:'03',апр:'04',мая:'05',май:'05',июн:'06',июл:'07',авг:'08',сен:'09',сент:'09',окт:'10',ноя:'11',дек:'12',
                 jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
    const stem = m[1].toLowerCase().replace('ё','е').slice(0,3);
    const mm = map[stem]; if (!mm) return null;
    return { y: m[2], m: mm };
  }
  function parseYM(){
    try{
      if (typeof window.parseYM === 'function'){ const r = window.parseYM(); if (r && r.y && r.m) return r; }
    }catch(_){}
    try{
      if (typeof window.parseHeadYM === 'function'){ const r = window.parseHeadYM(); if (r && r.y && r.m) return r; }
    }catch(_){}
    return parseYM_fallback();
  }
  function daysInMonth(y,m){ return new Date(+y, +m, 0).getDate(); }

  // ---------- TAILS MARKER ----------
  function markTailsAndAttachISO(ym){
    const grid = qs('#cal .cal-grid'); if (!grid) return;
    const cells = qsa('.cal-cell', grid).filter(c=>!c.classList.contains('cal-dow'));
    if (!cells.length) return;

    // Найти индекс первой ячейки с "1"
    let startIdx = -1;
    for (let i=0;i<cells.length;i++){
      const raw = (cells[i].dataset.day || cells[i].textContent || '').trim();
      if (/^\d+$/.test(raw) && parseInt(raw,10) === 1){ startIdx = i; break; }
    }
    if (startIdx < 0) startIdx = 0;

    const total = daysInMonth(ym.y, ym.m);
    const endIdx = startIdx + total - 1;

    cells.forEach((cell, idx)=>{
      const dayTxt = (cell.dataset.day || cell.textContent || '').trim();
      const dayNum = /^\d+$/.test(dayTxt) ? parseInt(dayTxt,10) : NaN;
      const inMonth = (idx >= startIdx && idx <= endIdx && !isNaN(dayNum) && dayNum>=1 && dayNum<=total);
      if (inMonth){
        const iso = `${ym.y}-${ym.m}-${dd2(dayNum)}`;
        cell.dataset.iso = iso;
        cell.classList.remove('tail');
        cell.style.visibility = '';
      } else {
        cell.classList.add('tail','off');
        cell.setAttribute('aria-disabled','true');
        if (cell.dataset.iso) delete cell.dataset.iso;
      }
    });
  }

  // ---------- MONTH CACHE (RAM + sessionStorage) ----------
  const TTL_MS = 60 * 1000; // 3 минуты
  const RAM = new Map();
  function keyYM(y,m){ return `${y}-${m}`; }
  function getCache(y,m){
    const k = keyYM(y,m);
    let e = RAM.get(k);
    if (!e){
      try{ e = JSON.parse(sessionStorage.getItem('free:'+k) || 'null'); }catch(_){ e = null; }
      if (e) RAM.set(k, e);
    }
    if (e && (Date.now() - (e.ts||0)) < TTL_MS) return e;
    return null;
  }
  function setCache(y,m,days,gran,tz){
    const k = keyYM(y,m);
    const e = { ts: Date.now(), days: days||{}, gran: gran||30, tz: tz||TZ };
    RAM.set(k, e);
    try{ sessionStorage.setItem('free:'+k, JSON.stringify(e)); }catch(_){}
    return e;
  }
  function invalidateMonth(y,m){
    const k = keyYM(y,m);
    RAM.delete(k);
    try{ sessionStorage.removeItem('free:'+k); }catch(_){}
  }

  // ---------- WRAPS (non-invasive) ----------
  // 1) Оборачиваем applyDays/applyDaysState, чтобы сначала отмечать хвосты
  (function(){
    const wrapApply = (fnName, mapper)=>{
      const orig = window[fnName];
      if (typeof orig !== 'function') return;
      window[fnName] = function(){
        // попытка достать YM из аргументов или заголовка
        let ym = null;
        if (arguments.length && typeof arguments[0]==='object' && arguments[0].y && arguments[0].m){
          ym = arguments[0];
        } else if (arguments.length>=2) {
          ym = { y: arguments[0], m: arguments[1] };
        } else {
          ym = parseYM();
        }
        if (ym) try{ markTailsAndAttachISO(ym); }catch(_){}
        return orig.apply(this, arguments);
      };
    };
    wrapApply('applyDays');        // V5
    wrapApply('applyDaysState');   // ранний блок
  })();

  // 2) Оборачиваем загрузчики месяца, добавляя кэш и race-guard
  (function(){
    // общий реквест-id (если ранее уже добавили — используем его)
    window.__CAL_REQ_ID__ = window.__CAL_REQ_ID__ || 0;

    // V5: loadFreeSlots(y, m) -> Promise<{days,gran,tz}>
    if (typeof window.loadFreeSlots === 'function'){
      const orig = window.loadFreeSlots;
      window.loadFreeSlots = async function(y, m, opt){
        opt = opt || {};
        const cached = getCache(y,m);
        if (cached && !opt.force){
          // синхронизируем глобалы для совместимости
          window.__GRAN__ = cached.gran;
          window.__FREE__ = cached.days;
          return { ok:true, days: cached.days, gran: cached.gran, tz: cached.tz, cached:true };
        }
        const my = ++window.__CAL_REQ_ID__;
        const res = await orig.apply(this, arguments);
        if (my !== window.__CAL_REQ_ID__) return res; // устарел — ничего не делаем
        try{
          if (res && res.days){ setCache(y,m, res.days, res.gran, res.tz); }
          else if (window.__FREE__){ setCache(y,m, window.__FREE__, window.__GRAN__||30, TZ); }
        }catch(_){}
        return res;
      };
    }

    // Ранний блок: loadFreeSlotsForMonth(y, m) -> async (заполняет window.__FREE__)
    if (typeof window.loadFreeSlotsForMonth === 'function'){
      const orig2 = window.loadFreeSlotsForMonth;
      window.loadFreeSlotsForMonth = async function(y, m, opt){
        opt = opt || {};
        const cached = getCache(y,m);
        if (cached && !opt.force){
          window.__GRAN__ = cached.gran;
          window.__FREE__ = cached.days;
          return; // из кэша уже всё положили
        }
        const my = ++window.__CAL_REQ_ID__;
        await orig2.apply(this, arguments);
        if (my !== window.__CAL_REQ_ID__) return; // устарел
        try{
          if (window.__FREE__){ setCache(y,m, window.__FREE__, window.__GRAN__||30, TZ); }
        }catch(_){}
      };
    }
  })();

  // 3) После успешной брони инвалидация кэша и мягкое обновление
  (function(){
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      const res = prev ? await prev(type, data) : undefined;
      try{
        if ((type==='consult_booking' || (data && data.type==='consult_booking')) && res && res.ok){
          const date = (data && data.date) || (window.scope && (scope._selDate||scope.selDate)) || '';
          if (date && /^\d{4}-\d{2}-\d{2}$/.test(date)){
            const ym = { y: date.slice(0,4), m: date.slice(5,7) };
            invalidateMonth(ym.y, ym.m);
            // локально вычеркнем занятый старт, если он в __FREE__
            const t = (data && data.time) || (window.scope && (scope._selTime||scope.selTime));
            const dur = (data && +data.duration_min) || (window.scope && +scope._durMin) || 30;
            const step = window.__GRAN__ || 30;
            if (window.__FREE__ && window.__FREE__[date] && t){
              const arr = window.__FREE__[date];
              const idx = arr.indexOf(t);
              if (idx>=0){
                const removeCount = Math.max(1, Math.ceil(dur / step));
                // удаляем непрерывную цепочку шагов
                for (let i=0;i<removeCount;i++){
                  const hh = (function(m){ const H=String(Math.floor(m/60)).padStart(2,'0'); const M=String(m%60).padStart(2,'0'); return H+':'+M; })(
                    (function(s){ const m=s.split(':').map(Number); return m[0]*60+m[1]; })(t) + i*step
                  );
                  const j = arr.indexOf(hh); if (j>=0) arr.splice(j,1);
                }
                if (!arr.length){ const ym2 = parseYM(); if (ym2) markTailsAndAttachISO(ym2); }
              }
            }
            // мягко перезагрузим месяц (если есть функции)
            if (typeof window.syncMonthAndDays === 'function') { try{ await window.syncMonthAndDays(); }catch(_){} }
            else if (typeof window.syncMonth === 'function')    { try{ await window.syncMonth(); }catch(_){} }
          }
        }
      }catch(_){}
      return res;
    };
  })();

  // 4) Первичная отметка хвостов после начальной отрисовки сетки
  setTimeout(()=>{ const ym = parseYM(); if (ym) markTailsAndAttachISO(ym); }, 50);

  // 5) После переключения месяца — тоже отметим хвосты (перехватываем клики на prev/next)
  document.addEventListener('click', (e)=>{
    if (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM')){
      setTimeout(()=>{ const ym = parseYM(); if (ym) markTailsAndAttachISO(ym); }, 60);
    }
  });
})();
</script>


<!-- ==== STEP3 STABLE: lock past days + auto-pick allowed slot after filter ==== -->
<script>
(function(){
  if (window.__CAL_STEP3_STABLE__) return; window.__CAL_STEP3_STABLE__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const TZ  = (Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');

  function todayISO(){
    try{ return new Date().toLocaleString('sv-SE', { timeZone: TZ }).slice(0,10); }
    catch(_){ return new Date().toISOString().slice(0,10); }
  }

  function lockPastDays(){
    const today = todayISO();
    qsa('#cal .cal-cell').forEach(cell=>{
      if (cell.classList.contains('cal-dow') || cell.classList.contains('tail')) return;
      const iso = cell.dataset.iso;
      if (iso && iso < today){
        cell.classList.add('off','muted');
        cell.setAttribute('aria-disabled','true');
      }
    });
  }

  // run initially and on calendar mutations / month nav
  setTimeout(lockPastDays, 120);
  document.addEventListener('click', (e)=>{
    if (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM')){
      setTimeout(lockPastDays, 80);
    }
  });
  const grid = qs('#cal .cal-grid');
  if (grid){
    new MutationObserver(()=>{ setTimeout(lockPastDays, 20); })
      .observe(grid, { childList:true, subtree:true });
  }

  // ---- Auto-select first allowed time slot when needed ----
  function autoPickFirstAllowed(){
    const wrap = qs('#slots,#slotsTime'); if (!wrap) return;
    const active  = wrap.querySelector('button.btn-primary,button.active');
    const allowed = wrap.querySelector('button:not(.off):not([disabled])');
    if (!active && allowed) allowed.click();
  }

  // On duration change or day click, ensure some allowed slot is selected
  document.addEventListener('click', (e)=>{
    if (e.target.closest('.dur,[data-dur],[data-duration],input[name="duration"],#duration,select[name="duration"]')){
      setTimeout(autoPickFirstAllowed, 60);
    }
    if (e.target.closest('#cal .cal-cell')){
      setTimeout(autoPickFirstAllowed, 80);
    }
  });

  // Observe slots container for async renders and re-filter events
  const wrap = qs('#slots,#slotsTime');
  if (wrap){
    new MutationObserver(()=>{ setTimeout(autoPickFirstAllowed, 10); })
      .observe(wrap, { childList:true, subtree:true });
  }
})();
</script>


<!-- ==== STEP4 SINGLE-SOURCE: route all calendar logic through V5 to avoid double renders ==== -->
<script>
(function(){
  if (window.__CAL_STEP4_SINGLE__) return; window.__CAL_STEP4_SINGLE__ = true;

  // Идея: не удаляем старые блоки, а мягко перенаправляем их в V5-реализацию,
  // чтобы не было двух источников истины (ранний блок + V5).
  // Это убирает дублированные перерисовки и «скачки».

  const preferV5 = true;

  // 1) Если вызывают ранний syncMonthAndDays — перезапускаем V5 syncMonth
  if (preferV5 && typeof window.syncMonthAndDays === 'function'){
    const _noop = async function(){
      if (typeof window.syncMonth === 'function') { try { return await window.syncMonth(); } catch(_){} }
      return undefined;
    };
    window.syncMonthAndDays = _noop;
  }

  // 2) Если вызывают ранний loadFreeSlotsForMonth — прокидываем в V5 loadFreeSlots
  if (preferV5 && typeof window.loadFreeSlotsForMonth === 'function'){
    window.loadFreeSlotsForMonth = async function(y, m, opt){
      if (typeof window.loadFreeSlots === 'function'){
        const res = await window.loadFreeSlots(y, m, opt);
        if (res && res.days){
          window.__FREE__ = res.days;
          if (res.gran) window.__GRAN__ = res.gran;
        }
      }
    };
  }

  // 3) Если вызывают ранний applyDaysState — используем V5 applyDays
  if (preferV5 && typeof window.applyDaysState === 'function'){
    window.applyDaysState = function(y, m){
      let ym = (typeof y === 'object' && y && y.y && y.m) ? y : { y, m };
      if (typeof window.applyDays === 'function' && window.__FREE__){
        try { return window.applyDays(ym, window.__FREE__); } catch(_){}
      }
    };
  }

  // 4) Приведём начальный запуск к одному месту: если оба блока пытаются делать init — оставим V5-пайплайн
  // Для надёжности запустим V5 sync с небольшим отложением (если уже был — просто обновит)
  setTimeout(function(){
    if (typeof window.syncMonth === 'function'){
      try { window.syncMonth(); } catch(_) {}
    }
  }, 100);

  // 5) Убедимся, что обработчики навигации по месяцам не множатся:
  // Введём флаг и сами подпишемся один раз; оставшиеся слушатели пусть отработают, но V5 всё равно перерисует последним.
  if (!window.__CAL_NAV_BOUND__){
    window.__CAL_NAV_BOUND__ = true;
    document.addEventListener('click', function(e){
      if (e.target.closest && (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM'))){
        setTimeout(function(){
          if (typeof window.syncMonth === 'function'){
            try { window.syncMonth(); } catch(_){}
          }
        }, 50);
      }
    });
  }

  // 6) На случай, если другие блоки дергают рендер слотов напрямую — V5 остаётся источником правды (он последним перерисует слоты по выбранному дню)
  // Дополнительно, если слоты дорисовались, применим фильтр длительности (из STEP3) и авто-подбор (из STEP3)
  function applyPostSlotAdjust(){
    try{
      if (typeof window.refilterSlots === 'function') window.refilterSlots();
      // Автовыбор уже добавлен в STEP3 (autoPickFirstAllowed), просто дернем вручную если есть
      if (window.__CAL_STEP3_STABLE__){
        const wrap = document.querySelector('#slots,#slotsTime');
        if (wrap && !wrap.querySelector('button.btn-primary,button.active')){
          const first = wrap.querySelector('button:not(.off):not([disabled])');
          if (first) first.click();
        }
      }
    }catch(_){}
  }
  const slotsWrap = document.querySelector('#slots,#slotsTime');
  if (slotsWrap){
    new MutationObserver(function(){ setTimeout(applyPostSlotAdjust, 10); })
      .observe(slotsWrap, { childList:true, subtree:true });
  }
})();
</script>


<!-- ==== STEP5 HARDEN: fail-soft syncMonth, single booking resync, no-dates stub, extra race-guards ==== -->
<script>
(function(){
  if (window.__CAL_STEP5_HARDEN__) return; window.__CAL_STEP5_HARDEN__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const dd2 = (n)=>String(n).padStart(2,'0');
  const TZ  = (Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');

  function fallbackYM(){
    const now = new Date();
    return { y:String(now.getFullYear()), m: dd2(now.getMonth()+1) };
  }

  // ---------- Fail-soft syncMonth (V5) ----------
  if (typeof window.syncMonth === 'function' && typeof window.fetchFreeSlotsMonth === 'function'){
    window.__CAL_REQ_ID__ = window.__CAL_REQ_ID__ || 0;
    const _orig_syncMonth = window.syncMonth;
    window.syncMonth = async function(){
      const ym = (typeof window.parseYM==='function' && window.parseYM()) || fallbackYM();
      const my = ++window.__CAL_REQ_ID__;
      let j = null;
      try { j = await window.fetchFreeSlotsMonth(ym.y, ym.m); } catch(_){ j = null; }
      if (my !== window.__CAL_REQ_ID__) return;  // устарел

      if (!j || j.ok === false || !j.days){
        try{
          if (typeof window.getCache === 'function'){
            const c = window.getCache(ym.y, ym.m);
            if (c && c.days){
              window.__FREE__ = c.days;
              window.__GRAN__ = c.gran || 30;
              if (typeof window.applyDays === 'function') window.applyDays(ym, window.__FREE__);
              else if (typeof window.applyDaysFromMap === 'function') window.applyDaysFromMap(ym, window.__FREE__);
            }
          }
        }catch(_){}
        return;
      }

      window.__FREE__ = j.days || {};
      window.__GRAN__ = j.gran || 30;
      if (typeof window.applyDays === 'function') window.applyDays(ym, window.__FREE__);
      else if (typeof window.applyDaysFromMap === 'function') window.applyDaysFromMap(ym, window.__FREE__);
    };
  }

  // ---------- Single booking resync (dedup) ----------
  (function(){
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      const res = prev ? await prev(type, data) : undefined;
      try{
        if ((type==='consult_booking' || (data && data.type==='consult_booking')) && res && res.ok){
          if (window.__CAL_BOOKING_HANDLED__) return res;
          window.__CAL_BOOKING_HANDLED__ = true;
          const date = (data && data.date) || (window.scope && (scope._selDate||scope.selDate)) || '';
          if (date && window.__FREE__ && window.__FREE__[date]){
            const step = window.__GRAN__ || 30;
            const dur  = (data && +data.duration_min) || (window.scope && +scope._durMin) || 30;
            const start = (data && data.time) || (window.scope && (scope._selTime||scope.selTime));
            if (start){
              const toMin = s => { const [h,m]=s.split(':').map(Number); return h*60+m; };
              const add   = (s,dm)=>{ const t=toMin(s)+dm; const H=String(Math.floor(t/60)).padStart(2,'0'); const M=String(t%60).padStart(2,'0'); return H+':'+M; };
              const need = Math.max(1, Math.ceil(dur/step));
              const arr = window.__FREE__[date];
              for (let i=0;i<need;i++){
                const hh = add(start, i*step);
                const idx = arr.indexOf(hh);
                if (idx>=0) arr.splice(idx,1);
              }
            }
          }
          try {
            const ym = { y: date.slice(0,4), m: date.slice(5,7) };
            if (typeof window.invalidateMonth === 'function') window.invalidateMonth(ym.y, ym.m);
          } catch(_){}
          try {
            if (typeof window.syncMonth === 'function') await window.syncMonth();
          } catch(_){}
          setTimeout(()=>{ window.__CAL_BOOKING_HANDLED__ = false; }, 300);
        }
      }catch(_){}
      return res;
    };
  })();

  // ---------- No-dates stub ----------
  (function(){
    function showNoDatesStub(on){
      let stub = document.getElementById('noDatesStub');
      if (on){
        if (!stub){
          stub = document.createElement('div');
          stub.id='noDatesStub';
          stub.className='cal-stub';
          stub.textContent='Нет свободных дат в этом месяце';
          (qs('#cal')||document.body).appendChild(stub);
        }
      } else if (stub){ stub.remove(); }
    }
    function checkAndToggleStub(){
      const any = qsa('#cal .cal-cell[data-iso]:not(.off):not(.tail)').length > 0;
      showNoDatesStub(!any);
    }
    ['applyDays','applyDaysFromMap'].forEach(fnName=>{
      const orig = window[fnName];
      if (typeof orig === 'function'){
        window[fnName] = function(){
          const r = orig.apply(this, arguments);
          try { checkAndToggleStub(); } catch(_){ }
          return r;
        };
      }
    });
    setTimeout(()=>{ try{ checkAndToggleStub(); }catch(_){ } }, 200);
  })();

  // ---------- Debounce for month navigation ----------
  (function(){
    if (!window.__CAL_NAV_DEBOUNCE__){
      window.__CAL_NAV_DEBOUNCE__ = true;
      let t = null;
      document.addEventListener('click', (e)=>{
        if (e.target.closest && (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM'))){
          if (t) clearTimeout(t);
          t = setTimeout(()=>{ try{ window.syncMonth && window.syncMonth(); }catch(_){ } }, 80);
        }
      });
    }
  })();
})();
</script>

<style>
  .cal-stub{
    margin: 8px 0 0;
    padding: 10px 12px;
    border-radius: 10px;
    background: rgba(255,255,255,.08);
    font-size: 13px;
    opacity: .8;
  }
</style>

</body>
</html>

<!-- === HOTFIX V7.2 — Calendar × GAS (robust YM parsing, optimistic remove, debounce book) === -->
<script>
(function(){
  if (window.__CAL_GAS_HOTFIX_V72__) return; window.__CAL_GAS_HOTFIX_V72__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const dd2 = (n)=>String(n).padStart(2,'0');
  const RU2MM = {
    'янв':'01','фев':'02','мар':'03','апр':'04','мая':'05','май':'05','июн':'06',
    'июл':'07','авг':'08','сен':'09','сент':'09','окт':'10','ноя':'11','дек':'12'
  };

  function nowTzISO(tz){
    try{ return new Date().toLocaleString('sv-SE', { timeZone: tz }).slice(0,10); }
    catch(_){ return new Date().toISOString().slice(0,10); }
  }
  const USER_TZ = (Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
  const todayISO = nowTzISO(USER_TZ);

  // --- YM parser: tolerates commas, quotes, two-digit years, extra spaces ---
  function parseYM(){
    const el = qs('#cal .cal-head .mon') || qs('#cal .mon') || qs('.cal-month') || qs('[data-cal-month]');
    if (!el) return null;
    const raw = (el.textContent||'').toLowerCase().replace(/[,'`´’ʻ‘]/g,' ').replace(/\s+/g,' ').trim();
    // Examples accepted: "октябрь 2025", "октябрь 25", "октябрь, 2025", "октябрь ’25"
    const m = raw.match(/([а-яёa-z]+)\s+(\d{2,4})/i);
    if (!m) return null;
    const monthStem = m[1].slice(0,4).replace('ё','е');
    const mm = RU2MM[monthStem.slice(0,3)] || RU2MM[monthStem.slice(0,4)];
    let y = m[2];
    if (y.length === 2){
      const yy = parseInt(y,10);
      y = String(yy < 80 ? 2000+yy : 1900+yy);
    }
    return mm ? { y, m: mm } : null;
  }

  function fallbackYM(){
    // 1) from any day cell with dataset.iso
    const d = qs('#cal .cal-cell[data-iso]');
    if (d && d.dataset.iso){
      const [y,m] = d.dataset.iso.split('-');
      return { y, m };
    }
    // 2) from today
    const dt = new Date(); return { y: String(dt.getUTCFullYear()), m: dd2(dt.getUTCMonth()+1) };
  }

  async function fetchFreeSlotsMonth(y, m){
    const base = (window.APP_CONFIG && (APP_CONFIG.GAS_WEBHOOK || APP_CONFIG.API_URL)) || '';
    if (!base) return null;
    const first = `${y}-${m}-01`;
    const last  = `${y}-${m}-${dd2(new Date(+y,+m,0).getDate())}`;
    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('tz', USER_TZ);
    try{
      const tg = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
      if (tg) u.searchParams.set('tg_init', tg);
      else if (window.APP_CONFIG && APP_CONFIG.API_KEY) u.searchParams.set('key', APP_CONFIG.API_KEY);
      if (window.APP_CONFIG && APP_CONFIG.DEV_ID) u.searchParams.set('dev_id', APP_CONFIG.DEV_ID);
    }catch(_){}
    const r = await fetch(u.toString()).catch(()=>null);
    const j = r && await r.json().catch(()=>null);
    return (j && j.ok) ? j : null;
  }

  function applyDaysFromMap(ym, freeMap){
    const grid = qs('#cal .cal-grid'); if (!grid) return;
    qsa('.cal-cell', grid).forEach(cell=>{
      if (cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if (!day || /\\D/.test(day)) return;
      const iso = `${ym.y}-${ym.m}-${dd2(day)}`;
      cell.dataset.iso = iso;

      const isPast = (iso < todayISO);
      const hasSlots = freeMap && Array.isArray(freeMap[iso]) && freeMap[iso].length>0;
      cell.classList.toggle('off', isPast || !hasSlots);
      cell.classList.toggle('muted', isPast || !hasSlots);
      if (isPast || !hasSlots) cell.setAttribute('aria-disabled','true'); else cell.removeAttribute('aria-disabled');
    });
  }

  function addMinHHMM(s, dm){
    const [h,m] = s.split(':').map(Number); const tot = h*60 + m + dm;
    const nh = String(Math.floor(tot/60)).padStart(2,'0'); const nm = String(tot%60).padStart(2,'0');
    return nh+':'+nm;
  }

  function contiguousOK(arr, start, step, need){
    for (let i=0;i<need;i++){ if (!arr.includes(addMinHHMM(start, i*step))) return false; }
    return true;
  }

  function renderSlotsForDate(iso, keepTime, autoPickIfMissing){
    const container = qs('#slots,#slotsTime'); if (!container) return;
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    container.innerHTML = ''; container.classList.add('show');
    if (!arr.length){ container.innerHTML = '<div class=\"muted\">Нет свободных слотов</div>'; return; }

    const step = (window.__GRAN__ || 30);
    const dur  = (window.scope && (scope._durMin||30)) || 30;
    const need = Math.ceil(dur/step);

    arr.forEach(t=>{
      const ok = contiguousOK(arr, t, step, need);
      const b = document.createElement('button');
      b.className = 'btn btn-ghost btn-slot' + (ok?'':' disabled');
      b.textContent = t; b.dataset.time = t;
      if (ok){
        b.addEventListener('click', ()=>{
          qsa('button', container).forEach(x=>x.classList.remove('btn-primary','active'));
          b.classList.add('btn-primary','active');
          window.scope = window.scope || {}; scope._selTime = t;
          window.SEL = window.SEL || {}; SEL.time = t;
        });
      }
      container.appendChild(b);
    });

    // keep selected time if still valid
    let picked = false;
    if (keepTime && arr.includes(keepTime) && contiguousOK(arr, keepTime, step, need)){
      const btn = Array.from(container.querySelectorAll('button')).find(x => (x.textContent||'').trim() === keepTime);
      if (btn){ btn.click(); picked = true; }
    }
    // else auto-pick first contiguous
    if (!picked && autoPickIfMissing){
      const firstOk = Array.from(container.querySelectorAll('button')).find(b => !b.classList.contains('disabled'));
      if (firstOk) firstOk.click();
    }
  }

  async function syncMonth(){
    let ym = parseYM() || fallbackYM();
    const j = await fetchFreeSlotsMonth(ym.y, ym.m);
    if (j){
      window.__FREE__ = j.days || {}; window.__GRAN__ = j.gran || 30;
      applyDaysFromMap(ym, window.__FREE__);
    }
  }

  // optimistic remove + debounce book
  let bookingBusy = false;
  async function bookHandlerWrapper(prevApiEvent, type, data){
    const res = await (prevApiEvent ? prevApiEvent(type, data) : undefined);
    try{
      if ((type==='consult_booking' || (data && data.type==='consult_booking'))){
        if (res && res.ok){
          // resync + keep day
          const keep = (window.scope && scope._selDate) || '';
          await syncMonth();
          if (keep) renderSlotsForDate(keep, (window.scope && scope._selTime) || '', false);
        }else{
          // failed → rollback optimistic change if мы её ранее сделали
          if (window.__lastOptimistic){
            const { date, time, dur } = window.__lastOptimistic;
            const step = (window.__GRAN__ || 30);
            const need = Math.ceil((dur||30)/step);
            const arr = window.__FREE__[date] || [];
            const toAdd = Array.from({length:need}, (_,i)=> addMinHHMM(time, i*step));
            window.__FREE__[date] = Array.from(new Set(arr.concat(toAdd))).sort();
            renderSlotsForDate(date, time, true);
            window.__lastOptimistic = null;
          }
        }
      }
    }catch(_){}
    bookingBusy = false;
    const btn = qs('#book,#doBook,#makeBooking'); if (btn){ btn.disabled = false; }
    return res;
  }

  // monkeypatch apiEvent to add optimistic remove & debounce
  (function(){
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      if (type==='consult_booking' || (data && data.type==='consult_booking')){
        if (bookingBusy) return { ok:false, error:'busy' };
        bookingBusy = true;
        const btn = qs('#book,#doBook,#makeBooking'); if (btn){ btn.disabled = true; }
        // optimistic remove from client cache
        const date = (data && data.date) || (window.scope && scope._selDate);
        const time = (data && data.time) || (window.scope && scope._selTime);
        const dur  = (data && (data.duration_min||data.duration)) || (window.scope && (scope._durMin||30)) || 30;
        if (date && time && window.__FREE__){
          const step = (window.__GRAN__ || 30);
          const need = Math.ceil(dur/step);
          const arr  = window.__FREE__[date] || [];
          const toRemove = new Set(Array.from({length:need}, (_,i)=> addMinHHMM(time, i*step)));
          window.__FREE__[date] = arr.filter(t => !toRemove.has(t));
          window.__lastOptimistic = { date, time, dur };
          // repaint quickly
          renderSlotsForDate(date, time, false);
        }
      }
      return bookHandlerWrapper(prev, type, data);
    };
  })();

  // wire up clicks
  document.addEventListener('click', (e)=>{
    if (e.target.closest && (e.target.closest('#prevM') || e.target.closest('#nextM') || e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM'))){
      setTimeout(syncMonth, 60);
    }
  });
  document.addEventListener('click', (e)=>{
    const cell = e.target.closest && e.target.closest('#cal .cal-cell'); if (!cell) return;
    if (cell.classList.contains('off')) return;
    const iso = cell.dataset.iso || cell.dataset.date; if (!iso) return;
    window.scope = window.scope || {}; scope._selDate = iso; window.__selDate = iso;
    renderSlotsForDate(iso, (window.scope && scope._selTime) || '', true);
  });
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest && e.target.closest('.dur,[data-min]'); if (!btn) return;
    const m = +btn.getAttribute('data-min') || parseInt(btn.textContent, 10) || 30;
    window.scope = window.scope || {}; scope._durMin = m;
    window.SEL   = window.SEL   || {}; SEL.duration_min = m;
    const hidden = document.getElementById('consultDuration'); if (hidden) hidden.value = m;
    const iso = (window.scope && scope._selDate) || '';
    const keep = (window.scope && scope._selTime) || '';
    if (iso) setTimeout(()=> renderSlotsForDate(iso, keep, true), 10);
  }, {capture:true});

  // init
  setTimeout(syncMonth, 80);
})();
</script>
