<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- CSP: –¥–æ–±–∞–≤–∏–ª workers.dev –≤ connect-src -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';
                 script-src 'self' https://telegram.org https://*.telegram.org 'unsafe-inline' 'unsafe-eval';
                 connect-src 'self' https://*.workers.dev; 
                 img-src 'self' https: data:; font-src 'self' https: data:; frame-src https: telegram.org *.telegram.org;"/>
  
  <title>–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --bg:#0b0c15; --text:#f4f6fa; --muted:#a7acc2; --primary:#7b5bff; --blue:#5b8cff; --mint:#3de0c5; --card:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.1) }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
    .container{ max-width:980px; margin:0 auto; padding:16px }
    header.container{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .logo{ width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--mint),var(--primary)); box-shadow:0 8px 20px rgba(0,0,0,.35) }
    .brand{ font-weight:800; letter-spacing:.4px }
    .muted{ color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:16px; backdrop-filter:blur(8px) }
    
    /* nav */
    #spa-nav{ position:sticky; top:0; z-index:10; background:rgba(10,12,22,.6); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.06); margin:8px; padding:6px; border-radius:14px; display:flex; gap:6px }
    #spa-nav .btn{ appearance:none; border:0; background:transparent; color:var(--text); font-weight:700; padding:8px 10px; border-radius:10px; cursor:pointer }
    #spa-nav .btn.active{ background:linear-gradient(135deg,var(--primary),var(--blue)); color:#fff }

    /* calendar */
    .calendar{ user-select:none }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px }
    .cal-head .mon{ font-weight:800 }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
    .cal-cell{ height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); font-weight:600; cursor:pointer }
    .cal-cell.muted{ opacity:.35 }
    .cal-cell.off{ opacity:.25; pointer-events:none }
    .cal-dow{ opacity:.6; font-weight:700; font-size:12px }

    /* slots */
    #slots{ display:none; gap:8px; flex-wrap:wrap }
    #slots.show{ display:flex }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.18); background:transparent; color:var(--text); border-radius:12px; padding:8px 10px; font-weight:700; cursor:pointer }
    .btn-primary{ background:linear-gradient(135deg,var(--primary),var(--blue)); color:#fff; border-color:transparent; box-shadow:0 10px 20px rgba(91,140,255,.32) }
    .off{ opacity:.5 }

    .row{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px }
    .stack{ display:grid; gap:10px }
  </style>

  <!-- –ö–æ–Ω—Ñ–∏–≥: —Ñ—Ä–æ–Ω—Ç —Ö–æ–¥–∏—Ç –≤ Cloudflare Worker -->
  <script>
    window.APP_CONFIG = {
      TG_BOT_USERNAME: 'serge_kamensky_bot',
      API_BASE: 'https://cifrovichkoff.cyberian13.workers.dev',
      GAS_WEBHOOK: '', // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
      API_KEY: '',
      USE_TG_SIGNATURE: true
    };
  </script>
</head>
<body>
  <header class="container">
    <div style="display:flex; align-items:center; gap:10px">
      <div class="logo"></div>
      <div>
        <div class="brand">–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</div>
        <div class="muted">–°—á–∏—Ç–∞–µ–º –ø—Ä–∏–±—ã–ª—å, –∞ –Ω–µ –∫–ª–∏–∫–∏</div>
      </div>
    </div>
  </header>

  <nav id="spa-nav" class="container">
    <button class="btn active" data-page="consult">üìÖ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</button>
    <button class="btn" data-page="about">üë§ –û–±–æ –º–Ω–µ</button>
  </nav>

  <main class="container">
    <section class="page" id="consult">
      <div class="card stack">
        <div class="cal-head">
          <button id="prevM" class="btn">‚Äπ</button>
          <div class="mon" id="monLabel"></div>
          <button id="nextM" class="btn">‚Ä∫</button>
        </div>
        <div id="cal" class="calendar" data-ready="1">
          <div class="cal-grid" id="calGrid"></div>
        </div>
        <div class="stack">
          <div class="row">
            <div class="muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
            <div>
              <button class="btn dur" data-dur="30">30 –º–∏–Ω</button>
              <button class="btn dur" data-dur="60">60 –º–∏–Ω</button>
              <button class="btn dur" data-dur="90">90 –º–∏–Ω</button>
            </div>
          </div>
          <div id="slots" class="stack"></div>
          <div class="row">
            <input id="contact" class="btn" placeholder="@username / +7..." style="width:100%"/>
            <button id="bookBtn" class="btn btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
          </div>
          <div id="status" class="muted"></div>
        </div>
      </div>
    </section>

    <section class="page" id="about" style="display:none">
      <div class="card">
        <h3>–û–±–æ –º–Ω–µ</h3>
        <p class="muted">–ö–æ—Ä–æ—Ç–∫–æ: —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å—á–∏—Ç–∞–µ–º –¥–µ–Ω—å–≥–∏ –∏ —Å—Ç—Ä–æ–∏–º –≤–º–µ–Ω—è–µ–º—É—é —Å–∏—Å—Ç–µ–º—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞. –ù–∏–∂–µ —Ç–æ–ª—å–∫–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ Cloudflare Worker + Google Sheets.</p>
      </div>
    </section>
  </main>

  <script>
    // ===== helpers =====
    const dd2 = n => String(n).padStart(2,'0');
    const qs  = (s,root=document)=>root.querySelector(s);
    const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow';
    function tgId(){ try{ return tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id; }catch(_){ return null; } }

    function urlWithParams(base, params){ const u=new URL(base); Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined&&v!==null) u.searchParams.set(k,String(v)); }); return u; }
    async function apiGet(path, params){ const u=urlWithParams(APP_CONFIG.API_BASE+path, params); const r=await fetch(u,{method:'GET'}); const t=await r.text(); try{ return JSON.parse(t);}catch{ return {ok:false, error:'bad_json', raw:t} } }
    async function apiPost(path, body){ body=body||{}; if(!body.tg_id && tgId()) body.tg_id=String(tgId()); const r=await fetch(APP_CONFIG.API_BASE+path,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); const t=await r.text(); try{ return JSON.parse(t);}catch{ return {ok:false, error:'bad_json', raw:t} } }

    // ===== calendar state =====
    let curY, curM; // —Å—Ç—Ä–æ–∫–∏ YYYY, MM
    let FREE = {};  // { 'YYYY-MM-DD': ['HH:MM', ...] }
    let GRAN = 30;  // —à–∞–≥
    let selDate = null; let selTime = null; let selDur = 30;

    // === fix: request guard + auto-select first free day ===
    let REQ = 0;
    function autoSelectFirstDayWithSlots(){
      const days = Object.keys(FREE).filter(d => Array.isArray(FREE[d]) && FREE[d].length);
      if (!days.length) return;
      selDate = days[0];
      const cell = document.querySelector(`#calGrid [data-iso="${selDate}"]`);
      if (cell){ document.querySelectorAll('#calGrid .cal-cell.sel').forEach(x=>x.classList.remove('sel')); cell.classList.add('sel'); }
      renderSlots(selDate);
    }

    // ===== UI wire =====
    document.getElementById('prevM').onclick = ()=> shiftMonth(-1);
    document.getElementById('nextM').onclick = ()=> shiftMonth(1);
    qsa('.dur').forEach(b=> b.onclick = ()=>{ qsa('.dur').forEach(x=>x.classList.remove('btn-primary')); b.classList.add('btn-primary'); selDur = +b.dataset.dur || 30; if (selDate) renderSlots(selDate); });
    document.getElementById('bookBtn').onclick = onBook;

    function nowYM(){ const d=new Date(); return { y:String(d.getFullYear()), m:dd2(d.getMonth()+1) }; }
    function shiftMonth(delta){ const y=+curY, m=+curM; const d=new Date(y, m-1+delta, 1); curY=String(d.getFullYear()); curM=dd2(d.getMonth()+1); syncMonth(); }

    function drawCalendar(y, m){
      const grid = document.getElementById('calGrid'); grid.innerHTML='';
      const mon = new Date(+y, +m-1, 1); const monLabel = mon.toLocaleDateString('ru-RU', { month:'long', year:'numeric' });
      document.getElementById('monLabel').textContent = monLabel.charAt(0).toUpperCase()+monLabel.slice(1);
      const dow = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      dow.forEach(d=>{ const div=document.createElement('div'); div.className='cal-cell cal-dow'; div.textContent=d; grid.appendChild(div); });
      const firstDow = (new Date(+y, +m-1, 1).getDay()+6)%7; // 0..6 (–ü–Ω..–í—Å)
      for(let i=0;i<firstDow;i++){ const sp=document.createElement('div'); sp.className='cal-cell muted'; sp.textContent=''; grid.appendChild(sp); }
      const daysInMonth = new Date(+y, +m, 0).getDate();
      for(let d=1; d<=daysInMonth; d++){
        const iso = `${y}-${m}-${dd2(d)}`;
        const btn = document.createElement('div'); btn.className='cal-cell'; btn.textContent=d; btn.dataset.iso=iso;
        btn.onclick = ()=>{ selDate=iso; qsa('.cal-cell.sel',grid).forEach(x=>x.classList.remove('sel')); btn.classList.add('sel'); renderSlots(iso); };
        grid.appendChild(btn);
      }
      applyDaysState(y, m);
    }

    function applyDaysState(y,m){
      const grid = document.getElementById('calGrid');
      qsa('.cal-cell', grid).forEach(cell=>{
        if (cell.classList.contains('cal-dow') || !cell.dataset.iso) return;
        const iso = cell.dataset.iso; const arr = FREE[iso] || [];
        const off = !(Array.isArray(arr) && arr.length>0);
        cell.classList.toggle('off', off); cell.classList.toggle('muted', off);
        if (off) cell.setAttribute('aria-disabled','true'); else cell.removeAttribute('aria-disabled');
      });
    }

    function filterStartsByDuration(starts, durMin, step){
      if (!Array.isArray(starts) || !starts.length) return [];
      const need = Math.ceil(durMin / step);
      const toMin = t=>{ const m=t.match(/(\d{1,2}):(\d{2})/); return m? (+m[1])*60 + (+m[2]) : null; };
      const set = new Set(starts.map(toMin).filter(x=>x!=null));
      return starts.filter(t=>{ const m=toMin(t); if(m==null) return false; for(let i=0;i<need;i++){ if(!set.has(m+i*step)) return false } return true; });
    }

    function renderSlots(iso){
      const wrap = document.getElementById('slots'); wrap.innerHTML=''; wrap.classList.add('show'); selTime=null;
      const arr = FREE[iso] || []; if (!arr.length){ wrap.innerHTML='<div class="muted">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤</div>'; return; }
      const filtered = filterStartsByDuration(arr, selDur, GRAN);
      filtered.forEach(label=>{
        const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.dataset.time=label;
        b.onclick=()=>{ qsa('#slots .btn').forEach(x=>x.classList.remove('btn-primary')); b.classList.add('btn-primary'); selTime=label; };
        wrap.appendChild(b);
      });
      if (!filtered.length) wrap.innerHTML='<div class="muted">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç–∞—Ä—Ç–æ–≤ –¥–ª—è '+selDur+' –º–∏–Ω</div>';
    }

    async function syncMonth(){
      const my = ++REQ; // guard against race conditions
      const first = `${curY}-${curM}-01`;
      const last  = `${curY}-${curM}-${dd2(new Date(+curY, +curM, 0).getDate())}`;

      // lightweight loader in the grid
      const grid = document.getElementById('calGrid');
      if (grid) grid.innerHTML = '<div class="muted" style="grid-column:1/-1;text-align:center;padding:10px">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>';

      const data = await apiGet('/api/slots/free', { from:first, to:last, gran:30, lead_min:60, tz });
      if (my !== REQ) return; // outdated response ‚Äî ignore

      if (data && data.ok){
        FREE = data.days || {};
        GRAN = data.gran || 30;
        // 1) draw grid, 2) color by FREE, 3) auto-select first available day
        drawCalendar(curY,curM);
        applyDaysState(curY,curM);
        autoSelectFirstDayWithSlots();
      } else {
        document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤';
      }
    }

    async function onBook(){
      if (!selDate || !selTime){ qs('#status').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'; return; }
      const contact = qs('#contact').value.trim(); if(!contact){ qs('#status').textContent='–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏'; return; }
      // –±—ã—Å—Ç—Ä—ã–π hold
      const hold = await apiPost('/api/slots/hold', { date:selDate, time:selTime, duration_min:selDur });
      if (!hold || !hold.ok){ qs('#status').textContent='–°–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç, –æ–±–Ω–æ–≤–ª—è—é‚Ä¶'; await syncMonth(); return; }
      const res = await apiPost('/api/consult/book', { date:selDate, time:selTime, duration_min:selDur, format:'call', contact });
      if (res && res.ok){ qs('#status').textContent='–ì–æ—Ç–æ–≤–æ! –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ '+(res.booking_id||'—Å–æ–∑–¥–∞–Ω–æ'); await syncMonth(); }
      else { qs('#status').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'; await syncMonth(); }
    }

    // init
    (function init(){ const ym=nowYM(); curY=ym.y; curM=ym.m; qsa('.dur')[0].classList.add('btn-primary'); syncMonth(); })();
  </script>
</body>
</html>
