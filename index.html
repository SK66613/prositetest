
<style>
/* Active slot button: blue with white text (scoped) */
#slots .btn.btn-primary,
#slotsTime .btn.btn-primary{
  background: linear-gradient(180deg, #3B82F6 0%, #1D4ED8 100%) !important;
  color:#fff !important;
  border-color:#1D4ED8 !important;
  box-shadow: 0 8px 22px rgba(59,130,246,.35) !important;
}
/* Base ghost slot style */
#slots .btn, #slotsTime .btn{
  transition: background-color .18s ease, color .18s ease, transform .12s ease;
}
</style>
<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';
        script-src 'self' https://script.google.com https://*.googleusercontent.com https://*.googleapis.com 'unsafe-inline' 'unsafe-eval';
        connect-src 'self' https://script.google.com https://*.googleusercontent.com https://*.googleapis.com data: blob:;
        img-src 'self' https: data: blob:;
        media-src 'self' https: data: blob:;
        font-src 'self' https: data:;
        frame-src https: telegram.org *.telegram.org https://*.googleusercontent.com;
      ">
  <title>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –£—á—ë—Ç ‚Äî –ú–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (pro)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c15; --text:#f4f6fa; --muted:#a7acc2;
      --primary:#7b5bff; --mint:#3de0c5; --blue:#5b8cff;
      --card:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.10);
      --toast:#0f1221;
    
  --nav-active-pad-extra: 6px;}
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);overflow-x:hidden}
    .container{max-width:1080px;margin:0 auto;padding:16px 16px 24px}
    header.container{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px}
    .brand-wrap{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;position:relative;overflow:hidden}
    .logo::before{content:"";position:absolute;inset:-30%;background:
      radial-gradient(120px 120px at 30% 30%, var(--mint), transparent 60%),
      radial-gradient(160px 160px at 80% 80%, var(--primary), transparent 60%);
      filter:blur(.2px);
    }
    .brand{font-family:'Montserrat',sans-serif;font-weight:800;font-size:20px;letter-spacing:.4px}
    .slogan{font-size:13px;color:var(--mint)}

    /* Background canvas */
    #bg-canvas{position:fixed;inset:0;z-index:-1}

    /* nav capsule */
    #spa-nav{position:sticky;top:0;z-index:10;display:flex;gap:8px;overflow:visible;
      padding:8px;margin:8px 0 18px;background:rgba(10,12,22,.6);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);
      white-space:nowrap;
    }
    #spa-nav .btn{appearance:none;border:1px solid transparent;background:transparent;color:var(--text);
      font-weight:600;font-size:14px;padding:9px 12px;border-radius:12px;cursor:pointer;text-decoration:none;transition:.18s;
      white-space:nowrap;position:relative;overflow:hidden;flex:0 0 auto;max-width:160px;text-overflow:ellipsis;
    }
    #spa-nav .btn:hover{background:rgba(255,255,255,.08)}
    #spa-nav .btn.active{background:linear-gradient(135deg,var(--primary),var(--blue));color:#fff;box-shadow:0 10px 22px rgba(91,140,255,.35);max-width:none}

    .h1{font-size:19px;line-height:1.2;font-weight:800;margin:14px 0 10px}
    .h1 span{background:linear-gradient(90deg,var(--primary),var(--mint));-webkit-background-clip:text;color:transparent}
    .lead{color:var(--muted);font-size:17px;max-width:820px}

    .grid{display:grid;gap:14px}
    @media(min-width:920px){.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}.h1{font-size:56px}}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:20px;padding:18px;backdrop-filter:blur(8px);
      transition:transform .2s ease, box-shadow .2s ease; will-change: transform}
    .card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(0,0,0,.4)}
    .card h3{margin:0 0 8px;font-size:18px}

    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px;color:var(--muted)}
    .list li{display:flex;gap:10px;align-items:flex-start}
    .dot{width:10px;height:10px;border-radius:50%;margin-top:6px;background:linear-gradient(135deg,var(--mint),var(--primary))}

    .cta{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
    .btn{appearance:none;border:none;border-radius:14px;padding:10px 12px;font-weight:700;font-size:12px;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;text-decoration:none;transition:.18s;position:relative;overflow:hidden}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--blue));color:#fff;box-shadow:0 10px 26px rgba(91,140,255,.32)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}

    .highlight-banner{margin:18px 0;padding:16px 18px;border-radius:16px;
      background:linear-gradient(135deg,rgba(61,224,197,.14),rgba(123,91,255,.14));
      color:var(--mint);font-weight:600;font-size:15px;text-align:center}
    .highlight-banner strong{color:#fff}

    /* KPI marquee */
    .kpi-strip{margin:14px 0 0;overflow:hidden;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
    .kpi-track{display:flex;gap:22px;padding:10px 12px;animation:marquee 20s linear infinite;will-change:transform}
    .kpi{display:flex;align-items:center;gap:8px;white-space:nowrap;font-weight:600}
    .kpi .v{font-weight:800;color:#fff}
    @keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}

    /* Savings widget */
    .savings{display:grid;gap:12px}
    .savings .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px}
    .savings input[type=range]{width:100%}
    .savings .stat{display:flex;gap:10px;flex-wrap:wrap}
    .badge{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);font-weight:700}
    .big{font-size:18px;font-weight:800}

    /* Toasts */
    .toasts{position:fixed;right:14px;top:14px;display:flex;flex-direction:column;gap:8px;z-index:1000}
    .toast{background:var(--toast);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;box-shadow:0 12px 26px rgba(0,0,0,.4);min-width:240px}
    .toast .t{font-weight:700}
    .toast .m{color:var(--muted);font-size:13px}

    /* Onboarding */
    .onb{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1200}
    .onb .box{width:min(560px,92vw);background:#0f1221;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
    .onb .steps{display:grid;gap:10px;margin:12px 0}
    .onb .steps .step{display:flex;gap:10px;align-items:flex-start}
    .onb .steps .num{width:24px;height:24px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--mint));display:grid;place-items:center;font-weight:800}
    .onb .actions{display:flex;gap:8px;justify-content:flex-end}

    footer{text-align:center;padding:36px 0 48px;color:var(--muted);font-size:13px}
    section.page{display:none;scroll-margin-top:70px}
    section.page.active{display:block}

    /* reveal animations */
    .reveal{opacity:0;transform:translateY(14px);transition:opacity .5s ease, transform .5s ease}
    .reveal.visible{opacity:1;transform:none}

    /* Console overlay */
    .console-toggle{position:fixed;right:14px;bottom:14px;z-index:1000}
    .console-panel{position:fixed;right:14px;bottom:56px;width:360px;max-height:45vh;background:rgba(15,18,33,.9);
      border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;overflow:auto;font:12px/1.4 monospace;color:#b9d3ff;display:none;z-index:1000}
    .console-panel .line{white-space:pre-wrap;border-bottom:1px dashed rgba(255,255,255,.06);padding:3px 0}
    .console-panel .time{color:#7bffcb;margin-right:6px}
    .console-panel .event{color:#e6eaff}

    /* mobile */
    @media(max-width:480px){
      html,body{font-size:14px}
      header.container{padding:12px 12px}
      .logo{margin-left:12px;}
      .logo{width:36px;height:36px;border-radius:10px}
      .brand{font-size:18px}
      #spa-nav{gap:6px;padding:6px}
      #spa-nav .btn{font-size:12.5px;padding:7px 9px;border-radius:10px;max-width:120px}
      #spa-nav .btn.active{max-width:none}
      .console-panel{width:88vw; right:6vw}
      .kpi-track{animation-duration:26s}
    }
  
/* --- Nav: carousel style + hide scrollbar line --- */
#spa-nav{
  overflow:visible; white-space:nowrap; border-bottom:none;
  -ms-overflow-style: none;  /* IE/Edge */
  scrollbar-width: none;     /* Firefox */
  mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
}
#spa-nav::-webkit-scrollbar{ height:0 } /* Chrome/Safari: hide bar */
#spa-nav .btn{
  scroll-snap-align: center;
  transform-origin: center center;
  transition: transform .18s ease, opacity .18s ease, background .18s ease;
  opacity:.86;
}
#spa-nav .btn.active{ opacity:1 }
#spa-nav .track{display:flex; gap:8px; scroll-snap-type: x mandatory
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;}


/* Leaderboard bars */
.bar{height:10px; border-radius:6px; background:rgba(255,255,255,.08); overflow:hidden}
.bar > span{display:block; height:100%; background:linear-gradient(90deg, var(--mint), var(--primary))}


/* --- New segmented carousel nav with bubble indicator --- */
#spa-nav{
  position:sticky; top:0; z-index:20;
  padding:6px; margin:8px 0 18px;
  background:rgba(10,12,22,.65); backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.35);
  overflow:hidden;
}
#spa-nav .track{
  display:flex; align-items:center; gap:8px; overflow-x:auto; padding:2px;
  scroll-snap-type:x mandatory; white-space:nowrap;
  -ms-overflow-style:none; scrollbar-width:none;
}
#spa-nav .track::-webkit-scrollbar{ display:none }
#spa-nav .btn{
  position:relative; z-index:1;
  scroll-snap-align:center;
  font-weight:700; font-size:14px; padding:9px 12px; border-radius:12px;
  color:var(--text); border:1px solid transparent; background:transparent;
  transition:transform .18s ease, opacity .18s ease, color .18s ease;
  flex:0 0 auto;
}
#spa-nav .btn:not(.active){ opacity:.82 }
#spa-nav .btn.active{ color:#fff }
#spa-nav .bubble{
  position:absolute; z-index:0; height:32px; border-radius:12px;
  background:linear-gradient(135deg, var(--primary), var(--blue));
  box-shadow:0 10px 22px rgba(91,140,255,.35);
  transition:left .24s cubic-bezier(.2,.8,.2,1), width .24s cubic-bezier(.2,.8,.2,1);
  will-change:left,width;
}
@media(max-width:480px){
  #spa-nav .btn{font-size:12.5px; padding:7px 10px; border-radius:10px}
  #spa-nav .bubble{height:28px; border-radius:10px}
}


/* Calendar styles */
.calendar{user-select:none}
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.cal-head .mon{font-weight:800}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-cell{height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03); font-weight:600; cursor:pointer; transition:transform .15s ease, background .15s ease, color .15s ease}
.cal-cell:hover{transform:translateY(-1px);}
.cal-cell.muted{opacity:.35}
.cal-cell.off{opacity:.25; pointer-events:none}
.cal-cell.sel{color:#fff; background:linear-gradient(135deg, var(--primary), var(--mint)); border-color:transparent}
.cal-dow{opacity:.6; font-weight:700; font-size:12px}


.badge-pill{display:inline-block; padding:revert; border-radius:999px; border:0px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); font-weight:700; font-size:revert}
.lb-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.q-badge{display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.04); font-size:12px}


/* Safe minimal "grow" effect for active tab without JS changes */
#spa-nav .btn { /* declare a fallback for horizontal padding if none defined as CSS var */
  --btn-pad-x: 12px; /* only used by the rule below if the existing CSS doesn't define it */
}
#spa-nav .btn.active{
  padding-left:  calc(var(--btn-pad-x, 12px) + var(--nav-active-pad-extra));
  padding-right: calc(var(--btn-pad-x, 12px) + var(--nav-active-pad-extra));
}


/* === Global vertical rhythm & paddings === */
:root{
  --space-1: 6px; --space-2: 10px; --space-3: 14px; --space-4: 18px;
  --section-gap: 28px;
}
.container{max-width:1080px;margin:0 auto;padding:18px 18px 28px!important;}
section.page > * + *{ margin-top: var(--section-gap); }
.grid{ gap: var(--space-2) !important; }
.card + .card{ margin-top: var(--space-3); }


/* === v13: global paddings & spacing === */
section.page{ padding-left:18px; padding-right:18px; }
@media (min-width:1024px){ section.page{ padding-left:24px; padding-right:24px; } }

/* vertical rhythm */
:root{ --section-gap: 28px; --space-2: 10px; --space-3: 14px; }
section.page > * + *{ margin-top: var(--section-gap); }
.grid{ gap: var(--space-2) !important; }
.card + .card{ margin-top: var(--space-3); }

/* KPI pills micro-gaps */
.kpi-track{ display:flex; gap:22px; padding:10px 12px; }
.kpi{ display:inline-flex; align-items:center; gap:6px; }
.kpi .v{ margin-left:4px; }

/* bonuses: ticker/marquee safe spacing */
.marquee,.ticker{ margin-bottom:14px; }
.marquee + .card, .ticker + .card{ margin-top:14px; }

/* consult: show time slots only after date select */
#consult #slots{ display:none; gap:10px; flex-wrap:wrap; }
#consult #slots.show{ display:flex; }
#consult .dur{ min-width:88px; text-align:center; }


/* === v14: unified spacing & typography === */
:root{
  --container-pad-x: 18px;
  --container-pad-y: 18px;
  --section-gap: 28px;
  --grid-gap: 12px;
  --card-pad: 18px;
}
@media (min-width: 1024px){
  :root{
    --container-pad-x: 24px;
    --container-pad-y: 20px;
    --section-gap: 32px;
    --grid-gap: 14px;
    --card-pad: 20px;
  }
}
.container{ padding: var(--container-pad-y) var(--container-pad-x) !important; }
section.page > * + *{ margin-top: var(--section-gap) !important; }
.grid{ gap: var(--grid-gap) !important; }
.card{ padding: var(--card-pad) !important; }

/* Typography */
body{ font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
.brand{ font-family: 'Montserrat', sans-serif !important; }
.h1{ font-size: clamp(19px, 3.4vw + 12px, 56px)  line-height: 1.15; font-weight: 800; margin: 0 0 4px; }


/* === v15: layout normalizer (uniform paddings & width) === */
:root{ --content-max: 1080px; }

/* 1) A single content column width for everything */
main, .container { max-width: var(--content-max); margin-inline: auto; }

/* 2) Identical horizontal paddings everywhere */
section.page { padding-left: var(--container-pad-x); padding-right: var(--container-pad-x); }
.container{ padding-left: 0 !important; padding-right: 0 !important; } /* avoid double padding */

/* 3) If —Å–µ–∫—Ü–∏—è –±–µ–∑ .container ‚Äî –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫—Ä—É–ø–Ω—ã–µ –±–ª–æ–∫–∏ */
section.page > .card,
section.page > .grid,
section.page > .section-head,
section.page > header,
section.page > .pillbar,
section.page > .stepper,
section.page > .pricing { margin-inline: 0; }

/* 4) Hero/heading rows inside sections also align */
section.page .hero, section.page .lead, section.page .h1 { margin-inline: 0; }

/* 5) Safety: on mobile keep paddings; on desktop they already scale by var */
@media (min-width: 1280px){
  :root{ --content-max: 1160px; }
}


/* v16-safe: input highlight + iOS zoom fix */
.input, .field, #contact{transition:box-shadow .18s ease, border-color .18s ease, background-color .18s ease}
.input.attn, .field.attn, #contact.attn{
  border-color: var(--mint,#3de0c5) !important;
  box-shadow: 0 0 0 3px rgba(61,224,197,.35);
  background: rgba(61,224,197,.06);
}
.input.ok, .field.ok, #contact.ok{
  border-color: var(--primary,#5b8cff) !important;
  box-shadow: 0 0 0 3px rgba(91,140,255,.35);
}
@media(max-width:480px){ input, select, textarea{ font-size:16px !important; line-height:1.3 } }


/* v21: mobile tap comfort, anti zoom & safer tilt */
html, body{ -webkit-text-size-adjust: 100%; }
.btn{ touch-action: manipulation; } /* removes 300ms delay & dbl-tap zoom on iOS */
@media (max-width: 480px){
  .tilt{ transform: none !important; } /* avoid Safari repaint glitches on iOS */
}
/* profile panel on top of everything */
.console-panel{ z-index: 3000; }
.console-toggle{ z-index: 3001; }


/* v23: fully remove legacy console log visuals */
.console-log, .console-panel pre, .console-panel .line, .console-panel .time, .console-panel .event { display:none !important; }
.console-panel { font: inherit; color: inherit; }
/* keep the panel container for profile usage */

/* v25: hide any legacy log UI completely; keep panel for profile */
.console-panel pre,.console-panel .line,.console-panel .time,.console-panel .event,.console-log{display:none!important}
/* z-index to ensure profile over content */
.console-panel{z-index:3000}
.console-toggle{z-index:3001}
/* mobile: prevent dbl-tap zoom + flicker */
.btn,button{touch-action:manipulation}
html,body{-webkit-text-size-adjust:100%}
@media(max-width:480px){.tilt{transform:none!important}}


/* v27 ensure panel on top */
.console-panel{z-index:3000}
.console-toggle,.fab-console{z-index:3001}


/* === Calendar: stable gating === */
#cal[data-ready="0"] .cal-cell:not(.cal-dow){ opacity:.25; pointer-events:none; }
#cal .cal-cell{ cursor: default; }
#cal .cal-cell:not(.off){ cursor: pointer; }
@media (prefers-reduced-motion: no-preference){
  #cal[data-busy="1"] .cal-cell{ transition:none !important; }
}


/* === Slots & duration UX polish === */
#slots .btn, #slotsTime .btn { transition: background-color .18s ease, color .18s ease, transform .12s ease; }
#slots .btn.btn-primary, #slotsTime .btn.btn-primary { transform: translateY(-1px); }
.cta .dur { transition: background-color .18s ease, color .18s ease; }
.cta .dur.btn-primary { box-shadow: 0 10px 22px rgba(91,140,255,.35); }

</style>

<!-- ==== DEV TEST (–≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ home, –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ —Å ?debug=1) ==== -->
<style>
  #dev-fab{position:fixed;right:14px;bottom:14px;z-index:9999;border:0;border-radius:999px;padding:12px 14px;background:#2b52ff;color:#fff;font:600 13px system-ui;box-shadow:0 8px 22px rgba(0,0,0,.35);cursor:pointer;display:none}
  #dev-panel{position:fixed;right:14px;bottom:64px;z-index:9999;width:320px;max-width:92vw;background:#0f1221;color:#c9d1ff;border:1px solid #2a3157;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;overflow:hidden}
  #dev-panel .hdr{padding:10px 12px;border-bottom:1px solid #2a3157;display:flex;gap:8px;align-items:center}
  #dev-panel .hdr .ttl{font-weight:600}
  #dev-panel .hdr .badge{margin-left:auto;font-size:11px;opacity:.8}
  #dev-panel .body{padding:12px;display:flex;flex-direction:column;gap:8px}
  #dev-panel button{padding:10px 12px;border:0;border-radius:10px;color:#fff;cursor:pointer}
  #btn-test-bootstrap{background:#2b52ff}
  #btn-test-booking{background:#3aa76d}
  #dev-log{background:#0b0e1a;border:1px solid #2a3157;border-radius:10px;padding:10px;max-height:180px;overflow:auto;white-space:pre-wrap}
</style>

<button id="dev-fab">DEV</button>
<div id="dev-panel">
  <div class="hdr">
    <div class="ttl">DEV ‚Ä¢ GAS quick test</div>
    <div class="badge" id="dev-badge"></div>
  </div>
  <div class="body">
    <button id="btn-test-bootstrap">1) Bootstrap</button>
    <button id="btn-test-booking">2) Test consult_booking</button>
    <div id="dev-log"></div>
  </div>
</div>

<script>
(function(){
  const params = new URL(location.href).searchParams;
  const debugOn = params.get('debug') === '1';
  const fab = document.getElementById('dev-fab');
  const panel = document.getElementById('dev-panel');
  const badge = document.getElementById('dev-badge');
  const logBox = document.getElementById('dev-log');

  if(!debugOn){ return; } // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å ?debug=1

  // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è #home ‚Äî –æ—Ç–ª–∏—á–Ω–æ, –Ω–æ –ø–∞–Ω–µ–ª—å –≤—Å—ë —Ä–∞–≤–Ω–æ —Ñ–∏–∫—Å–æ–º –ø–æ–≤–µ—Ä—Ö
  function log(msg, obj){
    const line = '['+new Date().toLocaleTimeString()+'] '+msg+(obj?' '+JSON.stringify(obj):'');
    console.log('[DEV]', msg, obj||'');
    logBox.textContent = line + '\n' + logBox.textContent;
  }

  // –±—ã—Å—Ç—Ä—ã–π –±–µ–π–¥–∂ —Å–æ—Å—Ç–æ—è–Ω–∏—è Telegram WebApp
  const inTG = !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData);
  const initLen = (Telegram && Telegram.WebApp && (Telegram.WebApp.initData||'').length) || 0;
  badge.textContent = inTG ? ('TG OK ‚Ä¢ initData '+initLen) : 'not in Telegram';
  if (!inTG) log('‚ö† –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –º–∏–Ω–∏-–∞–ø–ø–∞. –°–µ–π—á–∞—Å –Ω–µ –≤ Telegram.');

  // –ø–æ–∫–∞–∑–∞—Ç—å FAB –∏ –ø–∞–Ω–µ–ª—å (–ø–æ –∫–ª–∏–∫—É)
  fab.style.display = 'inline-flex';
  fab.onclick = () => { panel.style.display = panel.style.display==='none'?'block':'none'; };
  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å
  panel.style.display = 'block';

  // —Ö–µ–ª–ø–µ—Ä—ã API (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —É —Ç–µ–±—è ‚Äî –±—É–¥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –Ω–∏–∂–µ)
  async function apiBootstrapFallback(){
    const tgInit = Telegram.WebApp.initData;
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK) + '?mode=bootstrap&tg_init=' + encodeURIComponent(tgInit);
    const r = await fetch(url, { method: 'GET' });
    return r.json();
  }
  async function apiEventFallback(type, extra={}){
    const tgInit = Telegram.WebApp.initData;
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ type, tg_init: tgInit, ...extra })
    });
    return r.json();
  }
  const apiBootstrap = (window.apiBootstrap || apiBootstrapFallback);
  const apiEvent = (window.apiEvent || apiEventFallback);

  document.getElementById('btn-test-bootstrap').addEventListener('click', async ()=>{
    try{
      log('‚Üí bootstrap()‚Ä¶');
      const res = await apiBootstrap();
      log('‚Üê bootstrap()', res);
      if(res && res.ok) log('Profile', res.profile || {});
    }catch(e){ log('bootstrap error', String(e)); }
  });

  document.getElementById('btn-test-booking').addEventListener('click', async ()=>{
    try{
      const now = new Date(Date.now() + 15*60*1000);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const hh = String(now.getHours()).padStart(2,'0');
      const mi = String(now.getMinutes()).padStart(2,'0');
      const date = `${yyyy}-${mm}-${dd}`;
      const time = `${hh}:${mi}`;

      const payload = { date, time, duration_min: 30, format: 'call', contact: '@dev_test' };
      log('‚Üí consult_booking', payload);
      const res = await apiEvent('consult_booking', payload);
      log('‚Üê consult_booking', res);
      if(res && res.ok) log('‚úì –ü—Ä–æ–≤–µ—Ä—å –ª–∏—Å—Ç consult_bookings ‚Äî –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞.');
    }catch(e){ log('consult_booking error', String(e)); }
  });

  log('DEV-–ø–∞–Ω–µ–ª—å –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É.');
})();
</script>
<!-- ==== /DEV TEST ==== -->
<script>
(function(){
  const cont = document.getElementById('dev-panel') || document.body;
  const btn = document.createElement('button');
  btn.id = 'btn-echo-sign';
  btn.textContent = 'Echo Sign';
  btn.style.marginLeft = '8px';
  cont.appendChild(btn);

  btn.addEventListener('click', async ()=>{
    try{
      const res = await _jsonp(APP_CONFIG.GAS_WEBHOOK, {
        mode: 'echo_sign',
        tg_init: (Telegram.WebApp && Telegram.WebApp.initData) || ''
      });
      console.log('[echo_sign]', res);
      alert('equal=' + res.equal + ', ageSec=' + res.ageSec);
    }catch(e){
      console.error(e);
      alert('echo_sign error: ' + e);
    }
  });
})();
</script>

<script>
(function () {
  // ==== –º–∞–ª–µ–Ω—å–∫–∏–π JSONP-—Ö–µ–ª–ø–µ—Ä, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–≤–æ–µ–≥–æ –Ω–µ—Ç ====
  if (typeof window._jsonp !== 'function') {
    window._jsonp = function (baseUrl, params) {
      return new Promise(function (resolve, reject) {
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const url = new URL(baseUrl);
        Object.entries(params || {}).forEach(([k, v]) => url.searchParams.set(k, String(v)));
        url.searchParams.set('callback', cbName);

        const s = document.createElement('script');
        s.src = url.toString();
        s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };

        function cleanup() {
          try { delete window[cbName]; } catch(_) { window[cbName] = undefined; }
          if (s.parentNode) s.parentNode.removeChild(s);
        }
        window[cbName] = function (data) { cleanup(); resolve(data); };
        document.head.appendChild(s);
      });
    };
  }

  // ==== —É—Ç–∏–ª–∏—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ====
  const logBox = document.getElementById('dev-log');
  function logLine(msg, obj) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}` + (obj ? ' ' + JSON.stringify(obj) : '');
    console.log('[DEV]', msg, obj || '');
    if (logBox) {
      logBox.textContent = line + '\n' + logBox.textContent;
    } else {
      // –µ—Å–ª–∏ –Ω–µ—Ç dev-log ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–≤–µ—Ä—Ö
      let box = document.getElementById('dev-log-fallback');
      if (!box) {
        box = document.createElement('pre');
        box.id = 'dev-log-fallback';
        box.style.cssText = 'position:fixed;left:8px;bottom:8px;right:8px;max-height:40vh;overflow:auto;background:#0b1220;color:#9feaff;padding:8px;border-radius:8px;font:12px/1.4 ui-monospace,monospace;z-index:99999';
        document.body.appendChild(box);
      }
      box.textContent = line + '\n' + box.textContent;
    }
  }

  // ==== –∫–Ω–æ–ø–∫–∞ Echo Sign –≤ DEV-–ø–∞–Ω–µ–ª–∏ ====
  (function ensureEchoButton() {
    const devPanel = document.getElementById('dev-panel') || document.getElementById('dev') || document.body;
    let btn = document.getElementById('btn-echo-sign');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'btn-echo-sign';
      btn.textContent = 'Echo Sign (diag)';
      btn.style.cssText = 'margin:8px 0; padding:10px 14px; border-radius:10px; background:#444cf7; color:#fff; border:none; cursor:pointer;';
      devPanel.appendChild(btn);
    }
    btn.onclick = devEchoSign;
  })();

  // ==== —Å–∞–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ====
  async function devEchoSign() {
    try {
      const isTg = !!(window.Telegram && Telegram.WebApp);
      const platform = isTg ? Telegram.WebApp.platform : 'no-telegram';
      const userId   = isTg ? (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id) : null;
      const initData = isTg ? (Telegram.WebApp.initData || '') : '';
      const lenInit  = initData.length;
      const encInit  = encodeURIComponent(initData);
      const lenEnc   = encInit.length;

      logLine('TG context', { platform, userId, lenInit, lenEnc });

      if (!lenInit) {
        alert('initData –ø—É—Å—Ç–æ–π ‚Äî —ç—Ç–æ –Ω–µ WebApp-–∫–æ–Ω—Ç–µ–∫—Å—Ç. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.');
        return;
      }

      // JSONP –Ω–∞ GAS echo_sign
      const gas = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK) || '';
      if (!gas) { alert('APP_CONFIG.GAS_WEBHOOK –ø—É—Å—Ç'); return; }

      logLine('‚Üí echo_sign call');
      const res = await window._jsonp(gas, { mode: 'echo_sign', tg_init: initData });
      logLine('‚Üê echo_sign FULL', res);

      // –ö—Ä–∞—Å–∏–≤—ã–π –∏—Ç–æ–≥
      const equalA = res.equalA ?? res.equal;    // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
      const equalB = res.equalB;
      const age    = res.ageSec;
      const hint   = (equalA ? '–ú–µ—Ç–æ–¥ A (–ø–æ –¥–æ–∫–µ) OK' : (equalB ? '–ú–µ—Ç–æ–¥ B OK' : '–•—ç—à –Ω–µ —Å–æ—à—ë–ª'));

      alert(
        'equalA=' + equalA + '  equalB=' + equalB + '\n' +
        'ageSec=' + age + '\n' +
        'len_init=' + (res.len_init ?? lenInit) + '\n' +
        hint
      );

      // –ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è —É–≤–∏–¥–µ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ö—ç—à–∏ ‚Äî –æ–Ω–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏/–ª–æ–≥–µ
      // res.receivedHash, res.computedA, res.computedB
    } catch (e) {
      console.error(e);
      logLine('echo_sign error', String(e));
      alert('echo_sign error: ' + String(e));
    }
  }
})();
</script>



  
    
<!-- === FAST PANEL CSS OVERRIDE (transform/opacity toggle) === -->
<style>
  .console-panel{
    position: fixed; right: 14px; bottom: 56px; width: 360px;
    max-height: 78vh; overflow: auto;
    background: rgba(15,18,33,.9);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 12px; padding: 10px 12px;
    /* fast show via compositor only */
    transform: translateY(18px);
    opacity: 0;
    pointer-events: none;
    transition: transform .16s ease, opacity .16s ease;
    will-change: transform, opacity;
    contain: content;
    content-visibility: auto;
    z-index: 3000;
  }
  .console-panel.open{
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }
  @media (max-width:480px){
    .console-panel{ width: 88vw; right: 6vw; }
  }
</style>

<script>
(function(){
  const RU2MM = { '—è–Ω–≤':'01','—Ñ–µ–≤':'02','–º–∞—Ä':'03','–∞–ø—Ä':'04','–º–∞—è':'05','–∏—é–Ω':'06','–∏—é–ª':'07','–∞–≤–≥':'08','—Å–µ–Ω':'09','–æ–∫—Ç':'10','–Ω–æ—è':'11','–¥–µ–∫':'12' };

  function parseHeadYM(){
    const h = document.querySelector('#cal .cal-head .mon');
    if(!h) return null;
    const t = (h.textContent||'').trim().toLowerCase();           // "–û–∫—Ç—è–±—Ä—å 2025"
    const m = t.match(/([–∞-—èa-z]+)\s+(\d{4})/i);
    if(!m) return null;
    const mm = RU2MM[m[1].slice(0,3)] || RU2MM[m[1].slice(0,3).replace('—ë','–µ')];
    return mm ? { y: m[2], m: mm } : null;
  }
  function dd2(ddd){ return String(ddd).padStart(2,'0'); }

  async function loadFreeSlotsForMonth(y, m){
    const first = `${y}-${m}-01`;
    const last  = `${y}-${m}-${dd2(new Date(+y, +m, 0).getDate())}`;
    const base  = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    if(!base){ console.warn('No GAS_WEBHOOK'); return; }
    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('lead_min','120');      // –∑–∞–ø–∏—Å—å –Ω–µ —Ä–∞–Ω—å—à–µ —á–µ–º —á–µ—Ä–µ–∑ 2—á
    u.searchParams.set('gran','30');
    u.searchParams.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
    try{ u.searchParams.set('tg_init', Telegram?.WebApp?.initData || ''); }catch(_){}
    const r = await fetch(u.toString());
    const j = await r.json();
    if(!j || !j.ok){ console.error(j); return; }
    window.__FREE__ = j.days || {};
    window.__GRAN__ = j.gran || 30;
  }

  function isDayFree(iso){
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    return Array.isArray(arr) && arr.length>0;
  }

  function applyDaysState(y, m){
    const grid = document.querySelector('#cal .cal-grid');
    if(!grid) return;
    grid.querySelectorAll('.cal-cell').forEach(cell=>{
      if(cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if(!day || /\D/.test(day)) return;
      const iso = `${y}-${m}-${dd2(day)}`;
      cell.dataset.iso = iso;
      const hasKey = window.__FREE__ && Object.prototype.hasOwnProperty.call(window.__FREE__, iso);
      if (!hasKey) return;
      if(!isDayFree(iso)){
        cell.classList.add('off','muted');
        cell.setAttribute('aria-disabled','true');
      }else{
        cell.classList.remove('off','muted');
        cell.removeAttribute('aria-disabled');
      }
    });
  }

  function renderSlotsForDate(iso){
    const wrap = document.getElementById('slots');
    if(!wrap) return;
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    wrap.innerHTML = '';
    wrap.classList.toggle('show', true);

    if(!arr.length){
      wrap.innerHTML = '<div class="muted">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤</div>';
      return;
    }
    arr.forEach(label=>{
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.textContent = label;
      btn.dataset.time = label;
      btn.onclick = ()=>{
        wrap.querySelectorAll('button').forEach(x=>x.classList.remove('btn-primary','active'));
        btn.classList.add('btn-primary','active');
        window.SEL = window.SEL || {}; SEL.time = label;
        window.scope = window.scope || {}; scope._selTime = label;
      };
      wrap.appendChild(btn);
    });
  }

  async function syncMonthAndDays(){
    window.__CAL_REQ_ID__ = window.__CAL_REQ_ID__ || 0;
    const ym = parseHeadYM(); if(!ym) return;
    const __my = ++window.__CAL_REQ_ID__;
    await loadFreeSlotsForMonth(ym.y, ym.m);
    if (__my !== window.__CAL_REQ_ID__) return; // stale
    applyDaysState(ym.y, ym.m);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  setTimeout(syncMonthAndDays, 0);

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ prev/next)
  document.addEventListener('click', (ev)=>{
    if (ev.target.closest('#cal #prevM') || ev.target.closest('#cal #nextM')){
      setTimeout(syncMonthAndDays, 0);
    }
  });

  // –í—ã–±–æ—Ä –¥–Ω—è -> –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ—Ç—ã —ç—Ç–æ–≥–æ –¥–Ω—è
  document.addEventListener('click', (ev)=>{
    const cell = ev.target.closest && ev.target.closest('#cal .cal-cell');
    if(!cell || cell.classList.contains('off')) return;
    const iso = cell.dataset.iso || cell.dataset.date;
    if(iso){
      window.scope = window.scope || {}; scope._selDate = iso; window.__selDate = iso;
      renderSlotsForDate(iso);
    }
  });

  // –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç slot_unavailable ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Å—è—Ü
  const _origApiEvent = window.apiEvent;
  /* apiEvent removed for consolidation */

// helpers
function __uid(){
  let u = localStorage.getItem('uid');
  if(!u){ u = Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid', u); }
  return u;
}
function __tgUser(){ try{ return Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user || null } catch(e){ return null } }
function __tgInit(){ try{ return Telegram && Telegram.WebApp && Telegram.WebApp.initData || null } catch(e){ return null } }
async function __postGAS(payload){
  const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

  if(!C.GAS_WEBHOOK) return {ok:false, error:'no_webhook'};
  try{
    const body = Object.assign({}, payload);
    if (C.USE_TG_SIGNATURE && __tgInit()) body.tg_init = __tgInit();
    if (!__tgInit() && C.API_KEY) body.key = C.API_KEY;
    const r = await fetch(C.GAS_WEBHOOK, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    return await r.json().catch(()=>({ok:true}));
  }catch(e){ return {ok:false, error:String(e)} }
}
function __haptic(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }

// –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª—ë–≥–∫–∏–π —Ö–∞–ø—Ç–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–∏ (–Ω–µ –ª–æ–º–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
document.addEventListener('click', function(e){ if(e.target.closest('.btn')) __haptic('light'); }, {passive:true});

// === –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: –º—è–≥–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ + –æ—Ç–ø—Ä–∞–≤–∫–∞ –µ—Å–ª–∏ –∑–∞–¥–∞–Ω WEBHOOK ===
(function(){
  const scope = document.getElementById('consult'); if(!scope) return;
  const btn = scope.querySelector('#confirmConsult') || Array.from(scope.querySelectorAll('button')).find(b=>(b.textContent||'').toLowerCase().includes('–ø–æ–¥—Ç–≤–µ—Ä–¥'));
  const input = scope.querySelector('#contact') || scope.querySelector('input,textarea');
  if(!btn || !input) return;

  input.addEventListener('input', function(){
  let v = this.value;
  v = v.replace(/[^\d+]/g, '');
  if(v.startsWith('+')) v = '+' + v.slice(1).replace(/\D/g, ''); else v = v.replace(/\D/g, '');
  v = v.replace(/(?!^)\+/g, '');
  this.value = v; this.classList.remove('attn','ok');
  const hint = __ensureContactHint(this);
  if(hint) hint.textContent = '–ú–æ–∂–Ω–æ: +7 999 123-45-67, 8 999..., 999... ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 7XXXXXXXXXX';
});

  btn.addEventListener('click', async function(){
  const valRaw = (input.value||'').trim();
  const val = __normalizePhoneRU(valRaw);

    if(!val){
  input.classList.add('attn'); __haptic('medium'); input.focus({preventScroll:true});
  const hint = __ensureContactHint(input); if(hint) hint.textContent = '–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä. –ü—Ä–∏–º–µ—Ä: +7 999 123-45-67';
  return;
}
try{ input.value = '+'+val; }catch(_){}

    input.classList.add('ok');
    try{ __confAt(btn); }catch(_){ try{ __conf(); }catch(__){} }
__haptic('light');

    // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω GAS_WEBHOOK (–∏–Ω–∞—á–µ —Ç–∏—Ö–æ –≤—ã—Ö–æ–¥–∏–º)
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if (!C.GAS_WEBHOOK) return;

    const payload = {
      type: 'consult_booking',
      ts: new Date().toISOString(),
      uid: __uid(),
      page: (new URL(location.href)).searchParams.get('page') || (location.hash||'#home').slice(1) || 'home',
      date: scope._selDate || '',
      time: scope._selTime || '',
      duration_min: scope._durMin || +(scope.querySelector('.dur.btn-primary') && scope.querySelector('.dur.btn-primary').getAttribute('data-min') || 30),
      format: scope._type || (scope.querySelector('.consult-type.btn-primary') && scope.querySelector('.consult-type.btn-primary').getAttribute('data-type') || 'call'),
      contact: val,
      tg_user: __tgUser()
    };
    try{ Telegram && Telegram.WebApp && Telegram.WebApp.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){}
    const r = await __postGAS(payload);
    if (r && r.ok && window.showToast) showToast('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', '–ú—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–º –≤—Ä–µ–º—è –≤ —á–∞—Ç–µ');
  });
})();

// === –ü–∞—Ä—Ç–Ω—ë—Ä–∫–∞: —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –∏–∑ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ ===
(function(){
  const box = document.getElementById('invite'); if(!box) return;
  const inp = box.querySelector('#refLink'); const copy = box.querySelector('#copyRef'); const share = box.querySelector('#shareRef');
  
  const tg = __tgUser();
  const ref = tg && tg.id ? String(tg.id) : __uid();
  const bot = (window.APP_CONFIG && window.APP_CONFIG.TG_BOT_USERNAME) || 'serge_kamensky_bot';
  const link = 'https://t.me/' + bot + '?start=ref_' + ref;
  if (inp) inp.value = link;
  copy && copy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(link); window.showToast && showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ'); }catch(e){} });
  share && share.addEventListener('click', async ()=>{
    try{
      if (navigator.share) await navigator.share({title:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ', url: link});
      else { await navigator.clipboard.writeText(link); window.showToast && showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ'); }
    }catch(e){}
  });
})();

</script>


<script>
// v19 ‚Äî global haptic feedback for buttons
(function(){
  function haptic(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }
  document.addEventListener('click', function(e){
    const b = e.target.closest('.btn');
    if(b) haptic('light');
  }, {passive:true});
})();

// v19 ‚Äî normalize all t.me deeplinks to configured bot
(function(){
  const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}
 const bot = C.TG_BOT_USERNAME || 'serge_kamensky_bot';
  document.querySelectorAll('a[href*="t.me/"]').forEach(a=>{
    try{
      const u = new URL(a.href, location.href);
      if(u.hostname !== 't.me') return;
      const start = u.searchParams.get('start');
      const hash  = u.hash || '';
      a.href = 'https://t.me/' + bot + (start? ('?start='+start) : '') + hash;
    }catch(e){}
  });
})();

// v19 ‚Äî "–ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç": –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ + —Ç–æ—Å—Ç + –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç + (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) GAS
(function(){
  const btn = document.getElementById('ctaCalc'); if(!btn) return;
  const rev = document.getElementById('revVal');
  const pct = document.getElementById('pctVal');
  const was = document.getElementById('oldTax');
  const became = document.getElementById('newTax');
  const econ = document.getElementById('saveCounter');
  const num = s => (s||'').toString().replace(/[^\d.-]/g,'')*1 || 0;

  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(e){ return null } }
  function tgInit(){ try{ return Telegram?.WebApp?.initData || null }catch(e){ return null } }
  function uid(){ let u=localStorage.getItem('uid'); if(!u){u=Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid',u);} return u; }

  async function postGAS(payload){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if(!C.GAS_WEBHOOK) return {ok:false, error:'no_webhook'};
    const body = Object.assign({}, payload);
    if (C.USE_TG_SIGNATURE && tgInit()) body.tg_init = tgInit();
    if (!tgInit() && C.API_KEY) body.key = C.API_KEY;
    try{
      const r = await fetch(C.GAS_WEBHOOK, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      return await r.json().catch(()=>({ok:true}));
    }catch(e){ return {ok:false, error:String(e)} }
  }

  btn.addEventListener('click', async ()=>{
    // confetti + toast
    try{ __confAt(btn); }catch(_){ try{ __conf(); }catch(__){} }
try{ window.showToast && showToast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–≤–æ–¥–Ω—ã–µ –∏ –≤–µ—Ä–Ω—ë–º—Å—è —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏'); }catch(e){}

    const payload = {
      type: 'calc_lead',
      ts: new Date().toISOString(),
      uid: uid(),
      page: (new URL(location.href)).searchParams.get('page') || (location.hash||'#home').slice(1) || 'home',
      calc: {
        revenue: num(rev?.textContent),
        effect:  num(pct?.textContent),
        was:     num(was?.textContent),
        become:  num(became?.textContent),
        economy: num(econ?.textContent)
      },
      tg_user: tgUser()
    };

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ (web_app_data)
    try{ Telegram && Telegram.WebApp && Telegram.WebApp.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){}

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ GAS (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
    try{ await postGAS(payload); }catch(e){}
  });
})();

// v19 ‚Äî guard: fix "services" page showing wrong content due to duplicate show()
// Ensure only top-level sections toggle .active
(function(){
  const links = document.querySelectorAll('#spa-nav [data-page]');
  const sections = Array.from(document.querySelectorAll('body > main.container section.page, body > section.page'));
  function showSafe(id){
    sections.forEach(s=> s.classList.toggle('active', s.id === id));
    links.forEach(l=> l.classList.toggle('active', l.getAttribute('data-page')===id));
  }
  // If current hash points to a valid section but it's not visible, force it
  const current = (location.hash||'#home').replace('#','');
  if (sections.some(s=>s.id===current) && !document.getElementById(current).classList.contains('active')){
    showSafe(current);
  }
  // Keep bubble in place if nav already initialized
  if (window.__centerNavActive) try{ window.__centerNavActive(); }catch(e){}
})();
</script>


<script>
// v20 ‚Äî Bonuses: "–û—Ñ–æ—Ä–º–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é" safe handler (confetti + toast + sendData)
(function(){
  const box = document.getElementById('bonuses'); if(!box) return;
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      // confetti
      try{ if(window.confetti) confetti({particleCount:120, spread:70}); }catch(_){}
      // toast
      const msg = btn.getAttribute('data-msg') || '–ó–∞—è–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞';
      try{ window.showToast && showToast('–ì–æ—Ç–æ–≤–æ', msg); }catch(_){}
      // send to bot + GAS if configured
      try{
        const payload = { type:'register_business', ts:new Date().toISOString(), uid: (localStorage.getItem('uid')||'') };
        Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload));
      }catch(_){}
      // update local stats
      try{ localStorage.setItem('stat_points', String((+localStorage.getItem('stat_points')||0)+5)); }catch(_){}
    }, {once:false});
  });
})();

// v20 ‚Äî Main flow: stepper with redirect to #consult on last step
(function(){
  const card = document.getElementById('home'); if(!card) return;
  const flow = card.querySelector('#flow'); if(!flow) return;
  const btnNext = card.querySelector('#flowNext'); const btnReset = card.querySelector('#flowReset');
  const steps = Array.from(flow.querySelectorAll('.badge'));
  let i = 0;
  function render(){
    steps.forEach((s,idx)=>{
      s.style.opacity = idx<=i ? 1 : .45;
      s.style.filter = idx<=i ? 'none' : 'grayscale(.3)';
    });
    if(i >= steps.length-1){ btnNext.textContent = '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏'; }
    else { btnNext.textContent = '–î–∞–ª—å—à–µ'; }
  }
  btnNext?.addEventListener('click', ()=>{
    if(i < steps.length-1){ i++; render(); }
    else{
      try{ window.showToast && showToast('–ì–æ—Ç–æ–≤–æ', '–û—Ç–∫—Ä—ã–ª —Ä–∞–∑–¥–µ–ª ¬´–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª'); }catch(_){}
      if (typeof __showPage === 'function'){ __showPage('consult'); }
      else if (typeof show === 'function'){ show('consult'); }
      try{
        const u = new URL(location.href);
        u.searchParams.set('page','consult'); history.replaceState(null,'', u.pathname+u.search+'#consult');
      }catch(_){ location.hash = 'consult'; }
    }
  });
  btnReset?.addEventListener('click', ()=>{ i = 0; render(); });
  render();
})();

// v20 ‚Äî Wheel: 24h cooldown with countdown
(function(){
  const section = document.getElementById('bonuses'); if(!section) return;
  const oldBtn = section.querySelector('#spin'); const out = section.querySelector('#spinRes');
  if(!oldBtn || !out) return;
  const btn = oldBtn.cloneNode(true); oldBtn.replaceWith(btn);

  const uid = (localStorage.getItem('uid')|| (Date.now().toString(36)+Math.random().toString(36).slice(2,8))); localStorage.setItem('uid', uid);
  const KEY = 'spin_next_at_' + uid;
  const COOLDOWN = 24*60*60*1000;
  const prizes = ['üéÅ –®–∞–±–ª–æ–Ω ¬´–û—Ñ—Ñ–µ—Ä¬ª','üìò –ß–µ–∫-–ª–∏—Å—Ç –∞—É–¥–∏—Ç–∞','üí¨ +30 –º–∏–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏','üßÆ –î–æ—Å—Ç—É–ø –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É PRO','‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä'];

  function h(){ try{ Telegram.WebApp.HapticFeedback.impactOccurred('light'); }catch(e){ navigator.vibrate?.(25); } }
  function announce(txt){ try{ showToast && showToast('–ü–æ–∑–¥—Ä–∞–≤–ª—è—é!', txt); }catch(e){} }

  let timer;
  function apply(){
    const left = (parseInt(localStorage.getItem(KEY)||'0',10) - Date.now());
    if(left>0){
      btn.disabled = true; btn.classList.add('btn-ghost'); btn.classList.remove('btn-primary');
      const tick = ()=>{
        const l = parseInt(localStorage.getItem(KEY)||'0',10) - Date.now();
        if(l<=0){ clearInterval(timer); btn.disabled=false; btn.classList.remove('btn-ghost'); btn.classList.add('btn-primary'); btn.textContent='–ö—Ä—É—Ç–∏—Ç—å üé°'; return; }
        const s=Math.floor(l/1000), hhh=Math.floor(s/3600), mmm=Math.floor((s%3600)/60), ss=s%60;
        btn.textContent = '–ö—Ä—É—Ç–∏—Ç—å —á–µ—Ä–µ–∑ ' + (hhh? hhh+'—á ':'') + (mmm? mmm+'–º ':'') + ss+'—Å';
      };
      clearInterval(timer); timer = setInterval(tick,1000); tick(); return true;
    } else {
      btn.disabled=false; btn.classList.remove('btn-ghost'); btn.classList.add('btn-primary'); btn.textContent='–ö—Ä—É—Ç–∏—Ç—å üé°'; return false;
    }
  }

  let spinning=false;
  btn.addEventListener('click', ()=>{
    if(spinning) return;
    if(apply()) return;
    spinning=true; out.textContent='–ö—Ä—É—Ç–∏–º‚Ä¶'; h();
    const total = 1800 + Math.floor(Math.random()*900);
    const t0 = performance.now();
    const step = (t)=>{
      if(t - t0 >= total){
        const win = prizes[Math.floor(Math.random()*prizes.length)];
        out.textContent = '–í—ã–ø–∞–ª–æ: ' + win;
        announce(win);
        try{ if(window.__confAt) __confAt(btn); }catch(_){ }
        try{
          const ul = document.getElementById('ppPrizeList');
          if(ul){ ul.innerHTML=''; const li=document.createElement('li'); li.textContent=win; li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)'; ul.appendChild(li); }
          const pp = document.getElementById('ppPrize'); if(pp) pp.textContent = win;
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { prizes: ((window.__PROFILE&&window.__PROFILE.prizes)||[]).concat([{title:win}]).slice(-10) });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        }catch(_){ }
        // stats
        try{
          const arr = JSON.parse(localStorage.getItem('last_prizes')||'[]'); arr.push(win);
          localStorage.setItem('last_prizes', JSON.stringify(arr.slice(-10)));
          localStorage.setItem('stat_prizes', String(+(localStorage.getItem('stat_prizes')||0)+1));
          localStorage.setItem('stat_points', String(+(localStorage.getItem('stat_points')||0)+10));
        }catch(_){}
        localStorage.setItem(KEY, String(Date.now()+COOLDOWN));
        try{
          const nextAtISO = new Date(parseInt(localStorage.getItem(KEY)||'0',10)).toISOString();
          const prizes = JSON.parse(localStorage.getItem('last_prizes')||'[]');
          const payload = { type:'community_prize', prize: win, prizes_json: prizes, spin_next_at: nextAtISO, uid: (window.__uid&&__uid())||'' };
          if (typeof window.__postGAS==='function') window.__postGAS(payload);
        }catch(_){ }
        spinning=false; apply();
        return;
      }
      requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  });
  apply();
})();

/* removed: v20 profile panel block */


<script>
// v21 ‚Äî iOS flag & double-tap zoom suppressor
(function(){
  var ua = navigator.userAgent || navigator.vendor || '';
  var isiOS = /iPad|iPhone|iPod/.test(ua);
  if(isiOS) document.documentElement.classList.add('ios');
  // naive double-tap suppressor for interactive elements
  var last = 0;
  document.addEventListener('touchend', function(e){
    const target = e.target.closest('button, .btn, a, [role="button"]');
    if(!target) return;
    var now = Date.now();
    if(now - last < 350){ e.preventDefault(); }
    last = now;
  }, {passive:false});
})();

// v21 ‚Äî global haptics also on touchstart
(function(){
  function vibr(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }
  document.addEventListener('click',  function(e){ if(e.target.closest('.btn,button')) vibr('light'); }, {passive:true});
  document.addEventListener('touchstart', function(e){ if(e.target.closest('.btn,button')) vibr('light'); }, {passive:true});
})();

// v21 ‚Äî Bonuses: guard all CTA buttons to avoid layout break + send events
(function(){
  const box = document.getElementById('bonuses'); if(!box) return;
  // normalize external links to open in bot page, but don't navigate inside WebApp
  box.querySelectorAll('a.btn').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ if(window.confetti) confetti({particleCount:120, spread:70}); }catch(_){}
      try{ showToast && showToast('–û—Ç–∫—Ä–æ–µ–º –≤ –±–æ—Ç–µ', '–°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }catch(_){}
      const payload = { type:'bonus_btn', href:a.getAttribute('href'), ts:new Date().toISOString(), uid: localStorage.getItem('uid')||'' };
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
    }, {passive:false});
  });
  // existing toast-btn (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —Ç.–ø.)
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ if(window.confetti) confetti({particleCount:120, spread:70}); }catch(_){}
      try{ showToast && showToast('–ì–æ—Ç–æ–≤–æ', btn.getAttribute('data-msg')||'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }catch(_){}
      try{
        const payload = { type:'register_business', ts:new Date().toISOString(), uid: localStorage.getItem('uid')||'' };
        Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload));
      }catch(_){}
      // force repaint to avoid Safari layer artifacts
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>{ document.body.style.webkitTransform=''; }, 60);
    }, {passive:false});
  });
})();

// v21 ‚Äî Profile instead of console (ensure open on tap)
(function(){
  const btn = document.querySelector('.console-toggle');
  const panel = document.getElementById('consolePanel');
  if(!btn || !panel) return;

  function initials(name){
    const p=(name||'').trim().split(/\s+/);
    return ( (p[0]||'').charAt(0) + (p[1]||'').charAt(0) || (p[0]||'?').charAt(0) ).toUpperCase();
  }
  function render(){
    let user=null; try{ user = Telegram?.WebApp?.initDataUnsafe?.user || null; }catch(_){}
    const uname = user?.username ? '@'+user.username : '‚Äî';
    const name = [user?.first_name, user?.last_name].filter(Boolean).join(' ') || '–ì–æ—Å—Ç—å';
    const pts = +localStorage.getItem('stat_points') || 0;
    const prize = (JSON.parse(localStorage.getItem('last_prizes')||'[]')||[]).slice(-1)[0] || '‚Äî';
    const booking = localStorage.getItem('last_booking') || '–ù–µ—Ç';

    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–û—á–∫–∏</div><div class="big">${pts}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div class="big" style="font-size:14px">${prize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ó–∞–ø–∏—Å—å</div><div class="big" style="font-size:14px">${booking}</div></div>
      </div>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
        <button class="btn btn-ghost" id="profClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    `;
  }

  function openPanel(){
    render();
    panel.style.display='block';
    panel.style.maxHeight='70vh';
    panel.style.width='min(420px,92vw)';
  }
  function closePanel(){ panel.classList.remove('open'); }

  btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); 
    if (panel.classList.contains('open')) closePanel(); else openPanel();
  }, {passive:false});
  panel.addEventListener('click', (e)=>{
    if(e.target.id==='profClose') { closePanel(); }
  });
})();

</script>


<script>
/* ================= v25 SAFE PATCH ================= */

/* Config guard */
window.APP_CONFIG = Object.assign({
  TG_BOT_USERNAME: 'serge_kamensky_bot',
  GAS_WEBHOOK: '',
  API_KEY: '',
  USE_TG_SIGNATURE: true
}, window.APP_CONFIG||{});

/* Helpers */
function __uid(){ let u=localStorage.getItem('uid'); if(!u){u=Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid',u);} return u; }
function __tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user||null }catch(e){ return null } }
function __tgInit(){ try{ return Telegram?.WebApp?.initData||null }catch(e){ return null } }
function __haptic(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } }
function __conf(){ try{ if(window.confetti) confetti({particleCount:140, spread:70}); }catch(e){} }

function __confAt(el){
  try{
    if(!el || !window.confetti){ __conf(); return; }
    const r = el.getBoundingClientRect();
    const x = (r.left + r.width/2) / window.innerWidth;
    const y = (r.top + r.height/2) / window.innerHeight;
    confetti({particleCount: 140, spread: 70, origin: {x, y}});
  }catch(e){ try{ __conf(); }catch(_){} }
}
function __normalizePhoneRU(raw){
  let s = (raw||'').replace(/[^\d+]/g, '');
  if(s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g, '');
  else s = s.replace(/\D/g, '');
  s = s.replace(/^\+/, '');
  if(s.startsWith('8') && s.length===11) s = '7' + s.slice(1);
  if(s.startsWith('7') && s.length===11) return s;
  if(s.length===10 && s[0]==='9') return '7'+s;
  if(s.length>11 && /\d{10}$/.test(s)) return '7' + s.slice(-10);
  return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : '');
}
function __ensureContactHint(input){
  try{
    const hintId = 'contactHint';
    let hint = document.getElementById(hintId);
    if(!hint){
      hint = document.createElement('div');
      hint.id = hintId;
      hint.style.opacity = '.7';
      hint.style.fontSize = '12px';
      hint.style.marginTop = '4px';
      input.insertAdjacentElement('afterend', hint);
    }
    return hint;
  }catch(_) { return null; }
}
function __getBookingISODate(){
  try{
    const lb = localStorage.getItem('last_booking') || '';
    try{
      const obj = JSON.parse(lb);
      if (obj && obj.date) return String(obj.date);
    }catch(_){}
    const m = lb.match(/\b(\d{4}-\d{2}-\d{2})\b/);
    if(m) return m[1];
  }catch(_){}
  try{
    const bd = localStorage.getItem('booking_date') || (window.booking_date||'');
    if(/\d{4}-\d{2}-\d{2}/.test(bd)) return bd.match(/\d{4}-\d{2}-\d{2}/)[0];
  }catch(_){}
  return '';
}
function __fmtDMY(iso){
  if(!iso) return '';
  const m = iso.match(/(\d{4})-(\d{2})-(\d{2})/);
  if(!m) return '';
  return m[3]+'.'+m[2]+'.'+m[1];
}
function __addBookingDatePrefixTo(el){
  try{
    if(!el) return;
    const iso = __getBookingISODate();
    if(!iso) return;
    const d = __fmtDMY(iso);
    const t = (el.textContent||'').trim();
    if(!t.startsWith(d)){
      el.textContent = (d + ' ' + t).trim();
    }
  }catch(_){}
}
async function __postGAS(payload){
  const C = window.APP_CONFIG||{}; if(!C.GAS_WEBHOOK) return {ok:false, error:'no_webhook'};
  const body = Object.assign({}, payload);
  if (C.USE_TG_SIGNATURE && __tgInit()) body.tg_init = __tgInit();
  if (!__tgInit() && C.API_KEY) body.key = C.API_KEY;
  try{ const r = await fetch(C.GAS_WEBHOOK, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
       return await r.json().catch(()=>({ok:true}));
  }catch(e){ return {ok:false, error:String(e)} }
}

/* 0) Kill any in-page console hooks that might print into panel */
window.__domLog = function(){};

/* 1) Global haptics + confetti hooks */
(function(){
  const sel='button,.btn,[role="button"],a.btn';
  document.addEventListener('click',e=>{ if(e.target.closest(sel)) __haptic('light'); }, {passive:true});
  document.addEventListener('touchstart',e=>{ if(e.target.closest(sel)) __haptic('light'); }, {passive:true});
  // auto-confetti on elements with .confetti or data-confetti
  document.addEventListener('click',e=>{ const t=e.target.closest('.confetti,[data-confetti]'); if(t) __conf(); }, {passive:true});
})();

/* 2) Deeplinks to the configured bot (open in Telegram) */
(function(){
  const bot = (window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot';
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-open-bot], a[href^="https://t.me/"], a[href^="t.me/"]');
    if(!a) return;
    e.preventDefault(); e.stopPropagation();
    const href = a.getAttribute('href')||('https://t.me/'+bot);
    try{ Telegram.WebApp.openTelegramLink(href); }catch(_){ window.open(href,'_blank'); }
  }, {passive:false});
})();

/* 3) Referral points: +100 per invited friend */
(function(){
  const u = new URL(location.href);
  const start = u.searchParams.get('start') || u.searchParams.get('tgWebAppStartParam') || u.searchParams.get('start_param');
  if(!start) return;
  const m = String(start).match(/^ref_(.+)$/);
  if(!m) return;
  const inviter = m[1];
  const KEY = 'ref_paid_'+inviter;
  if(localStorage.getItem(KEY)) return; // one-time per device for this inviter
  try{
    const cur = +(localStorage.getItem('stat_points_'+inviter) || 0);
    localStorage.setItem('stat_points_'+inviter, String(cur + 100));
    if((localStorage.getItem('uid')||'') === inviter){ // inviter on same device
      localStorage.setItem('stat_points', String((+localStorage.getItem('stat_points')||0)+100));
    }
    localStorage.setItem('invited_by', inviter);
    localStorage.setItem(KEY, '1');
    // send event (optional)
    const payload = {type:'ref_join', ts:new Date().toISOString(), inviter, uid:__uid(), tg_user:__tgUser()};
    try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
    __postGAS(payload);
  }catch(_){}
})();

/* 4) Invite page: generate link + demo add +100 */
(function(){
  const box=document.getElementById('invite'); if(!box) return;
  const bot=(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'; const link=`https://t.me/${bot}?start=ref_${(__tgUser()&&__tgUser().id)?__tgUser().id:__uid()}`;
  const inp=box.querySelector('#refLink'); if(inp) inp.value=link;
  const copy=box.querySelector('#copyRef'), share=box.querySelector('#shareRef'), sim=box.querySelector('#simulateRef');
  copy && copy.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(link); showToast && showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ'); }catch(_){}});
  share && share.addEventListener('click', async()=>{ try{ if(navigator.share) await navigator.share({title:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ',url:link}); else await navigator.clipboard.writeText(link); showToast && showToast('–ì–æ—Ç–æ–≤–æ','–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }catch(_){}});
  sim && sim.addEventListener('click', ()=>{ const cur=+localStorage.getItem('stat_points')||0; localStorage.setItem('stat_points', String(cur+100)); __conf(); try{showToast('+100 –æ—á–∫–æ–≤','–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');}catch(_){} });
})();

/* 5) Profile panel (–≤–º–µ—Å—Ç–æ –∫–æ–Ω—Å–æ–ª–∏) ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∏–º–µ–Ω–∏ */
(function(){
  const btn=document.querySelector('.console-toggle'); const panel=document.getElementById('consolePanel');
  if(!btn||!panel) return;
  function initials(name){ const p=(name||'').trim().split(/\s+/); return ((p[0]||'').charAt(0)+(p[1]||'').charAt(0)||'‚ò∫').toUpperCase(); }
  function render(){
    const u=__tgUser(); const name=[u?.first_name,u?.last_name].filter(Boolean).join(' ')||'–ì–æ—Å—Ç—å'; const uname=u?.username?('@'+u.username):'‚Äî';
    const pts=+localStorage.getItem('stat_points')||0;
    const prize=(JSON.parse(localStorage.getItem('last_prizes')||'[]')||[]).slice(-1)[0]||'‚Äî';
    const booking=localStorage.getItem('last_booking')||'–ù–µ—Ç';
    const bot=(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot';
    panel.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–û—á–∫–∏</div><div class="big">${pts}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div class="big" style="font-size:14px">${prize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ó–∞–ø–∏—Å—å</div><div class="big" style="font-size:14px">${booking}</div></div>
      </div>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" data-open-bot href="https://t.me/${bot}">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
        <button class="btn btn-ghost" id="profClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>`;
    panel.style.display='block'; panel.classList.add('open'); panel.style.maxHeight='70vh'; panel.style.width='min(420px,92vw)';
    panel.querySelector('#profClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
  }
  btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); if(panel.style.display==='block') panel.classList.remove('open'); else { render(); let tries=0; const t=setInterval(()=>{ const u=__tgUser(); if(u||tries++>20){clearInterval(t); if(u) render();}},150); } }, {passive:false});
})();

/* 6) Bonuses CTA safe-handlers: –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ + —Å–æ–±—ã—Ç–∏–µ –≤ –±–æ—Ç–∞, –±–µ–∑ –ª–æ–º–∫–∏ —Å–ª–æ—è */
(function(){
  const box=document.getElementById('bonuses'); if(!box) return;
  // links
  box.querySelectorAll('a.btn').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      __conf(); __haptic('light');
      const payload={type:'bonus_btn', href:a.getAttribute('href'), ts:new Date().toISOString(), uid:__uid()};
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
  // toast buttons (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      __conf(); __haptic('light');
      try{ showToast && showToast('–ì–æ—Ç–æ–≤–æ', btn.getAttribute('data-msg')||'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }catch(_){}
      const payload={type:'register_business', ts:new Date().toISOString(), uid:__uid()};
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      __postGAS(payload);
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
})();

/* 7) "–ö–∞–∫ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º" ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ */
(function(){
  const home=document.getElementById('home'); if(!home) return;
  const flow=home.querySelector('#flow'); const next=home.querySelector('#flowNext'); const reset=home.querySelector('#flowReset');
  if(!flow || !next) return;
  const steps=[...flow.querySelectorAll('.badge')]; let i=0;
  function paint(){ steps.forEach((s,idx)=>{ s.style.opacity=idx<=i?1:.45; s.style.filter=idx<=i?'none':'grayscale(.3)'; }); next.textContent = i>=steps.length-1 ? '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏' : '–î–∞–ª—å—à–µ'; }
  next.addEventListener('click', ()=>{ if(i<steps.length-1){ i++; paint(); } else { try{ showToast && showToast('–û—Ç–∫—Ä—ã–≤–∞—é','–†–∞–∑–¥–µ–ª ¬´–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª'); }catch(_){}
    if (typeof __showPage==='function') __showPage('consult'); else if (typeof show==='function') show('consult');
    try{ const u=new URL(location.href); u.searchParams.set('page','consult'); history.replaceState(null,'', u.pathname+u.search+'#consult'); }catch(_){ location.hash='consult'; } } });
  reset && reset.addEventListener('click', ()=>{ i=0; paint(); });
  paint();
})();
/* ================================================== */
</script>


<script>
/* v26: robust SPA navigation helper used by stepper */
(function(){
  function go(page){
    try{
      const sections=[...document.querySelectorAll('section.page, main.container section.page')];
      sections.forEach(s=> s.classList.toggle('active', s.id===page));
      const links=[...document.querySelectorAll('#spa-nav [data-page]')];
      links.forEach(l=> l.classList.toggle('active', l.getAttribute('data-page')===page));
    }catch(e){}
    try{
      const u=new URL(location.href);
      u.searchParams.set('page', page);
      history.replaceState(null,'', u.pathname+u.search+'#'+page);
    }catch(_){ location.hash = page; }
    try{ window.__centerNavActive && window.__centerNavActive(); }catch(e){}
  }
  window.__goPage = go;
})();

/* v26: patch Stepper to use __goPage always */
(function(){
  const home=document.getElementById('home'); if(!home) return;
  const flow=home.querySelector('#flow'); const next=home.querySelector('#flowNext'); const reset=home.querySelector('#flowReset');
  if(!flow || !next) return;
  const steps=[...flow.querySelectorAll('.badge')]; let i=0;
  function paint(){ steps.forEach((s,idx)=>{ s.style.opacity=idx<=i?1:.45; s.style.filter=idx<=i?'none':'grayscale(.3)'; }); next.textContent = i>=steps.length-1 ? '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏' : '–î–∞–ª—å—à–µ'; }
  next.addEventListener('click', ()=>{ if(i<steps.length-1){ i++; paint(); } else { try{ showToast && showToast('–û—Ç–∫—Ä—ã–≤–∞—é','–†–∞–∑–¥–µ–ª ¬´–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª'); }catch(_){}
    window.__goPage && window.__goPage('consult');
  }});
  reset && reset.addEventListener('click', ()=>{ i=0; paint(); });
  paint();
})();
</script>


<script>
/* v27 ‚Äî Fixes: debounce toasts, robust profile toggle, reliable confetti triggers */

/* 0) Guard & helpers */
(function(){
  window.APP_CONFIG = Object.assign({
    TG_BOT_USERNAME: 'serge_kamensky_bot',
    GAS_WEBHOOK: '',
    API_KEY: '',
    USE_TG_SIGNATURE: true
  }, window.APP_CONFIG||{});
  window.__uid = window.__uid || function(){ let u=localStorage.getItem('uid'); if(!u){u=Date.now().toString(36)+Math.random().toString(36).slice(2,8); localStorage.setItem('uid',u);} return u; };
  window.__haptic = window.__haptic || function(level){ try{ Telegram.WebApp.HapticFeedback.impactOccurred(level||'light'); }catch(e){ navigator.vibrate && navigator.vibrate(25); } };
})();

/* 1) Debounced toasts ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –≤—Å–ø–ª—ã—Ç–∏—è –ø–æ–¥—Ä—è–¥ */
(function(){
  const orig = window.showToast;
  let lastAt = 0, lastKey = '';
  window.showToast = function(title, msg){
    const key = String(title||'')+'|'+String(msg||'');
    const now = Date.now();
    if (key===lastKey && (now - lastAt) < 900) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç ¬´–¥—É–±–ª–µ–π¬ª
    lastAt = now; lastKey = key;
    try{ if(typeof orig === 'function') return orig(title, msg); }catch(e){}
    // fallback
    try{ console.log('[Toast]', title, msg); }catch(e){}
  };
})();

/* 2) Global haptics + confetti everywhere (like on "–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç") */
(function(){
  function conf(){
    try{ if(window.confetti){ confetti({particleCount:140, spread:70}); return; } }catch(e){}
  }
  const celebrateSel = [
    '#ctaCalc',
    '#bonuses .toast-btn',
    '#bonuses a.btn',
    '#consult #confirmConsult, #consult #consultSubmit, #consult #confirmBtn',
    '#invite #copyRef',
    '#invite #shareRef',
    '.btn[data-confetti]',
    '.btn.confetti'
  ].join(',');
  document.addEventListener('click', (e)=>{
    const el = e.target.closest(celebrateSel);
    if(!el) return;
    conf(); window.__haptic('light');
  }, {passive:true});
})();

/* 3) Bonuses CTA safe handler (no layout break + single toast) */
(function(){
  const box = document.getElementById('bonuses'); if(!box) return;
  // Links
  box.querySelectorAll('a.btn').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ window.showToast('–û—Ç–∫—Ä–æ–µ–º –≤ –±–æ—Ç–µ', a.textContent.trim() || '–°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }catch(e){}
      const payload = { type:'bonus_btn', href:a.getAttribute('href'), ts:new Date().toISOString(), uid: window.__uid() };
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      // repaint for Safari
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
  // Buttons with toast-msg
  box.querySelectorAll('.toast-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      window.showToast('–ì–æ—Ç–æ–≤–æ', btn.getAttribute('data-msg')||'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      const payload = { type:'register_business', ts:new Date().toISOString(), uid: window.__uid() };
      try{ Telegram?.WebApp?.sendData && Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(_){}
      document.body.style.webkitTransform='translateZ(0)'; setTimeout(()=>document.body.style.webkitTransform='',60);
    }, {passive:false});
  });
})();

/* 4) Profile panel ‚Äî –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–π –ø–æ–∏—Å–∫ –∫–Ω–æ–ø–∫–∏ –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ */
(function(){
  const panel = document.getElementById('consolePanel');
  const btn = document.querySelector('.console-toggle, #consoleToggle, .fab-console, .console');
  if(!panel || !btn) return;

  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null } catch(e){ return null } }
  function initials(name){ const p=(name||'').trim().split(/\s+/); return ((p[0]||'').charAt(0)+(p[1]||'').charAt(0)||'‚ò∫').toUpperCase(); }
  function render(){
    const u = tgUser();
    const name = [u?.first_name, u?.last_name].filter(Boolean).join(' ') || '–ì–æ—Å—Ç—å';
    const uname = u?.username ? '@'+u.username : '‚Äî';
    const pts = +localStorage.getItem('stat_points') || 0;
    const prize = (JSON.parse(localStorage.getItem('last_prizes')||'[]')||[]).slice(-1)[0] || '‚Äî';
    const booking = localStorage.getItem('last_booking') || '–ù–µ—Ç';
    const bot = (window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot';
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–û—á–∫–∏</div><div class="big">${pts}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div class="big" style="font-size:14px">${prize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ó–∞–ø–∏—Å—å</div><div class="big" style="font-size:14px">${booking}</div></div>
      </div>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" data-open-bot href="https://t.me/${bot}">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
        <button class="btn btn-ghost" id="profClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    `;
    panel.style.display='block';
    panel.style.maxHeight='70vh'; panel.style.width='min(420px,92vw)';
  }
  function open(){ panel.style.display='block'; panel.classList.add('open');  render(); __haptic('light'); let tries=0; const t=setInterval(()=>{ const u = (Telegram?.WebApp?.initDataUnsafe?.user || null); if(u || tries++>20){ clearInterval(t); if(u) render(); }}, 150); }
  function close(){ panel.classList.remove('open'); }
  btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); (panel.classList.contains('open')) ? close() : open(); }, {passive:false});
  panel.addEventListener('click', (e)=>{ if(e.target.id==='profClose'){ close(); }}, {passive:true});
})();
</script>


<script>
// GAS bootstrap: fetch profile by tg_init on load
(function(){
  const C = window.APP_CONFIG||{};
  if(!C.GAS_WEBHOOK) return;
  function tgInit(){ try{ return Telegram && Telegram.WebApp && Telegram.WebApp.initData || ''; }catch(e){ return '' } }
  async function bootstrap(){
    try{
      const url = C.GAS_WEBHOOK + '?mode=bootstrap&tg_init=' + encodeURIComponent(tgInit());
      const res = await fetch(url, {method:'GET', headers:{'Cache-Control':'no-store'}});
      const data = await res.json().catch(()=>null);
      if(!data || !data.ok) return;
      // Cache essentials for UI
      try{
        const p = data.profile||{};
        localStorage.setItem('stat_points', String(p.points||0));
        localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
        if(p.spin_next_at) localStorage.setItem('spin_next_at', p.spin_next_at);
        if(p.last_booking) localStorage.setItem('last_booking', p.last_booking);
      }catch(_){}
      // notify UI
      try{ window.showToast && showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', '–î–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–Ω—É—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞'); }catch(_){}
    }catch(e){ /*silent*/ }
  }
  // start when WebApp is ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') bootstrap();
  else document.addEventListener('DOMContentLoaded', bootstrap);
})();
</script>



<!-- ==== DEV TEST (home overlay; show only with ?debug=1) ==== -->
<style>
  #dev-fab{position:fixed;right:14px;bottom:14px;z-index:9999;border:0;border-radius:999px;padding:12px 14px;background:#2b52ff;color:#fff;font:600 13px system-ui;box-shadow:0 8px 22px rgba(0,0,0,.35);cursor:pointer;display:none}
  #dev-panel{position:fixed;right:14px;bottom:64px;z-index:9999;width:320px;max-width:92vw;background:#0f1221;color:#c9d1ff;border:1px solid #2a3157;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;overflow:hidden}
  #dev-panel .hdr{padding:10px 12px;border-bottom:1px solid #2a3157;display:flex;gap:8px;align-items:center}
  #dev-panel .hdr .ttl{font-weight:600}
  #dev-panel .hdr .badge{margin-left:auto;font-size:11px;opacity:.8}
  #dev-panel .body{padding:12px;display:flex;flex-direction:column;gap:8px}
  #dev-panel button{padding:10px 12px;border:0;border-radius:10px;color:#fff;cursor:pointer}
  #btn-test-bootstrap{background:#2b52ff}
  #btn-test-booking{background:#3aa76d}
  #dev-log{background:#0b0e1a;border:1px solid #2a3157;border-radius:10px;padding:10px;max-height:180px;overflow:auto;white-space:pre-wrap}
</style>
<button id="dev-fab">DEV</button>
<div id="dev-panel">
  <div class="hdr">
    <div class="ttl">DEV ‚Ä¢ GAS quick test</div>
    <div class="badge" id="dev-badge"></div>
  </div>
  <div class="body">
    <button id="btn-test-bootstrap">1) Bootstrap</button>
    <button id="btn-test-booking">2) Test consult_booking</button>
    <div id="dev-log"></div>
  </div>
</div>

<!-- ==== /DEV TEST ==== -->


<script>
(function(){
  function _jsonp(url, params = {}, cbName = 'cb_'+Math.random().toString(36).slice(2)) {
    return new Promise((resolve, reject) => {
      const q = new URLSearchParams(params);
      q.set('callback', cbName);
      const src = url + (url.includes('?') ? '&' : '?') + q.toString();
      const s = document.createElement('script');
      let done = false;
      window[cbName] = (data) => { if (done) return; done = true; resolve(data); cleanup(); };
      s.onerror = () => { if (done) return; done = true; reject(new Error('JSONP load error')); cleanup(); };
      function cleanup(){ try{ delete window[cbName]; }catch(e){} s.remove(); }
      s.src = src;
      document.head.appendChild(s);
      setTimeout(()=>{ if (!done) { done = true; reject(new Error('JSONP timeout')); cleanup(); } }, 15000);
    });
  }
  window._jsonp = _jsonp;

  async function apiBootstrap() {
    const tg = (window.Telegram && Telegram.WebApp) || null;
    const tgInit = tg ? (tg.initData || '') : '';
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    return _jsonp(url, { mode: 'bootstrap', tg_init: tgInit });
  }
  window.apiBootstrap = apiBootstrap;

  async function apiEvent(type, extra = {}) {
    const tg = (window.Telegram && Telegram.WebApp) || null;
    const tgInit = tg ? (tg.initData || '') : '';
    const url = (window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK);
    const data = JSON.stringify({ ...extra });
    return _jsonp(url, { mode: 'event', type, tg_init: tgInit, data });
  }
  window.apiEvent = apiEvent;

  try{ console.log('[GAS] JSONP helpers ready', { webhook: (window.APP_CONFIG||{}).GAS_WEBHOOK }); }catch(e){}
})();
</script>

<!-- --- BEGIN: universal fetch wrapper for GAS (json -> form-urlencoded + auto type) --- -->
<script>
(function(){
  const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

  const GAS = (C && C.GAS_WEBHOOK) || '';
  if (!GAS) { console.warn('[fetch-wrapper] GAS_WEBHOOK not set'); return; }

  const strip = (u)=> (u||'').split('#')[0].split('?')[0];
  const GAS_BASE = strip(GAS);
  const _origFetch = window.fetch;

  function _autoType(obj){
    if (!obj || typeof obj !== 'object') return '';
    if (obj.type || obj.event) return obj.type || obj.event;
    if ('date' in obj && 'time' in obj) return 'consult_booking';
    if ('inviter' in obj) return 'ref_join';
    // –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    if (Object.keys(obj).length === 0) return 'register_business';
    return '';
  }

  window.fetch = function(input, init){
    try{
      const url = (typeof input === 'string') ? input : (input && input.url) || '';
      const method = (init && (init.method || 'GET')).toUpperCase();
      const isGAS = GAS_BASE && strip(url) === GAS_BASE;

      if (isGAS && method === 'POST') {
        const hdrs = (init && init.headers) || {};
        const ct = (typeof hdrs.get === 'function') ? (hdrs.get('Content-Type')||'') : (hdrs['Content-Type'] || hdrs['content-type'] || '');
        if (String(ct).toLowerCase().includes('application/json')) {
          // Convert JSON body to x-www-form-urlencoded to avoid CORS preflight
          let obj = {};
          try { obj = JSON.parse(init.body || '{}'); } catch(_) {}

          const type = _autoType(obj);
          const params = new URLSearchParams();
          if (type) params.set('type', type);

          // auth: tg_init -> key
          if (obj.tg_init) params.set('tg_init', obj.tg_init);
          else {
            try {
              const initData = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
              if (initData) params.set('tg_init', initData);
            } catch(_){}
          }
          if (!params.has('tg_init') && obj.key) params.set('key', obj.key);
          if (!params.has('tg_init') && !params.has('key') && C.API_KEY) {
            params.set('key', C.API_KEY);
            if (C.DEV_ID) params.set('dev_id', C.DEV_ID);
          }
          if (obj.dev_id && !params.has('dev_id')) params.set('dev_id', obj.dev_id);

          const data = Object.assign({}, obj);
          delete data.type; delete data.event;
          delete data.tg_init; delete data.key; delete data.dev_id;

          params.set('data', JSON.stringify(data));

          const newInit = Object.assign({}, init, {
            method: 'POST',
            headers: (typeof Headers !== 'undefined' && hdrs instanceof Headers)
              ? (hdrs.set('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8'), hdrs)
              : Object.assign({}, hdrs, {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'}),
            body: params.toString(),
            credentials: 'omit'
          });

          return _origFetch.call(this, url, newInit);
        }
      }
    } catch (e) {
      console.warn('[fetch-wrapper] error:', e);
    }
    return _origFetch.apply(this, arguments);
  };

  console.log('[fetch-wrapper] active ‚Üí', GAS_BASE);
})();
</script>
<!-- --- END: universal fetch wrapper --- -->








<!-- BEGIN: MiniApp core (clean) -->
<script>
(function(){
  function jsonp(url, params = {}, timeoutMs = 25000){
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const q = new URLSearchParams(params);
      q.set('callback', cb);
      q.set('_ts', Date.now().toString());
      const src = url + (url.includes('?') ? '&' : '?') + q.toString();
      const s = document.createElement('script');
      let done = false, tmr = null;
      function cleanup(){ if (tmr) clearTimeout(tmr); try{ delete window[cb]; }catch(_){ window[cb]=undefined; } if(s.parentNode) s.parentNode.removeChild(s); }
      window[cb] = (data)=>{ if(done) return; done = true; cleanup(); resolve(data); };
      s.onerror = ()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP load error')); };
      document.head.appendChild(s); s.src = src;
      tmr = setTimeout(()=>{ if(done) return; done = true; cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
    });
  }
  window._jsonp = jsonp;

  function authParams(){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    const tg = (window.Telegram && Telegram.WebApp) || null;
    const init = tg ? (tg.initData || '') : '';
    if (init) return { tg_init: init };
    if (C.API_KEY){ const p = { key: C.API_KEY }; if (C.DEV_ID) p.dev_id = C.DEV_ID; return p; }
    return {};
  }

  window.apiBootstrap = function(){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if (!C.GAS_WEBHOOK) return Promise.reject(new Error('GAS_WEBHOOK not set'));
    return jsonp(C.GAS_WEBHOOK, { mode:'bootstrap', ...authParams() })
      .then(j => { if(!j || !j.ok) throw new Error(j && j.error || 'bootstrap_failed'); return j.profile; });
  };
  window.apiEvent = function(type, data = {}){
    const C = window.APP_CONFIG || {};
    try{ if(scope && scope._selDate){ localStorage.setItem('last_booking', JSON.stringify({date: scope._selDate, time: scope._selTime||'', duration_min: scope._durMin||0})); } }catch(_){}

    if (!C.GAS_WEBHOOK) return Promise.reject(new Error('GAS_WEBHOOK not set'));
    let t = type || '';
    if (!t && 'date' in data && 'time' in data) t = 'consult_booking';
    if (!t && 'inviter' in data) t = 'ref_join';
    if (!t && Object.keys(data).length === 0) t = 'register_business';
    return jsonp(C.GAS_WEBHOOK, { mode:'event', type: t, data: JSON.stringify(data), ...authParams() })
      .then(j => { if(!j || !j.ok) throw new Error(j && j.error || 'event_failed'); return j; });
  };

  function qs(id){ return document.getElementById(id); }
  function bindBooking(){
    const btn = qs('consultSubmit') || qs('btnConsultSubmit');
    if (!btn) return;
    btn.addEventListener('click', async ()=>{
      try{
        const date = (qs('consultDate') && qs('consultDate').value) || '';
        const time = (qs('consultTime') && qs('consultTime').value) || '';
        const duration_min = Number((qs('consultDuration') && qs('consultDuration').value) || 30);
        const format = (qs('consultType') && qs('consultType').value) || 'call';
        const contact = (qs('contact') && qs('contact').value) || '';
        const res = await window.apiEvent('consult_booking', { date, time, duration_min, format, contact });
        console.log('[consult_booking]', res);
        (window.showToast && showToast('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞', '–ú—ã —Å –≤–∞–º–∏ —Å–≤—è–∂–µ–º—Å—è')) || alert('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞');
      }catch(e){
        console.error(e);
        (window.showToast && showToast('–û—à–∏–±–∫–∞', String(e.message||e))) || alert('–û—à–∏–±–∫–∞: ' + String(e.message||e));
      }
    });
  }
  document.addEventListener('DOMContentLoaded', bindBooking);

  console.log('[MiniApp core] ready');
})();
</script>
<!-- END: MiniApp core (clean) -->


<!-- === Profile Panel Enhancer: server profile + referrals === -->
<script>
(function(){
  // Helper
  function initials(name){
    const parts = (name||'').trim().split(/\s+/);
    const a = (parts[0]||'').charAt(0), b = (parts[1]||'').charAt(0);
    return (a+b||a||'?').toUpperCase();
  }
  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(_){ return null } }
  function localFallback(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: localStorage.getItem('last_booking')||null,
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }

  async function getProfile(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p;
        // light cache to keep legacy widgets
        try{
          localStorage.setItem('stat_points', String(p.points||0));
          localStorage.setItem('last_booking', p.last_booking||'');
          localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
          localStorage.setItem('referrals_count', String(p.referrals_count||0));
        }catch(_){}
        return p;
      }
    }catch(e){}
    return Object.assign({ method:'fallback' }, localFallback());
  }

  function renderProfileInto(panel, p){
    let user = tgUser();
    const name = [user?.first_name, user?.last_name].filter(Boolean).join(' ') || '–ì–æ—Å—Ç—å';
    const uname = user?.username ? '@'+user.username : '‚Äî';
    const points = p.points ?? 0;
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes[p.prizes.length-1].title || p.prizes[p.prizes.length-1].name || '‚Äî') : '‚Äî';
    const lastBooking = p.last_booking ? (function(x){ try{ return new Date(x).toLocaleString(); }catch(_){return x;} })(p.last_booking) : '–ù–µ—Ç';
    const refCount = p.referrals_count ?? 0;

    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--mint),var(--primary));display:grid;place-items:center;font-weight:800">${initials(name)}</div>
        <div><div style="font-weight:800">${name}</div><div style="opacity:.7;font-size:12px">${uname}</div></div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–û—á–∫–∏</div><div class="big">${points}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div class="big" style="font-size:14px">${lastPrize}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–ó–∞–ø–∏—Å—å</div><div class="big" style="font-size:14px">${lastBooking}</div></div>
        <div class="card" style="padding:10px"><div class="lead" style="font-size:12px;opacity:.7">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div class="big" style="font-size:14px">${refCount}</div></div>
      </div>

      <details style="margin-top:10px">
        <summary class="btn btn-ghost" style="display:inline-flex">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑—ã</summary>
        <ul id="prizeUL" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
      </details>

      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
        <button class="btn btn-ghost" id="profClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    `;
    // Fill prize list
    const ul = panel.querySelector('#prizeUL');
    if (ul && Array.isArray(p.prizes)){
      p.prizes.forEach(x=>{
        const li = document.createElement('li');
        li.textContent = (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x === 'string' ? x : JSON.stringify(x));
        li.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
        ul.appendChild(li);
      });
    }
    panel.querySelector('#profClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
    panel.style.display='block'; panel.style.maxHeight='70vh'; panel.style.width='min(420px,92vw)';
  }

  /* removed: legacy toggle hook block */


/* === Profile Panel: instant open + async hydrate + skeleton === */
<style>
  #consolePanel{ max-height: 78vh; overflow:auto; }
  .skel{ position:relative; background:rgba(255,255,255,.08); border-radius:12px; overflow:hidden; }
  .skel::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-100%);
    animation: skel 1.2s infinite;
  }
  @keyframes skel{ to { transform: translateX(100%); } }
</style>
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  // Cache helpers
  function cachePut(p){
    try{
      localStorage.setItem('stat_points', String(p.points||0));
      localStorage.setItem('last_booking', p.last_booking||'');
      localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
      localStorage.setItem('referrals_count', String(p.referrals_count||0));
    }catch(_){}
  }
  function cacheGet(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' –º–∏–Ω)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(),
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }

  // Skeleton HTML
  function skeleton(){
    return `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div class="skel" style="width:42px;height:42px;border-radius:12px"></div>
        <div style="flex:1">
          <div class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
          <div class="skel" style="height:12px;width:90px;border-radius:6px"></div>
        </div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card skel" style="height:54px"></div>
        <div class="card skel" style="height:54px"></div>
        <div class="card skel" style="height:54px"></div>
        <div class="card skel" style="height:54px"></div>
      </div>
      <div class="skel" style="height:38px;margin-top:10px;border-radius:10px"></div>
      <div class="cta" style="margin-top:10px;display:flex;gap:8px">
        <div class="skel" style="height:38px;width:140px;border-radius:10px"></div>
        <div class="skel" style="height:38px;width:100px;border-radius:10px"></div>
      </div>`;
  }

  // Patch existing openProfilePanel to show instantly with cache/skeleton
  (function patchOpen(){
    const prev = window.openProfilePanel;
    window.openProfilePanel = async function(){
      const panel = document.getElementById('consolePanel');
      if (!panel) return;
      // 1) instant open with cached data or skeleton
      panel.style.display = 'block';
      panel.innerHTML = skeleton();

      // 2) if cached profile exists, render it quickly (soft UI update)
      try{
        const pCached = window.__PROFILE || cacheGet();
        if (pCached && (pCached.points || (pCached.prizes||[]).length || pCached.last_booking || pCached.referrals_count)) {
          try { (prev && prev()); } catch(_){}
          // re-render using existing renderer if available
        }
      }catch(_){}

      // 3) fetch fresh profile in background and render via original implementation
      try{
        if (typeof window.apiBootstrap === 'function'){
          const p = await window.apiBootstrap();
          window.__PROFILE = p; cachePut(p);
        }
      }catch(_){}
      try { (prev && prev()); } catch(_){}
    };
  })();

  // Prefetch profile on startup to warm cache & Apps Script
  onReady(async function(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p; cachePut(p);
      }
    }catch(_){/* ignore */}
    // light ping endpoint if present
    try{
      const url = (window.APP_CONFIG && window.APP_CONFIG.GAS_WEBHOOK);
      if (url) {
        const s = document.createElement('script');
        const cb = 'cb_ping_' + Math.random().toString(36).slice(2);
        s.src = url + '?mode=ping&callback='+cb+'&_ts='+Date.now();
        window[cb] = function(){ try{ delete window[cb]; }catch(_){ } s.remove(); };
        document.head.appendChild(s);
      }
    }catch(_){}
  });
})();
</script>
<!-- === /instant profile panel patch === -->


<!-- === Profile Panel: smooth hydrate (micro-loaders + gradual text updates) === -->
<style>
  .skel { position:relative; background:rgba(255,255,255,.08); border-radius:8px; overflow:hidden; }
  .skel::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-100%);
    animation: skel 1.2s infinite;
  }
  @keyframes skel{ to { transform: translateX(100%); } }
  .metric { display:flex; flex-direction:column; gap:2px; }
  .metric .label { font-size:12px; opacity:.7 }
  .metric .value { font-weight:800 }
</style>
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function tgUser(){ try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(_){ return null } }
  function initials(name){ const p=(name||'').trim().split(/\s+/); const a=(p[0]||'').charAt(0), b=(p[1]||'').charAt(0); return (a+b||a||'?').toUpperCase(); }
  function cachePut(p){ try{ localStorage.setItem('stat_points', String(p.points||0)); localStorage.setItem('last_booking', p.last_booking||''); localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[])); localStorage.setItem('referrals_count', String(p.referrals_count||0)); }catch(_){ } }
  function cacheGet(){ return { points:+(localStorage.getItem('stat_points')||0), prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[], last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' –º–∏–Ω)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(), referrals_count:+(localStorage.getItem('referrals_count')||0) }; }
  function fmtDate(x){ try{ return x ? new Date(x).toLocaleString() : '–ù–µ—Ç'; }catch(_){ return x||'–ù–µ—Ç'; } }

  // Build minimal, controlled DOM for smooth updates
  function buildPanelShell(panel){
    const u = tgUser();
    const name = [u?.first_name, u?.last_name].filter(Boolean).join(' ') || '–ì–æ—Å—Ç—å';
    const uname = u?.username ? '@'+u.username : '‚Äî';
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div id="ppAvatar" class="skel" style="width:42px;height:42px;border-radius:12px;display:grid;place-items:center;font-weight:800"></div>
        <div style="flex:1">
          <div id="ppName" class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
          <div id="ppUname" class="skel" style="height:12px;width:90px;border-radius:6px"></div>
        </div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card metric" style="padding:10px"><div class="label">–û—á–∫–∏</div><div id="ppPoints" class="value skel" style="height:20px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div id="ppPrize" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">–ó–∞–ø–∏—Å—å</div><div id="ppBooking" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div id="ppRefs" class="value skel" style="height:16px;border-radius:6px"></div></div>
      </div>
      <details style="margin-top:10px">
        <summary class="btn btn-ghost" style="display:inline-flex">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑—ã</summary>
        <ul id="ppPrizeList" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
      </details>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
        <button class="btn btn-ghost" id="ppClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    `;
    // Fill avatar/name instantly (no shimmer after)
    const av = panel.querySelector('#ppAvatar');
    av.classList.remove('skel'); av.style.background = 'linear-gradient(135deg,var(--mint),var(--primary))';
    av.textContent = initials(name);
    const nm = panel.querySelector('#ppName'); nm.classList.remove('skel'); nm.textContent = name;
    const un = panel.querySelector('#ppUname'); un.classList.remove('skel'); un.textContent = uname;
    panel.querySelector('#ppClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
  }

  function setVal(el, text){ if(!el) return; el.classList.remove('skel'); el.textContent = text; }
  function hydrateFrom(p){
    const panel = document.getElementById('consolePanel');
    if (!panel) return;
    setVal(panel.querySelector('#ppPoints'), String(p.points ?? 0));
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes[p.prizes.length-1].title || p.prizes[p.prizes.length-1].name || '‚Äî') : '‚Äî';
    setVal(panel.querySelector('#ppPrize'), lastPrize);
    setVal(panel.querySelector('#ppBooking'), fmtDate(p.last_booking));
    try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}
    setVal(panel.querySelector('#ppRefs'), String(p.referrals_count ?? 0));

    // diff render prize list
    const ul = panel.querySelector('#ppPrizeList');
    if (ul){
      const wanted = (Array.isArray(p.prizes) ? p.prizes : []).map(x => (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x === 'string' ? x : JSON.stringify(x)));
      const current = Array.from(ul.children).map(li => li.textContent);
      // remove extra
      for (let i=current.length-1;i>=0;i--){ if (!wanted.includes(current[i])) ul.removeChild(ul.children[i]); }
      // add missing in order
      wanted.forEach((txt, idx)=>{
        if (!current.includes(txt)){
          const li = document.createElement('li');
          li.textContent = txt;
          li.style.cssText = 'padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
          ul.appendChild(li);
        }
      });
    }
  }

  // Override openProfilePanel to use shell + cache + async hydrate
  (function(){
    const prev = window.openProfilePanel;
    window.openProfilePanel = async function(){
      const panel = document.getElementById('consolePanel');
      if (!panel) return;
      panel.style.display = 'block';
      buildPanelShell(panel);

      // 1) show cached quickly
      const cached = window.__PROFILE || cacheGet();
      if (cached) hydrateFrom(cached);

      // 2) fetch fresh and hydrate
      try{
        if (typeof window.apiBootstrap === 'function'){
          const p = await window.apiBootstrap();
          window.__PROFILE = p; cachePut(p);
          hydrateFrom(p);
        }
      }catch(_){}

      // call previous if it exists (to keep any side effects/animations)
      try{ prev && prev(); }catch(_){}
    };
  })();

  // Preload profile to warm cache
  onReady(async function(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p; cachePut(p);
      }
    }catch(_){}
  });
})();
</script>
<!-- === /smooth hydrate === -->


<!-- === FAST PANEL JS (build once, toggle class, hydrate async) === -->
<script>
(function(){
  function onReady(f){ document.readyState!=='loading' ? f() : document.addEventListener('DOMContentLoaded', f); }
  function cachePut(p){
    try{
      localStorage.setItem('stat_points', String(p.points||0));
      localStorage.setItem('last_booking', p.last_booking||'');
      localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
      localStorage.setItem('referrals_count', String(p.referrals_count||0));
    }catch(_){}
  }
  function cacheGet(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' –º–∏–Ω)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(),
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }
  function initials(name){
    const p=(name||'').trim().split(/\s+/);
    const a=(p[0]||'').charAt(0), b=(p[1]||'').charAt(0);
    return (a+b||a||'?').toUpperCase();
  }
  function tgUser(){
    try{ return Telegram?.WebApp?.initDataUnsafe?.user || null }catch(_){ return null }
  }
  function fmtDate(x){ try{ return x ? new Date(x).toLocaleString() : '–ù–µ—Ç'; }catch(_){ return x||'–ù–µ—Ç'; } }
  function setVal(sel, txt){
    const el = document.querySelector(sel); if (!el) return;
    el.classList && el.classList.remove('skel');
    el.textContent = txt;
  }

  function buildShell(panel){
    const u = tgUser();
    const name = [u?.first_name, u?.last_name].filter(Boolean).join(' ') || '–ì–æ—Å—Ç—å';
    const uname = u?.username ? '@'+u.username : '‚Äî';
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <div id="ppAvatar" class="skel" style="width:42px;height:42px;border-radius:12px;display:grid;place-items:center;font-weight:800"></div>
        <div style="flex:1">
          <div id="ppName" class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
          <div id="ppUname" class="skel" style="height:12px;width:90px;border-radius:6px"></div>
        </div>
      </div>
      <div class="grid" style="gap:8px">
        <div class="card metric" style="padding:10px"><div class="label">–û—á–∫–∏</div><div id="ppPoints" class="value skel" style="height:20px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div id="ppPrize" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">–ó–∞–ø–∏—Å—å</div><div id="ppBooking" class="value skel" style="height:16px;border-radius:6px"></div></div>
        <div class="card metric" style="padding:10px"><div class="label">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div id="ppRefs" class="value skel" style="height:16px;border-radius:6px"></div></div>
      </div>
      <details style="margin-top:10px">
        <summary class="btn btn-ghost" style="display:inline-flex">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑—ã</summary>
        <ul id="ppPrizeList" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
      </details>
      <div class="cta" style="margin-top:10px">
        <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
        <button class="btn btn-ghost" id="ppClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    `;
    // avatar & name immediate
    const av = panel.querySelector('#ppAvatar');
    av && av.classList.remove('skel');
    if (av){ av.style.background='linear-gradient(135deg,var(--mint),var(--primary))'; av.textContent = initials(name); }
    setVal('#ppName', name); setVal('#ppUname', uname);
    panel.querySelector('#ppClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
  }

  function hydrate(p){
    const panel = document.getElementById('consolePanel'); if (!panel) return;
    setVal('#ppPoints', String(p.points ?? 0));
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes.at(-1).title || p.prizes.at(-1).name || '‚Äî') : '‚Äî';
    setVal('#ppPrize', lastPrize);
    try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}
    setVal('#ppBooking', fmtDate(p.last_booking));
    setVal('#ppRefs', String(p.referrals_count ?? 0));
    const ul = panel.querySelector('#ppPrizeList');
    if (ul){
      const wanted = (Array.isArray(p.prizes)?p.prizes:[]).map(x => (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x==='string'?x:JSON.stringify(x)));
      const cur = Array.from(ul.children).map(li=>li.textContent);
      for (let i=cur.length-1;i>=0;i--){ if(!wanted.includes(cur[i])) ul.removeChild(ul.children[i]); }
      wanted.forEach(txt=>{
        if(!cur.includes(txt)){
          const li=document.createElement('li');
          li.textContent=txt;
          li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
          ul.appendChild(li);
        }
      });
    }
  }

  async function refresh(){
    try{
      if (typeof window.apiBootstrap === 'function'){
        const p = await window.apiBootstrap();
        window.__PROFILE = p; cachePut(p); hydrate(p);
      }
    }catch(_){}
  }

  // Build shell once
  onReady(function(){
    const panel = document.getElementById('consolePanel');
    if (!panel) return;
    if (!panel.dataset.ready){ buildShell(panel); panel.dataset.ready='1'; }
  });

  // Toggle on click (capture) without reflow-heavy DOM rebuilds
  document.addEventListener('click', function(ev){
    const t = ev.target.closest && ev.target.closest('.console-toggle');
    if (!t) return;
    ev.preventDefault();
    const panel = document.getElementById('consolePanel'); if (!panel) return;
    const opening = !panel.classList.contains('open');
      if (opening) panel.style.display='block';

  panel.classList.toggle('open');
    if (opening){
      // hydrate from cache instantly
      try{
        const cached = window.__PROFILE || cacheGet();
        hydrate(cached);
      }catch(_){}
      // refresh async
      refresh();
    }
  }, true);

  // Warm cache on start
  onReady(refresh);
})();
</script>


<!-- === FAST OPEN v2: zero-wait toggle + staged hydrate + fetch throttle === -->
<script>
(function(){
  let __profileFetching = false;
  let __profileFetchedAt = 0;

  function cachePut(p){
    try{
      localStorage.setItem('stat_points', String(p.points||0));
      localStorage.setItem('last_booking', p.last_booking||'');
      localStorage.setItem('last_prizes', JSON.stringify(p.prizes||[]));
      localStorage.setItem('referrals_count', String(p.referrals_count||0));
    }catch(_){}
  }
  function cacheGet(){
    return {
      points: +(localStorage.getItem('stat_points')||0),
      prizes: JSON.parse(localStorage.getItem('last_prizes')||'[]')||[],
      last_booking: (function(){ try{ const lb=localStorage.getItem('last_booking')||''; if(lb.trim().startsWith('{')){ const o=JSON.parse(lb); return (o.date||'') + (o.time?(' '+o.time):'') + (o.duration_min?(' ('+o.duration_min+' –º–∏–Ω)'):''); } return lb||null; }catch(_){ return localStorage.getItem('last_booking')||null; } })(),
      referrals_count: +(localStorage.getItem('referrals_count')||0)
    };
  }
  function fmtDate(x){ try{ return x ? new Date(x).toLocaleString() : '–ù–µ—Ç'; }catch(_){ return x||'–ù–µ—Ç'; } }
  function setVal(sel, txt){
    const el = document.querySelector(sel); if (!el) return;
    el.classList && el.classList.remove('skel');
    if (el.textContent !== String(txt)) el.textContent = String(txt);
  }
  function hydrate(p){
    if (!p) return;
    const lastPrize = (Array.isArray(p.prizes) && p.prizes.length) ? (p.prizes.at(-1).title || p.prizes.at(-1).name || '‚Äî') : '‚Äî';
    setVal('#ppPoints', String(p.points ?? 0));
    try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}
    setVal('#ppPrize', lastPrize);
    setVal('#ppBooking', fmtDate(p.last_booking));
    setVal('#ppRefs', String(p.referrals_count ?? 0));

    const ul = document.querySelector('#ppPrizeList');
    if (ul){
      const wanted = (Array.isArray(p.prizes)?p.prizes:[]).map(x => (x && (x.title||x.name)) ? (x.title||x.name) : (typeof x==='string'?x:JSON.stringify(x)));
      const cur = Array.from(ul.children).map(li=>li.textContent);
      // minimal diff
      // remove extras
      for (let i=cur.length-1;i>=0;i--){ if(!wanted.includes(cur[i])) ul.removeChild(ul.children[i]); }
      // add missing
      const frag = document.createDocumentFragment();
      wanted.forEach(txt=>{
        if(!cur.includes(txt)){
          const li=document.createElement('li');
          li.textContent=txt;
          li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
          frag.appendChild(li);
        }
      });
      if (frag.children && frag.children.length) ul.appendChild(frag);
    }
  }

  async function refresh(force=false){
    if (typeof window.apiBootstrap !== 'function') return;
    const now = Date.now();
    if (!force && (__profileFetching || (now - __profileFetchedAt) < 4000)) return;
    __profileFetching = true;
    try{
      const p = await window.apiBootstrap();
      window.__PROFILE = p; cachePut(p); hydrate(p);
      __profileFetchedAt = Date.now();
    }catch(_){}
    finally{ __profileFetching = false; }
  }

  // Replace the click handler to guarantee instant open (no awaits before showing)
  (function installFastOpen(){
    // Ensure shell exists
    document.addEventListener('DOMContentLoaded', function(){
      const panel = document.getElementById('consolePanel');
      if (!panel || panel.dataset.ready) return;
      // If shell wasn't built, build a very thin shell (minimal cost)
      if (!panel.querySelector('#ppPoints')){
        panel.innerHTML = panel.innerHTML || `
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
            <div id="ppAvatar" class="skel" style="width:42px;height:42px;border-radius:12px;display:grid;place-items:center;font-weight:800"></div>
            <div style="flex:1">
              <div id="ppName" class="skel" style="height:14px;width:160px;border-radius:6px;margin-bottom:6px"></div>
              <div id="ppUname" class="skel" style="height:12px;width:90px;border-radius:6px"></div>
            </div>
          </div>
          <div class="grid" style="gap:8px">
            <div class="card metric" style="padding:10px"><div class="label">–û—á–∫–∏</div><div id="ppPoints" class="value skel" style="height:20px;border-radius:6px"></div></div>
            <div class="card metric" style="padding:10px"><div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑</div><div id="ppPrize" class="value skel" style="height:16px;border-radius:6px"></div></div>
            <div class="card metric" style="padding:10px"><div class="label">–ó–∞–ø–∏—Å—å</div><div id="ppBooking" class="value skel" style="height:16px;border-radius:6px"></div></div>
            <div class="card metric" style="padding:10px"><div class="label">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div id="ppRefs" class="value skel" style="height:16px;border-radius:6px"></div></div>
          </div>
          <details style="margin-top:10px">
            <summary class="btn btn-ghost" style="display:inline-flex">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑—ã</summary>
            <ul id="ppPrizeList" style="list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:6px"></ul>
          </details>
          <div class="cta" style="margin-top:10px">
            <a class="btn btn-primary" href="https://t.me/${(window.APP_CONFIG&&window.APP_CONFIG.TG_BOT_USERNAME)||'serge_kamensky_bot'}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
            <button class="btn btn-ghost" id="ppClose">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        `;
        const u = (Telegram&&Telegram.WebApp&&Telegram.WebApp.initDataUnsafe&&Telegram.WebApp.initDataUnsafe.user)||null;
        const name = [u?.first_name,u?.last_name].filter(Boolean).join(' ') || '–ì–æ—Å—Ç—å';
        const uname = u?.username ? '@'+u.username : '‚Äî';
        const av = panel.querySelector('#ppAvatar');
        if (av){ av.classList.remove('skel'); av.style.background='linear-gradient(135deg,var(--mint),var(--primary))'; av.textContent=(name[0]||'?')+(name.split(' ')[1]?.[0]||''); }
        setVal('#ppName', name); setVal('#ppUname', uname);
        panel.querySelector('#ppClose')?.addEventListener('click', ()=> panel.classList.remove('open'));
      }
      panel.dataset.ready = '1';
    });

    <!-- removed: legacy fast-open rAF handler (duplicate) -->


<script>(function(){ try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); __addBookingDatePrefixTo(document.querySelector('#p_record')); }catch(_){}})();</script>

<script>
(function(){
  if (window.__helpersInjected__) return; window.__helpersInjected__ = true;

  window.__confAt = function(el){
    try{
      var r = el.getBoundingClientRect();
      var x = (r.left + r.width/2) / window.innerWidth;
      var y = (r.top + r.height/2) / window.innerHeight;
      if (window.confetti) return confetti({ particleCount: 140, spread: 70, origin: {x:x,y:y} });
    }catch(e){}
    try{ if (typeof __conf === 'function') __conf(); }catch(_){}
  };

  window.__normalizePhoneRU = function(raw){
    var s = String(raw||'').replace(/[^\d+]/g,'');
    if (s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g,''); else s = s.replace(/\D/g,'');
    s = s.replace(/^\+/, '');
    if (s.length===11 && s[0]==='8') s = '7' + s.slice(1);
    if (s.length===10 && s[0]==='9') s = '7' + s;
    if (s.length===11 && (s[0]==='7')) return s;
    return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : (s.length===10&&s[0]==='9'?'7'+s:''));
  };

  window.__maskPhoneRU = function(v){
    var d = String(v||'').replace(/\D/g,'');
    if (d.startsWith('8')) d = '7'+d.slice(1);
    if (d.length===10 && d[0]==='9') d = '7'+d;
    if (!d.startsWith('7')) d = '7'+d.replace(/^7?/,'');
    var p = (d+'           ').slice(0,11); // pad soft
    return ('+'+p[0]+' '+p.slice(1,4)+' '+p.slice(4,7)+'-'+p.slice(7,9)+'-'+p.slice(9,11)).trim().replace(/\s+$/,'');
  };

  window.__ensureContactHint = function(input){
    try{
      var id='contactHint', hint=document.getElementById(id);
      if(!hint){
        hint=document.createElement('div'); hint.id=id;
        hint.style.opacity='.75'; hint.style.fontSize='12px'; hint.style.marginTop='4px';
        input.insertAdjacentElement('afterend', hint);
      }
      return hint;
    }catch(_){ return null; }
  };

  function __getBookingISODate(){
    try{
      var lb = localStorage.getItem('last_booking')||'';
      try{
        var obj = JSON.parse(lb);
        if (obj && obj.date) return String(obj.date);
      }catch(_){}
      var m = lb.match(/\b(\d{4}-\d{2}-\d{2})\b/);
      if (m) return m[1];
    }catch(_){}
    try{
      var bd = localStorage.getItem('booking_date') || (window.booking_date||'');
      var mm = bd.match(/\d{4}-\d{2}-\d{2}/);
      if (mm) return mm[0];
    }catch(_){}
    return '';
  }
  function __fmtDMY(iso){
    var m = (iso||'').match(/(\d{4})-(\d{2})-(\d{2})/);
    return m ? (m[3]+'.'+m[2]+'.'+m[1]) : '';
  }
  window.__addBookingDatePrefixTo = function(el){
    try{
      if(!el) return;
      var iso = __getBookingISODate(); if(!iso) return;
      var d = __fmtDMY(iso);
      var t = (el.textContent||'').trim();
      if (!t.startsWith(d)) el.textContent = (d+' '+t).trim();
    }catch(_){}
  };

  window.__postGAS = async function(payload){
    try{
      var t = payload.type || 'event';
      if (window.apiEvent && typeof window.apiEvent === 'function'){
        return await window.apiEvent(t, payload);
      }
      var C = window.APP_CONFIG || {};
      if (C.GAS_WEBHOOK){
        return await fetch(C.GAS_WEBHOOK, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        }).catch(function(){});
      }
    }catch(_){}
  };
})();
</script>

<script>
(function(){

  // Spin: single source of truth
  try{
    var spinBtn = document.getElementById('spin');
    var spinOut = document.getElementById('spinRes');
    if (spinBtn && spinOut){
      spinBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

        var PRIZES = ['üéÅ –®–∞–±–ª–æ–Ω ¬´–û—Ñ—Ñ–µ—Ä¬ª','üìò –ß–µ–∫-–ª–∏—Å—Ç –∞—É–¥–∏—Ç–∞','üí¨ +30 –º–∏–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏','üßÆ –î–æ—Å—Ç—É–ø –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É PRO','‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä'];
        var win = PRIZES[Math.floor(Math.random()*PRIZES.length)];
        spinOut.textContent = '–í—ã–ø–∞–ª–æ: ' + win;

        try{ __confAt(spinBtn); }catch(_){}

        try{
          var arr = [];
          try{ arr = JSON.parse(localStorage.getItem('last_prizes')||'[]') }catch(_){}
          arr.push(win);
          localStorage.setItem('last_prizes', JSON.stringify(arr.slice(-1))); // —Ö—Ä–∞–Ω–∏–º 1 –ø–æ—Å–ª–µ–¥–Ω–∏–π
          localStorage.setItem('stat_prizes', String((+localStorage.getItem('stat_prizes')||0)+1));
          localStorage.setItem('stat_points', String((+localStorage.getItem('stat_points')||0)+10));
        }catch(_){}

        try{
          var ul = document.getElementById('ppPrizeList');
          if (ul){
            ul.innerHTML = '';
            var li = document.createElement('li');
            li.textContent = win;
            li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
            ul.appendChild(li);
          }
          var pp = document.getElementById('ppPrize'); if (pp) pp.textContent = win;

          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { prizes: ((window.__PROFILE&&window.__PROFILE.prizes)||[]).concat([{title:win}]).slice(-10) });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        }catch(_){}

        try{
          var prizes = [];
          try{ prizes = JSON.parse(localStorage.getItem('last_prizes')||'[]') }catch(_){}
          var payload = { type:'community_prize', prize: win, prizes_json: prizes, uid: (window.__uid && __uid()) || '' };
          __postGAS && __postGAS(payload);
        }catch(_){}
      }, {capture:true});
    }
  }catch(_){}

  // Contact input: mask while typing
  try{
    var contact = document.querySelector('#contact');
    if (contact){
      function setHint(state){
        var hint = (window.__ensureContactHint && __ensureContactHint(contact)) || null;
        if(!hint) return;
        hint.style.padding='6px 8px'; hint.style.borderRadius='8px'; hint.style.border='1px solid rgba(255,255,255,.10)';
        hint.style.background='rgba(255,255,255,.04)'; hint.style.fontWeight='600';
        if(state==='empty'){ hint.textContent='–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä'; hint.style.color='#ffd95a'; }
        else if(state==='ok'){ hint.textContent='–ù–æ–º–µ—Ä –≤–≤–µ–¥—ë–Ω –≤–µ—Ä–Ω–æ'; hint.style.color='#7CFFA7'; }
        else if(state==='bad'){ hint.textContent='–ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä: +7 999 123-45-67)'; hint.style.color='#ffd95a'; }
        else if(state==='sent'){ hint.textContent='–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'; hint.style.color='#7CFFA7'; }
      }
      setHint('empty');
      contact.addEventListener('input', function(){
        var raw = this.value;
        raw = raw.replace(/[^\d+]/g, '');
        if (raw.startsWith('+')) raw = '+' + raw.slice(1).replace(/\D/g,''); else raw = raw.replace(/\D/g,'');
        raw = raw.replace(/(?!^)\+/g, '');
        var norm = raw.replace(/^\+/, '');
        if (!norm.length){
          this.value=''; this.dataset.norm=''; this.classList.remove('ok','attn'); setHint('empty'); return;
        }
        if (norm.length===11 && norm[0]==='8') norm = '7'+norm.slice(1);
        else if (norm.length===10 && norm[0]==='9') norm = '7'+norm;
        try{ this.value = (window.__maskPhoneRU ? __maskPhoneRU(norm) : raw); }catch(e){ this.value = raw; }
        this.dataset.norm = norm;
        this.classList.remove('attn');
        if(norm.length===11 && norm[0]==='7'){ this.classList.add('ok'); setHint('ok'); }
        else { this.classList.remove('ok'); setHint('empty'); }
      }, {capture:true});
    }
  }catch(_){}

  // Confirm consult

  try{
    var confBtn = document.getElementById('confirmConsult');
    if (confBtn){
      confBtn.addEventListener('click', async function(){
        var input = document.getElementById('contact');
        var valRaw = (input && input.value || '').trim();
        var norm = (input && input.dataset && input.dataset.norm) ? input.dataset.norm : (__normalizePhoneRU ? __normalizePhoneRU(valRaw) : valRaw);

        try{ __confAt(confBtn); }catch(_){}

        if (!norm || (norm.length!==11)){
          if (input){ input.classList.add('attn'); input.focus({preventScroll:true}); var hint=__ensureContactHint(input); if(hint) hint.textContent='–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä. –ü—Ä–∏–º–µ—Ä: +7 999 123-45-67'; }
          (window.__haptic||function(){})('medium');
          return;
        } else {
          try{ if (input) input.value = '+'+norm; input.classList.add('ok'); }catch(_){}
        }

        var selDate = (window.scope && scope._selDate) || (window.__lastDate) || '';
        var selTime = (window.scope && scope._selTime) || (window.__lastTime) || '';
        var durMin  = (window.scope && scope._durMin)  || (window.__lastDur)  || 30;

        var human = '';
        try{
          var obj = { date: selDate, time: selTime, duration_min: durMin };
          localStorage.setItem('last_booking', JSON.stringify(obj));
          human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' –º–∏–Ω)'):'');
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { last_booking: human });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
          try{ __addBookingDatePrefixTo(document.querySelector('#ppBooking')); }catch(_){}
        }catch(_){}

        try{
          var payload = { type:'consult_booking', contact: '+'+norm, date: selDate, time: selTime, duration_min: durMin, last_booking: human, uid: (window.__uid && __uid()) || '' };
          __postGAS && __postGAS(payload);
        }catch(_){}
      }, {capture:true});
    }
  }catch(_){}

  try{
    setTimeout(function(){
      __addBookingDatePrefixTo && __addBookingDatePrefixTo(document.querySelector('#ppBooking'));
      __addBookingDatePrefixTo && __addBookingDatePrefixTo(document.querySelector('#p_record'));
    }, 200);
  }catch(_){}

})();
</script>
<script>(function(){ if(window.__helpers2) return; window.__helpers2=true;
window.__confAt = window.__confAt || function(el){
  try{
    if(!el) return;
    var r = el.getBoundingClientRect();
    var x = (r.left + r.width/2) / window.innerWidth;
    var y = (r.top + r.height/2) / window.innerHeight;
    if (window.confetti) return confetti({ particleCount: 140, spread: 70, origin: {x:x,y:y} });
  }catch(e){}
  try{ if (typeof __conf === 'function') __conf(); }catch(_){}
};
window.__normalizePhoneRU = window.__normalizePhoneRU || function(raw){
  var s = String(raw||'').replace(/[^\d+]/g,'');
  if (s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g,''); else s = s.replace(/\D/g,'');
  s = s.replace(/^\+/, '');
  if (s.length===11 && s[0]==='8') s = '7' + s.slice(1);
  if (s.length===10 && s[0]==='9') s = '7' + s;
  if (s.length===11 && s[0]==='7') return s;
  return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : (s.length===10&&s[0]==='9'?'7'+s:''));
};
window.__maskPhoneRU = window.__maskPhoneRU || function(v){
  var d = String(v||'').replace(/\D/g,'');
  if (d.startsWith('8')) d = '7'+d.slice(1);
  if (d.length===10 && d[0]==='9') d = '7'+d;
  if (!d.startsWith('7')) d = '7'+d.replace(/^7?/,'');
  var p = (d+'           ').slice(0,11);
  return ('+'+p[0]+' '+p.slice(1,4)+' '+p.slice(4,7)+'-'+p.slice(7,9)+'-'+p.slice(9,11)).trim().replace(/\s+$/,'');
};
window.__ensureContactHint = window.__ensureContactHint || function(input){
  try{
    var id='contactHint', hint=document.getElementById(id);
    if(!hint){
      hint=document.createElement('div'); hint.id=id;
      hint.style.opacity='.85'; hint.style.fontSize='12px'; hint.style.marginTop='4px';
      input.insertAdjacentElement('afterend', hint);
    }
    return hint;
  }catch(_){ return null; }
};
window.__postGAS = window.__postGAS || (async function(payload){
  try{
    var t = payload.type || 'event';
    if (window.apiEvent && typeof window.apiEvent === 'function') return await window.apiEvent(t, payload);
    var C = window.APP_CONFIG || {};
    if (C.GAS_WEBHOOK){
      return await fetch(C.GAS_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    }
  }catch(_){}
});
function __getBookingISODate(){
  try{
    var lb = localStorage.getItem('last_booking')||'';
    try{ var obj = JSON.parse(lb); if (obj && obj.date) return String(obj.date); }catch(_){}
    var m = lb.match(/\b(\d{4}-\d{2}-\d{2})\b/); if (m) return m[1];
  }catch(_){}
  try{
    var bd = localStorage.getItem('booking_date') || (window.booking_date||'');
    var mm = bd.match(/\d{4}-\d{2}-\d{2}/); if (mm) return mm[0];
  }catch(_){}
  return '';
}
function __fmtDMY(iso){ var m=(iso||'').match(/(\d{4})-(\d{2})-(\d{2})/); return m ? (m[3]+'.'+m[2]+'.'+m[1]) : ''; }
window.__addBookingDatePrefixTo = window.__addBookingDatePrefixTo || function(el){
  try{ if(!el) return; var iso = __getBookingISODate(); if(!iso) return;
    var d = __fmtDMY(iso); var t = (el.textContent||'').trim();
    if (!t.startsWith(d)) el.textContent = (d+' '+t).trim();
  }catch(_){}
};
})();</script>
<script>(function(){
  const input = document.getElementById('contact');
  if(!input) return;
  function setHint(state){
    const hint = (window.__ensureContactHint && __ensureContactHint(input)) || null;
    if(!hint) return;
    hint.style.padding = '6px 8px';
    hint.style.borderRadius = '8px';
    hint.style.border = '1px solid rgba(255,255,255,.10)';
    hint.style.background = 'rgba(255,255,255,.04)';
    hint.style.fontWeight = '600';
    if(state==='empty'){ hint.textContent='–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä'; hint.style.color='#ffd95a'; }
    else if(state==='ok'){ hint.textContent='–ù–æ–º–µ—Ä –≤–≤–µ–¥—ë–Ω –≤–µ—Ä–Ω–æ'; hint.style.color='#7CFFA7'; }
    else if(state==='sent'){ hint.textContent='–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'; hint.style.color='#7CFFA7'; }
    else if(state==='bad'){ hint.textContent='–ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä: +7 999 123-45-67)'; hint.style.color='#ffd95a'; }
  }
  setHint('empty');
  input.addEventListener('input', function(){
    let raw = this.value;
    raw = raw.replace(/[^\d+]/g, '');
    if (raw.startsWith('+')) raw = '+' + raw.slice(1).replace(/\D/g,''); else raw = raw.replace(/\D/g,'');
    raw = raw.replace(/(?!^)\+/g, '');
    let norm = raw.replace(/^\+/, '');
    if (norm.length===11 && norm[0]==='8') norm = '7'+norm.slice(1);
    else if (norm.length===10 && norm[0]==='9') norm = '7'+norm;
    try{ this.value = (window.__maskPhoneRU ? __maskPhoneRU(norm||raw) : raw); }catch(e){ this.value = raw; }
    this.dataset.norm = norm;
    this.classList.remove('attn');
    if(norm && norm.length===11 && norm[0]==='7'){ this.classList.add('ok'); setHint('ok'); }
    else { this.classList.remove('ok'); setHint('empty'); }
  }, {capture:true});
  const btn = document.getElementById('confirmConsult');
  if(btn){
    btn.addEventListener('click', async function(){
      const norm = input.dataset.norm ? input.dataset.norm : (window.__normalizePhoneRU ? __normalizePhoneRU(input.value) : '');
      try{ window.__confAt && __confAt(btn); }catch(_){}
      if(!norm || norm.length!==11){
        input.classList.add('attn');
        input.focus({preventScroll:true});
        setHint('bad');
        (window.__haptic||function(){})('medium');
        return;
      }else{
        try{ input.value = '+'+norm; input.classList.add('ok'); setHint('ok'); }catch(_){}
      }
      const selDate = (window.scope && scope._selDate) || (window.__lastDate) || '';
      const selTime = (window.scope && scope._selTime) || (window.__lastTime) || '';
      const durMin  = (window.scope && scope._durMin)  || (window.__lastDur)  || 30;
      try{
        const obj = { date: selDate, time: selTime, duration_min: durMin };
        localStorage.setItem('last_booking', JSON.stringify(obj));
        const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' –º–∏–Ω)'):'') ;
        window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { last_booking: human });
        window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        try{ window.__addBookingDatePrefixTo && __addBookingDatePrefixTo(document.querySelector('#ppBooking')); }catch(_){}
      }catch(_){}
      try{
        const obj = JSON.parse(localStorage.getItem('last_booking')||'{}');
        const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' –º–∏–Ω)'):'') ;
        const payload = { type:'consult_booking', contact:'+'+norm, date: obj.date||'', time: obj.time||'', duration_min: obj.duration_min||0, last_booking: human, uid: (window.__uid&&__uid())||'' };
        window.__postGAS && __postGAS(payload);
        setHint('sent');
      }catch(_){}
    }, {capture:true});
  }
})();</script>

<script>
(function(){
  window.__boom = function(x, y){
    try{
      const c = document.createElement('canvas');
      c.width = innerWidth; c.height = innerHeight;
      Object.assign(c.style,{position:'fixed',left:0,top:0,pointerEvents:'none',zIndex:999});
      document.body.appendChild(c);
      const ctx = c.getContext('2d'); const N=140, P=[];
      for(let i=0;i<N;i++){
        P.push({ x,y, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2, g:0.22+Math.random()*0.18, s:4+Math.random()*5, r:Math.random()*Math.PI, col:`hsl(${Math.random()*360},90%,60%)` });
      }
      let t=0;
      (function tick(){
        ctx.clearRect(0,0,c.width,c.height);
        P.forEach(p=>{ p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=0.08;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r); ctx.fillStyle=p.col; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
        });
        t++; if (t<180) requestAnimationFrame(tick); else c.remove();
      })();
    }catch(_){}
  };
  window.__conf = function(){
    try{ if (window.confetti) return confetti({particleCount:140, spread:70}); }catch(_){}
    try{ window.__boom(innerWidth/2, innerHeight*0.33); }catch(_){}
  };
  window.__confAt = function(el){
    try{
      if(!el) return window.__conf();
      const r = el.getBoundingClientRect();
      const x = (r.left + r.width/2);
      const y = (r.top + r.height/2);
      if (window.confetti) return confetti({particleCount:140, spread:70, origin:{ x:x/innerWidth, y:y/innerHeight }});
      return window.__boom(x,y);
    }catch(_){ try{ window.__conf(); }catch(__){} }
  };
})();
</script>


<!-- === app-patch: confetti, phone mask, spin wheel, booking hydrate (guarded) === -->
<script>
(function(){
  if (window.__APP_PATCH_V2__) return; window.__APP_PATCH_V2__ = true;

  window.__boom = window.__boom || function(x, y){
    try{
      const c = document.createElement('canvas');
      c.width = innerWidth; c.height = innerHeight;
      Object.assign(c.style, { position:'fixed', left:0, top:0, pointerEvents:'none', zIndex: 9999 });
      document.body.appendChild(c);
      const ctx = c.getContext('2d'), N=140, P=[];
      for(let i=0;i<N;i++){
        P.push({ x,y, vx:(Math.random()-0.5)*6, vy:Math.random()*-6-2, g:0.22+Math.random()*0.18, s:4+Math.random()*5, r:Math.random()*Math.PI, col:`hsl(${Math.random()*360},90%,60%)` });
      }
      let t=0; (function tick(){
        ctx.clearRect(0,0,c.width,c.height);
        for(const p of P){
          p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=0.08;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r); ctx.fillStyle=p.col; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
        }
        if (++t<180) requestAnimationFrame(tick); else c.remove();
      })();
    }catch(_){}
  };
  window.__conf = window.__conf || function(){
    try{ if (window.confetti) return confetti({ particleCount:140, spread:70 }); }catch(_){}
    try{ window.__boom(innerWidth/2, innerHeight*0.33); }catch(_){}
  };
  window.__confAt = window.__confAt || function(el){
    try{
      if(!el) return window.__conf();
      const r = el.getBoundingClientRect();
      const x = r.left + r.width/2, y = r.top + r.height/2;
      if (window.confetti) return confetti({ particleCount:140, spread:70, origin:{ x:x/innerWidth, y:y/innerHeight } });
      return window.__boom(x,y);
    }catch(_){ try{ window.__conf(); }catch(__){} }
  };

  window.__postGAS = window.__postGAS || (async function(payload){
    try{
      if (window.apiEvent && typeof window.apiEvent === 'function'){
        return await window.apiEvent(payload.type || 'event', payload);
      }
      const C = window.APP_CONFIG || {};
      if (C.GAS_WEBHOOK){
        return await fetch(C.GAS_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      }
    }catch(_){}
  });

  function __uid(){
    try{
      return (window.__PROFILE && (__PROFILE.tg_id||__PROFILE.id))
         || (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id)
         || '';
    }catch(_){ return ''; }
  }
  function fmtLeft(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
    return (h? h+'—á ' : '') + (m? m+'–º ' : '') + ss+'—Å';
  }

  window.__normalizePhoneRU = window.__normalizePhoneRU || function(raw){
    let s = String(raw||'').replace(/[^\d+]/g,'');
    if (s.startsWith('+')) s = '+' + s.slice(1).replace(/\D/g,''); else s = s.replace(/\D/g,'');
    s = s.replace(/^\+/, '');
    if (s.length===11 && s[0]==='8') s = '7' + s.slice(1);
    if (s.length===10 && s[0]==='9') s = '7' + s;
    if (s.length===11 && s[0]==='7') return s;
    return (s.length===11 ? (s[0]==='7'?s : (s[0]==='8'?'7'+s.slice(1):'')) : (s.length===10&&s[0]==='9'?'7'+s:''));
  };
  window.__maskPhoneRU = window.__maskPhoneRU || function(v){
    let d = String(v||'').replace(/\D/g,'');
    if (d.startsWith('8')) d = '7'+d.slice(1);
    if (d.length===10 && d[0]==='9') d = '7'+d;
    if (!d.startsWith('7')) d = '7'+d.replace(/^7?/,'');
    const p = (d+'           ').slice(0,11);
    return ('+'+p[0]+' '+p.slice(1,4)+' '+p.slice(4,7)+'-'+p.slice(7,9)+'-'+p.slice(9,11)).trim().replace(/\s+$/,'');
  };
  window.__ensureContactHint = window.__ensureContactHint || function(input){
    try{
      let hint = document.getElementById('contactHint');
      if (!hint){
        hint = document.createElement('div');
        hint.id = 'contactHint';
        hint.style.cssText = 'opacity:.9;font-size:12px;margin-top:4px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-weight:600;';
        input.insertAdjacentElement('afterend', hint);
      }
      return hint;
    }catch(_){ return null; }
  };

  function replaceWithClone(el){ if(!el) return el; const cl = el.cloneNode(true); el.replaceWith(cl); return cl; }

  (function(){ // SPIN
    const btn0 = document.getElementById('spin');
    const out  = document.getElementById('spinRes');
    if (!btn0 || !out) return;
    const btn = replaceWithClone(btn0);

    const uid = String(__uid()||'anon');
    const KEY = 'spin_next_at_'+uid;
    const COOLDOWN = 24*60*60*1000;

    function updateBtn(){
      const now = Date.now();
      const next = Number(localStorage.getItem(KEY)||0);
      if (next>now){ btn.disabled = true; btn.textContent = '–ö—Ä—É—Ç–∏—Ç—å —á–µ—Ä–µ–∑ ' + fmtLeft(next-now); }
      else { btn.disabled = false; btn.textContent = '–ö—Ä—É—Ç–∏—Ç—å üé°'; }
    }
    updateBtn(); let tmr = setInterval(updateBtn, 1000);

    btn.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      const now = Date.now(); const next = Number(localStorage.getItem(KEY)||0);
      if (next>now){ updateBtn(); return; }
      const prizes = ['üéÅ –®–∞–±–ª–æ–Ω ¬´–û—Ñ—Ñ–µ—Ä¬ª','üìò –ß–µ–∫-–ª–∏—Å—Ç –∞—É–¥–∏—Ç–∞','üí¨ +30 –º–∏–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏','üßÆ –î–æ—Å—Ç—É–ø –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É PRO','‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä'];
      let ticks=0; btn.disabled = true;
      const spinInt = setInterval(()=>{ out.textContent = '–ö—Ä—É—Ç–∏–º‚Ä¶ ' + '‚ü≤'.repeat((ticks%4)+1); ticks++; }, 80);
      setTimeout(()=>{
        clearInterval(spinInt);
        const win = prizes[Math.floor(Math.random()*prizes.length)];
        out.textContent = '–í—ã–ø–∞–ª–æ: ' + win;
        try{ __confAt(btn); }catch(_){}
        try{ localStorage.setItem('last_prizes', JSON.stringify([win])); }catch(_){}
        try{
          const ul = document.getElementById('ppPrizeList');
          if (ul){ ul.innerHTML=''; const li=document.createElement('li'); li.textContent=win; li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)'; ul.appendChild(li); }
          const pp = document.getElementById('ppPrize'); if (pp) pp.textContent = win;
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { prizes: ((window.__PROFILE&&window.__PROFILE.prizes)||[]).concat([{title:win}]).slice(-10) });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
        }catch(_){}
        try{
          const until = Date.now()+COOLDOWN;
          localStorage.setItem(KEY, String(until));
        }catch(_){}
        updateBtn();
        try{
          const payload = { type:'community_prize', prize: win, prizes_json: JSON.parse(localStorage.getItem('last_prizes')||'[]'), spin_next_at: new Date(Number(localStorage.getItem(KEY)||0)).toISOString(), uid: uid };
          window.__postGAS && __postGAS(payload);
        }catch(_){}
      }, 1400);
    }, {capture:true});
  })();

  (function(){ // CONTACT
    const input0 = document.getElementById('contact');
    const btn0   = document.getElementById('confirmConsult');
    if (!input0 && !btn0) return;
    const input = input0 ? replaceWithClone(input0) : null;
    const btn   = btn0   ? replaceWithClone(btn0)   : null;

    function setHint(state){
      const hint = window.__ensureContactHint && __ensureContactHint(input);
      if (!hint) return;
      if (state==='empty'){ hint.textContent='–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä'; hint.style.color='#ffd95a'; }
      else if (state==='ok'){ hint.textContent='–ù–æ–º–µ—Ä –≤–≤–µ–¥—ë–Ω –≤–µ—Ä–Ω–æ'; hint.style.color='#7CFFA7'; }
      else if (state==='bad'){ hint.textContent='–ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä: +7 999 123-45-67)'; hint.style.color='#ffd95a'; }
      else if (state==='sent'){ hint.textContent='–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'; hint.style.color='#7CFFA7'; }
    }

    if (input){
      setHint('empty');
      input.addEventListener('input', function(){
        let raw = this.value;
        raw = raw.replace(/[^\d+]/g,'');
        if (raw.startsWith('+')) raw = '+' + raw.slice(1).replace(/\D/g,''); else raw = raw.replace(/\D/g,'');
        raw = raw.replace(/(?!^)\+/g, '');
        let norm = raw.replace(/^\+/, '');
        if (!norm.length){ this.value=''; this.dataset.norm=''; this.classList.remove('ok','attn'); setHint('empty'); return; }
        if (norm.length===11 && norm[0]==='8') norm = '7'+norm.slice(1);
        else if (norm.length===10 && norm[0]==='9') norm = '7'+norm;
        try{ this.value = (window.__maskPhoneRU ? __maskPhoneRU(norm) : raw); }catch(e){ this.value = raw; }
        this.dataset.norm = norm;
        this.classList.remove('attn');
        if (norm.length===11 && norm[0]==='7'){ this.classList.add('ok'); setHint('ok'); }
        else { this.classList.remove('ok'); setHint('empty'); }
      }, {capture:true});
    }

    if (btn){
      btn.addEventListener('click', function(){
        const norm = (input && input.dataset && input.dataset.norm) ? input.dataset.norm : (window.__normalizePhoneRU ? __normalizePhoneRU(input.value) : '');
        if (!norm || norm.length!==11){
          input && input.classList.add('attn');
          input && input.focus({preventScroll:true});
          setHint('bad');
          return;
        }
        try{ __confAt(btn); }catch(_){}
        try{ if (input){ input.value = '+'+norm; input.classList.add('ok'); setHint('ok'); } }catch(_){}
        const selDate = (window.scope && scope._selDate) || (window.__lastDate) || '';
        const selTime = (window.scope && scope._selTime) || (window.__lastTime) || '';
        const durMin  = (window.scope && scope._durMin)  || (window.__lastDur)  || 30;
        try{
          const obj = { date: selDate, time: selTime, duration_min: durMin };
          localStorage.setItem('last_booking', JSON.stringify(obj));
          const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' –º–∏–Ω)'):'') ;
          window.__PROFILE = Object.assign({}, window.__PROFILE||{}, { last_booking: human });
          window.__profileHydrate__ && window.__profileHydrate__.hydrate(window.__PROFILE);
          const dmy = (function(iso){ const m=(iso||'').match(/(\d{4})-(\d{2})-(\d{2})/); return m ? (m[3]+'.'+m[2]+'.'+m[1]) : ''; })(obj.date||'');
          [document.querySelector('#ppBooking'), document.querySelector('#p_record')].forEach(el=>{
            if (!el) return;
            const t = (el.textContent||'').trim();
            if (dmy && !t.startsWith(dmy)) el.textContent = (dmy + ' ' + t).trim();
          });
        }catch(_){}
        try{
          const obj = JSON.parse(localStorage.getItem('last_booking')||'{}');
          const human = (obj.date||'') + (obj.time?(' '+obj.time):'') + (obj.duration_min?(' ('+obj.duration_min+' –º–∏–Ω)'):'') ;
          const payload = { type:'consult_booking', contact:'+'+norm, date: obj.date||'', time: obj.time||'', duration_min: obj.duration_min||0, last_booking: human, uid: __uid()||'' };
          window.__postGAS && __postGAS(payload);
          setHint('sent');
        }catch(_){}
      }, {capture:true});
    }
  })();

  (function(){ // On open: prefix date + render last prize
    try{
      const lb = localStorage.getItem('last_booking')||'';
      let dmy='';
      if (lb && lb.trim().startsWith('{')){
        const o = JSON.parse(lb);
        const m = (o.date||'').match(/(\d{4})-(\d{2})-(\d{2})/);
        if (m) dmy = m[3]+'.'+m[2]+'.'+m[1];
      } else if (lb){
        const m = lb.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (m) dmy = m[3]+'.'+m[2]+'.'+m[1];
      }
      if (dmy){
        [document.querySelector('#ppBooking'), document.querySelector('#p_record')].forEach(el=>{
          if (!el) return;
          const t = (el.textContent||'').trim();
          if (!t.startsWith(dmy)) el.textContent = (dmy + ' ' + t).trim();
        });
      }
    }catch(_){}
    try{
      const arr = JSON.parse(localStorage.getItem('last_prizes')||'[]');
      const last = arr && arr[0];
      const ul = document.getElementById('ppPrizeList');
      if (ul && last){
        ul.innerHTML='';
        const li=document.createElement('li'); li.textContent=last;
        li.style.cssText='padding:6px 8px;border:1px solid rgba(255,255,255,.14);border-radius:8px;background:rgba(255,255,255,.04)';
        ul.appendChild(li);
      }
    }catch(_){}
  })();

})();
</script>
<!-- === /app-patch === -->


<script>
(function(){
  if (window.__BOOKING_BRIDGE_V2__) return; window.__BOOKING_BRIDGE_V2__ = true;

  function dd2(n){ return String(n).padStart(2,'0'); }
  var RU = ['—è–Ω–≤–∞—Ä','—Ñ–µ–≤—Ä–∞–ª','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä','–æ–∫—Ç—è–±—Ä','–Ω–æ—è–±—Ä','–¥–µ–∫–∞–±—Ä'];

  function pickDateFromCalendar(){
    try{
      var head = document.querySelector('#cal .cal-head .mon') || document.querySelector('#cal .mon');
      var sel  = document.querySelector('#cal .cal-cell.sel');
      if (!head || !sel) return '';
      var t = (head.textContent||'').toLowerCase();
      var y = (t.match(/\d{4}/)||[])[0] || new Date().getFullYear();
      var stem = RU.findIndex(s => t.includes(s));
      var m = stem>=0 ? dd2(stem+1) : dd2(new Date().getMonth()+1);
      var d = parseInt((sel.dataset.day || sel.textContent || '').replace(/\D+/g,''),10);
      if (!d) return '';
      var iso = y + '-' + m + '-' + dd2(d);
      sel.dataset.date = sel.dataset.date || iso;
      return iso;
    }catch(_){ return ''; }
  }

  function pickTimeFromSlots(){
    try{
      var btn = document.querySelector('#slots .btn.btn-primary, #slots .btn.active, #slots button[aria-pressed="true"]');
      var raw = (btn && (btn.dataset.time || btn.textContent)) || '';
      var m = String(raw).match(/\b\d{2}:\d{2}\b/);
      return m ? m[0] : '';
    }catch(_){ return ''; }
  }

  function getSelectedFormat(){
    try{
      if (window.scope && (scope._format || scope.format)) return (scope._format || scope.format);
      if (window.SEL && SEL.type) return SEL.type;
      var b = document.querySelector('.consult-type.btn-primary, .consult-type.active, .consult-type[aria-pressed="true"]');
      return (b && b.dataset && b.dataset.type) || '';
    }catch(_){ return ''; }
  }

  function getSelectedBooking(){
    var date = '', time = '', dur = 30;
    try{ date = (window.scope && (scope._selDate || scope.selDate)) || ''; }catch(_){}
    try{ time = (window.scope && (scope._selTime || scope.selTime)) || ''; }catch(_){}
    try{ dur  = (window.scope && (scope._durMin  || scope.durMin))  || 30; }catch(_){}

    if (!date || !time){
      try{
        var s = JSON.parse(localStorage.getItem('consult_selected')||'{}');
        if (!date && s.date) date = s.date;
        if (!time && s.time) time = s.time;
      }catch(_){}
    }

    if (!date){
      var dp = document.getElementById('datePick');
      if (dp && dp.value) { date = new Date(dp.value).toISOString().slice(0,10); }
      if (!date) { date = pickDateFromCalendar(); }
    }
    if (!time) time = pickTimeFromSlots();

    try{
      var dBtn = document.querySelector('.dur.btn-primary, .dur.active');
      if (dBtn && dBtn.dataset.min) dur = parseInt(dBtn.dataset.min,10)||dur;
    }catch(_){}

    return { date: date||'', time: time||'', duration_min: dur||30 };
  }

  window.getSelectedBooking = window.getSelectedBooking || getSelectedBooking;

  function attachTgInit(payload){
    try{
      if (!payload.tg_init && window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) {
        payload.tg_init = Telegram.WebApp.initData;
      }
    }catch(_){}
    return payload;
  }

  (function(){
    var prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      data = data || {};
      try{
        if (type==='consult_booking' || (data && data.type==='consult_booking')) {
          var pick = getSelectedBooking();
          if (!data.date) data.date = pick.date;
          if (!data.time) data.time = pick.time;
          if (!data.duration_min) data.duration_min = pick.duration_min;
          if (!data.format) data.format = getSelectedFormat();
        }
      }catch(_){}
      data = attachTgInit(data);
      if (typeof prev === 'function') return prev(type, data);
      if (typeof window.__postGAS === 'function') {
        var payload = Object.assign({ type: type || (data && data.type) || '' }, data);
        return await window.__postGAS(payload);
      }
    };
  })();

  (function(){
    var prev = window.__postGAS;
    if (typeof prev !== 'function') return;
    window.__postGAS = async function(payload){
      payload = payload || {};
      try{
        if (payload.type === 'consult_booking') {
          var pick = getSelectedBooking();
          if (!payload.date) payload.date = pick.date;
          if (!payload.time) payload.time = pick.time;
          if (!payload.duration_min) payload.duration_min = pick.duration_min;
          if (!payload.format) payload.format = getSelectedFormat();
        }
      }catch(_){}
      payload = attachTgInit(payload);
      return prev(payload);
    };
  })();

})();
</script>

<script>
// === Calendar √ó GAS (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è) ===
(function(){
  if (window.__CAL_MIN_GAS__) return; window.__CAL_MIN_GAS__ = true;

  // RU -> MM
  const RU2MM = { '—è–Ω–≤':'01','—Ñ–µ–≤':'02','–º–∞—Ä':'03','–∞–ø—Ä':'04','–º–∞—è':'05','–º–∞–π':'05','–∏—é–Ω':'06','–∏—é–ª':'07','–∞–≤–≥':'08','—Å–µ–Ω':'09','—Å–µ–Ω—Ç':'09','–æ–∫—Ç':'10','–Ω–æ—è':'11','–¥–µ–∫':'12' };
  const dd2 = (n)=>String(n).padStart(2,'0');
  const qs = (s,root=document)=>root.querySelector(s);
  const qsa= (s,root=document)=>Array.from(root.querySelectorAll(s));

  function parseYM(){
    const head = qs('#cal .cal-head .mon');
    if (!head) return null;
    const txt = (head.textContent||'').trim().toLowerCase();   // "–û–∫—Ç—è–±—Ä—å 2025"
    const m = txt.match(/([–∞-—èa-z—ë]+)\s+(\d{4})/i);
    if (!m) return null;
    const stem = m[1].slice(0,3).replace('—ë','–µ');
    const mm = RU2MM[stem];
    return mm ? { y: m[2], m: mm } : null;
  }

  async function loadFreeSlots(y, m){
    const base = window.APP_CONFIG && APP_CONFIG.GAS_WEBHOOK;
    if (!base) { console.warn('[cal] APP_CONFIG.GAS_WEBHOOK –ø—É—Å—Ç'); return false; }
    const first = `${y}-${m}-01`;
    const last  = `${y}-${m}-${dd2(new Date(+y,+m,0).getDate())}`;

    const u = new URL(base);
    u.searchParams.set('mode','free_slots');
    u.searchParams.set('from', first);
    u.searchParams.set('to',   last);
    u.searchParams.set('gran','30');
    u.searchParams.set('lead_min','120');
    u.searchParams.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');
    try{
      const tg = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) || '';
      if (tg) u.searchParams.set('tg_init', tg);
      else if (window.APP_CONFIG && APP_CONFIG.API_KEY) u.searchParams.set('key', APP_CONFIG.API_KEY);
    }catch(_){}

    const r = await fetch(u.toString()).catch(()=>null);
    const j = r && await r.json().catch(()=>null);
    if (!j || !j.ok) { console.warn('[cal] free_slots error', j); return false; }
    window.__FREE__ = j.days || {}; window.__GRAN__ = j.gran || 30;
    return true;
  }

  function dayHasSlots(iso){
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    return Array.isArray(arr) && arr.length > 0;
  }

  function applyDays(y, m){
    const grid = qs('#cal .cal-grid'); if (!grid) return;
    qsa('.cal-cell', grid).forEach(cell=>{
      if (cell.classList.contains('cal-dow')) return;
      const day = (cell.dataset.day || cell.textContent || '').trim();
      if (!day || /\D/.test(day)) return;
      const iso = `${y}-${m}-${dd2(day)}`;
      cell.dataset.iso = iso;
      if (dayHasSlots(iso)) {
        cell.classList.remove('off','muted');
        cell.removeAttribute('aria-disabled');
      } else {
        cell.classList.add('off','muted');
        cell.setAttribute('aria-disabled','true');
      }
    });
  }

  function renderSlots(iso){
    const wrap = qs('#slots,#slotsTime'); if (!wrap) return;
    const arr = (window.__FREE__ && window.__FREE__[iso]) || [];
    wrap.innerHTML = ''; wrap.classList.add('show');
    if (!arr.length) { wrap.innerHTML = '<div class="muted">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤</div>'; return; }
    arr.forEach(t=>{
      const b = document.createElement('button');
      b.className = 'btn btn-ghost'; b.textContent = t; b.dataset.time = t;
      b.onclick = ()=>{
        qsa('button', wrap).forEach(x=>x.classList.remove('btn-primary','active'));
        b.classList.add('btn-primary','active');
        window.scope = window.scope || {}; scope._selTime = t;
        window.SEL = window.SEL || {}; SEL.time = t;
      };
      wrap.appendChild(b);
    });
  }

  async function syncMonth(){
    const ym = parseYM(); if (!ym) return;
    if (CAL){ CAL.dataset.busy="1"; CAL.dataset.ready="0"; CAL.dataset.ym = `${ym.y}-${ym.m}`; const grid = CAL.querySelector(".cal-grid"); if (grid) grid.setAttribute("inert",""); }
    const ok = await loadFreeSlots(ym.y, ym.m); if (!ok) return;
    applyDays(ym.y, ym.m);
  }

  // init (—á—É—Ç—å –ø–æ–∑–∂–µ, —á—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è)
  setTimeout(syncMonth, 50);

  // –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤
  document.addEventListener('click', (e)=>{
    if (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM')) setTimeout(syncMonth, 30);
  });

  // –≤—ã–±–æ—Ä –¥–Ω—è -> —Å–ª–æ—Ç—ã
  document.addEventListener('click', (e)=>{
    const cell = e.target.closest && e.target.closest('#cal .cal-cell');
    if (!cell || cell.classList.contains('off')) return;
    const iso = cell.dataset.iso || cell.dataset.date;
    if (iso) {
      window.scope = window.scope || {}; scope._selDate = iso; window.__selDate = iso;
      renderSlots(iso);
    }
  });
})();
</script>

<!-- ==== STEP2 NORMAL: tails hidden + monthly cache (race-safe, non-invasive) ==== -->
<style>
  /* –•–≤–æ—Å—Ç—ã —Å–æ—Å–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–µ–≤ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º –∏ –∑–∞–ø—Ä–µ—â–∞–µ–º –∫–ª–∏–∫–∏ */
  #cal .cal-cell.tail{ visibility:hidden; pointer-events:none; }
<<script type="text/disabled">
(function(){
  if (window.__CAL_STEP2_NORMAL__) return; window.__CAL_STEP2_NORMAL__ = true;

  const qs  = (s,root=document)=>root.querySelector(s);
  const qsa = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const dd2 = (n)=>String(n).padStart(2,'0');
  const TZ  = (Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow');

  // ---------- MONTH HELPERS ----------
  function parseYM_fallback(){
    const h = qs('#cal .cal-head .mon') || qs('#cal .mon');
    if (!h) return null;
    const t = (h.textContent||'').trim();
    const m = t.match(/([–ê-–Ø–∞-—èA-Za-z–Å—ë]+)\s+(\d{4})/);
    if (!m) return null;
    const map = {—è–Ω–≤:'01',—Ñ–µ–≤:'02',–º–∞—Ä:'03',–∞–ø—Ä:'04',–º–∞—è:'05',–º–∞–π:'05',–∏—é–Ω:'06',–∏—é–ª:'07',–∞–≤–≥:'08',—Å–µ–Ω:'09',—Å–µ–Ω—Ç:'09',–æ–∫—Ç:'10',–Ω–æ—è:'11',–¥–µ–∫:'12',
                 jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
    const stem = m[1].toLowerCase().replace('—ë','–µ').slice(0,3);
    const mm = map[stem]; if (!mm) return null;
    return { y: m[2], m: mm };
  }
  function parseYM(){
    try{
      if (typeof window.parseYM === 'function'){ const r = window.parseYM(); if (r && r.y && r.m) return r; }
    }catch(_){}
    try{
      if (typeof window.parseHeadYM === 'function'){ const r = window.parseHeadYM(); if (r && r.y && r.m) return r; }
    }catch(_){}
    return parseYM_fallback();
  }
  function daysInMonth(y,m){ return new Date(+y, +m, 0).getDate(); }

  // ---------- TAILS MARKER ----------
  function markTailsAndAttachISO(ym){
    const grid = qs('#cal .cal-grid'); if (!grid) return;
    const cells = qsa('.cal-cell', grid).filter(c=>!c.classList.contains('cal-dow'));
    if (!cells.length) return;

    // –ù–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–≤–æ–π —è—á–µ–π–∫–∏ —Å "1"
    let startIdx = -1;
    for (let i=0;i<cells.length;i++){
      const raw = (cells[i].dataset.day || cells[i].textContent || '').trim();
      if (/^\d+$/.test(raw) && parseInt(raw,10) === 1){ startIdx = i; break; }
    }
    if (startIdx < 0) startIdx = 0;

    const total = daysInMonth(ym.y, ym.m);
    const endIdx = startIdx + total - 1;

    cells.forEach((cell, idx)=>{
      const dayTxt = (cell.dataset.day || cell.textContent || '').trim();
      const dayNum = /^\d+$/.test(dayTxt) ? parseInt(dayTxt,10) : NaN;
      const inMonth = (idx >= startIdx && idx <= endIdx && !isNaN(dayNum) && dayNum>=1 && dayNum<=total);
      if (inMonth){
        const iso = `${ym.y}-${ym.m}-${dd2(dayNum)}`;
        cell.dataset.iso = iso;
        cell.classList.remove('tail');
        cell.style.visibility = '';
      } else {
        cell.classList.add('tail','off');
        cell.setAttribute('aria-disabled','true');
        if (cell.dataset.iso) delete cell.dataset.iso;
      }
    });
  }

  // ---------- MONTH CACHE (RAM + sessionStorage) ----------
  const TTL_MS = 3 * 60 * 1000; // 3 –º–∏–Ω—É—Ç—ã
  const RAM = new Map();
  function keyYM(y,m){ return `${y}-${m}`; }
  function getCache(y,m){
    const k = keyYM(y,m);
    let e = RAM.get(k);
    if (!e){
      try{ e = JSON.parse(sessionStorage.getItem('free:'+k) || 'null'); }catch(_){ e = null; }
      if (e) RAM.set(k, e);
    }
    if (e && (Date.now() - (e.ts||0)) < TTL_MS) return e;
    return null;
  }
  function setCache(y,m,days,gran,tz){
    const k = keyYM(y,m);
    const e = { ts: Date.now(), days: days||{}, gran: gran||30, tz: tz||TZ };
    RAM.set(k, e);
    try{ sessionStorage.setItem('free:'+k, JSON.stringify(e)); }catch(_){}
    return e;
  }
  function invalidateMonth(y,m){
    const k = keyYM(y,m);
    RAM.delete(k);
    try{ sessionStorage.removeItem('free:'+k); }catch(_){}
  }

  // ---------- WRAPS (non-invasive) ----------
  // 1) –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º applyDays/applyDaysState, —á—Ç–æ–±—ã —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—á–∞—Ç—å —Ö–≤–æ—Å—Ç—ã
  (function(){
    const wrapApply = (fnName, mapper)=>{
      const orig = window[fnName];
      if (typeof orig !== 'function') return;
      window[fnName] = function(){
        // –ø–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç–∞—Ç—å YM –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        let ym = null;
        if (arguments.length && typeof arguments[0]==='object' && arguments[0].y && arguments[0].m){
          ym = arguments[0];
        } else if (arguments.length>=2) {
          ym = { y: arguments[0], m: arguments[1] };
        } else {
          ym = parseYM();
        }
        if (ym) try{ markTailsAndAttachISO(ym); }catch(_){}
        return orig.apply(this, arguments);
      };
    };
    wrapApply('applyDays');        // V5
    wrapApply('applyDaysState');   // —Ä–∞–Ω–Ω–∏–π –±–ª–æ–∫
  })();

  // 2) –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫–∏ –º–µ—Å—è—Ü–∞, –¥–æ–±–∞–≤–ª—è—è –∫—ç—à –∏ race-guard
  (function(){
    // –æ–±—â–∏–π —Ä–µ–∫–≤–µ—Å—Ç-id (–µ—Å–ª–∏ —Ä–∞–Ω–µ–µ —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ)
    window.__CAL_REQ_ID__ = window.__CAL_REQ_ID__ || 0;

    // V5: loadFreeSlots(y, m) -> Promise<{days,gran,tz}>
    if (typeof window.loadFreeSlots === 'function'){
      const orig = window.loadFreeSlots;
      window.loadFreeSlots = async function(y, m, opt){
        opt = opt || {};
        const cached = getCache(y,m);
        if (cached && !opt.force){
          // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          window.__GRAN__ = cached.gran;
          window.__FREE__ = cached.days;
          return { ok:true, days: cached.days, gran: cached.gran, tz: cached.tz, cached:true };
        }
        const my = ++window.__CAL_REQ_ID__;
        const res = await orig.apply(this, arguments);
        if (my !== window.__CAL_REQ_ID__) return res; // —É—Å—Ç–∞—Ä–µ–ª ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        try{
          if (res && res.days){ setCache(y,m, res.days, res.gran, res.tz); }
          else if (window.__FREE__){ setCache(y,m, window.__FREE__, window.__GRAN__||30, TZ); }
        }catch(_){}
        return res;
      };
    }

    // –†–∞–Ω–Ω–∏–π –±–ª–æ–∫: loadFreeSlotsForMonth(y, m) -> async (–∑–∞–ø–æ–ª–Ω—è–µ—Ç window.__FREE__)
    if (typeof window.loadFreeSlotsForMonth === 'function'){
      const orig2 = window.loadFreeSlotsForMonth;
      window.loadFreeSlotsForMonth = async function(y, m, opt){
        opt = opt || {};
        const cached = getCache(y,m);
        if (cached && !opt.force){
          window.__GRAN__ = cached.gran;
          window.__FREE__ = cached.days;
          return; // –∏–∑ –∫—ç—à–∞ —É–∂–µ –≤—Å—ë –ø–æ–ª–æ–∂–∏–ª–∏
        }
        const my = ++window.__CAL_REQ_ID__;
        await orig2.apply(this, arguments);
        if (my !== window.__CAL_REQ_ID__) return; // —É—Å—Ç–∞—Ä–µ–ª
        try{
          if (window.__FREE__){ setCache(y,m, window.__FREE__, window.__GRAN__||30, TZ); }
        }catch(_){}
      };
    }
  })();

  // 3) –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –±—Ä–æ–Ω–∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –∏ –º—è–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  (function(){
    const prev = window.apiEvent;
    window.apiEvent = async function(type, data){
      const res = prev ? await prev(type, data) : undefined;
      try{
        if ((type==='consult_booking' || (data && data.type==='consult_booking')) && res && res.ok){
          const date = (data && data.date) || (window.scope && (scope._selDate||scope.selDate)) || '';
          if (date && /^\d{4}-\d{2}-\d{2}$/.test(date)){
            const ym = { y: date.slice(0,4), m: date.slice(5,7) };
            invalidateMonth(ym.y, ym.m);
            // –ª–æ–∫–∞–ª—å–Ω–æ –≤—ã—á–µ—Ä–∫–Ω–µ–º –∑–∞–Ω—è—Ç—ã–π —Å—Ç–∞—Ä—Ç, –µ—Å–ª–∏ –æ–Ω –≤ __FREE__
            const t = (data && data.time) || (window.scope && (scope._selTime||scope.selTime));
            const dur = (data && +data.duration_min) || (window.scope && +scope._durMin) || 30;
            const step = window.__GRAN__ || 30;
            if (window.__FREE__ && window.__FREE__[date] && t){
              const arr = window.__FREE__[date];
              const idx = arr.indexOf(t);
              if (idx>=0){
                const removeCount = Math.max(1, Math.ceil(dur / step));
                // —É–¥–∞–ª—è–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Ü–µ–ø–æ—á–∫—É —à–∞–≥–æ–≤
                for (let i=0;i<removeCount;i++){
                  const hh = (function(m){ const H=String(Math.floor(m/60)).padStart(2,'0'); const M=String(m%60).padStart(2,'0'); return H+':'+M; })(
                    (function(s){ const m=s.split(':').map(Number); return m[0]*60+m[1]; })(t) + i*step
                  );
                  const j = arr.indexOf(hh); if (j>=0) arr.splice(j,1);
                }
                if (!arr.length){ const ym2 = parseYM(); if (ym2) markTailsAndAttachISO(ym2); }
              }
            }
            // –º—è–≥–∫–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –º–µ—Å—è—Ü (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏)
            if (typeof window.syncMonthAndDays === 'function') { try{ await window.syncMonthAndDays(); }catch(_){} }
            else if (typeof window.syncMonth === 'function')    { try{ await window.syncMonth(); }catch(_){} }
          }
        }
      }catch(_){}
      return res;
    };
  })();

  // 4) –ü–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç–º–µ—Ç–∫–∞ —Ö–≤–æ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª—å–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å–µ—Ç–∫–∏
  setTimeout(()=>{ const ym = parseYM(); if (ym) markTailsAndAttachISO(ym); }, 50);

  // 5) –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ—Å—è—Ü–∞ ‚Äî —Ç–æ–∂–µ –æ—Ç–º–µ—Ç–∏–º —Ö–≤–æ—Å—Ç—ã (–ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ prev/next)
  document.addEventListener('click', (e)=>{
    if (e.target.closest('#cal #prevM') || e.target.closest('#cal #nextM')) { if (CAL){ CAL.dataset.busy="1"; CAL.dataset.ready="0"; const grid = CAL.querySelector(".cal-grid"); if (grid) grid.setAttribute("inert",""); }
      setTimeout(()=>{ const ym = parseYM(); if (ym) markTailsAndAttachISO(ym); }, 60);
    }
  });
})();
</script>


<script>
(function(){
  if (window.__DUR_TABS_ENHANCED__) return; window.__DUR_TABS_ENHANCED__ = true;
  const qsa = (s,root=document)=>Array.from((root||document).querySelectorAll(s));
  const qs = (s,root=document)=> (root||document).querySelector(s);

  function setDur(m){
    // visual state
    qsa('.dur,[data-min]').forEach(b=>{
      const val = +b.getAttribute('data-min') || parseInt(b.textContent,10) || 0;
      b.classList.toggle('btn-primary', val===m);
      b.classList.toggle('btn-ghost', val!==m);
    });
    // keep in scope for pick()
    window.scope = window.scope || {}; scope._durMin = m;
    window.SEL   = window.SEL   || {}; SEL.duration_min = m;
    const hidden = document.getElementById('consultDuration'); if (hidden) hidden.value = m;
    // re-render slots for selected date if any
    const iso = (window.scope && scope._selDate) || '';
    if (iso && typeof renderSlots==='function') {
      // new API expects (iso, freeMap)
      try{ renderSlots(iso, window.__FREE__); }catch(_){}
    }
  }

  // init state from existing active .dur
  const active = qs('.dur.btn-primary, .dur.active');
  if (active){
    const m = +active.getAttribute('data-min') || parseInt(active.textContent,10) || 30;
    setDur(m);
  }

  // bind clicks
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest && e.target.closest('.dur,[data-min]');
    if (!btn) return;
    const m = +btn.getAttribute('data-min') || parseInt(btn.textContent,10) || 30;
    setDur(m);
  }, {capture:true});
})();
</script>


<script>
(function(){
  if (window.__RENDERSLOTS_ADAPTOR__) return; window.__RENDERSLOTS_ADAPTOR__ = true;
  const qsa=(s,root=document)=>Array.from((root||document).querySelectorAll(s));
  const qs=(s,root=document)=>(root||document).querySelector(s);

  // lightweight toast helper (no deps)
  function toast(msg){
    try{
      const n=document.createElement('div');
      n.className='toast shadow';
      n.textContent=String(msg||''); Object.assign(n.style,{
        position:'fixed',left:'50%',bottom:'22px',transform:'translateX(-50%)',
        background:'#111B2C',color:'#fff',padding:'10px 14px',borderRadius:'10px',
        zIndex:9999,opacity:'0',transition:'opacity .15s ease'
      });
      document.body.appendChild(n); requestAnimationFrame(()=>{ n.style.opacity='1'; });
      setTimeout(()=>{ n.style.opacity='0'; setTimeout(()=>n.remove(),150); }, 1600);
    }catch(_){}
  }

  // unified modern render
  function renderSlotsModern(iso, freeMap){
    try{
      const wrap = document.querySelector('#slots,#slotsTime'); if (!wrap) return;
      const arr = (freeMap && freeMap[iso]) || (window.__FREE__ && window.__FREE__[iso]) || [];
      wrap.innerHTML = ''; wrap.classList.add('show');
      if (!arr.length){ wrap.innerHTML = '<div class="muted">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤</div>'; return; }

      const dur = (window.SEL && +window.SEL.duration_min) || (window.scope && +window.scope._durMin) || 30;

      arr.forEach(time=>{
        const b = document.createElement('button');
        b.className = 'btn btn-ghost'; b.textContent = time;
        b.dataset.time = time; b.dataset.iso = iso;
        b.onclick = async () => {
          if (b.dataset.busy) return;
          b.dataset.busy='1';
          // visual feedback (blue) before removal
          qsa('button', wrap).forEach(x=>x.classList.remove('btn-primary','active'));
          b.classList.add('btn-primary','active');
          // remove from UI quickly (120ms), per requirement
          setTimeout(()=>{ try{ b.remove(); }catch(_){ } }, 120);

          // send HOLD to backend; duration_min required; date/time from dataset
          const payload = { type:'hold_slot', date: iso, time: time, duration_min: dur };
          try{
            if (typeof window.apiEvent==='function'){
              const res = await window.apiEvent('hold_slot', payload);
              if (!res || res.ok===false){
                // slot is not holdable -> refresh slots to reflect server truth
                if (window.syncMonth) try{ window.syncMonth(); }catch(_){}
                toast((res && res.error)||'–°–ª–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
              }else{
                // also remove from __FREE__ locally to avoid reappearance
                try{
                  const list = (window.__FREE__ && window.__FREE__[iso]) || [];
                  const idx = list.indexOf(time); if (idx>=0) list.splice(idx,1);
                }catch(_){}
              }
            }
          }catch(err){
            // network or handler error -> refresh
            toast('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏');
            if (window.syncMonth) try{ window.syncMonth(); }catch(_){}
          }
        };
        wrap.appendChild(b);
      });
    }catch(_){}
  }

  // Public adaptor that accepts multiple signatures
  window.renderSlots = function(){
    const args = Array.from(arguments);
    if (args.length >= 2){
      return renderSlotsModern(args[0], args[1]);
    }else if (args.length === 1){
      const x = args[0];
      if (x && typeof x === 'string'){
        window.__selDate = x;
        return renderSlotsModern(x, window.__FREE__ || {});
      }
      if (x && typeof x === 'object' && x.getFullYear){
        const iso = x.toISOString ? x.toISOString().slice(0,10) :
                   (x.getFullYear()+'-'+String(x.getMonth()+1).padStart(2,'0')+'-'+String(x.getDate()).padStart(2,'0'));
        window.__selDate = iso;
        return renderSlotsModern(iso, window.__FREE__ || {});
      }
      const iso = (window.scope && window.scope._selDate) || window.__selDate || '';
      if (iso) return renderSlotsModern(iso, window.__FREE__ || {});
      return;
    }else{
      const iso = (window.scope && window.scope._selDate) || window.__selDate || '';
      if (iso) return renderSlotsModern(iso, window.__FREE__ || {});
    }
  };
})();
</script>
</script>

<script>
// --- Unified apiEvent: attach tg_init or fallback API key for Desktop/browser ---
(function(){
  const cfg = window.APP_CONFIG || (window.APP_CONFIG = {});
  const GAS = cfg.GAS_WEBHOOK;
  if (!window.apiEvent) window.apiEvent = async function(type, data){ data = data || {}; return { ok:false, error:'no_backend' }; };

  const prev = window.apiEvent;
  window.apiEvent = async function(type, data){
    data = data || {};
    try{
      if (!data.tg_init && window.Telegram && Telegram.WebApp) {
        data.tg_init = Telegram.WebApp.initData || '';
      }
      if ((!data.tg_init || data.tg_init.length === 0) && cfg.API_KEY) {
        data.key = cfg.API_KEY; // Desktop/browser fallback
      }
    }catch(_){}
    if (typeof prev === 'function') return prev(type, data);
    try {
      const r = await fetch(GAS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type, ...data }) });
      return await r.json();
    } catch(e){
      return { ok:false, error: String(e) };
    }
  };
})();
</script>


<script>
// === Unified apiEvent (Desktop fallback): attach tg_init or API key ===
(function(){
  const cfg = window.APP_CONFIG || (window.APP_CONFIG = {});
  const GAS = cfg.GAS_WEBHOOK;
  const prev = typeof window.apiEvent === 'function' ? window.apiEvent : null;
  window.apiEvent = async function(type, data){
    data = data || {};
    try{
      if (!data.tg_init && window.Telegram && Telegram.WebApp){
        data.tg_init = Telegram.WebApp.initData || '';
      }
      if ((!data.tg_init || data.tg_init.length === 0) && cfg.API_KEY){
        data.key = cfg.API_KEY; // Desktop/browser fallback
      }
    }catch(_){}
    if (prev) return prev(type, data);
    // Fallback transport if no previous transport
    const res = await fetch(GAS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type, ...data }) });
    return res.json();
  };
})();
</script>

</body>
</html>
